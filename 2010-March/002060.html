<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-374-SuSE-11-1-SLE-SP-Devel,	updated. 0386077abb795ae1c35985927a70b21f8f723e3b
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2010-March/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%0A%09KIWI-374-SuSE-11-1-SLE-SP-Devel%2C%0A%09updated.%200386077abb795ae1c35985927a70b21f8f723e3b&In-Reply-To=%3C201003240740.o2O7eUZ9025080%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002059.html">
   <LINK REL="Next"  HREF="002061.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-374-SuSE-11-1-SLE-SP-Devel,	updated. 0386077abb795ae1c35985927a70b21f8f723e3b</H1>
    <B>marcus_schaefer at BerliOS</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%0A%09KIWI-374-SuSE-11-1-SLE-SP-Devel%2C%0A%09updated.%200386077abb795ae1c35985927a70b21f8f723e3b&In-Reply-To=%3C201003240740.o2O7eUZ9025080%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-374-SuSE-11-1-SLE-SP-Devel,	updated. 0386077abb795ae1c35985927a70b21f8f723e3b">marcus_schaefer at mail.berlios.de
       </A><BR>
    <I>Wed Mar 24 08:40:30 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002059.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. c75b921620abaf7c0124d71d7af5db4d78b66fd4
</A></li>
        <LI>Next message: <A HREF="002061.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-374-SuSE-11-1-SLE-SP-Devel,	updated. fbb6ff7733a4632f842e706c39fa6dc5cdd23b10
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2060">[ date ]</a>
              <a href="thread.html#2060">[ thread ]</a>
              <a href="subject.html#2060">[ subject ]</a>
              <a href="author.html#2060">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Project kiwi at BerliOS&quot;.

The branch, KIWI-374-SuSE-11-1-SLE-SP-Devel has been updated
       via  0386077abb795ae1c35985927a70b21f8f723e3b (commit)
      from  dafac4317db2ce16a0a681c7c829970d200d31e3 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 0386077abb795ae1c35985927a70b21f8f723e3b
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Wed Mar 24 08:40:17 2010 +0100

    - added bootnext program which implements a small boot loader
      needed for the 'boot from hard disk' menu entry on usb media.
      It basically loads the mbr from the first drive that is
      not the usb stick. Thanks to Steffen Winterfeldt who
      implemented this (bnc #583212)
    - added dialog based OEM install verification UI

-----------------------------------------------------------------------

Summary of changes:
diff --git a/locale/ar/LC_MESSAGES/kiwi.po b/locale/ar/LC_MESSAGES/kiwi.po
index bdb2635..c59cd58 100644
--- a/locale/ar/LC_MESSAGES/kiwi.po
+++ b/locale/ar/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/cs/LC_MESSAGES/kiwi.po b/locale/cs/LC_MESSAGES/kiwi.po
index 549a8a3..5e476a2 100644
--- a/locale/cs/LC_MESSAGES/kiwi.po
+++ b/locale/cs/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/de/LC_MESSAGES/kiwi.po b/locale/de/LC_MESSAGES/kiwi.po
index b838746..60d6782 100644
--- a/locale/de/LC_MESSAGES/kiwi.po
+++ b/locale/de/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/el/LC_MESSAGES/kiwi.po b/locale/el/LC_MESSAGES/kiwi.po
index a72a739..cafada4 100644
--- a/locale/el/LC_MESSAGES/kiwi.po
+++ b/locale/el/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/es/LC_MESSAGES/kiwi.po b/locale/es/LC_MESSAGES/kiwi.po
index 232c9ed..00ccf93 100644
--- a/locale/es/LC_MESSAGES/kiwi.po
+++ b/locale/es/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/fi/LC_MESSAGES/kiwi.po b/locale/fi/LC_MESSAGES/kiwi.po
index 79b9902..ac13394 100644
--- a/locale/fi/LC_MESSAGES/kiwi.po
+++ b/locale/fi/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/fr/LC_MESSAGES/kiwi.po b/locale/fr/LC_MESSAGES/kiwi.po
index 6043d7e..b2422c1 100644
--- a/locale/fr/LC_MESSAGES/kiwi.po
+++ b/locale/fr/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/hu/LC_MESSAGES/kiwi.po b/locale/hu/LC_MESSAGES/kiwi.po
index 4b2447b..9cac8c4 100644
--- a/locale/hu/LC_MESSAGES/kiwi.po
+++ b/locale/hu/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/it/LC_MESSAGES/kiwi.po b/locale/it/LC_MESSAGES/kiwi.po
index 2db252c..43e8c92 100644
--- a/locale/it/LC_MESSAGES/kiwi.po
+++ b/locale/it/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/ja/LC_MESSAGES/kiwi.po b/locale/ja/LC_MESSAGES/kiwi.po
index a372f51..88d4b2b 100644
--- a/locale/ja/LC_MESSAGES/kiwi.po
+++ b/locale/ja/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/kiwi-template/kiwi.pot b/locale/kiwi-template/kiwi.pot
index be7f667..5474f3c 100644
--- a/locale/kiwi-template/kiwi.pot
+++ b/locale/kiwi-template/kiwi.pot
@@ -77,5 +77,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/ko/LC_MESSAGES/kiwi.po b/locale/ko/LC_MESSAGES/kiwi.po
index 0b1f39a..156ef12 100644
--- a/locale/ko/LC_MESSAGES/kiwi.po
+++ b/locale/ko/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/nl/LC_MESSAGES/kiwi.po b/locale/nl/LC_MESSAGES/kiwi.po
index f2473c0..7f53e98 100644
--- a/locale/nl/LC_MESSAGES/kiwi.po
+++ b/locale/nl/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/pl/LC_MESSAGES/kiwi.po b/locale/pl/LC_MESSAGES/kiwi.po
index 947e138..9f60a24 100644
--- a/locale/pl/LC_MESSAGES/kiwi.po
+++ b/locale/pl/LC_MESSAGES/kiwi.po
@@ -76,5 +76,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/pt_BR/LC_MESSAGES/kiwi.po b/locale/pt_BR/LC_MESSAGES/kiwi.po
index 56822a7..55dd357 100644
--- a/locale/pt_BR/LC_MESSAGES/kiwi.po
+++ b/locale/pt_BR/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/ru/LC_MESSAGES/kiwi.po b/locale/ru/LC_MESSAGES/kiwi.po
index 5e62b97..62c4a2f 100644
--- a/locale/ru/LC_MESSAGES/kiwi.po
+++ b/locale/ru/LC_MESSAGES/kiwi.po
@@ -76,5 +76,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/sv/LC_MESSAGES/kiwi.po b/locale/sv/LC_MESSAGES/kiwi.po
index 77638dc..e057da5 100644
--- a/locale/sv/LC_MESSAGES/kiwi.po
+++ b/locale/sv/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/tr/LC_MESSAGES/kiwi.po b/locale/tr/LC_MESSAGES/kiwi.po
index 0e9a828..f8b0830 100644
--- a/locale/tr/LC_MESSAGES/kiwi.po
+++ b/locale/tr/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/uk/LC_MESSAGES/kiwi.po b/locale/uk/LC_MESSAGES/kiwi.po
index 4d86c64..0d2662a 100644
--- a/locale/uk/LC_MESSAGES/kiwi.po
+++ b/locale/uk/LC_MESSAGES/kiwi.po
@@ -76,5 +76,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/zh_CN/LC_MESSAGES/kiwi.po b/locale/zh_CN/LC_MESSAGES/kiwi.po
index e3bd7b0..700c1fc 100644
--- a/locale/zh_CN/LC_MESSAGES/kiwi.po
+++ b/locale/zh_CN/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/locale/zh_TW/LC_MESSAGES/kiwi.po b/locale/zh_TW/LC_MESSAGES/kiwi.po
index 293147a..5be209a 100644
--- a/locale/zh_TW/LC_MESSAGES/kiwi.po
+++ b/locale/zh_TW/LC_MESSAGES/kiwi.po
@@ -75,5 +75,8 @@ msgstr &quot;&quot;
 msgid &quot;Loading %1&quot;
 msgstr &quot;&quot;
 
+msgid &quot;Verifying %1&quot;
+msgstr &quot;&quot;
+
 msgid &quot;Select disk for installation:&quot;
 msgstr &quot;&quot;
diff --git a/modules/KIWIBoot.pm b/modules/KIWIBoot.pm
index 1a98718..851d7c1 100644
--- a/modules/KIWIBoot.pm
+++ b/modules/KIWIBoot.pm
@@ -3693,9 +3693,18 @@ sub setupBootLoaderConfiguration {
 		} elsif ($type =~ /^KIWI USB/) {
 			print FD &quot;gfxmenu (hd0,0)/boot/message\n&quot;;
 			print FD &quot;title Boot from Hard Disk\n&quot;;
-			print FD &quot; chainloader (hd0)+1\n&quot;;
+			print FD &quot; chainloader (hd0,0)/boot/grub/bootnext\n&quot;;
 			$title = $this -&gt; makeLabel (&quot;Install/Restore $label&quot;);
 			print FD &quot;title $title\n&quot;;
+			my $bootnext = $this -&gt; addBootNext (
+				&quot;$tmpdir/boot/grub/bootnext&quot;, hex $this-&gt;{mbrid}
+			);
+			if (! defined $bootnext) {
+				$kiwi -&gt; failed ();
+				$kiwi -&gt; error  (&quot;Failed to write bootnext\n&quot;);
+				$kiwi -&gt; failed ();
+				return undef;
+			}
 		} else {
 			$title = $this -&gt; makeLabel (&quot;$label [ $type ]&quot;);
 			print FD &quot;gfxmenu (hd0,$bootpart)/boot/message\n&quot;;
@@ -4968,4 +4977,64 @@ sub setupFilesystem {
 	return $this;
 }
 
+#==========================================
+# addBootNext
+#------------------------------------------
+sub addBootNext {
+	# ...
+	# Write boot program that boots the firsts drive that
+	# does _not_ have our mbr id. The boot program source which
+	# creates $bootnext below is added in the git repo below
+	# tools/bootnext
+	# ---
+	my $this = shift;
+	my $file = shift;
+	my $id   = shift;
+	my $bn;
+	my $bootnext =
+		&quot;\x8c\xc8\x8e\xd0\x31\xe4\x8e\xd8\x8e\xc0\xfc\xfb\xbe\x00\x7c\xbf&quot; .
+		&quot;\x00\x60\xb9\x00\x01\xf3\xa5\xea\x1c\x60\x00\x00\xb4\x08\x31\xff&quot; .
+		&quot;\xb2\x80\xcd\x13\x73\x02\xb2\x01\x80\xfa\x01\xb0\x80\x10\xc2\x88&quot; .
+		&quot;\x16\x29\x61\xa2\x2a\x61\xe8\x8b\x00\x73\x10\xa0\x2a\x61\x40\x3a&quot; .
+		&quot;\x06\x29\x61\x72\xee\xbe\x2d\x61\xe9\xb3\x00\x80\x3e\x2a\x61\x80&quot; .
+		&quot;\x74\x03\xe8\x07\x00\xb2\x80\xea\x00\x7c\x00\x00\xa1\x13\x04\x48&quot; .
+		&quot;\xa3\x13\x04\xc1\xe0\x06\x2d\x00\x06\x66\x8b\x16\x4c\x00\x66\x89&quot; .
+		&quot;\x16\x25\x61\x50\x68\x89\x60\x66\x8f\x06\x4c\x00\x50\x07\xbe\x00&quot; .
+		&quot;\x60\x89\xf7\xb9\x00\x01\xf3\xa5\xc3\x9c\x2e\x88\x16\x2b\x61\x2e&quot; .
+		&quot;\x88\x26\x2c\x61\x2e\x3a\x16\x2a\x61\x75\x04\xb2\x80\xeb\x0a\x80&quot; .
+		&quot;\xfa\x80\x75\x05\x2e\x8a\x16\x2a\x61\x2e\xff\x1e\x25\x61\x50\x9f&quot; .
+		&quot;\x67\x88\x64\x24\x06\x58\x2e\x80\x3e\x2c\x61\x08\x74\x05\x2e\x8a&quot; .
+		&quot;\x16\x2b\x61\xcf\xe8\x10\x00\x72\x0d\x66\xa1\xb8\x61\x66\x3b\x06&quot; .
+		&quot;\xb8\x7d\xf9\x74\x01\xf8\xc3\xb8\x01\x02\xb9\x01\x00\xb6\x00\x8a&quot; .
+		&quot;\x16\x2a\x61\xbb\x00\x7c\xcd\x13\x72\x13\x66\x83\x3e\x00\x7c\x00&quot; .
+		&quot;\xf9\x74\x0a\x81\x3e\xfe\x7d\x55\xaa\xf9\x75\x01\xf8\xc3\xe8\x15&quot; .
+		&quot;\x00\xbe\x44\x61\xe8\x0f\x00\xb4\x00\xcd\x16\xbe\x41\x61\xe8\x05&quot; .
+		&quot;\x00\xcd\x19\xf4\xeb\xfd\xac\x08\xc0\x74\x09\xbb\x07\x00\xb4\x0e&quot; .
+		&quot;\xcd\x10\xeb\xf2\xc3\x00\x00\x00\x00\x00\x00\x00\x00\x4e\x6f\x20&quot; .
+		&quot;\x6f\x70\x65\x72\x61\x74\x69\x6e\x67\x20\x73\x79\x73\x74\x65\x6d&quot; .
+		&quot;\x2e\x0d\x0a\x00\x0a\x50\x72\x65\x73\x73\x20\x61\x20\x6b\x65\x79&quot; .
+		&quot;\x20\x74\x6f\x20\x72\x65\x62\x6f\x6f\x74\x2e\x00\x00\x00\x00\x00&quot; .
+		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot; .
+		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot; .
+		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot; .
+		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot; .
+		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot; .
+		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot; .
+		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot; .
+		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot; .
+		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot; .
+		&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x55\xaa&quot;;
+
+	# we really need a valid id
+	return undef unless $id;
+
+	substr $bootnext, 0x1b8, 4, pack(&quot;V&quot;, $id);
+
+	open $bn, &quot;&gt;$file&quot; or return undef;
+	print $bn $bootnext;
+	close $bn;
+
+	return $this;
+}
+
 1; 
diff --git a/rpm/kiwi.changes b/rpm/kiwi.changes
index bbe6741..7630900 100644
--- a/rpm/kiwi.changes
+++ b/rpm/kiwi.changes
@@ -1,4 +1,14 @@
 -------------------------------------------------------------------
+Wed Mar 24 08:35:02 CET 2010 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
+
+- added bootnext program which implements a small boot loader
+  needed for the 'boot from hard disk' menu entry on usb media.
+  It basically loads the mbr from the first drive that is
+  not the usb stick. Thanks to Steffen Winterfeldt who
+  implemented this (bnc #583212)
+- added dialog based OEM install verification UI
+
+-------------------------------------------------------------------
 Fri Mar 19 13:36:15 CET 2010 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
 
 - added &quot;Select disk for installation&quot; to getText (bnc #589667)
diff --git a/system/boot/ix86/oemboot/suse-dump b/system/boot/ix86/oemboot/suse-dump
index f259381..2d0d76e 100755
--- a/system/boot/ix86/oemboot/suse-dump
+++ b/system/boot/ix86/oemboot/suse-dump
@@ -279,9 +279,34 @@ function OEMInstall {
 	# Check the md5sum of the raw disk
 	#--------------------------------------
 	Echo &quot;Install complete, checking data...&quot;
-	dd if=$imageDevice bs=1024 |\
-		head --bytes=$((blocks * blocksize)) |\
-		md5sum - &gt; /etc/ireal.md5
+	verifyBytes=$((blocks * blocksize))
+	verifyMByte=$((verifyBytes / 1048576))
+	if [ -x /usr/bin/dcounter ];then
+		test -e /progress || mkfifo /progress
+		TEXT_VERIFY=$(getText &quot;Verifying %1&quot; $imageDevice)
+		dump=&quot;cat $imageDevice&quot;
+		dump=&quot;$dump | dcounter -s $verifyMByte -l \&quot;$TEXT_VERIFY \&quot;&quot;
+		errorLogStop
+		(
+			eval $dump 2&gt;/progress |\
+				head --bytes=$verifyBytes | md5sum - &gt; /etc/ireal.md5
+		)&amp;
+		echo &quot;cat /progress | dialog \
+			--backtitle \&quot;$TEXT_INSTALLTITLE\&quot; \
+			--progressbox 3 65
+		&quot; &gt; /tmp/progress.sh
+		if [ -e /dev/fb0 ];then
+			fbiterm -m $UFONT -- bash -e /tmp/progress.sh
+		else
+			bash -e /tmp/progress.sh
+		fi
+		clear
+		errorLogContinue
+	else
+		dd if=$imageDevice bs=1024 |\
+			head --bytes=$verifyBytes |\
+			md5sum - &gt; /etc/ireal.md5
+	fi
 	read sum2 dumy &lt; /etc/ireal.md5
 	if [ $sum1 != $sum2 ];then
 		systemException \
diff --git a/tools/bootnext/Makefile b/tools/bootnext/Makefile
new file mode 100644
index 0000000..a0d20b0
--- /dev/null
+++ b/tools/bootnext/Makefile
@@ -0,0 +1,8 @@
+all: bootnext
+
+bootnext: bootnext.asm
+	nasm -O99 -f bin -l $@.lst -o $@ $&lt;
+
+clean:
+	rm -f *~ bootnext *.lst
+
diff --git a/tools/bootnext/README b/tools/bootnext/README
new file mode 100644
index 0000000..46cb578
--- /dev/null
+++ b/tools/bootnext/README
@@ -0,0 +1,8 @@
+A small boot loader needed for the 'boot from hard disk' menu entry on usb
+media. It basically loads the mbr from the first drive that is not the usb
+stick.
+
+There's no real need to reassemble; it is already included in
+KIWIBoot.pm::addBootNext() in binary form. The code is here mostly for
+reference.
+
diff --git a/tools/bootnext/bootnext.asm b/tools/bootnext/bootnext.asm
new file mode 100644
index 0000000..e053412
--- /dev/null
+++ b/tools/bootnext/bootnext.asm
@@ -0,0 +1,239 @@
+;
+; bootnext.asm
+;
+; A small boot program that boots the first local disk that does not have
+; the same id (4 bytes at offset 1b8h) as 'bootnext'.
+;
+; Copyright (c) 2010 Steffen Winterfeldt.
+;
+; Licensed under GPL2; for details see file LICENSE.
+;
+
+
+; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
+			bits 16
+
+disk_buf		equ 7c00h
+mbr_start		equ 6000h
+id_ofs			equ  1b8h
+
+			section .text
+
+			org mbr_start
+
+			mov ax,cs
+			mov ss,ax
+			xor sp,sp
+			mov ds,ax
+			mov es,ax
+			cld
+			sti
+
+			; move us out of the way
+			mov si,disk_buf
+			mov di,mbr_start
+			mov cx,100h
+			rep movsw
+			jmp 0:main_10
+
+main_10:
+			; look at all drives in turn until we find one with
+			; a non-matching id
+			mov ah,8
+			xor di,di
+			mov dl,80h
+			int 13h
+			jnc main_20
+			mov dl,1		; we'll try at least one
+main_20:
+			cmp dl,1		; dto
+			mov al,80h
+			adc dl,al
+			mov [bios_drives],dl
+
+main_30:
+			mov [drive],al
+			call check
+			jnc main_60
+			mov al,[drive]
+			inc ax
+			cmp al,[bios_drives]
+			jb main_30
+
+			mov si,msg_no_os
+			jmp final_msg
+main_60:
+			cmp byte [drive],80h
+			jz main_70
+			call relocate
+main_70:			
+			; continue with MBR
+			mov dl,80h
+			jmp 0:disk_buf
+
+
+; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
+; Copy us to top of memory and install new int 13h interrupt handler.
+;
+relocate:
+			mov ax,[413h]		; mem size in kB
+			dec ax			; reserve 1k
+			mov [413h],ax
+			shl ax,6
+			sub ax,mbr_start &gt;&gt; 4
+			mov edx,[13h*4]
+			mov [old_int13],edx
+			push ax
+			push word new_int13
+			pop dword [13h*4]
+			push ax
+			pop es
+			mov si,mbr_start
+			mov di,si
+			mov cx,100h
+			rep movsw
+			ret
+
+
+; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
+; Swap drives 80h and [drive].
+;
+new_int13:
+			pushf
+
+			mov [cs:dl_old],dl
+			mov [cs:ah_old],ah
+
+			cmp dl,[cs:drive]
+			jnz new_int13_20
+			mov dl,80h
+			jmp new_int13_50
+new_int13_20:
+			cmp dl,80h
+			jnz new_int13_50
+			mov dl,[cs:drive]
+new_int13_50:
+			call far [cs:old_int13]
+			push ax
+			lahf
+			mov [esp+6],ah
+			pop ax
+
+			; ah = 8 changes dl; otherwise restore value
+			cmp byte [cs:ah_old],8
+			jz new_int13_90
+			mov dl,[cs:dl_old]
+new_int13_90:
+			iret
+
+
+; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
+; Read MBR and check id (id should _not_ match).
+;
+; return:
+;   CF:		0 ok; 1 not
+;
+check:
+			call disk_read
+			jc check_90
+			mov eax,[magic_id]
+			cmp eax,[disk_buf+id_ofs]
+			stc
+			jz check_90
+			clc
+check_90:
+			ret
+
+
+; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
+; Read MBR and verify boot signature.
+;
+; return:
+;   CF:		0 ok; 1 not
+;
+disk_read:
+			mov ax,201h
+			mov cx,1
+			mov dh,0
+			mov dl,[drive]
+			mov bx,disk_buf
+			int 13h
+			jc disk_read_90
+			; there should be proper boot code
+			cmp dword [disk_buf],0
+			stc
+			jz disk_read_90
+			cmp word [disk_buf+1feh],0aa55h
+			stc
+			jnz disk_read_90
+			clc
+disk_read_90:
+			ret
+
+
+; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
+; Write string and let user reboot.
+;
+;  si			text
+;
+; return:
+;
+final_msg:
+			call print
+			mov si,msg_next
+			call print
+			mov ah,0
+			int 16h
+			mov si,msg_nl
+			call print
+			int 19h
+
+final_msg_10:
+			hlt
+			jmp final_msg_10
+
+
+; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
+; Write string.
+;
+;  si			text
+;
+; return:
+;
+print:
+			lodsb
+			or al,al
+			jz print_90
+			mov bx,7
+			mov ah,14
+			int 10h
+			jmp print
+print_90:
+			ret
+
+
+; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
+old_int13		dd 0
+bios_drives		db 0
+drive			db 0
+dl_old			db 0
+ah_old			db 0
+
+msg_no_os		db &quot;No operating system.&quot;
+msg_nl			db 13, 10
+msg_no_msg		db 0
+msg_next		db 10, &quot;Press a key to reboot.&quot;, 0
+
+
+; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
+%if ($ - $$) &gt; id_ofs
+%error &quot;mbr too big&quot;
+%endif
+
+			times id_ofs - ($ - $$) db 0
+
+magic_id		dd 0
+
+			times 1feh - ($ - $$) db 0
+			dw 0aa55h
+


hooks/post-receive
-- 
Project kiwi at BerliOS

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002059.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. c75b921620abaf7c0124d71d7af5db4d78b66fd4
</A></li>
	<LI>Next message: <A HREF="002061.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-374-SuSE-11-1-SLE-SP-Devel,	updated. fbb6ff7733a4632f842e706c39fa6dc5cdd23b10
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2060">[ date ]</a>
              <a href="thread.html#2060">[ thread ]</a>
              <a href="subject.html#2060">[ subject ]</a>
              <a href="author.html#2060">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
