<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-443-SuSE-11-3-Devel,	updated. 4ed150201acbbb62f67c945ae809284523cb6071
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2010-August/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%0A%09KIWI-443-SuSE-11-3-Devel%2C%0A%09updated.%204ed150201acbbb62f67c945ae809284523cb6071&In-Reply-To=%3C20100818095156.9409F480F7D%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002557.html">
   <LINK REL="Next"  HREF="002559.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-443-SuSE-11-3-Devel,	updated. 4ed150201acbbb62f67c945ae809284523cb6071</H1>
    <B>marcus_schaefer at BerliOS</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%0A%09KIWI-443-SuSE-11-3-Devel%2C%0A%09updated.%204ed150201acbbb62f67c945ae809284523cb6071&In-Reply-To=%3C20100818095156.9409F480F7D%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-443-SuSE-11-3-Devel,	updated. 4ed150201acbbb62f67c945ae809284523cb6071">marcus_schaefer at mail.berlios.de
       </A><BR>
    <I>Wed Aug 18 11:51:55 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002557.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-374-SuSE-11-1-SLE-SP-Devel,	updated. ba918ebfc783f8ef4f5cef23597e82cbfb999ccf
</A></li>
        <LI>Next message: <A HREF="002559.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 49e1dfa536f8f2cac35f470d22ef55edeb377dba
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2558">[ date ]</a>
              <a href="thread.html#2558">[ thread ]</a>
              <a href="subject.html#2558">[ subject ]</a>
              <a href="author.html#2558">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Project kiwi at BerliOS&quot;.

The branch, KIWI-443-SuSE-11-3-Devel has been updated
       via  4ed150201acbbb62f67c945ae809284523cb6071 (commit)
       via  40f0af67d14555cc963fed048a5966a68980e95c (commit)
       via  3b0651f7d2653a46148a024292a8924aad294f60 (commit)
       via  1eb2fd87b9eb0646cb850b3cd0a47788c47fccff (commit)
       via  e89bd5a9f8324d6caff275412f66067bf2ebe450 (commit)
      from  2bafb6171a88b73d3f9c5976bb02f82fabb2afe6 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 4ed150201acbbb62f67c945ae809284523cb6071
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Wed Aug 18 11:49:02 2010 +0200

    - added changelog entry for the last four commits

commit 40f0af67d14555cc963fed048a5966a68980e95c
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Wed Aug 18 11:21:09 2010 +0200

    - fixed shell exception handling after the move mount of
      devices. In that cases the tty devices are in /mnt/dev and
      therefore any shell exception failed because the setctsid
      call can't find the device. This is now fixed (bnc #608620)

commit 3b0651f7d2653a46148a024292a8924aad294f60
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Wed Aug 18 11:06:47 2010 +0200

    - fixed netboot building by providing atftp for SLE11 (bnc #632203)

commit 1eb2fd87b9eb0646cb850b3cd0a47788c47fccff
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Tue Aug 17 15:36:24 2010 +0200

    - added support for selecting the default boot entry for a
      kiwi install image. The optional &lt;type&gt; attribute called
      installboot can take the values 'install' for standard
      installation, 'failsafe-install' for installation with
      failsafe kernel parameters and 'harddisk' which is the
      default anyway if no installboot attribute was
      given (bnc #624228)

commit e89bd5a9f8324d6caff275412f66067bf2ebe450
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Fri Aug 13 14:21:18 2010 +0200

    - deactivate the filesystem check for initial boot
      by resetting the mount counter. The function called
      resetMountCounter() handles this and also checks
      the filesystem type to be able to distinguish different
      filesystem tools for the operation (bnc #627021)

-----------------------------------------------------------------------

Summary of changes:
diff --git a/modules/KIWIBoot.pm b/modules/KIWIBoot.pm
index 7c96c6f..37266ba 100644
--- a/modules/KIWIBoot.pm
+++ b/modules/KIWIBoot.pm
@@ -3857,6 +3857,31 @@ sub setupBootLoaderConfiguration {
 	my $bloader  = &quot;grub&quot;;
 	my $title;
 	#==========================================
+	# setup boot loader default boot label/nr
+	#------------------------------------------
+	my $defaultBootLabel = $label;
+	my $defaultBootNr    = 0;
+	if ((($type =~ /^KIWI (CD|USB)/)) &amp;&amp; ($type{installboot})) {
+		# In install mode we have the following menu layout
+		# ----
+		# 0 -&gt; Boot from Hard Disk
+		# 1 -&gt; Install/Restore $label
+		# 2 -&gt; Failsafe -- Install/Restore $label
+		# ----
+		if ($type{installboot} eq &quot;install&quot;) {
+			$defaultBootLabel= makeLabel (
+				&quot;Install/Restore $label&quot;
+			);
+			$defaultBootNr = 1;
+		}
+		if ($type{installboot} eq &quot;failsafe-install&quot;) {
+			$defaultBootLabel= makeLabel (
+				&quot;Failsafe -- Install/Restore $label&quot;
+			);
+			$defaultBootNr = 2;
+		}
+	}
+	#==========================================
 	# setup boot loader type
 	#------------------------------------------
 	if ($type{bootloader}) {
@@ -3917,7 +3942,7 @@ sub setupBootLoaderConfiguration {
 		# General grub setup
 		#------------------------------------------
 		print FD &quot;color cyan/blue white/blue\n&quot;;
-		print FD &quot;default 0\n&quot;;
+		print FD &quot;default $defaultBootNr\n&quot;;
 		print FD &quot;timeout 10\n&quot;;
 		if ($type =~ /^KIWI (CD|USB)/) {
 			my $dev = $1 eq 'CD' ? '(cd)' : '(hd0,0)';
@@ -4097,7 +4122,7 @@ sub setupBootLoaderConfiguration {
 		#==========================================
 		# General syslinux setup
 		#------------------------------------------
-		print FD &quot;default  $label&quot;.&quot;\n&quot;;
+		print FD &quot;default  $defaultBootLabel&quot;.&quot;\n&quot;;
 		print FD &quot;implicit 1&quot;.&quot;\n&quot;;
 		print FD &quot;prompt   1&quot;.&quot;\n&quot;;
 		print FD &quot;timeout  200&quot;.&quot;\n&quot;;
diff --git a/modules/KIWIImage.pm b/modules/KIWIImage.pm
index 04ac74e..fe0aacd 100644
--- a/modules/KIWIImage.pm
+++ b/modules/KIWIImage.pm
@@ -979,6 +979,9 @@ sub createImageUSB {
 	if ($type{bootloader}) {
 		$main::ForeignRepo{&quot;bootloader&quot;} = $type{bootloader};
 	}
+	if ($type{installboot}) {
+		$main::ForeignRepo{&quot;installboot&quot;} = $type{installboot};
+	}
 	$main::ForeignRepo{&quot;xmlnode&quot;} = $xml -&gt; getForeignNodeList();
 	$main::ForeignRepo{&quot;xmlpacnode&quot;} = $xml -&gt; getForeignPackageNodeList();
 	$main::ForeignRepo{&quot;packagemanager&quot;} = $xml -&gt; getPackageManager();
@@ -2799,6 +2802,9 @@ sub createImageSplit {
 	if ($type{bootloader}) {
 		$main::ForeignRepo{&quot;bootloader&quot;} = $type{bootloader};
 	}
+	if ($type{installboot}) {
+		$main::ForeignRepo{&quot;installboot&quot;} = $type{installboot};
+	}
 	$main::ForeignRepo{&quot;xmlnode&quot;} = $xml -&gt; getForeignNodeList();
 	$main::ForeignRepo{&quot;xmlpacnode&quot;} = $xml -&gt; getForeignPackageNodeList();
 	$main::ForeignRepo{&quot;packagemanager&quot;} = $xml -&gt; getPackageManager();
diff --git a/modules/KIWILinuxRC.sh b/modules/KIWILinuxRC.sh
index 54e9378..c381705 100644
--- a/modules/KIWILinuxRC.sh
+++ b/modules/KIWILinuxRC.sh
@@ -238,6 +238,14 @@ function systemException {
 	# ----
 	set +x
 	local what=$2
+	local nuldev=/dev/null
+	local ttydev=$ELOG_EXCEPTION
+	if [ ! -e $nuldev ];then
+		nuldev=/mnt/$nuldev
+	fi
+	if [ ! -e $ttydev ];then
+		ttydev=/mnt/$ttydev
+	fi
 	test -e /proc/splash &amp;&amp; echo verbose &gt; /proc/splash
 	if [ $what = &quot;reboot&quot; ];then
 		if cat /proc/cmdline | grep -qi &quot;kiwidebug=1&quot;;then
@@ -249,7 +257,7 @@ function systemException {
 	&quot;reboot&quot;)
 		Echo &quot;rebootException: error consoles at Alt-F3/F4&quot;
 		Echo &quot;rebootException: reboot in 120 sec...&quot;; sleep 120
-		/sbin/reboot -f -i &gt;/dev/null
+		/sbin/reboot -f -i &gt;$nuldev
 	;;
 	&quot;wait&quot;)
 		Echo &quot;waitException: waiting for ever...&quot;
@@ -257,12 +265,12 @@ function systemException {
 	;;
 	&quot;shell&quot;)
 		Echo &quot;shellException: providing shell...&quot;
-		setctsid $ELOG_EXCEPTION /bin/bash -i || /bin/bash -i
+		setctsid $ttydev /bin/bash -i
 	;;
 	&quot;user_reboot&quot;)
 		Echo &quot;reboot triggered by user: consoles at Alt-F3/F4&quot;
 		Echo &quot;reboot in 30 sec...&quot;; sleep 30
-		/sbin/reboot -f -i &gt;/dev/null
+		/sbin/reboot -f -i &gt;$nuldev
 	;;
 	*)
 		Echo &quot;unknownException...&quot;
@@ -4037,9 +4045,16 @@ function mountSystem {
 		mountSystemStandard &quot;$mountDevice&quot;
 		retval=$?
 	fi
+	#======================================
+	# setup boot partition
+	#--------------------------------------
 	if [ $retval = 0 ] &amp;&amp; [ -z &quot;$RESTORE&quot; ];then
 		setupBootPartition
 	fi
+	#======================================
+	# reset mount counter
+	#--------------------------------------
+	resetMountCounter
 	IFS=$OLDIFS
 	return $retval
 }
@@ -5633,6 +5648,34 @@ function resizeFilesystem {
 	fi
 }
 #======================================
+# resetMountCounter
+#--------------------------------------
+function resetMountCounter {
+	local curtype=$FSTYPE
+	local command
+	for device in \
+		$imageRootDevice $imageBootDevice \
+		$imageRecoveryDevice $imageHomeDevice
+	do
+		if [ ! -e $device ];then
+			continue
+		fi
+		probeFileSystem $device
+		if [ &quot;$FSTYPE&quot; = &quot;ext2&quot; ];then
+			command=&quot;tune2fs -c -1 -i 0&quot;
+		elif [ &quot;$FSTYPE&quot; = &quot;ext3&quot; ];then
+			command=&quot;tune2fs -c -1 -i 0&quot;
+		elif [ &quot;$FSTYPE&quot; = &quot;ext4&quot; ];then
+			command=&quot;tune2fs -c -1 -i 0&quot;
+		else
+			# nothing to do here...
+			continue
+		fi
+		eval $command $device 1&gt;&amp;2
+	done
+	FSTYPE=$curtype
+}
+#======================================
 # createFilesystem
 #--------------------------------------
 function createFilesystem {
diff --git a/modules/KIWISchema.rnc b/modules/KIWISchema.rnc
index 849545a..a0989aa 100644
--- a/modules/KIWISchema.rnc
+++ b/modules/KIWISchema.rnc
@@ -1329,6 +1329,13 @@ div {
 		attribute bootloader {
 			&quot;extlinux&quot; | &quot;grub&quot; | &quot;syslinux&quot; | &quot;zipl&quot;
 		}
+	k.type.installboot.attribute =
+		## Specifies the bootloader default boot entry for the&quot;
+		## initial boot of a kiwi install image. This value is&quot;
+		## evaluated for grub and ext|syslinux but not for zipl&quot;
+		attribute installboot {
+			&quot;failsafe-install&quot; | &quot;harddisk&quot; | &quot;install&quot;
+		}
 	k.type.compressed.attribute =
 		## Specifies whether the image output file should be
 		## compressed or not. This makes only sense for filesystem
@@ -1403,6 +1410,7 @@ div {
 		k.type.hybrid.attribute? &amp;
 		k.type.hybridpersistent.attribute? &amp;
 		k.type.bootloader.attribute? &amp;
+		k.type.installboot.attribute? &amp;
 		k.type.compressed.attribute? &amp;
 		k.type.vga.attribute? &amp;
 		k.type.luks.attribute? &amp;
diff --git a/modules/KIWISchema.rng b/modules/KIWISchema.rng
index 2ec7d7f..51e8373 100644
--- a/modules/KIWISchema.rng
+++ b/modules/KIWISchema.rng
@@ -1836,6 +1836,18 @@ At the moment grub, zipl and sys|extlinux are supported&lt;/a:documentation&gt;
         &lt;/choice&gt;
       &lt;/attribute&gt;
     &lt;/define&gt;
+    &lt;define name=&quot;k.type.installboot.attribute&quot;&gt;
+      &lt;attribute name=&quot;installboot&quot;&gt;
+        &lt;a:documentation&gt;Specifies the bootloader default boot entry for the&quot;
+initial boot of a kiwi install image. This value is&quot;
+evaluated for grub and ext|syslinux but not for zipl&quot;&lt;/a:documentation&gt;
+        &lt;choice&gt;
+          &lt;value&gt;failsafe-install&lt;/value&gt;
+          &lt;value&gt;harddisk&lt;/value&gt;
+          &lt;value&gt;install&lt;/value&gt;
+        &lt;/choice&gt;
+      &lt;/attribute&gt;
+    &lt;/define&gt;
     &lt;define name=&quot;k.type.compressed.attribute&quot;&gt;
       &lt;attribute name=&quot;compressed&quot;&gt;
         &lt;a:documentation&gt;Specifies whether the image output file should be
@@ -1997,6 +2009,9 @@ file for write operations&lt;/a:documentation&gt;
           &lt;ref name=&quot;k.type.bootloader.attribute&quot;/&gt;
         &lt;/optional&gt;
         &lt;optional&gt;
+          &lt;ref name=&quot;k.type.installboot.attribute&quot;/&gt;
+        &lt;/optional&gt;
+        &lt;optional&gt;
           &lt;ref name=&quot;k.type.compressed.attribute&quot;/&gt;
         &lt;/optional&gt;
         &lt;optional&gt;
diff --git a/modules/KIWIXML.pm b/modules/KIWIXML.pm
index f14e19e..18a6153 100644
--- a/modules/KIWIXML.pm
+++ b/modules/KIWIXML.pm
@@ -434,6 +434,11 @@ sub new {
 				&quot;bootloader&quot;,$foreignRepo-&gt;{&quot;bootloader&quot;}
 			);
 		}
+		if (defined $foreignRepo-&gt;{&quot;installboot&quot;}) {
+			$this -&gt; setForeignTypeAttribute (
+				&quot;installboot&quot;,$foreignRepo-&gt;{&quot;installboot&quot;}
+			);
+		}
 		#==========================================
 		# foreign image attributes
 		#------------------------------------------
@@ -812,6 +817,7 @@ sub getImageTypeAndAttributes {
 		$record{installstick}  = $node -&gt; getAttribute(&quot;installstick&quot;);
 		$record{vga}           = $node -&gt; getAttribute(&quot;vga&quot;);
 		$record{bootloader}    = $node -&gt; getAttribute(&quot;bootloader&quot;);
+		$record{installboot}   = $node -&gt; getAttribute(&quot;installboot&quot;);
 		$record{checkprebuilt} = $node -&gt; getAttribute(&quot;checkprebuilt&quot;);
 		$record{baseroot}      = $node -&gt; getAttribute(&quot;baseroot&quot;);
 		$record{bootprofile}   = $node -&gt; getAttribute(&quot;bootprofile&quot;);
@@ -2497,6 +2503,9 @@ sub getImageConfig {
 	if ((%type) &amp;&amp; ($type{bootloader})) {
 		$result{kiwi_bootloader} = $type{bootloader};
 	}
+	if ((%type) &amp;&amp; ($type{installboot})) {
+		$result{kiwi_installboot} = $type{installboot};
+	}
 	if ((%type) &amp;&amp; ($type{luks})) {
 		$result{kiwi_luks} = &quot;yes&quot;;
 	}
diff --git a/rpm/kiwi.changes b/rpm/kiwi.changes
index ce4f3ed..0fd0e8e 100644
--- a/rpm/kiwi.changes
+++ b/rpm/kiwi.changes
@@ -1,4 +1,25 @@
 -------------------------------------------------------------------
+Wed Aug 18 11:47:49 CEST 2010 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
+
+- fixed shell exception handling after the move mount of
+  devices. In that cases the tty devices are in /mnt/dev and
+  therefore any shell exception failed because the setctsid
+  call can't find the device. This is now fixed (bnc #608620)
+- fixed netboot building by providing atftp for SLE11 (bnc #632203)
+- added support for selecting the default boot entry for a
+  kiwi install image. The optional &lt;type&gt; attribute called
+  installboot can take the values 'install' for standard
+  installation, 'failsafe-install' for installation with
+  failsafe kernel parameters and 'harddisk' which is the
+  default anyway if no installboot attribute was
+  given (bnc #624228)
+- deactivate the filesystem check for initial boot
+  by resetting the mount counter. The function called
+  resetMountCounter() handles this and also checks
+  the filesystem type to be able to distinguish different
+  filesystem tools for the operation (bnc #627021)
+
+-------------------------------------------------------------------
 Wed Aug  4 15:08:15 CEST 2010 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
 
 - don't check the return value of the e2fsck call. If the
diff --git a/system/boot/ix86/netboot/suse-SLED11/config.xml b/system/boot/ix86/netboot/suse-SLED11/config.xml
index 86745f6..9ca219d 100644
--- a/system/boot/ix86/netboot/suse-SLED11/config.xml
+++ b/system/boot/ix86/netboot/suse-SLED11/config.xml
@@ -149,6 +149,7 @@
 		&lt;package name=&quot;psmisc&quot;/&gt;
 		&lt;package name=&quot;iputils&quot;/&gt;
 		&lt;package name=&quot;busybox&quot;/&gt;
+		&lt;package name=&quot;atftp&quot;/&gt;
 		&lt;package name=&quot;bind-libs&quot;/&gt;
 		&lt;package name=&quot;bind-utils&quot;/&gt;
 		&lt;package name=&quot;dhcpcd&quot;/&gt;
@@ -175,6 +176,7 @@
 	&lt;packages type=&quot;image&quot; profiles=&quot;diskless&quot;&gt;
 		&lt;package name=&quot;iputils&quot;/&gt;
 		&lt;package name=&quot;busybox&quot;/&gt;
+		&lt;package name=&quot;atftp&quot;/&gt;
 		&lt;package name=&quot;dhcpcd&quot;/&gt;
 		&lt;package name=&quot;file&quot;/&gt;
 		&lt;package name=&quot;hwinfo&quot;/&gt;
diff --git a/system/repo/ix86/suse-repo/suse-sle11-repo/atftp-0.7.0-135.6.i586.rpm b/system/repo/ix86/suse-repo/suse-sle11-repo/atftp-0.7.0-135.6.i586.rpm
new file mode 100644
index 0000000..8ffc924
Binary files /dev/null and b/system/repo/ix86/suse-repo/suse-sle11-repo/atftp-0.7.0-135.6.i586.rpm differ
diff --git a/system/repo/ix86/suse-repo/suse-sle11-repo/atftp-0.7.0-135.6.x86_64.rpm b/system/repo/ix86/suse-repo/suse-sle11-repo/atftp-0.7.0-135.6.x86_64.rpm
new file mode 100644
index 0000000..25437f7
Binary files /dev/null and b/system/repo/ix86/suse-repo/suse-sle11-repo/atftp-0.7.0-135.6.x86_64.rpm differ


hooks/post-receive
-- 
Project kiwi at BerliOS

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002557.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-374-SuSE-11-1-SLE-SP-Devel,	updated. ba918ebfc783f8ef4f5cef23597e82cbfb999ccf
</A></li>
	<LI>Next message: <A HREF="002559.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 49e1dfa536f8f2cac35f470d22ef55edeb377dba
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2558">[ date ]</a>
              <a href="thread.html#2558">[ thread ]</a>
              <a href="subject.html#2558">[ subject ]</a>
              <a href="author.html#2558">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
