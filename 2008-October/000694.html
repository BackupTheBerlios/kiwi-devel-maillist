<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] r1595 - in kiwi-head: . modules rpm	system/boot/ix86/isoboot system/boot/ix86/isoboot/suse-10.1/root	system/boot/ix86/isoboot/suse-10.2/root	system/boot/ix86/isoboot/suse-10.3/root	system/boot/ix86/isoboot/suse-11.0/root	system/boot/ix86/isoboot/suse-11.1/root	system/boot/ix86/isoboot/suse-SLED10/root	system/boot/ix86/isoboot/suse-SLES10/root
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20r1595%20-%20in%20kiwi-head%3A%20.%20modules%20rpm%0A%09system/boot/ix86/isoboot%20system/boot/ix86/isoboot/suse-10.1/root%0A%09system/boot/ix86/isoboot/suse-10.2/root%0A%09system/boot/ix86/isoboot/suse-10.3/root%0A%09system/boot/ix86/isoboot/suse-11.0/root%0A%09system/boot/ix86/isoboot/suse-11.1/root%0A%09system/boot/ix86/isoboot/suse-SLED10/root%0A%09system/boot/ix86/isoboot/suse-SLES10/root&In-Reply-To=%3C200810011241.m91CfqjM014708%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000693.html">
   <LINK REL="Next"  HREF="000695.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] r1595 - in kiwi-head: . modules rpm	system/boot/ix86/isoboot system/boot/ix86/isoboot/suse-10.1/root	system/boot/ix86/isoboot/suse-10.2/root	system/boot/ix86/isoboot/suse-10.3/root	system/boot/ix86/isoboot/suse-11.0/root	system/boot/ix86/isoboot/suse-11.1/root	system/boot/ix86/isoboot/suse-SLED10/root	system/boot/ix86/isoboot/suse-SLES10/root</H1>
    <B>marcus_schaefer at mail.berlios.de</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20r1595%20-%20in%20kiwi-head%3A%20.%20modules%20rpm%0A%09system/boot/ix86/isoboot%20system/boot/ix86/isoboot/suse-10.1/root%0A%09system/boot/ix86/isoboot/suse-10.2/root%0A%09system/boot/ix86/isoboot/suse-10.3/root%0A%09system/boot/ix86/isoboot/suse-11.0/root%0A%09system/boot/ix86/isoboot/suse-11.1/root%0A%09system/boot/ix86/isoboot/suse-SLED10/root%0A%09system/boot/ix86/isoboot/suse-SLES10/root&In-Reply-To=%3C200810011241.m91CfqjM014708%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] r1595 - in kiwi-head: . modules rpm	system/boot/ix86/isoboot system/boot/ix86/isoboot/suse-10.1/root	system/boot/ix86/isoboot/suse-10.2/root	system/boot/ix86/isoboot/suse-10.3/root	system/boot/ix86/isoboot/suse-11.0/root	system/boot/ix86/isoboot/suse-11.1/root	system/boot/ix86/isoboot/suse-SLED10/root	system/boot/ix86/isoboot/suse-SLES10/root">marcus_schaefer at mail.berlios.de
       </A><BR>
    <I>Wed Oct  1 14:41:52 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000693.html">[Kiwi-devel] r1594 - kiwi-head/modules
</A></li>
        <LI>Next message: <A HREF="000695.html">[Kiwi-devel] r1596 - in kiwi-head: modules rpm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#694">[ date ]</a>
              <a href="thread.html#694">[ thread ]</a>
              <a href="subject.html#694">[ subject ]</a>
              <a href="author.html#694">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: marcus_schaefer
Date: 2008-10-01 14:41:44 +0200 (Wed, 01 Oct 2008)
New Revision: 1595

Added:
   kiwi-head/modules/KIWIIsoLinux.pm
Removed:
   kiwi-head/system/boot/ix86/isoboot/suse-10.1/root/isolinux
   kiwi-head/system/boot/ix86/isoboot/suse-10.2/root/isolinux
   kiwi-head/system/boot/ix86/isoboot/suse-10.3/root/isolinux
   kiwi-head/system/boot/ix86/isoboot/suse-11.0/root/isolinux
   kiwi-head/system/boot/ix86/isoboot/suse-11.1/root/isolinux
   kiwi-head/system/boot/ix86/isoboot/suse-SLED10/root/isolinux
   kiwi-head/system/boot/ix86/isoboot/suse-SLES10/root/isolinux
   kiwi-head/system/boot/ix86/isoboot/suse-isolinux
Modified:
   kiwi-head/kiwi.pl
   kiwi-head/modules/KIWIImage.pm
   kiwi-head/rpm/kiwi.changes
Log:

- moved suse-isolinux (m_cd) code into KIWIIsoLinux.pm
  perl based module.



Modified: kiwi-head/kiwi.pl
===================================================================
--- kiwi-head/kiwi.pl	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/kiwi.pl	2008-10-01 12:41:44 UTC (rev 1595)
@@ -44,6 +44,8 @@
 # Globals (Version)
 #--------------------------------------------
 our $Version       = &quot;2.83&quot;;
+our $Publisher     = &quot;SUSE LINUX Products GmbH&quot;;
+our $Preparer      = &quot;KIWI - <A HREF="http://kiwi.berlios.de">http://kiwi.berlios.de</A>&quot;;
 our $openSUSE      = &quot;<A HREF="http://download.opensuse.org/repositories/">http://download.opensuse.org/repositories/</A>&quot;;
 our $ConfigFile    = &quot;$ENV{'HOME'}/.kiwirc&quot;;
 our $ConfigName    = &quot;config.xml&quot;;

Modified: kiwi-head/modules/KIWIImage.pm
===================================================================
--- kiwi-head/modules/KIWIImage.pm	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/modules/KIWIImage.pm	2008-10-01 12:41:44 UTC (rev 1595)
@@ -22,6 +22,7 @@
 use strict;
 use KIWILog;
 use KIWIBoot;
+use KIWIIsoLinux;
 use Math::BigFloat;
 use File::Basename;
 use File::Find qw(find);
@@ -1708,22 +1709,36 @@
 	#==========================================
 	# create ISO image
 	#------------------------------------------
-	$kiwi -&gt; info (&quot;Calling mkisofs...&quot;);
+	$kiwi -&gt; info (&quot;Calling mkisofs...\n&quot;);
+	my $isoerror = 1;
 	my $name = $imageDest.&quot;/&quot;.$namerw.&quot;.iso&quot;;
-	$kiwi -&gt; loginfo (&quot;Calling: $CD/isolinux $main::RootTree/CD $name&quot;);
-	$data = qxx (&quot;$CD/isolinux $main::RootTree/CD $name 2&gt;&amp;1&quot;);
-	$code = $? &gt;&gt; 8;
-	if ($code != 0) {
-		$kiwi -&gt; failed ();
-		$kiwi -&gt; error  (&quot;Failed to create ISO image: $data&quot;);
-		$kiwi -&gt; failed ();
+	my $isolinux = new KIWIIsoLinux (
+		$kiwi,$main::RootTree.&quot;/CD&quot;,$name,
+		$main::Publisher,$main::Preparer,
+		&quot;-R -J -pad -joliet-long&quot;
+	);
+	if (defined $isolinux) {
+		$isoerror = 0;
+		if (! $isolinux -&gt; createSortFile()) {
+			$isoerror = 1;
+		}
+		if (! $isolinux -&gt; createISOLinuxConfig()) {
+			$isoerror = 1;
+		}
+		if (! $isolinux -&gt; createISO()) {
+			$isoerror = 1;
+		}
+	}
+	if ($isoerror) {
 		if (! -d $main::RootTree.$baseSystem) {
 			qxx (&quot;rm -rf $main::RootTree&quot;);
 			qxx (&quot;rm -rf $tmpdir&quot;);
 		}
 		return undef;
 	}
-	$kiwi -&gt; done();
+	#==========================================
+	# relocate boot catalog
+	#------------------------------------------
 	if (! relocateCatalog ($this,$name)) {
 		if (! -d $main::RootTree.$baseSystem) {
 			qxx (&quot;rm -rf $main::RootTree&quot;);

Added: kiwi-head/modules/KIWIIsoLinux.pm
===================================================================
--- kiwi-head/modules/KIWIIsoLinux.pm	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/modules/KIWIIsoLinux.pm	2008-10-01 12:41:44 UTC (rev 1595)
@@ -0,0 +1,262 @@
+#================
+# FILE          : KIWIIsoLinux.pm
+#----------------
+# PROJECT       : OpenSUSE Build-Service
+# COPYRIGHT     : (c) 2006 SUSE LINUX Products GmbH, Germany
+#               :
+# AUTHOR        : Marcus Schaefer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>&gt;
+#               :
+# BELONGS TO    : Operating System images
+#               :
+# DESCRIPTION   : This module is used to create an ISO
+#               : filesystem based on mkisofs
+#               : 
+#               :
+# STATUS        : Development
+#----------------
+package KIWIIsoLinux;
+#==========================================
+# Modules
+#------------------------------------------
+use strict;
+use File::Find;
+use KIWILog;
+use KIWIQX;
+
+#==========================================
+# Constructor
+#------------------------------------------
+sub new {
+	# ...
+	# Create a new KIWIIsoLinux object which is used to wrap
+	# around the major mkisofs call
+	# ---
+	#==========================================
+	# Object setup
+	#------------------------------------------
+	my $this  = {};
+	my $class = shift;
+	bless $this,$class;
+	#==========================================
+	# Module Parameters
+	#------------------------------------------
+	my $kiwi         = shift;
+	my $source       = shift;  # location of source tree
+	my $dest         = shift;  # destination for the iso file
+	my $publisher    = shift;  # publisher string
+	my $preparer     = shift;  # preparer string
+	my $params       = shift;  # mkisofs parameters
+	#==========================================
+	# Constructor setup
+	#------------------------------------------
+	my $bootbase     = &quot;boot&quot;;
+	my $bootbaseZ    = &quot;&quot;;
+	my $bootimage    = &quot;&quot;;
+	my $bootisolinux = &quot;&quot;;
+	#==========================================
+	# create log object if not done
+	#------------------------------------------
+	if (! defined $kiwi) {
+		$kiwi = new KIWILog(&quot;tiny&quot;);
+	}
+	if (! defined $source) {
+		return undef;
+	}
+	if (! defined $dest) {
+		return undef;
+	}
+	if (! defined $preparer) {
+		$preparer = 'KIWI-Team - <A HREF="http://kiwi.berlios.de">http://kiwi.berlios.de</A>';
+	}
+	if (! defined $publisher) {
+		$publisher = 'SUSE LINUX Products GmbH, <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">suse at novell.com</A>'
+	}
+	if (! defined $params) {
+		$params = '-R -J -pad -joliet-long';
+	}
+	#=======================================
+	# check /boot/&lt;arch&gt;/loader layout
+	#---------------------------------------
+	if (-d &quot;$source/$bootbase/s390x&quot;) {
+		$bootbaseZ = $bootbase.&quot;/s390x&quot;;
+		$bootbase  = $bootbase.&quot;/i386&quot;;
+	} elsif (-d &quot;$source/$bootbase/s390&quot;) {
+		$bootbaseZ = $bootbase.&quot;/s390&quot;;
+		$bootbase  = $bootbase.&quot;/i386&quot;;
+	} elsif (-d &quot;$source/$bootbase/i386&quot;) {
+		$bootbase  = $bootbase.&quot;/i386&quot;;
+	} elsif (-d &quot;$source/$bootbase/x86_64&quot;) {
+		$bootbase  = $bootbase.&quot;/x86_64&quot;;
+	} elsif (-d &quot;$source/$bootbase/ia64&quot;) {
+		$bootbase  = $bootbase.&quot;/ia64&quot;;
+	} else {
+		return undef;
+	}
+	$bootimage    = $bootbase.&quot;/image&quot;;
+	$bootisolinux = $bootbase.&quot;/loader&quot;;
+	#==========================================
+	# Store object data
+	#------------------------------------------
+	$this -&gt; {kiwi}         = $kiwi;
+	$this -&gt; {source}       = $source;
+	$this -&gt; {dest}         = $dest;
+	$this -&gt; {params}       = $params;
+	$this -&gt; {publisher}    = $publisher;
+	$this -&gt; {preparer}     = $preparer;
+	$this -&gt; {rootoncd}     = &quot;suse&quot;;
+	$this -&gt; {bootbase}     = $bootbase;
+	$this -&gt; {bootimage}    = $bootimage;
+	$this -&gt; {bootisolinux} = $bootisolinux;
+	return $this;
+}
+
+#==========================================
+# createSortFile 
+#------------------------------------------
+sub createSortFile {
+	my $this = shift;
+	my $kiwi = $this-&gt;{kiwi};
+	my $boot = $this-&gt;{bootisolinux};
+	my $base = $this-&gt;{bootbase};
+	my $src  = $this-&gt;{source};
+	my $para = $this-&gt;{params};
+	my $code;
+	#==========================================
+	# check boot directory 
+	#------------------------------------------
+	if (! -d &quot;$src/$boot&quot;) {
+		$kiwi -&gt; error (&quot;Directory $src/$boot doesn't exist&quot;);
+		$kiwi -&gt; failed ();
+		return undef;
+	}
+	#==========================================
+	# create tmp files/directories 
+	#------------------------------------------
+	my $sort = qxx (&quot;mktemp /tmp/m_cd-XXXXXX 2&gt;&amp;1&quot;); chomp $sort;
+	$code = $? &gt;&gt; 8;
+	if ($code != 0) {
+		$kiwi -&gt; error  (&quot;Couldn't create sort file: $sort: $!&quot;);
+		$kiwi -&gt; failed ();
+		$this -&gt; cleanISO();
+		return undef;
+	}
+	my $sdir = qxx (&quot;mktemp -q -d /tmp/m_cd-XXXXXX 2&gt;&amp;1&quot;); chomp $sdir;
+	$code = $? &gt;&gt; 8;
+	if ($code != 0) {
+		$kiwi -&gt; error  (&quot;Couldn't create tmp directory: $sdir: $!&quot;);
+		$kiwi -&gt; failed ();
+		$this -&gt; cleanISO();
+		return undef;
+	}
+	#==========================================
+	# store tmp files/directories 
+	#------------------------------------------
+	$this -&gt; {sortfile} = $sort;
+	$this -&gt; {srcxdir}  = $sdir;
+	#==========================================
+	# create sort file 
+	#------------------------------------------
+	sub generateWanted {
+		my $filelist = shift;
+		return sub {
+			push (@{$filelist},$File::Find::name);
+		}
+	}
+	if (! open FD, &quot;&gt;$sort&quot;) {
+		$kiwi -&gt; error  (&quot;Failed to open sort file: $!&quot;);
+		$kiwi -&gt; failed ();
+		$this -&gt; cleanISO();
+		return undef;
+	}
+	my @list = ();
+	my $wref = generateWanted (\@list);
+	find ({wanted =&gt; $wref, follow =&gt; 0 }, &quot;$src/$boot&quot;);
+	print FD &quot;$sdir/$base/boot.catalog 3&quot;.&quot;\n&quot;;
+	print FD &quot;$base/boot.catalog 3&quot;.&quot;\n&quot;;
+	print FD &quot;$src/$base/boot.catalog 3&quot;.&quot;\n&quot;;
+	foreach my $file (@list) {
+		print FD &quot;$file 1&quot;.&quot;\n&quot;;
+	}
+	print FD &quot;$src/$boot/isolinux.bin 2&quot;.&quot;\n&quot;;
+	close FD;
+	qxx (&quot;mkdir -p $sdir/$boot&quot;);
+	#==========================================
+	# setup mkisofs parameters for boot iso 
+	#------------------------------------------
+	$para.= &quot; -sort $sort -no-emul-boot -boot-load-size 4 -boot-info-table&quot;;
+	$para.= &quot; -b $boot/isolinux.bin -c $base/boot.catalog&quot;;
+	$para.= &quot; -hide $base/boot.catalog -hide-joliet $base/boot.catalog&quot;;
+	$this -&gt; {params} = $para;
+	return $this;
+}
+
+#==========================================
+# createISOLinuxConfig 
+#------------------------------------------
+sub createISOLinuxConfig {
+	my $this = shift;
+	my $kiwi = $this -&gt; {kiwi};
+	my $boot = $this -&gt; {bootisolinux};
+	my $src  = $this -&gt; {source};
+	my $isox = &quot;/usr/bin/isolinux-config&quot;;
+	if (! -x $isox) {
+		$kiwi -&gt; error  (&quot;Can't find isolinux-config binary&quot;);
+		$kiwi -&gt; failed ();
+		$this -&gt; cleanISO();
+		return undef;
+	}
+	my $data = qxx (&quot;$isox --base $boot $src/$boot/isolinux.bin 2&gt;&amp;1&quot;);
+	my $code = $? &gt;&gt; 8;
+	if ($code != 0) {
+		$kiwi -&gt; error  (&quot;Failed to call isolinux-config binary: $data&quot;);
+		$kiwi -&gt; failed ();
+		$this -&gt; cleanISO();
+		return undef;
+	}
+	return $this;
+}
+
+#==========================================
+# createISO
+#------------------------------------------
+sub createISO {
+	my $this = shift;
+	my $kiwi = $this -&gt; {kiwi};
+	my $src  = $this -&gt; {source};
+	my $dest = $this -&gt; {dest};
+	my $para = $this -&gt; {params};
+	my $pub  = $this -&gt; {publisher};
+	my $prep = $this -&gt; {preparer};
+	my $srcx = $this -&gt; {srcxdir};
+	my $prog = &quot;/usr/bin/mkisofs&quot;;
+	my $data = qxx (
+		&quot;$prog -p \&quot;$prep\&quot; -publisher \&quot;$pub\&quot; $para -o $dest $srcx $src 2&gt;&amp;1&quot;
+	);
+	my $code = $? &gt;&gt; 8;
+	if ($code != 0) {
+		$kiwi -&gt; error  (&quot;Failed to call mkisofs binary: $data&quot;);
+		$kiwi -&gt; failed ();
+		$this -&gt; cleanISO();
+		return undef;
+	}
+	$this -&gt; cleanISO();
+	return $this;
+}
+
+#==========================================
+# cleanISO
+#------------------------------------------
+sub cleanISO {
+	my $this = shift;
+	my $sort = $this -&gt; {sortfile};
+	my $srcx = $this -&gt; {srcxdir};
+	if (-f $sort) {
+		qxx (&quot;rm -f $sort 2&gt;&amp;1&quot;);
+	}
+	if (-d $srcx) {
+		qxx (&quot;rm -rf $srcx 2&gt;&amp;1&quot;);
+	}
+	return $this;
+}
+
+1;

Modified: kiwi-head/rpm/kiwi.changes
===================================================================
--- kiwi-head/rpm/kiwi.changes	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/rpm/kiwi.changes	2008-10-01 12:41:44 UTC (rev 1595)
@@ -8,6 +8,8 @@
   a full qualified path name according to the Xen docs
 - fixed xenboot arch setup for kernel package
 - fixed product parsing
+- moved suse-isolinux (m_cd) code into KIWIIsoLinux.pm
+  perl based module.
 
 -------------------------------------------------------------------
 Thu Sep 25 12:39:08 CEST 2008 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>

Deleted: kiwi-head/system/boot/ix86/isoboot/suse-10.1/root/isolinux
===================================================================
--- kiwi-head/system/boot/ix86/isoboot/suse-10.1/root/isolinux	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/system/boot/ix86/isoboot/suse-10.1/root/isolinux	2008-10-01 12:41:44 UTC (rev 1595)
@@ -1 +0,0 @@
-link ../../suse-isolinux
\ No newline at end of file

Deleted: kiwi-head/system/boot/ix86/isoboot/suse-10.2/root/isolinux
===================================================================
--- kiwi-head/system/boot/ix86/isoboot/suse-10.2/root/isolinux	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/system/boot/ix86/isoboot/suse-10.2/root/isolinux	2008-10-01 12:41:44 UTC (rev 1595)
@@ -1 +0,0 @@
-link ../../suse-isolinux
\ No newline at end of file

Deleted: kiwi-head/system/boot/ix86/isoboot/suse-10.3/root/isolinux
===================================================================
--- kiwi-head/system/boot/ix86/isoboot/suse-10.3/root/isolinux	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/system/boot/ix86/isoboot/suse-10.3/root/isolinux	2008-10-01 12:41:44 UTC (rev 1595)
@@ -1 +0,0 @@
-link ../../suse-isolinux
\ No newline at end of file

Deleted: kiwi-head/system/boot/ix86/isoboot/suse-11.0/root/isolinux
===================================================================
--- kiwi-head/system/boot/ix86/isoboot/suse-11.0/root/isolinux	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/system/boot/ix86/isoboot/suse-11.0/root/isolinux	2008-10-01 12:41:44 UTC (rev 1595)
@@ -1 +0,0 @@
-link ../../suse-isolinux
\ No newline at end of file

Deleted: kiwi-head/system/boot/ix86/isoboot/suse-11.1/root/isolinux
===================================================================
--- kiwi-head/system/boot/ix86/isoboot/suse-11.1/root/isolinux	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/system/boot/ix86/isoboot/suse-11.1/root/isolinux	2008-10-01 12:41:44 UTC (rev 1595)
@@ -1 +0,0 @@
-link ../../suse-isolinux
\ No newline at end of file

Deleted: kiwi-head/system/boot/ix86/isoboot/suse-SLED10/root/isolinux
===================================================================
--- kiwi-head/system/boot/ix86/isoboot/suse-SLED10/root/isolinux	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/system/boot/ix86/isoboot/suse-SLED10/root/isolinux	2008-10-01 12:41:44 UTC (rev 1595)
@@ -1 +0,0 @@
-link ../../suse-isolinux
\ No newline at end of file

Deleted: kiwi-head/system/boot/ix86/isoboot/suse-SLES10/root/isolinux
===================================================================
--- kiwi-head/system/boot/ix86/isoboot/suse-SLES10/root/isolinux	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/system/boot/ix86/isoboot/suse-SLES10/root/isolinux	2008-10-01 12:41:44 UTC (rev 1595)
@@ -1 +0,0 @@
-link ../../suse-isolinux
\ No newline at end of file

Deleted: kiwi-head/system/boot/ix86/isoboot/suse-isolinux
===================================================================
--- kiwi-head/system/boot/ix86/isoboot/suse-isolinux	2008-10-01 10:20:20 UTC (rev 1594)
+++ kiwi-head/system/boot/ix86/isoboot/suse-isolinux	2008-10-01 12:41:44 UTC (rev 1595)
@@ -1,226 +0,0 @@
-#!/bin/bash
-
-#=======================================
-# Globals
-#---------------------------------------
-CD_PREPARER=&quot;KIWI-Team - <A HREF="http://kiwi.berlios.de">http://kiwi.berlios.de</A>&quot;
-CD_PUBLISHER=&quot;SUSE LINUX Products GmbH, <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">suse at suse.de</A>&quot;
-
-#=======================================
-# Globals
-#---------------------------------------
-PARAMS=&quot;-R -J -pad -joliet-long&quot;
-SORTFILE=`mktemp /var/tmp/m_cd-XXXXXX`
-SOURCE2=`mktemp -d /var/tmp/m_cd-XXXXXX`
-ROOT_ON_CD=suse
-BOOT_BASE_DIR=boot
-BOOT_IMAGE=$BOOT_BASE_DIR/image
-BOOT_ISOLINUX=$BOOT_BASE_DIR/loader
-
-#=======================================
-# Parameters
-#---------------------------------------
-SOURCE=$1  # source tree
-DEST=$2    # output file
-
-#=======================================
-# check /boot/&lt;arch&gt;/loader layout
-#---------------------------------------
-if [ -d $SOURCE/$BOOT_BASE_DIR/s390x ] ; then
-	BOOT_BASE_DIR_Z=$BOOT_BASE_DIR/s390x
-	BOOT_BASE_DIR=$BOOT_BASE_DIR/i386
-	BOOT_IMAGE=$BOOT_BASE_DIR/image
-	BOOT_ISOLINUX=$BOOT_BASE_DIR/loader
-elif [ -d $SOURCE/$BOOT_BASE_DIR/s390 ] ; then
-	BOOT_BASE_DIR_Z=$BOOT_BASE_DIR/s390
-	BOOT_BASE_DIR=$BOOT_BASE_DIR/i386
-	BOOT_IMAGE=$BOOT_BASE_DIR/image
-	BOOT_ISOLINUX=$BOOT_BASE_DIR/loader
-elif [ -d $SOURCE/$BOOT_BASE_DIR/i386 ] ; then
-	BOOT_BASE_DIR=$BOOT_BASE_DIR/i386
-	BOOT_IMAGE=$BOOT_BASE_DIR/image
-	BOOT_ISOLINUX=$BOOT_BASE_DIR/loader
-elif [ -d $SOURCE/$BOOT_BASE_DIR/x86_64 ] ; then
-	BOOT_BASE_DIR=$BOOT_BASE_DIR/x86_64
-	BOOT_IMAGE=$BOOT_BASE_DIR/image
-	BOOT_ISOLINUX=$BOOT_BASE_DIR/loader
-elif [ -d $SOURCE/$BOOT_BASE_DIR/ia64 ] ; then
-	BOOT_BASE_DIR=$BOOT_BASE_DIR/ia64
-	BOOT_IMAGE=$BOOT_BASE_DIR/image
-fi
-
-#=======================================
-# Create ISO
-#---------------------------------------
-TMP_LS=`/bin/ls -d $SOURCE/*/update 2&gt; /dev/null`
-if test -d $SOURCE/$BOOT_BASE_DIR \
-	-o -d $SOURCE/$ROOT_ON_CD -o ! -z &quot;$TMP_LS&quot;
-then
-	if test -f $SOURCE/$BOOT_IMAGE -o -f $SOURCE/.boot \
-		-o -d $SOURCE/$BOOT_ISOLINUX \
-		-o -d $SOURCE/etc -o -f $SOURCE/boot/silo.conf
-	then
-		mkdir -p $SOURCE2 || { echo &quot;can't create tmpdir $SOURCE2&quot; ; exit 1 ; }
-		chmod 755 $SOURCE2
-		if [ -f $SOURCE/.boot ] ; then
-			PARAMS=&quot;$PARAMS -b .boot -c boot.catalog&quot;
-			echo found boot image. Making CD bootable.
-			mkdir -p $SOURCE2/$BOOT_BASE_DIR || exit 1
-		elif [ -f $SOURCE/$BOOT_IMAGE ] ; then
-			# needed for ia64
-			xx=`filesize $SOURCE/$BOOT_IMAGE`
-			if [ \( &quot;$xx&quot; -ne 1474560 \) -a \( &quot;$xx&quot; -ne 2949120 \) ] ; then
-			if head -c 200 $SOURCE/$BOOT_IMAGE | \
-				grep -a -q 'Sorry, didn.t find boot loader, stopped.'
-			then
-				PARAMS=&quot;$PARAMS -hard-disk-boot&quot;
-			else
-				PARAMS=&quot;$PARAMS -no-emul-boot&quot;
-			fi
-			fi
-			echo &quot;$SOURCE2/$BOOT_BASE_DIR/boot.catalog 2&quot; &gt;$SORTFILE
-			echo &quot;$SOURCE/$BOOT_IMAGE 1&quot; &gt;&gt;$SORTFILE
-			PARAMS=&quot;$PARAMS -sort $SORTFILE -b $BOOT_IMAGE \
-					-c $BOOT_BASE_DIR/boot.catalog \
-					-hide $BOOT_BASE_DIR/boot.catalog \
-					-hide-joliet $BOOT_BASE_DIR/boot.catalog&quot;
-			echo found boot image. Making CD bootable.
-			mkdir -p $SOURCE2/$BOOT_BASE_DIR || exit 1
-		elif [ -d $SOURCE/$BOOT_ISOLINUX ] ; then
-			echo &quot;$SOURCE2/$BOOT_BASE_DIR/boot.catalog 3&quot; &gt;$SORTFILE
-			echo &quot;$BOOT_BASE_DIR/boot.catalog 3&quot; &gt;&gt;$SORTFILE
-			echo &quot;$SOURCE/$BOOT_BASE_DIR/boot.catalog 3&quot; &gt;&gt;$SORTFILE
-			find $SOURCE/$BOOT_ISOLINUX -printf &quot;%p 1\n&quot; &gt;&gt;$SORTFILE
-			# last priority wins
-			echo &quot;$SOURCE/$BOOT_ISOLINUX/isolinux.bin 2&quot; &gt;&gt;$SORTFILE
-			echo &quot;sortfile has&quot;
-			cat $SORTFILE
-			echo &quot;end sortfile&quot;
-			# isolinux expects a directory
-			PARAMS=&quot;$PARAMS -sort $SORTFILE -no-emul-boot \
-				-boot-load-size 4 -boot-info-table \
-				-b $BOOT_ISOLINUX/isolinux.bin \
-				-c $BOOT_BASE_DIR/boot.catalog \
-				-hide $BOOT_BASE_DIR/boot.catalog \
-				-hide-joliet $BOOT_BASE_DIR/boot.catalog&quot;
-			echo found boot image. Making CD bootable.
-			mkdir -p $SOURCE2/$BOOT_BASE_DIR || exit 1
-		else
-			if [ -d $SOURCE/etc ] ; then
-				echo found $SOURCE/etc. put it at the beginning of iso image.
-				mkdir -p $SOURCE2/etc || exit 1
-			else
-				if [ -f $SOURCE/boot/silo.conf ] ; then
-					PARAMS=&quot;$PARAMS -silo-boot boot/second.b -s /boot/silo.conf&quot;
-					echo found SPARC boot config. Making CD bootable.
-					mkdir -p $SOURCE2/boot || exit 1
-				fi
-			fi
-		fi
-		XPARAMS=&quot;$SOURCE2&quot;
-	else 
-		echo found no boot image. No bootable CD.
-	fi
-
-	if test -f $SOURCE/content -a -z &quot;$TMP_LS&quot; ; then
-		# we already collected this above
-		APPID=$DISTIDENT
-	elif test -f $SOURCE/$DESCRDIR/info ; then
-		set -- `fgrep DIST_IDENT $SOURCE/$DESCRDIR/info`
-		APPID=$2
-	else
-		# If we have directory &quot;update&quot; in the second level, we assume
-		# this is a Patch-CD
-		if test ! -z &quot;$TMP_LS&quot; ; then
-		if test -f $SOURCE/media.1/patches ; then
-			APPID=&quot;`cat $SOURCE/media.1/patches|sed -e&quot;s|/ ||g&quot; | tr &quot; &quot; _`&quot;
-		else
-			APPID=&quot;`cat $SOURCE/.S.u.S.E-disk-* | tr &quot; &quot; _`&quot;
-		fi
-		fi
-	fi
-	if test -z &quot;$APPID&quot; \
-		-a -f $SOURCE/$ROOT_ON_CD/MD5SUMS \
-		-a -f $SOURCE/.S.u.S.E-disk-*
-	then
-		APPID=`cat $SOURCE/.S.u.S.E-disk-*|tr &quot; &quot; - |sed -e&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">s at -Version-</A>@-@&quot;`
-		APPID=&quot;$APPID.0#0&quot;
-	fi
-	APPID=`echo $APPID | tr &quot; &quot; -`
-	test -n &quot;$APPID&quot; &amp;&amp; PARAMS=&quot;$PARAMS -A $APPID&quot;
-
-	if test -f $SOURCE/content ; then
-		MEDIANUMBER=1
-		for i in $SOURCE/media.? ; do
-			test -d $i || continue
-			MEDIADIR=`ls -d $SOURCE/media.?`
-			MEDIANUMBER=${MEDIADIR##$SOURCE/media.}
-		done
-		VOL=&quot;0$MEDIANUMBER&quot;
-	elif test -f $SOURCE/.S.u.S.E-disk-* ; then
-		BASE=`basename $SOURCE/.S.u.S.E-disk-*`
-		VOL=`echo $BASE | cut -c 16-17`
-	fi
-	if test -n &quot;$VOL&quot; ; then
-		DIS=`echo $APPID | sed -e &quot;s/.*-//&quot; | tr -d \.\#`
-		VOL_PREFIX=&quot;SU&quot;
-		case &quot;$APPID&quot; in
-			*Basic*)
-				KND=&quot;B&quot;
-			;;
-			*Evaluation*)
-				KND=&quot;E&quot;
-			;;
-			*FTP*)
-				KND=&quot;F&quot;
-			;;
-			*full*)
-				KND=&quot;Z&quot;
-			;;
-			*ITP*)
-				KND=&quot;I&quot;
-			;;
-			*Runtime*)
-				KND=&quot;R&quot;
-			;;
-			*Patch-CD*)
-				DIS=&quot;PATCH&quot;
-				KND=&quot;P&quot;
-			;;
-			*)
-				KND=&quot;0&quot;
-			;;
-		esac
-		VOL=&quot;$VOL_PREFIX$DIS.$KND$VOL&quot;
-		if test -n &quot;$VOL&quot; ; then
-			PARAMS=&quot;$PARAMS -V $VOL&quot;
-		fi
-	fi
-fi
-
-if [ ! -x /usr/bin/isolinux-config ];then
-	echo &quot;Can't find isolinux-config binary&quot;
-	exit 1
-fi
-/usr/bin/isolinux-config \
-	--base $BOOT_ISOLINUX $SOURCE/$BOOT_ISOLINUX/isolinux.bin
-mkisofs \
-	-p &quot;$CD_PREPARER&quot; \
-	-publisher &quot;$CD_PUBLISHER&quot; \
-	$PARAMS -o $DEST $XPARAMS $SOURCE
-code=$?
-
-#=======================================
-# Clean up
-#---------------------------------------
-if [ -d &quot;$SOURCE2&quot; ] ; then
-	echo removing $SOURCE2
-	rm -r $SOURCE2
-fi
-
-if [ -e &quot;$SORTFILE&quot; ] ; then
-	echo removing $SORTFILE
-	rm -f &quot;$SORTFILE&quot;
-fi
-
-exit $code


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000693.html">[Kiwi-devel] r1594 - kiwi-head/modules
</A></li>
	<LI>Next message: <A HREF="000695.html">[Kiwi-devel] r1596 - in kiwi-head: modules rpm
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#694">[ date ]</a>
              <a href="thread.html#694">[ thread ]</a>
              <a href="subject.html#694">[ subject ]</a>
              <a href="author.html#694">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
