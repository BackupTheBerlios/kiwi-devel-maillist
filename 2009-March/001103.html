<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 11e9984d02e9e5e74c61de8b86351aa49dffdafd
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2009-March/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%20master%2C%0A%09updated.%2011e9984d02e9e5e74c61de8b86351aa49dffdafd&In-Reply-To=%3C200903171734.n2HHYMSo008120%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001102.html">
   <LINK REL="Next"  HREF="001104.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 11e9984d02e9e5e74c61de8b86351aa49dffdafd</H1>
    <B>mbarringer at BerliOS</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%20master%2C%0A%09updated.%2011e9984d02e9e5e74c61de8b86351aa49dffdafd&In-Reply-To=%3C200903171734.n2HHYMSo008120%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 11e9984d02e9e5e74c61de8b86351aa49dffdafd">mbarringer at mail.berlios.de
       </A><BR>
    <I>Tue Mar 17 18:34:22 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001102.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 52b9fb7a21b96757e557601f9c30f7e0d00ca570
</A></li>
        <LI>Next message: <A HREF="001104.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 6d8a03e081d086a0bd688320a8cd0e8883a3e082
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1103">[ date ]</a>
              <a href="thread.html#1103">[ thread ]</a>
              <a href="subject.html#1103">[ subject ]</a>
              <a href="author.html#1103">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Project kiwi at BerliOS&quot;.

The branch, master has been updated
       via  11e9984d02e9e5e74c61de8b86351aa49dffdafd (commit)
       via  d523924e55edd3cdcd1bf3f567ce74f2aa7c3687 (commit)
       via  9bafc3dc9b32486099ea071594be00202d2543d0 (commit)
       via  2e5f4ea57d981800969bc9a65aa7edb5d9d76505 (commit)
      from  52b9fb7a21b96757e557601f9c30f7e0d00ca570 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 11e9984d02e9e5e74c61de8b86351aa49dffdafd
Author: Matt Barringer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">mbarringer at suse.de</A>&gt;
Date:   Tue Mar 17 18:33:48 2009 +0100

    Trying to commit the MacOS port again

commit d523924e55edd3cdcd1bf3f567ce74f2aa7c3687
Author: Matt Barringer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">mbarringer at suse.de</A>&gt;
Date:   Tue Mar 17 18:14:52 2009 +0100

    Last commit failed for some reason

commit 9bafc3dc9b32486099ea071594be00202d2543d0
Merge: 2e5f4ea57d981800969bc9a65aa7edb5d9d76505 52b9fb7a21b96757e557601f9c30f7e0d00ca570
Author: Matt Barringer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">mbarringer at suse.de</A>&gt;
Date:   Tue Mar 17 18:07:47 2009 +0100

    Merge branch 'master' of <A HREF="ssh://mbarringer@git.berlios.de/gitroot/kiwi">ssh://mbarringer@git.berlios.de/gitroot/kiwi</A>

commit 2e5f4ea57d981800969bc9a65aa7edb5d9d76505
Author: Matt Barringer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">mbarringer at suse.de</A>&gt;
Date:   Tue Mar 17 18:07:28 2009 +0100

    Finished the MacOS X port

-----------------------------------------------------------------------

Summary of changes:
diff --git a/rpm/kiwi.changes b/rpm/kiwi.changes
index d037613..404d06a 100644
--- a/rpm/kiwi.changes
+++ b/rpm/kiwi.changes
@@ -1,4 +1,11 @@
 -------------------------------------------------------------------
+Tue Mar 17 18:05:05 CET 2009 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">mbarringer at suse.de</A>
+
+- Ported the new imagewriter UI to MacOS
+- MacOS USB key writing is now functional.  &quot;Unsafe mode&quot; coming
+  soon
+
+-------------------------------------------------------------------
 Tue Mar 17 10:54:49 CET 2009 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
 
 - v3.33
diff --git a/tools/burner/PlatformMac.cpp b/tools/burner/PlatformMac.cpp
index 12a5528..beef5ac 100644
--- a/tools/burner/PlatformMac.cpp
+++ b/tools/burner/PlatformMac.cpp
@@ -31,6 +31,8 @@
 
 #include &lt;QtGui&gt;
 #include &lt;CoreFoundation/CoreFoundation.h&gt;
+#include &lt;CoreServices/CoreServices.h&gt;
+
 #include &lt;IOKit/IOKitLib.h&gt;
 #include &lt;IOKit/IOCFPlugIn.h&gt; 
 #include &lt;IOKit/IOBSD.h&gt; 
@@ -41,7 +43,7 @@
 #define BLOCKSIZE 1048576
 
 void
-PlatformMacintosh::findDevices()
+PlatformMacintosh::findDevices(bool unsafe)
 {
     kern_return_t ret;
     io_registry_entry_t entry;
@@ -52,6 +54,7 @@ PlatformMacintosh::findDevices()
     SInt64 capacity = 0;
 
     // Search for USB devices
+    // TODO: Pay attention to the unsafe flag
     CFMutableDictionaryRef dict = NULL;
     dict = IOServiceMatching(&quot;IOUSBDevice&quot;);
 
@@ -76,6 +79,7 @@ PlatformMacintosh::findDevices()
 
             QString newDevString = QString(&quot;/dev/%1&quot;).arg(CFStringGetCStringPtr(bsdname, kCFStringEncodingMacRoman));
             devItem-&gt;setPath(newDevString);
+            devItem-&gt;setUDI(newDevString);
 
             QString newDisplayString = QString(&quot;%1 - %2 (%3 MB)&quot;).arg(devItem-&gt;getVendorString()).arg(devItem-&gt;getPath()).arg(devItem-&gt;getSize() / 1048576);
             devItem-&gt;setDisplayString(newDisplayString);
@@ -88,13 +92,46 @@ PlatformMacintosh::findDevices()
 bool
 PlatformMacintosh::isMounted(QString path)
 {
-    // This doesn't actually work
-    // TODO: Figure out how to make it work
+    unsigned int mounts = 0;
+    struct statfs *fsStats=NULL;
+
+    mounts = getmntinfo(&amp;fsStats, MNT_NOWAIT);
+    if (mounts)
+        return(true);
+    return(false);
+}
+
+bool
+PlatformMacintosh::unmountDevice(QString path)
+{
+    int mounts = 0;
+    int i;
+    int len = path.length();
+    struct statfs *fsStats=NULL;
+    FSRef volFSRef;
+    FSCatalogInfo volumeInfo;
+
+    mounts = getmntinfo(&amp;fsStats, MNT_NOWAIT);
+    if (mounts)
+    {
+        for (i = 0; i &lt; mounts; i++)
+        {
+            if ((!memcmp(path.toLocal8Bit().data(), &amp;fsStats[i].f_mntfromname[0], len)) // First check the path
+                &amp;&amp; (!isdigit(fsStats[i].f_mntfromname[len]))) // Then make sure we're not going to really mess things up
+            {
+                qDebug() &lt;&lt; &quot;Will try to unmount &quot; &lt;&lt; &amp;fsStats[i].f_mntfromname[0];
+                if (FSPathMakeRef((UInt8 *) fsStats[i].f_mntonname, &amp;volFSRef, NULL) != noErr)
+                    return(false);
 
-    if (unmount(path.toLatin1().data(), 0) == -1)
-        return true;
+                if (FSGetCatalogInfo(&amp;volFSRef, kFSCatInfoVolume, &amp;volumeInfo, NULL, NULL, NULL) != noErr)
+                    return(false);
 
-    return false;
+                if (FSUnmountVolumeSync(volumeInfo.volume, 0, NULL) != noErr)
+                    return(false);
+            }
+        }
+    }
+    return(true);
 }
 
 void
diff --git a/tools/burner/PlatformMac.h b/tools/burner/PlatformMac.h
index 65f7412..70c2901 100644
--- a/tools/burner/PlatformMac.h
+++ b/tools/burner/PlatformMac.h
@@ -31,8 +31,9 @@ class PlatformMacintosh : public Platform
 public:
     PlatformMacintosh() { };
     // Override the Platform functions
-    void findDevices();
+    void findDevices(bool unsafe = false);
     bool isMounted(QString path);
+    bool unmountDevice(QString path);
     void writeData(QString path, QString fileName, qint64 deviceSize);
 };
 
diff --git a/tools/burner/imagewriter.pro b/tools/burner/imagewriter.pro
index 948abd6..aa8ecff 100644
--- a/tools/burner/imagewriter.pro
+++ b/tools/burner/imagewriter.pro
@@ -15,21 +15,28 @@ HEADERS += DeviceItem.h \
            PlatformWindows.h \
            PlatformMac.h
 SOURCES += main.cpp MainWindow.cpp Platform.cpp
-unix {
+
+win32 {
+	SOURCES += PlatformWindows.cpp
+	SDKDIR = $$(WindowsSdkDir)
+	INCLUDEPATH += E:\WINDDK\3790.1830\inc\wxp $$quote($$SDKDIR\..\v6.0A\include)
+	LIBS += user32.lib
+	LIBPATH += $$quote($$SDKDIR\..\v6.0A\Lib)
+}
+
+macx {
+	SOURCES += PlatformMac.cpp
+	CONFIG += x86 ppc
+	LIBS += -framework IOKit
+}
+
+unix:!macx {
 	exists (&quot;/usr/include/hal/libhal.h&quot;)
 	{
 		CONFIG += link_pkgconfig
 		PKGCONFIG += hal hal-storage
 	}
-}
-unix:SOURCES += PlatformLinux.cpp
-unix:CONFIG += qdbus
-macx:SOURCES += PlatformMac.cpp
-win32:SOURCES += PlatformWindows.cpp
-win32:SDKDIR = $$(WindowsSdkDir)
-win32:INCLUDEPATH += E:\WINDDK\3790.1830\inc\wxp $$quote($$SDKDIR\..\v6.0A\include)
-win32:LIBS += user32.lib
-win32:LIBPATH += $$quote($$SDKDIR\..\v6.0A\Lib)
-macx:CONFIG += x86 ppc
-macx:LIBS += -framework IOKit
+	SOURCES += PlatformLinux.cpp
+	CONFIG += qdbus
+} 
 RESOURCES += imagewriter.qrc


hooks/post-receive
-- 
Project kiwi at BerliOS

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001102.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 52b9fb7a21b96757e557601f9c30f7e0d00ca570
</A></li>
	<LI>Next message: <A HREF="001104.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 6d8a03e081d086a0bd688320a8cd0e8883a3e082
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1103">[ date ]</a>
              <a href="thread.html#1103">[ thread ]</a>
              <a href="subject.html#1103">[ subject ]</a>
              <a href="author.html#1103">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
