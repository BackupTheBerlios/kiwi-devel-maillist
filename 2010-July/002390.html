<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-374-SuSE-11-1-SLE-SP-Devel,	updated. ba374aff6e28f1780d692f909d9edc0fd394740a
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2010-July/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%0A%09KIWI-374-SuSE-11-1-SLE-SP-Devel%2C%0A%09updated.%20ba374aff6e28f1780d692f909d9edc0fd394740a&In-Reply-To=%3C20100708135144.CBB8548088F%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002389.html">
   <LINK REL="Next"  HREF="002391.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-374-SuSE-11-1-SLE-SP-Devel,	updated. ba374aff6e28f1780d692f909d9edc0fd394740a</H1>
    <B>marcus_schaefer at BerliOS</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%0A%09KIWI-374-SuSE-11-1-SLE-SP-Devel%2C%0A%09updated.%20ba374aff6e28f1780d692f909d9edc0fd394740a&In-Reply-To=%3C20100708135144.CBB8548088F%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-374-SuSE-11-1-SLE-SP-Devel,	updated. ba374aff6e28f1780d692f909d9edc0fd394740a">marcus_schaefer at mail.berlios.de
       </A><BR>
    <I>Thu Jul  8 15:51:44 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002389.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. e0fd9747c875d73f8b6ebf1b52002ca21df93bc7
</A></li>
        <LI>Next message: <A HREF="002391.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 207b5660a9a0fa2d88d5d499d6319e257dc955c5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2390">[ date ]</a>
              <a href="thread.html#2390">[ thread ]</a>
              <a href="subject.html#2390">[ subject ]</a>
              <a href="author.html#2390">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Project kiwi at BerliOS&quot;.

The branch, KIWI-374-SuSE-11-1-SLE-SP-Devel has been updated
       via  ba374aff6e28f1780d692f909d9edc0fd394740a (commit)
       via  85ec45248f9e02fe892383fb747b2774c2e80a8f (commit)
       via  5fac6cb3e0a8b8cbc39d2c60b0c8735329060ff2 (commit)
       via  88df0d79810dd07948ad837f966f72b6d8974024 (commit)
      from  ab6bf33f5363ac29d7774d134af2d200801c17c2 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit ba374aff6e28f1780d692f909d9edc0fd394740a
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Thu Jul 8 15:49:35 2010 +0200

    - moved in-place recovery file creation into suse-dump
      directly after the install verification (bnc #620777)

commit 85ec45248f9e02fe892383fb747b2774c2e80a8f
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Thu Jul 8 12:07:49 2010 +0200

    - don't put the recovery meta information into the recovery tarball
      when creating them dynamically

commit 5fac6cb3e0a8b8cbc39d2c60b0c8735329060ff2
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Thu Jul 8 10:41:05 2010 +0200

    - added oem-inplace-recovery option which allows creation
      of the recovery tarball at first deployment instead of
      creating the tarball and store it inside the image (bnc #620777)

commit 88df0d79810dd07948ad837f966f72b6d8974024
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Thu Jul 8 09:57:47 2010 +0200

    - fixed this path evaluation (bnc #619482)

-----------------------------------------------------------------------

Summary of changes:
diff --git a/modules/KIWIBoot.pm b/modules/KIWIBoot.pm
index 618f95a..a04785d 100644
--- a/modules/KIWIBoot.pm
+++ b/modules/KIWIBoot.pm
@@ -2325,6 +2325,27 @@ sub setupBootDisk {
 		}
 	}
 	#==========================================
+	# increase vmsize on in-place recovery
+	#------------------------------------------
+	my $inplace = $xml -&gt; getOEMRecoveryInPlace();
+	if (defined $inplace) {
+		my ($FD,$recoMB);
+		my $sizefile = &quot;$destdir/recovery.partition.size&quot;;
+		if (open ($FD,$sizefile)) {
+			$recoMB = &lt;$FD&gt;; chomp $recoMB;
+			$kiwi -&gt; info (
+				&quot;Adding $recoMB MB spare space for in-place recovery&quot;
+			);
+			close $FD;
+			unlink $sizefile;
+			$vmsize = $this-&gt;{vmmbyte} + $recoMB;
+			$this-&gt;{vmmbyte} = $vmsize;
+			$vmsize = $vmsize.&quot;M&quot;;
+			$this-&gt;{vmsize}  = $vmsize;
+			$kiwi -&gt; done ();
+		}
+	}
+	#==========================================
 	# increase vmsize if image split portion
 	#------------------------------------------
 	if (($imgtype eq &quot;split&quot;) &amp;&amp; (-f $splitfile)) {
diff --git a/modules/KIWIConfig.sh b/modules/KIWIConfig.sh
index 841caca..824fc94 100644
--- a/modules/KIWIConfig.sh
+++ b/modules/KIWIConfig.sh
@@ -245,6 +245,10 @@ function baseSetupOEMPartition {
 		echo &quot;Setting up OEM_RECOVERY_ID=$kiwi_oemrecoveryID&quot;
 		echo &quot;OEM_RECOVERY_ID=$kiwi_oemrecoveryID&quot; &gt;&gt; $oemfile
 	fi
+	if [ ! -z &quot;$kiwi_oemrecoveryInPlace&quot; ];then
+		echo &quot;Setting up OEM_RECOVERY_INPLACE=1&quot;
+		echo &quot;OEM_RECOVERY_INPLACE=1&quot; &gt;&gt; $oemfile
+	fi
 }
 
 #======================================
diff --git a/modules/KIWIConfigure.pm b/modules/KIWIConfigure.pm
index 052f2a4..fa5d9ad 100644
--- a/modules/KIWIConfigure.pm
+++ b/modules/KIWIConfigure.pm
@@ -81,13 +81,14 @@ sub new {
 # setupRecoveryArchive
 #------------------------------------------
 sub setupRecoveryArchive {
-	my $this  = shift;
-	my $fstype= shift;
-	my $kiwi  = $this-&gt;{kiwi};
-	my $dest  = $this-&gt;{imageDest};
-	my $xml   = $this-&gt;{xml};
-	my $root  = $this-&gt;{root};
-	my $start = $xml -&gt; getOEMRecovery();
+	my $this    = shift;
+	my $fstype  = shift;
+	my $kiwi    = $this-&gt;{kiwi};
+	my $dest    = $this-&gt;{imageDest};
+	my $xml     = $this-&gt;{xml};
+	my $root    = $this-&gt;{root};
+	my $start   = $xml -&gt; getOEMRecovery();
+	my $inplace = $xml -&gt; getOEMRecoveryInPlace();
 	my $FD;
 	if ((! defined $start) || (&quot;$start&quot; eq &quot;false&quot;)) {
 		return $this;
@@ -98,6 +99,9 @@ sub setupRecoveryArchive {
 		return undef;
 	}
 	$kiwi -&gt; info (&quot;Creating recovery archive...&quot;);
+	#==========================================
+	# Create tar archive from root tree .tar
+	#------------------------------------------
 	my $topts  = &quot;--numeric-owner -czpf&quot;;
 	my $excld  = &quot;--exclude ./dev --exclude ./proc --exclude ./sys&quot;;
 	my $status = qxx (
@@ -110,6 +114,9 @@ sub setupRecoveryArchive {
 		$kiwi -&gt; error  (&quot;Failed to create recovery archive: $status&quot;);
 		return undef;
 	}
+	#==========================================
+	# Create file count information
+	#------------------------------------------
 	$status = qxx (
 		&quot;tar -tf $root/recovery.tar.gz | wc -l &gt; $root/recovery.tar.files&quot;
 	);
@@ -119,6 +126,30 @@ sub setupRecoveryArchive {
 		$kiwi -&gt; error  (&quot;Failed to create recovery file count: $status&quot;);
 		return undef;
 	}
+	#==========================================
+	# Create recovery partition size info
+	#------------------------------------------
+	if (! open ($FD,&quot;&gt;$root/recovery.partition.size&quot;)) {
+		$kiwi -&gt; failed ();
+		$kiwi -&gt; error  (&quot;Failed to create recovery partition size info: $!&quot;);
+		return undef;
+	}
+	my $psize = -s &quot;$root/recovery.tar.gz&quot;;
+	$psize /= 1048576;
+	$psize += 100;
+	$psize = sprintf (&quot;%.0f&quot;, $psize);
+	print $FD $psize;
+	close $FD;
+	$status = qxx (&quot;cp $root/recovery.partition.size $dest 2&gt;&amp;1&quot;);
+	$code = $? &gt;&gt; 8;
+	if ($code != 0) {
+		$kiwi -&gt; failed ();
+		$kiwi -&gt; error  (&quot;Failed to copy partition size info file: $status&quot;);
+		return undef;
+	}
+	#==========================================
+	# Create destination filesystem information
+	#------------------------------------------
 	if (! open ($FD,&quot;&gt;$root/recovery.tar.filesystem&quot;)) {
 		$kiwi -&gt; failed ();
 		$kiwi -&gt; error  (&quot;Failed to create recovery filesystem info: $!&quot;);
@@ -126,6 +157,12 @@ sub setupRecoveryArchive {
 	}
 	print $FD $fstype;
 	close $FD;
+	#==========================================
+	# Remove tarball for later recreation
+	#------------------------------------------
+	if (defined $inplace) {
+		qxx (&quot;rm -f $root/recovery.tar.gz 2&gt;&amp;1&quot;);
+	}
 	$kiwi -&gt; done ();
 	return $this;
 }
diff --git a/modules/KIWIImage.pm b/modules/KIWIImage.pm
index fe2ce39..53f097a 100644
--- a/modules/KIWIImage.pm
+++ b/modules/KIWIImage.pm
@@ -1016,6 +1016,7 @@ sub createImageUSB {
 	$main::ForeignRepo{&quot;oem-dumphalt&quot;}   = $xml -&gt; getOEMDumpHalt();
 	$main::ForeignRepo{&quot;oem-recovery&quot;}   = $xml -&gt; getOEMRecovery();
 	$main::ForeignRepo{&quot;oem-recoveryID&quot;} = $xml -&gt; getOEMRecoveryID();
+	$main::ForeignRepo{&quot;oem-inplace-recovery&quot;} = $xml -&gt;getOEMRecoveryInPlace();
 	$main::ForeignRepo{&quot;displayname&quot;}    = $xml -&gt; getImageDisplayName();
 	$main::ForeignRepo{&quot;locale&quot;}    = $xml -&gt; getLocale();
 	$main::ForeignRepo{&quot;boot-theme&quot;}= $xml -&gt; getBootTheme();
@@ -2827,6 +2828,7 @@ sub createImageSplit {
 	$main::ForeignRepo{&quot;oem-dumphalt&quot;}   = $xml -&gt; getOEMDumpHalt();
 	$main::ForeignRepo{&quot;oem-recovery&quot;}   = $xml -&gt; getOEMRecovery();
 	$main::ForeignRepo{&quot;oem-recoveryID&quot;} = $xml -&gt; getOEMRecoveryID();
+	$main::ForeignRepo{&quot;oem-inplace-recovery&quot;} = $xml -&gt;getOEMRecoveryInPlace();
 	$main::ForeignRepo{&quot;displayname&quot;}    = $xml -&gt; getImageDisplayName();
 	$main::ForeignRepo{&quot;locale&quot;}    = $xml -&gt; getLocale();
 	$main::ForeignRepo{&quot;boot-theme&quot;}= $xml -&gt; getBootTheme();
diff --git a/modules/KIWISchema.rnc b/modules/KIWISchema.rnc
index bfe042e..6461eca 100644
--- a/modules/KIWISchema.rnc
+++ b/modules/KIWISchema.rnc
@@ -906,6 +906,31 @@ div {
 }
 
 #==========================================
+# common element &lt;oem-inplace-recovery&gt;
+#
+div {
+	k.oem-inplace-recovery.content = xsd:boolean
+	k.oem-inplace-recovery.attlist = empty
+	k.oem-inplace-recovery =
+		## For oemboot driven images: Specify whether the
+		## recovery archive should be stored as part of the image
+		## or not. If it's not stored it's created during install
+		## of the oem image
+		[
+		db:para [
+			&quot;For oemboot driven images: Specify whether the\x{a}&quot;~
+			&quot;recovery archive should be stored as part of the image\x{a}&quot;~
+			&quot;or not. If it's not stored it's created during install\x{a}&quot;~
+			&quot;of the oem image&quot;
+		]
+		]
+		element oem-inplace-recovery {
+			k.oem-inplace-recovery.attlist,
+			k.oem-inplace-recovery.content
+		}
+}
+
+#==========================================
 # common element &lt;oem-swap&gt;
 #
 div {
@@ -2028,6 +2053,7 @@ div {
 			k.oem-systemsize? &amp;
 			k.oem-recovery? &amp;
 			k.oem-recoveryID? &amp;
+			k.oem-inplace-recovery? &amp;
 			k.oem-reboot? &amp;
 			k.oem-dumphalt? &amp;
 			k.packagemanager? &amp;
diff --git a/modules/KIWISchema.rng b/modules/KIWISchema.rng
index f8531d2..11b9890 100644
--- a/modules/KIWISchema.rng
+++ b/modules/KIWISchema.rng
@@ -1291,6 +1291,33 @@ recovery partition. Default value is 83 (Linux)&lt;/db:para&gt;
   &lt;/div&gt;
   &lt;!--
     ==========================================
+    common element &lt;oem-inplace-recovery&gt;
+    
+  --&gt;
+  &lt;div&gt;
+    &lt;define name=&quot;k.oem-inplace-recovery.content&quot;&gt;
+      &lt;data type=&quot;boolean&quot;/&gt;
+    &lt;/define&gt;
+    &lt;define name=&quot;k.oem-inplace-recovery.attlist&quot;&gt;
+      &lt;empty/&gt;
+    &lt;/define&gt;
+    &lt;define name=&quot;k.oem-inplace-recovery&quot;&gt;
+      &lt;element name=&quot;oem-inplace-recovery&quot;&gt;
+        &lt;a:documentation&gt;For oemboot driven images: Specify whether the
+recovery archive should be stored as part of the image
+or not. If it's not stored it's created during install
+of the oem image&lt;/a:documentation&gt;
+        &lt;db:para&gt;For oemboot driven images: Specify whether the
+recovery archive should be stored as part of the image
+or not. If it's not stored it's created during install
+of the oem image&lt;/db:para&gt;
+        &lt;ref name=&quot;k.oem-inplace-recovery.attlist&quot;/&gt;
+        &lt;ref name=&quot;k.oem-inplace-recovery.content&quot;/&gt;
+      &lt;/element&gt;
+    &lt;/define&gt;
+  &lt;/div&gt;
+  &lt;!--
+    ==========================================
     common element &lt;oem-swap&gt;
     
   --&gt;
@@ -2951,6 +2978,9 @@ and also depends of the selected image output type.&lt;/db:para&gt;
             &lt;ref name=&quot;k.oem-recoveryID&quot;/&gt;
           &lt;/optional&gt;
           &lt;optional&gt;
+            &lt;ref name=&quot;k.oem-inplace-recovery&quot;/&gt;
+          &lt;/optional&gt;
+          &lt;optional&gt;
             &lt;ref name=&quot;k.oem-reboot&quot;/&gt;
           &lt;/optional&gt;
           &lt;optional&gt;
diff --git a/modules/KIWIURL.pm b/modules/KIWIURL.pm
index 37c4b49..d780918 100644
--- a/modules/KIWIURL.pm
+++ b/modules/KIWIURL.pm
@@ -230,6 +230,8 @@ sub thisPath {
 		my $pwd = qxx (&quot;pwd&quot;); chomp $pwd;
 		$thisPath = $pwd.&quot;/&quot;.$thisPath;
 	}
+	$thisPath =~ s/\/\.\//\//g;
+	$thisPath =~ s/\/+/\//g;
 	return $thisPath;
 }
 
diff --git a/modules/KIWIXML.pm b/modules/KIWIXML.pm
index af6e404..28e0f7b 100644
--- a/modules/KIWIXML.pm
+++ b/modules/KIWIXML.pm
@@ -365,6 +365,9 @@ sub new {
 		if (defined $foreignRepo-&gt;{&quot;oem-recoveryID&quot;}) {
 			$this -&gt; setForeignOptionsElement (&quot;oem-recoveryID&quot;);
 		}
+		if (defined $foreignRepo-&gt;{&quot;oem-inplace-recovery&quot;}) {
+			$this -&gt; setForeignOptionsElement (&quot;oem-inplace-recovery&quot;);
+		}
 		#==========================================
 		# foreign type attributes
 		#------------------------------------------
@@ -1434,6 +1437,22 @@ sub getOEMRecoveryID {
 }
 
 #==========================================
+# getOEMRecoveryInPlace
+#------------------------------------------
+sub getOEMRecoveryInPlace {
+	# ...
+	# Obtain the oem-inplace-recovery value or return undef
+	# ---
+	my $this = shift;
+	my $node = $this -&gt; getPreferencesNodeByTagName (&quot;oem-inplace-recovery&quot;);
+	my $inplace = $node -&gt; getElementsByTagName (&quot;oem-inplace-recovery&quot;);
+	if ((! defined $inplace) || (&quot;$inplace&quot; eq &quot;&quot;)) {
+		return undef;
+	}
+	return $inplace;
+}
+
+#==========================================
 # getOEMHome
 #------------------------------------------
 sub getOEMHome {
@@ -2315,6 +2334,7 @@ sub getImageConfig {
 		my $oemhalt  = $element -&gt; getElementsByTagName (&quot;oem-dumphalt&quot;);
 		my $oemreco  = $element -&gt; getElementsByTagName (&quot;oem-recovery&quot;);
 		my $oemrecoid= $element -&gt; getElementsByTagName (&quot;oem-recoveryID&quot;);
+		my $inplace  = $element -&gt; getElementsByTagName (&quot;oem-inplace-recovery&quot;);
 		if ((defined $keytable) &amp;&amp; (&quot;$keytable&quot; ne &quot;&quot;)) {
 			$result{kiwi_keytable} = $keytable;
 		}
@@ -2359,6 +2379,9 @@ sub getImageConfig {
 		if ((defined $oemrecoid) &amp;&amp; (&quot;$oemrecoid&quot; ne &quot;&quot;)) {
 			$result{kiwi_oemrecoveryID} = $oemrecoid;
 		}
+		if ((defined $inplace) &amp;&amp; (&quot;$inplace&quot; eq &quot;true&quot;)) {
+			$result{kiwi_oemrecoveryInPlace} = $inplace;
+		}
 	}
 	#==========================================
 	# profiles
diff --git a/rpm/kiwi.changes b/rpm/kiwi.changes
index 73f42f0..01095c3 100644
--- a/rpm/kiwi.changes
+++ b/rpm/kiwi.changes
@@ -1,4 +1,22 @@
 -------------------------------------------------------------------
+Thu Jul  8 15:22:16 CEST 2010 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
+
+- moved in-place recovery file creation into suse-dump
+  directly after the install verification (bnc #620777)
+
+-------------------------------------------------------------------
+Thu Jul  8 10:33:39 CEST 2010 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
+
+- added oem-inplace-recovery option which allows creation
+  of the recovery tarball at first deployment instead of
+  creating the tarball and store it inside the image (bnc #620777)
+
+-------------------------------------------------------------------
+Thu Jul  8 09:57:16 CEST 2010 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
+
+- fixed this path evaluation (bnc #619482)
+
+-------------------------------------------------------------------
 Fri Jun 11 09:50:34 CEST 2010 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ug at suse.de</A>
 
 - kiwi overwrites /etc/sysconfig/firstboot (bnc#604705)
diff --git a/system/boot/ix86/oemboot/suse-dump b/system/boot/ix86/oemboot/suse-dump
index af30cf0..7b57ed8 100755
--- a/system/boot/ix86/oemboot/suse-dump
+++ b/system/boot/ix86/oemboot/suse-dump
@@ -336,6 +336,47 @@ function OEMInstall {
 	export imageDiskDevice=$imageDevice
 	unset stickSerial
 	#======================================
+	# create recovery archive if requested
+	#--------------------------------------
+	if [ ! -z &quot;$OEM_RECOVERY_INPLACE&quot; ];then
+		setupInitialDeviceNames
+		probeFileSystem $imageRootDevice
+		Echo &quot;Resize $FSTYPE filesystem to full partition space...&quot;
+		luksResize $imageRootDevice
+		if [ &quot;$FSTYPE&quot; = &quot;reiserfs&quot; ];then
+			resize_reiserfs -q $imageRootDevice
+		else
+			resize2fs -f -F -p $imageRootDevice
+		fi
+		if ! mountSystem $imageRootDevice;then
+			systemException &quot;Failed to mount root filesystem&quot; &quot;reboot&quot;
+		fi
+		if [ ! -f /mnt/recovery.partition.size ];then
+			systemException &quot;Can't find recovery part size info&quot; &quot;reboot&quot;
+		fi
+		recoMByte=$(cat /mnt/recovery.partition.size)
+		haveMByte=$(
+			df -B1M $imageRootDevice | tail -n 1 | column -t |\
+			sed -e s@&quot;  &quot;@:@g | cut -f 4 -d:
+		)
+		if [ &quot;$haveMByte&quot; -gt &quot;$recoMByte&quot; ];then
+			pushd /mnt
+			Echo &quot;Creating recovery root tarball...&quot;
+			touch recovery.tar.gz
+			tar --numeric-owner -czpf recovery.tar.gz . \
+				--exclude &quot;./dev&quot; \
+				--exclude &quot;./proc&quot; \
+				--exclude &quot;./sys&quot; \
+				--exclude &quot;./recovery.*&quot;
+			popd
+		else
+			Echo &quot;Not enough space left to create recovery archive&quot;
+			Echo &quot;=&gt; Warning: Postponed after repartitioning is done&quot;
+			Echo &quot;=&gt; Warning: This moves the archive creation to first boot&quot;
+		fi
+		umountSystem
+	fi
+	#======================================
 	# Check for halt request
 	#--------------------------------------
 	if [ ! -z &quot;$OEM_DUMPHALT&quot; ];then
diff --git a/system/boot/ix86/oemboot/suse-repart b/system/boot/ix86/oemboot/suse-repart
index 48faed3..eb61838 100755
--- a/system/boot/ix86/oemboot/suse-repart
+++ b/system/boot/ix86/oemboot/suse-repart
@@ -37,12 +37,10 @@ function OEMRepartInit {
 		if ! mount $imageRootDevice /reco-root &gt;/dev/null;then
 			systemException &quot;Failed to mount root device&quot; &quot;reboot&quot;
 		fi
-		if [ ! -f /reco-root/recovery.tar.gz ];then
-			systemException &quot;Can't find recovery archive&quot; &quot;reboot&quot;
+		if [ ! -f /reco-root/recovery.partition.size ];then
+			systemException &quot;Can't find recovery part size info&quot; &quot;reboot&quot;
 		fi
-		recoBytes=`du --bytes /reco-root/recovery.tar.gz | cut -f1`
-		recoMByte=`expr $recoBytes / 1048576`
-		recoMByte=`expr $recoMByte \* 15 / 10`
+		recoMByte=$(cat /reco-root/recovery.partition.size)
 		recoID=83
 		if [ ! -z &quot;$OEM_RECOVERY_ID&quot; ];then
 			recoID=$OEM_RECOVERY_ID
@@ -844,15 +842,29 @@ function OEMRepart {
 		if ! mount $imageRecoveryDevice /reco-save &gt;/dev/null;then
 			systemException &quot;Failed to mount recovery device&quot; &quot;reboot&quot;
 		fi
-		if ! mv /reco-root/recovery.tar.gz /reco-save &gt;/dev/null;then
-			systemException &quot;Failed to move recovery archive&quot; &quot;reboot&quot;
-		fi
 		if ! mv /reco-root/recovery.tar.files /reco-save &gt;/dev/null;then
 			systemException &quot;Failed to move recovery file count&quot; &quot;reboot&quot;
 		fi
 		if ! mv /reco-root/recovery.tar.filesystem /reco-save &gt;/dev/null;then
 			systemException &quot;Failed to move recovery filesystem info&quot; &quot;reboot&quot;
 		fi
+		if ! mv /reco-root/recovery.partition.size /reco-save &gt;/dev/null;then
+			systemException &quot;Failed to move recovery part size info&quot; &quot;reboot&quot;
+		fi
+		if [ -f /reco-root/recovery.tar.gz ];then
+			if ! mv /reco-root/recovery.tar.gz /reco-save &gt;/dev/null;then
+				systemException &quot;Failed to move recovery archive&quot; &quot;reboot&quot;
+			fi
+		else
+			pushd /reco-root
+			Echo &quot;Creating recovery root tarball...&quot;
+			tar --numeric-owner -czpf /reco-save/recovery.tar.gz . \
+				--exclude &quot;./dev&quot; \
+				--exclude &quot;./proc&quot; \
+				--exclude &quot;./sys&quot; \
+				--exclude &quot;./recovery.*&quot;
+			popd
+		fi
 		mkdir /reco-save/boot
 		if ! cp /reco-root/boot/initrd.vmx /reco-save/boot/initrd;then
 			systemException &quot;Failed to copy recovery initrd&quot; &quot;reboot&quot;


hooks/post-receive
-- 
Project kiwi at BerliOS

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002389.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. e0fd9747c875d73f8b6ebf1b52002ca21df93bc7
</A></li>
	<LI>Next message: <A HREF="002391.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 207b5660a9a0fa2d88d5d499d6319e257dc955c5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2390">[ date ]</a>
              <a href="thread.html#2390">[ thread ]</a>
              <a href="subject.html#2390">[ subject ]</a>
              <a href="author.html#2390">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
