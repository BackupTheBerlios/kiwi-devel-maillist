<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 1cd4bbd3fec2a6d9ef109b38686305dbe013a321
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2009-July/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%20master%2C%0A%09updated.%201cd4bbd3fec2a6d9ef109b38686305dbe013a321&In-Reply-To=%3C200907071514.n67FEUG3017664%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001330.html">
   <LINK REL="Next"  HREF="001332.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 1cd4bbd3fec2a6d9ef109b38686305dbe013a321</H1>
    <B>marcus_schaefer at BerliOS</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%20master%2C%0A%09updated.%201cd4bbd3fec2a6d9ef109b38686305dbe013a321&In-Reply-To=%3C200907071514.n67FEUG3017664%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 1cd4bbd3fec2a6d9ef109b38686305dbe013a321">marcus_schaefer at mail.berlios.de
       </A><BR>
    <I>Tue Jul  7 17:14:30 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001330.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 4a22528c995db91712aface86bbf17a1de00df36
</A></li>
        <LI>Next message: <A HREF="001332.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 54606b9ea536de612f5428f8148c21450d69d48a
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1331">[ date ]</a>
              <a href="thread.html#1331">[ thread ]</a>
              <a href="subject.html#1331">[ subject ]</a>
              <a href="author.html#1331">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Project kiwi at BerliOS&quot;.

The branch, master has been updated
       via  1cd4bbd3fec2a6d9ef109b38686305dbe013a321 (commit)
       via  aa6feb4733d8a03f3432f74cb6b5a9667ef447f5 (commit)
      from  4a22528c995db91712aface86bbf17a1de00df36 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1cd4bbd3fec2a6d9ef109b38686305dbe013a321
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Tue Jul 7 17:14:14 2009 +0200

    - added support for luks extension for oem image type
    - fixed CD eject in oem CD/DVD install mode

commit aa6feb4733d8a03f3432f74cb6b5a9667ef447f5
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Mon Jul 6 15:51:35 2009 +0200

    - fixed block comment

-----------------------------------------------------------------------

Summary of changes:
diff --git a/modules/KIWILinuxRC.sh b/modules/KIWILinuxRC.sh
index 1c3f6d4..53c6d39 100644
--- a/modules/KIWILinuxRC.sh
+++ b/modules/KIWILinuxRC.sh
@@ -2072,6 +2072,7 @@ function searchBIOSBootDevice {
 	local ddevs=`$h --disk|grep -E &quot;$c&quot;|sed -e&quot;s@(.*)@@&quot;|cut -f2 -d:|tr -d &quot; &quot;`
 	local cmpd=/tmp/mbrids
 	local ifix=0
+	local matched
 	local bios
 	local file
 	local pred
@@ -2130,13 +2131,14 @@ function searchBIOSBootDevice {
 		mbrM=`dd if=$curd bs=1 count=4 skip=$((0x1b8))|hexdump -n4 -e '&quot;0x%x&quot;'`
 		if [ $mbrM = $mbrI ];then
 			ifix=1
+			matched=$curd
 			if [ &quot;$curd&quot; = &quot;$bios&quot; ];then
 				echo $curd; return
 			fi
 		fi
 	done
 	if [ $ifix -eq 1 ];then
-		echo $curd; return
+		echo $matched; return
 	fi
 	systemException \
 		&quot;No devices matches MBR identifier: $mbrI !&quot; \
@@ -4361,22 +4363,21 @@ function stoppX {
 #--------------------------------------
 function luksOpen {
 	# /.../
-	# check give device if it uses the LUKS extension
+	# check given device if it uses the LUKS extension
 	# if yes open the device and return the new
 	# /dev/mapper/ device name
 	# ----
 	local ldev=$1
 	local name=$2
+	if [ -z $name ];then
+		name=luksroot
+	fi
 	if [ -e /dev/mapper/$name ];then
-		echo /dev/mapper/$name
-		return
+		echo /dev/mapper/$name; return
 	fi
 	if ! cryptsetup isLuks $ldev &amp;&gt;/dev/null;then
 		echo $ldev; return
 	fi
-	if [ -z $name ];then
-		name=luksroot
-	fi
 	dialog --stdout --insecure --passwordbox &quot;Enter LUKS passphrase&quot; 10 60 |\
 		cryptsetup luksOpen $ldev $name 1&gt;&amp;2
 	if [ ! $? = 0 ];then
@@ -4387,6 +4388,38 @@ function luksOpen {
 	echo /dev/mapper/$name
 }
 #======================================
+# luksResize
+#--------------------------------------
+function luksResize {
+	# /.../
+	# check given device if it is a mapped device name
+	# and run cryptsetup resize on the mapper name
+	# ----
+	local ldev=$1
+	if [ ! &quot;$haveLuks&quot; = &quot;yes&quot; ] || [ ! -e $ldev ];then
+		return
+	fi
+	local name=$(basename $ldev)
+	local dmap=$(dirname  $ldev)
+	if [ ! &quot;$dmap&quot; = &quot;/dev/mapper&quot; ];then
+		return
+	fi
+	cryptsetup resize $name
+}
+#======================================
+# luksClose
+#--------------------------------------
+function luksClose {
+	# /.../
+	# close all open LUKS mappings
+	# ----
+	local name
+	for i in /dev/mapper/luks*;do
+		name=$(basename $i)
+		cryptsetup luksClose $name
+	done
+}
+#======================================
 # SAPMemCheck
 #--------------------------------------
 function SAPMemCheck {
diff --git a/modules/KIWIXML.pm b/modules/KIWIXML.pm
index 91cb3e3..cb8793d 100644
--- a/modules/KIWIXML.pm
+++ b/modules/KIWIXML.pm
@@ -2094,6 +2094,9 @@ sub getImageConfig {
 	if (%type) {
 		$result{kiwi_type} = $type{type};
 	}
+	if ((%type) &amp;&amp; ($type{luks})) {
+		$result{kiwi_luks} = &quot;yes&quot;;
+	}
 	if ($size) {
 		$result{kiwi_size} = $size;
 	}
diff --git a/rpm/kiwi.changes b/rpm/kiwi.changes
index 0599708..7bfb052 100644
--- a/rpm/kiwi.changes
+++ b/rpm/kiwi.changes
@@ -3,6 +3,8 @@ Sun Jul  5 19:59:26 CEST 2009 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
 
 - v3.62
 - fixed combined mount with luks encoded read-write part
+- added support for luks extension for oem image type
+- fixed CD eject in oem CD/DVD install mode
 
 -------------------------------------------------------------------
 Tue Jun 30 10:11:11 CEST 2009 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
diff --git a/system/boot/ix86/oemboot/suse-10.3/config.xml b/system/boot/ix86/oemboot/suse-10.3/config.xml
index 155cdd7..378075b 100644
--- a/system/boot/ix86/oemboot/suse-10.3/config.xml
+++ b/system/boot/ix86/oemboot/suse-10.3/config.xml
@@ -27,6 +27,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;crypto/*&quot;/&gt;
 		&lt;file name=&quot;drivers/md/*&quot;/&gt;
 		&lt;file name=&quot;drivers/block/loop.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/hid/*&quot;/&gt;
@@ -105,6 +106,7 @@
 		&lt;package name=&quot;tar&quot;/&gt;
 		&lt;package name=&quot;lvm2&quot;/&gt;
 		&lt;package name=&quot;bzip2&quot;/&gt;
+		&lt;package name=&quot;cryptsetup&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;
diff --git a/system/boot/ix86/oemboot/suse-11.0/config.xml b/system/boot/ix86/oemboot/suse-11.0/config.xml
index 1f4b727..dd01a2d 100644
--- a/system/boot/ix86/oemboot/suse-11.0/config.xml
+++ b/system/boot/ix86/oemboot/suse-11.0/config.xml
@@ -27,6 +27,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;crypto/*&quot;/&gt;
 		&lt;file name=&quot;drivers/virtio/*&quot;/&gt;
 		&lt;file name=&quot;drivers/block/virtio_blk.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/net/virtio_net.ko&quot;/&gt;
@@ -111,6 +112,7 @@
 		&lt;package name=&quot;bzip2&quot;/&gt;
 		&lt;package name=&quot;cromfs&quot;/&gt;
 		&lt;package name=&quot;kiwi-tools&quot;/&gt;
+		&lt;package name=&quot;cryptsetup&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;
diff --git a/system/boot/ix86/oemboot/suse-11.1/config.xml b/system/boot/ix86/oemboot/suse-11.1/config.xml
index 6f428be..b1e6011 100644
--- a/system/boot/ix86/oemboot/suse-11.1/config.xml
+++ b/system/boot/ix86/oemboot/suse-11.1/config.xml
@@ -28,6 +28,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;crypto/*&quot;/&gt;
 		&lt;file name=&quot;drivers/virtio/*&quot;/&gt;
 		&lt;file name=&quot;drivers/block/virtio_blk.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/char/hw_random/virtio-rng.ko&quot;/&gt;
@@ -125,6 +126,7 @@
 		&lt;package name=&quot;bzip2&quot;/&gt;
 		&lt;package name=&quot;cromfs&quot;/&gt;
 		&lt;package name=&quot;kiwi-tools&quot;/&gt;
+		&lt;package name=&quot;cryptsetup&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;
diff --git a/system/boot/ix86/oemboot/suse-11.2/config.xml b/system/boot/ix86/oemboot/suse-11.2/config.xml
index ecec527..fcee480 100644
--- a/system/boot/ix86/oemboot/suse-11.2/config.xml
+++ b/system/boot/ix86/oemboot/suse-11.2/config.xml
@@ -28,6 +28,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;crypto/*&quot;/&gt;
 		&lt;file name=&quot;drivers/virtio/*&quot;/&gt;
 		&lt;file name=&quot;drivers/block/virtio_blk.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/char/hw_random/virtio-rng.ko&quot;/&gt;
@@ -120,6 +121,7 @@
 		&lt;package name=&quot;lvm2&quot;/&gt;
 		&lt;package name=&quot;bzip2&quot;/&gt;
 		&lt;package name=&quot;kiwi-tools&quot;/&gt;
+		&lt;package name=&quot;cryptsetup&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;
diff --git a/system/boot/ix86/oemboot/suse-SLED11/config.xml b/system/boot/ix86/oemboot/suse-SLED11/config.xml
index 9014f2b..5bdaf2c 100644
--- a/system/boot/ix86/oemboot/suse-SLED11/config.xml
+++ b/system/boot/ix86/oemboot/suse-SLED11/config.xml
@@ -28,6 +28,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;crypto/*&quot;/&gt;
 		&lt;file name=&quot;drivers/virtio/*&quot;/&gt;
 		&lt;file name=&quot;drivers/block/virtio_blk.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/char/hw_random/virtio-rng.ko&quot;/&gt;
@@ -115,6 +116,7 @@
 		&lt;package name=&quot;lvm2&quot;/&gt;
 		&lt;package name=&quot;bzip2&quot;/&gt;
 		&lt;package name=&quot;kiwi-tools&quot;/&gt;
+		&lt;package name=&quot;cryptsetup&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;
diff --git a/system/boot/ix86/oemboot/suse-SLES11/config.xml b/system/boot/ix86/oemboot/suse-SLES11/config.xml
index 1765800..2720698 100644
--- a/system/boot/ix86/oemboot/suse-SLES11/config.xml
+++ b/system/boot/ix86/oemboot/suse-SLES11/config.xml
@@ -28,6 +28,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;crypto/*&quot;/&gt;
 		&lt;file name=&quot;drivers/virtio/*&quot;/&gt;
 		&lt;file name=&quot;drivers/block/virtio_blk.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/char/hw_random/virtio-rng.ko&quot;/&gt;
@@ -115,6 +116,7 @@
 		&lt;package name=&quot;lvm2&quot;/&gt;
 		&lt;package name=&quot;bzip2&quot;/&gt;
 		&lt;package name=&quot;kiwi-tools&quot;/&gt;
+		&lt;package name=&quot;cryptsetup&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;
diff --git a/system/boot/ix86/oemboot/suse-dump b/system/boot/ix86/oemboot/suse-dump
index 60aac8d..362f44c 100755
--- a/system/boot/ix86/oemboot/suse-dump
+++ b/system/boot/ix86/oemboot/suse-dump
@@ -270,13 +270,7 @@ function OEMInstall {
 	#======================================
 	# Reboot system
 	#--------------------------------------
-	#if [ &quot;$OEMInstallType&quot; = &quot;CD&quot; ];then
-	#	Echo &quot;NOTE: Please remove the installation CD before reboot !&quot;
-	#	CDEject
-	#else
-	#	Echo &quot;NOTE: Please unplug the USB stick before reboot !&quot;
-	#fi
-	#systemException \
-	#	&quot;System installation has finished&quot; \
-	#&quot;reboot&quot;
+	if [ &quot;$OEMInstallType&quot; = &quot;CD&quot; ];then
+		CDEject
+	fi
 }
diff --git a/system/boot/ix86/oemboot/suse-linuxrc b/system/boot/ix86/oemboot/suse-linuxrc
index b3fda00..0bc08b5 100755
--- a/system/boot/ix86/oemboot/suse-linuxrc
+++ b/system/boot/ix86/oemboot/suse-linuxrc
@@ -47,6 +47,97 @@ export OEM_PARTITION_CONFIG=&quot;/config.oempartition&quot;
 . /dump
 
 #======================================
+# Functions...
+#--------------------------------------
+function setupDeviceNames {
+	#======================================
+	# Check for DONT_PARTITION variable
+	#--------------------------------------
+	if [ ! -z &quot;$DONT_PARTITION&quot; ];then
+		return
+	fi
+	#======================================
+	# Check boot device
+	#--------------------------------------
+	if [ -z &quot;$imageDiskDevice&quot; ];then
+		systemException \
+			&quot;Couldn't find any boot device... abort&quot; \
+		&quot;reboot&quot;
+	fi
+	#======================================
+	# Set default filesystem device names
+	#--------------------------------------
+	export imageRWDevice=$imageDiskDevice&quot;2&quot;
+	export imageRODevice=$imageDiskDevice&quot;1&quot;
+	export imageIOWRDevice=$imageRWDevice
+	#======================================
+	# Check for LVM or standard boot
+	#--------------------------------------
+	if searchVolumeGroup; then
+		#======================================
+		# LVM setup...
+		#--------------------------------------
+		export haveLVM=yes
+		if [ -e /dev/kiwiVG/LVComp ];then
+			export imageRootDevice=/dev/kiwiVG/LVComp
+		else
+			export imageRootDevice=/dev/kiwiVG/LVRoot
+		fi
+		export imageRWDevice=/dev/kiwiVG/LVRoot
+		export imageRODevice=/dev/kiwiVG/LVComp
+		export imageIOWRDevice=$imageRWDevice
+		export imageBootDevice=$imageDiskDevice&quot;2&quot;
+		if [ ! -z &quot;$KIWI_RECOVERY&quot; ];then
+			export imageRecoveryDevice=/dev/kiwiVG/LVRecovery
+		fi
+		probeFileSystem $imageRootDevice
+	else
+		#======================================
+		# Standard setup
+		#--------------------------------------
+		if [ ! -z &quot;$KIWI_RECOVERY&quot; ];then
+			export imageRecoveryDevice=$imageDiskDevice&quot;4&quot;
+			export imageRootDevice=$imageDiskDevice&quot;2&quot;
+		else
+			for i in 1 2;do
+				export imageRootDevice=$imageDiskDevice$i
+				probeFileSystem $imageRootDevice
+				if [ ! &quot;$FSTYPE&quot; = &quot;unknown&quot; ];then
+					break
+				fi
+			done
+		fi
+	fi
+	#======================================
+	# Check for LUKS extension on root fs
+	#--------------------------------------
+	if [ &quot;$FSTYPE&quot; = &quot;luks&quot; ];then
+		imageRootDevice=$(luksOpen $imageRootDevice)
+		probeFileSystem $imageRootDevice
+		export haveLuks=yes
+	fi
+	#======================================
+	# Check root filesystem type
+	#--------------------------------------
+	if [ &quot;$FSTYPE&quot; = &quot;unknown&quot; ];then
+		systemException \
+			&quot;Couldn't determine filesystem type... abort&quot; \
+		&quot;reboot&quot;
+	fi
+	#======================================
+	# Check for LUKS extension on rw fs
+	#--------------------------------------
+	if isFSTypeReadOnly;then
+		FSTYPE_OLD=$FSTYPE
+		probeFileSystem $imageRWDevice
+		if [ &quot;$FSTYPE&quot; = &quot;luks&quot; ];then
+			export haveLuks=yes
+		fi
+		FSTYPE=$FSTYPE_OLD
+	fi
+}
+
+#======================================
 # Beautify Startup
 #--------------------------------------
 echo &quot;Loading KIWI OEM Boot-System...&quot;
@@ -142,72 +233,28 @@ if [ ! -z &quot;$OEM_SAP_INSTALL&quot; ];then
 fi
 
 #======================================
-# 11) Get filesystem type and boot ID
+# 11) Setup device names...
 #--------------------------------------
-export imageBootID=1
-probeFileSystem $imageDiskDevice$imageBootID
-if [ $FSTYPE = &quot;unknown&quot; ];then
-	imageBootID=2
-	probeFileSystem $imageDiskDevice$imageBootID
-	if [ $FSTYPE = &quot;unknown&quot; ];then
-		systemException \
-			&quot;Couldn't determine filesystem type... abort&quot; \
-		&quot;reboot&quot;
-	fi
-fi
+setupDeviceNames
 
 #======================================
-# 12) Setup device names...
+# 12) repartition the disk device
 #--------------------------------------
-export imageRootDevice=$imageDiskDevice$imageBootID
-export imageRWDevice=$imageDiskDevice&quot;2&quot;
-export imageRODevice=$imageDiskDevice&quot;1&quot;
-export imageIOWRDevice=$imageDiskDevice&quot;2&quot;
-if [ ! -z &quot;$KIWI_RECOVERY&quot; ];then
-	export imageRecoveryDevice=$imageDiskDevice&quot;4&quot;
-	export imageRootDevice=$imageDiskDevice&quot;2&quot;
-fi
-if [ -z &quot;$imageDiskDevice&quot; ];then
-	systemException \
-		&quot;Couldn't find any boot device... abort&quot; \
-	&quot;reboot&quot;
-fi
-Echo &quot;Searching for kiwiVG volume group...&quot;
-if searchVolumeGroup; then
-	export haveLVM=yes
-	if [ -e /dev/kiwiVG/LVComp ];then
-		export imageRootDevice=/dev/kiwiVG/LVComp
-	else
-		export imageRootDevice=/dev/kiwiVG/LVRoot
-	fi
-	export imageRWDevice=/dev/kiwiVG/LVRoot
-	export imageRODevice=/dev/kiwiVG/LVComp
-	export imageIOWRDevice=/dev/kiwiVG/LVRoot
-	export imageBootDevice=$imageDiskDevice&quot;2&quot;
-	if [ ! -z &quot;$KIWI_RECOVERY&quot; ];then
-		export imageRecoveryDevice=/dev/kiwiVG/LVRecovery
-	fi
-	probeFileSystem $imageRootDevice
+Echo &quot;Filesystem of OEM system is: $FSTYPE -&gt; $imageRootDevice&quot;
+if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
+	OEMRepart
 fi
 
 #======================================
-# 13) Check filesystem
+# 13) Check for read-only filesystem
 #--------------------------------------
-Echo &quot;Filesystem of OEM system is: $FSTYPE -&gt; $imageRootDevice&quot;
 if isFSTypeReadOnly;then
 	setupUnionFS $imageRWDevice $imageRODevice $unionFST
 	bootid=1
 fi
 
 #======================================
-# 14) repartition the disk device
-#--------------------------------------
-if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
-	OEMRepart
-fi
-
-#======================================
-# 15) Resize filesystem to full space
+# 14) Resize filesystem to full space
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	deviceResize=$imageRootDevice
@@ -232,11 +279,13 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 		if [ -z &quot;$DONT_PARTITION&quot; ];then
 			if [ &quot;$FSTYPE&quot; = &quot;reiserfs&quot; ];then
 				Echo &quot;Resize Reiser filesystem to full partition space...&quot;
+				luksResize $deviceResize
 				resize_reiserfs -q $deviceResize
 				INITRD_MODULES=&quot;$INITRD_MODULES reiserfs&quot;
 			fi
 			if [ &quot;$FSTYPE&quot; = &quot;ext2&quot; ];then
 				Echo &quot;Resize EXT2 filesystem to full partition space...&quot;
+				luksResize $deviceResize
 				resize2fs -f -F -p $deviceResize
 				Echo &quot;Checking EXT2 filesystem...&quot;
 				e2fsck -p $deviceResize
@@ -244,6 +293,7 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 			fi
 			if [ &quot;$FSTYPE&quot; = &quot;ext3&quot; ];then
 				Echo &quot;Resize EXT3 filesystem to full partition space...&quot;
+				luksResize $deviceResize
 				resize2fs -f -F -p $deviceResize
 				Echo &quot;Checking EXT3 filesystem...&quot;
 				e2fsck -p $deviceResize
@@ -251,6 +301,7 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 			fi
 			if [ &quot;$FSTYPE&quot; = &quot;ext4&quot; ];then
 				Echo &quot;Resize EXT4 filesystem to full partition space...&quot;
+				luksResize $deviceResize
 				resize2fs -f -F -p $deviceResize
 				Echo &quot;Checking EXT4 filesystem...&quot;
 				e2fsck -p $deviceResize
@@ -267,7 +318,7 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 16) Mount system
+# 15) Mount system
 #--------------------------------------
 if ! mountSystem $imageRootDevice;then
 	systemException &quot;Failed to mount root filesystem&quot; &quot;reboot&quot;
@@ -275,7 +326,7 @@ fi
 validateRootTree
 
 #======================================
-# 17) Recover system if requested
+# 16) Recover system if requested
 #--------------------------------------
 if [ ! -z &quot;$KIWI_RECOVERY&quot; ];then
 	dialog --defaultno --yesno &quot;Do you want to start the System-Recovery ?&quot; 5 50
@@ -337,14 +388,14 @@ if [ ! -z &quot;$KIWI_RECOVERY&quot; ];then
 fi
 
 #======================================
-# 18) get installed kernels
+# 17) get installed kernels
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	kernelList /mnt
 fi
 
 #======================================
-# 19) setup boot partition
+# 18) setup boot partition
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ]; then
 	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
@@ -372,11 +423,26 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ]; then
 		test -f /tmp/mbrid &amp;&amp; mv /tmp/mbrid /mnt/dmboot/boot/grub
 		rm -rf /mnt/boot
 		( cd /mnt &amp;&amp; ln -s dmboot/boot boot )
+	elif [ &quot;$haveLuks&quot; = &quot;yes&quot; ];then
+		mkdir -p /mnt/luksboot
+		imageBootDevice=$imageDiskDevice&quot;2&quot;
+		bootid=1
+		if isFSTypeReadOnly;then
+			export imageBootDevice=$imageDiskDevice&quot;3&quot;
+			bootid=2
+		fi
+		mount $imageBootDevice /mnt/luksboot
+		cp -a /mnt/boot /mnt/luksboot
+		test -f /tmp/linux.vmx  &amp;&amp; mv /tmp/linux.vmx  /mnt/luksboot/boot
+		test -f /tmp/initrd.vmx &amp;&amp; mv /tmp/initrd.vmx /mnt/luksboot/boot
+		test -f /tmp/mbrid &amp;&amp; mv /tmp/mbrid /mnt/luksboot/boot/grub
+		rm -rf /mnt/boot
+		( cd /mnt &amp;&amp; ln -s luksboot/boot boot )
 	fi
 fi
 
 #======================================
-# 20) setup ird/kernel links for union
+# 19) setup ird/kernel links for union
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then 
 	if [ &quot;$OEM_KIWI_INITRD&quot; = &quot;yes&quot; ] || isFSTypeReadOnly;then
@@ -390,6 +456,8 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 			pushd /mnt/lvmboot/boot &gt;/dev/null
 		elif [ &quot;$haveDMSquash&quot; = &quot;yes&quot; ];then
 			pushd /mnt/dmboot/boot &gt;/dev/null
+		elif [ &quot;$haveLuks&quot; = &quot;yes&quot; ];then
+			pushd /mnt/luksboot/boot &gt;/dev/null
 		elif [ &quot;$OEM_KIWI_INITRD&quot; = &quot;yes&quot; ];then
 			pushd /mnt/boot &gt;/dev/null
 		else
@@ -416,7 +484,7 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 21) Create system dependant files
+# 20) Create system dependant files
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	#======================================
@@ -428,6 +496,8 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 		updateLVMBootDeviceFstab /config $imageBootDevice
 	elif [ &quot;$haveDMSquash&quot; = &quot;yes&quot; ];then
 		updateDMBootDeviceFstab /config $imageBootDevice
+	elif [ &quot;$haveLuks&quot; = &quot;yes&quot; ];then
+		updateLuksBootDeviceFstab /config $imageBootDevice
 	fi
 	if partitionSize $imageSwapDevice &amp;&gt;/dev/null;then
 		updateSwapDeviceFstab /config $imageSwapDevice
@@ -471,14 +541,14 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 22) copy system dependant files
+# 21) copy system dependant files
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	setupConfigFiles
 fi
 
 #======================================
-# 23) copy recovery related files
+# 22) copy recovery related files
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ] &amp;&amp; [ ! -z &quot;$OEM_RECOVERY&quot; ];then
 	IFS=$IFS_ORIG
@@ -510,22 +580,22 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ] &amp;&amp; [ ! -z &quot;$OEM_RECOVERY&quot; ];then
 fi
 
 #======================================
-# 24) update system dependant files
+# 23) update system dependant files
 #--------------------------------------
 setupInittab /mnt
 
 #======================================
-# 25) setup real root device
+# 24) setup real root device
 #--------------------------------------
 echo 256 &gt; /proc/sys/kernel/real-root-dev
 
 #======================================
-# 26) umount system filesystems
+# 25) umount system filesystems
 #--------------------------------------
 umountSystemFilesystems
 
 #======================================
-# 27) copy initrd files to image
+# 26) copy initrd files to image
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	importBranding
@@ -534,17 +604,17 @@ cp /preinit /mnt
 cp /include /mnt
 
 #======================================
-# 28) kill boot shell
+# 27) kill boot shell
 #--------------------------------------
 killShell
 killBlogD
 
 #======================================
-# 29) Activate new root
+# 28) Activate new root
 #--------------------------------------
 activateImage
 
 #======================================
-# 30 Unmount initrd / system init
+# 29 Unmount initrd / system init
 #--------------------------------------
 bootImage $@
diff --git a/system/boot/ix86/oemboot/suse-repart b/system/boot/ix86/oemboot/suse-repart
index 4bcacb7..5d3bdf9 100755
--- a/system/boot/ix86/oemboot/suse-repart
+++ b/system/boot/ix86/oemboot/suse-repart
@@ -141,35 +141,19 @@ function OEMRepartStandard {
 					#======================================
 					# -home +swap -recovery
 					#--------------------------------------
-					for cmd in \
+					createFDiskInput \
 						d n p 2 1 +&quot;$disk1MBytes&quot;M \
 						n p 1 . . \
-						t 1 82 \
-						a 2 w q
-					do
-						if [ $cmd = &quot;.&quot; ];then
-							echo &gt;&gt; $input
-							continue
-						fi
-						echo $cmd &gt;&gt; $input
-					done
+						t 1 82 w q
 				else
 					#======================================
 					# -home +swap +recovery
 					#--------------------------------------
-					for cmd in \
+					createFDiskInput \
 						d n p 2 1 +&quot;$disk1MBytes&quot;M \
 						n p 4 . +&quot;$recoMByte&quot;M \
 						n p 1 . . \
-						t 1 82 \
-						a 2 w q
-					do
-					if [ $cmd = &quot;.&quot; ];then
-						echo &gt;&gt; $input
-							continue
-						fi
-						echo $cmd &gt;&gt; $input
-					done
+						t 1 82 w q
 				fi
 			else
 				#======================================
@@ -179,31 +163,15 @@ function OEMRepartStandard {
 					#======================================
 					# -home -swap -recovery
 					#--------------------------------------
-					for cmd in \
-						d n p 2 . . \
-						a 2 w q
-					do
-						if [ $cmd = &quot;.&quot; ];then
-							echo &gt;&gt; $input
-							continue
-						fi
-						echo $cmd &gt;&gt; $input
-					done
+					createFDiskInput \
+						d n p 2 . . w q
 				else
 					#======================================
 					# -home -swap +recovery
 					#--------------------------------------
-					for cmd in \
+					createFDiskInput \
 						d n p 2 1 +&quot;$disk1MBytes&quot;M \
-						n p 4 . . \
-						a 2 w q
-					do
-						if [ $cmd = &quot;.&quot; ];then
-							echo &gt;&gt; $input
-							continue
-						fi
-						echo $cmd &gt;&gt; $input
-					done
+						n p 4 . .  w q
 				fi
 			fi
 		else
@@ -218,37 +186,21 @@ function OEMRepartStandard {
 					#======================================
 					# +home +swap -recovery
 					#--------------------------------------
-					for cmd in \
+					createFDiskInput \
 						d n p 2 1 +&quot;$disk1MBytes&quot;M \
 						n p 1 . +&quot;$swapsize&quot;M \
 						n p 3 . . \
-						t 1 82 \
-						a 2 w q
-					do
-						if [ $cmd = &quot;.&quot; ];then
-							echo &gt;&gt; $input
-							continue
-						fi
-						echo $cmd &gt;&gt; $input
-					done
+						t 1 82 w q
 				else
 					#======================================
 					# +home +swap +recovery
 					#--------------------------------------
-					for cmd in \
+					createFDiskInput \
 						d n p 2 1 +&quot;$disk1MBytes&quot;M \
 						n p 1 . +&quot;$swapsize&quot;M \
 						n p 4 . +&quot;$recoMByte&quot;M \
 						n p 3 . . \
-						t 1 82 \
-						a 2 w q
-					do
-						if [ $cmd = &quot;.&quot; ];then
-							echo &gt;&gt; $input
-							continue
-						fi
-						echo $cmd &gt;&gt; $input
-					done
+						t 1 82 w q
 				fi
 			else
 				#======================================
@@ -258,33 +210,17 @@ function OEMRepartStandard {
 					#======================================
 					# +home -swap -recovery
 					#--------------------------------------
-					for cmd in \
+					createFDiskInput \
 						d n p 2 1 +&quot;$disk1MBytes&quot;M \
-						n p 3 . . \
-						a 2 w q
-					do
-						if [ $cmd = &quot;.&quot; ];then
-							echo &gt;&gt; $input
-							continue
-						fi
-						echo $cmd &gt;&gt; $input
-					done
+						n p 3 . . w q
 				else
 					#======================================
 					# +home -swap +recovery
 					#--------------------------------------
-					for cmd in \
+					createFDiskInput \
 						d n p 2 1 +&quot;$disk1MBytes&quot;M \
 						n p 4 . +&quot;$recoMByte&quot;M \
-						n p 3 . . \
-						a 2 w q
-					do
-						if [ $cmd = &quot;.&quot; ];then
-							echo &gt;&gt; $input
-							continue
-						fi
-						echo $cmd &gt;&gt; $input
-					done
+						n p 3 . . w q
 				fi
 			fi
 		fi
@@ -293,24 +229,21 @@ function OEMRepartStandard {
 		if test $? != 0; then
 			systemException &quot;Failed to create partition table&quot; &quot;reboot&quot;
 		fi
-		activateBootPartition
 	fi
 	#======================================
 	# Update new device names
 	#--------------------------------------
 	if [ -z &quot;$DONT_PARTITION&quot; ];then
-		export imageRootDevice=$imageDiskDevice&quot;2&quot;
+		export imageRootDevice=$(luksOpen $imageDiskDevice&quot;2&quot;)
 		export imageSwapDevice=$imageDiskDevice&quot;1&quot;
+		if [ -z &quot;$OEM_WITHOUTHOME&quot; ];then
+			export imageHomeDevice=$imageDiskDevice&quot;3&quot;
+		fi
+		if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+			export imageRecoveryDevice=$imageDiskDevice&quot;4&quot;
+		fi
 		bootid=1
-	else
-		export imageRootDevice=$imageDiskDevice&quot;1&quot;
-		bootid=0
-	fi
-	if [ -z &quot;$OEM_WITHOUTHOME&quot; ];then
-		export imageHomeDevice=$imageDiskDevice&quot;3&quot;
-	fi
-	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
-		export imageRecoveryDevice=$imageDiskDevice&quot;4&quot;
+		activateBootPartition
 	fi
 }
 
@@ -394,46 +327,22 @@ function OEMRepartOverlayed {
 		rm -f $input
 		if [ $swapsize = 0 ];then
 			if [ &quot;$haveDMSquash&quot; = &quot;yes&quot; ];then
-				for cmd in d 2 n p 2 . +&quot;$disk2MBytes&quot;M n p 3 . . a 3 w q; do
-					if [ $cmd = &quot;.&quot; ];then
-						echo &gt;&gt; $input
-						continue
-					fi
-					echo $cmd &gt;&gt; $input
-				done
+				createFDiskInput \
+					d 2 n p 2 . +&quot;$disk2MBytes&quot;M n p 3 . . w q
 			else
-				for cmd in d 2 n p 2 . . a 2 w q; do
-					if [ $cmd = &quot;.&quot; ];then
-						echo &gt;&gt; $input
-						continue
-					fi
-					echo $cmd &gt;&gt; $input
-				done
+				createFDiskInput \
+					d 2 n p 2 . . w q
 			fi
 		else
 			if [ &quot;$haveDMSquash&quot; = &quot;yes&quot; ];then
-				for cmd in \
+				createFDiskInput \
 					d 2 n p 2 . +&quot;$disk2MBytes&quot;M \
 					n p 3 . +&quot;$bootXMBytes&quot;M n p 4 . . \
-					t 4 82 a 3 w q
-				do
-					if [ $cmd = &quot;.&quot; ];then
-						echo &gt;&gt; $input
-						continue
-					fi
-					echo $cmd &gt;&gt; $input
-				done
+					t 4 82 w q
 			else
-				for cmd in \
+				createFDiskInput \
 					d 2 n p 2 . +&quot;$disk2MBytes&quot;M n p 3 . . \
-					t 3 82 a 2 w q
-				do
-					if [ $cmd = &quot;.&quot; ];then
-						echo &gt;&gt; $input
-						continue
-					fi
-					echo $cmd &gt;&gt; $input
-				done
+					t 3 82 w q
 			fi
 		fi
 		Echo &quot;Repartition the disk according to current geometry&quot;
@@ -441,24 +350,28 @@ function OEMRepartOverlayed {
 		if test $? != 0; then
 			systemException &quot;Failed to create partition table&quot; &quot;reboot&quot;
 		fi
-		activateBootPartition
 	fi
 	#======================================
 	# Update new device names
 	#--------------------------------------
-	export imageRootDevice=$imageDiskDevice&quot;1&quot;
-	export imageIOWRDevice=$imageDiskDevice&quot;2&quot;
-	if [ ! $swapsize = 0 ];then
+	if [ -z &quot;$DONT_PARTITION&quot; ];then
+		export imageRootDevice=$(luksOpen $imageDiskDevice&quot;1&quot;)
+		export imageIOWRDevice=$(luksOpen $imageDiskDevice&quot;2&quot; luksReadWrite)
+		export imageRWDevice=$imageIOWRDevice
+		export imageRODevice=$imageRootDevice
+		if [ ! $swapsize = 0 ];then
+			if [ &quot;$haveDMSquash&quot; = &quot;yes&quot; ];then
+				export imageSwapDevice=$imageDiskDevice&quot;4&quot;
+			else
+				export imageSwapDevice=$imageDiskDevice&quot;3&quot;
+			fi
+		fi
 		if [ &quot;$haveDMSquash&quot; = &quot;yes&quot; ];then
-			export imageSwapDevice=$imageDiskDevice&quot;4&quot;
+			bootid=2
 		else
-			export imageSwapDevice=$imageDiskDevice&quot;3&quot;
+			bootid=1
 		fi
-	fi
-	if [ &quot;$haveDMSquash&quot; = &quot;yes&quot; ];then
-		bootid=2
-	else
-		bootid=1
+		activateBootPartition
 	fi
 	#======================================
 	# Create bootfs if DM squash setup
@@ -466,7 +379,7 @@ function OEMRepartOverlayed {
 	if [ &quot;$haveDMSquash&quot; = &quot;yes&quot; ];then
 		export imageBootDevice=$imageDiskDevice&quot;3&quot;
 		if ! mke2fs -T ext2 -q $imageBootDevice &gt;/dev/null 2&gt;&amp;1;then
-			systemException &quot;Failed to create Boot fs&quot; &quot;reboot&quot;
+			systemException &quot;Failed to create Boot filesystem&quot; &quot;reboot&quot;
 		fi
 	fi
 }
@@ -544,36 +457,30 @@ function OEMRepartCombined {
 		input=/part.input
 		rm -f $input
 		if [ $swapsize = 0 ];then
-			for cmd in d 2 n p 2 . . a 2 w q;do
-				if [ $cmd = &quot;.&quot; ];then
-					echo &gt;&gt; $input
-					continue
-				fi
-				echo $cmd &gt;&gt; $input
-			done
+			createFDiskInput \
+				d 2 n p 2 . . w q
 		else
-			for cmd in d 2 n p 2 . +&quot;$disk2MBytes&quot;M n p 3 . . t 3 82 a 2 w q;do
-				if [ $cmd = &quot;.&quot; ];then
-					echo &gt;&gt; $input
-					continue
-				fi
-				echo $cmd &gt;&gt; $input
-			done
+			createFDiskInput \
+				d 2 n p 2 . +&quot;$disk2MBytes&quot;M n p 3 . . t 3 82 w q
 		fi
 		Echo &quot;Repartition the disk according to current geometry&quot;
 		fdisk $imageDiskDevice &lt; $input 1&gt;&amp;2
 		if test $? != 0; then
 			systemException &quot;Failed to create partition table&quot; &quot;reboot&quot;
 		fi
-		activateBootPartition
 	fi
 	#======================================
 	# Update new device names
 	#--------------------------------------
-	export imageRootDevice=$imageDiskDevice&quot;1&quot;
-	export imageSwapDevice=$imageDiskDevice&quot;3&quot;
-	export imageIOWRDevice=$imageDiskDevice&quot;2&quot;
-	bootid=1
+	if [ -z &quot;$DONT_PARTITION&quot; ];then
+		export imageRootDevice=$(luksOpen $imageDiskDevice&quot;1&quot;)
+		export imageSwapDevice=$imageDiskDevice&quot;3&quot;
+		export imageIOWRDevice=$(luksOpen $imageDiskDevice&quot;2&quot; luksReadWrite)
+		export imageRWDevice=$imageIOWRDevice
+		export imageRODevice=$imageRootDevice
+		bootid=1
+		activateBootPartition
+	fi
 }
 
 #======================================
@@ -604,18 +511,18 @@ function OEMRepartLVM {
 	vgchange -an
 	input=/part.input
 	rm -f $input
-	for cmd in n p 3 . . t 3 8e a 2 w q;do
-		if [ $cmd = &quot;.&quot; ];then
-			echo &gt;&gt; $input
-			continue
-		fi
-		echo $cmd &gt;&gt; $input
-	done
+	createFDiskInput \
+		n p 3 . . t 3 8e w q
+	luksClose
 	Echo &quot;Extending volume group according to current geometry&quot;
 	fdisk $imageDiskDevice &lt; $input 1&gt;&amp;2
 	if test $? != 0; then
 		systemException &quot;Failed to create partition table&quot; &quot;reboot&quot;
 	fi
+	#======================================
+	# Set boot id
+	#--------------------------------------
+	bootid=1
 	activateBootPartition
 	vgchange -a y kiwiVG
 	pvcreate $imageDiskDevice&quot;3&quot;
@@ -667,10 +574,143 @@ function OEMRepartLVM {
 			lvextend -l 100%FREE /dev/kiwiVG/LVRoot
 		fi
 	fi
+}
+
+#======================================
+# OEMRepartLuks
+#--------------------------------------
+function OEMRepartLuks {
+	#====================================== 
+	# no recovery support for LUKS mode
+	#--------------------------------------
+	unset OEM_RECOVERY
+	#====================================== 
+	# no homepart support for LUKS mode
+	#--------------------------------------
+	export OEM_WITHOUTHOME=1
+	#====================================== 
+	# Store kiwi kernel and initrd
+	#--------------------------------------
+	if isFSTypeReadOnly;then
+		mount $imageDiskDevice&quot;3&quot; /mnt
+		cp /mnt/boot/linux.vmx  /tmp
+		cp /mnt/boot/initrd.vmx /tmp
+		cp /mnt/boot/grub/mbrid /tmp
+		umount /mnt
+	fi
 	#======================================
-	# Set boot id
+	# calculate end block - swapspace
 	#--------------------------------------
-	bootid=1
+	swapXMBytes=$swapsize
+	bootXMBytes=0
+	if [ &quot;$haveLuks&quot; = &quot;yes&quot; ];then
+		bootXMBytes=40
+	fi
+	diskXMBytes=`partitionSize $imageDiskDevice`
+	diskXMBytes=`expr $diskXMBytes / 1024`
+	disk1MBytes=`partitionSize $imageDiskDevice&quot;1&quot;`
+	disk1MBytes=`expr $disk1MBytes / 1024`
+	disk2MBytes=`expr $diskXMBytes - $disk1MBytes - $swapsize - $bootXMBytes`
+	if ! isFSTypeReadOnly;then
+		disk1MBytes=`expr $diskXMBytes - $swapsize - $bootXMBytes`
+		disk2MBytes=$disk1MBytes
+	fi
+	if [ $disk2MBytes -lt 100 ];then
+		# /.../
+		# Very small disk which we will not re-partition
+		# ----
+		Echo &quot;Disk is too small, will not re-partition it&quot;
+		DONT_PARTITION=1
+	fi
+	if [ -z &quot;$DONT_PARTITION&quot; ];then
+		#======================================
+		# write new partition table
+		#--------------------------------------
+		# /.../
+		# Explanation of the partition commands used within the
+		# here document below:
+		# ----
+		# d               # delete xda partition
+		# 2               # [ 2 ]
+		# d               # delete xda partition
+		# n               # create xda partition at same place than xda1
+		# p               # primary
+		# 1               # [ 1 ]
+		#                 # accept old xda1 start block
+		# +&quot;disk1MBytes&quot;M # accept new root device size - swap - boot
+		# n               # create xda boot partition
+		# p               # primary
+		# 2               # [ 2 ]
+		#                 # accept start block
+		# +&quot;bootXMBytes&quot;M # accept bootMBytes for boot
+		# n               # create xda swap partition
+		# p               # primary
+		# 3               # [ 3 ]
+		#                 # accept start block
+		#                 # accept end block
+		# t               # change swap system id
+		# 3               # [ 3 ]
+		# 82              # Linux Swap
+		# w               # write partition table
+		# ----
+		input=/part.input
+		rm -f $input
+		if [ $swapsize = 0 ];then
+			if isFSTypeReadOnly;then
+				createFDiskInput \
+					d 2 d 3 n p 2 . +&quot;$disk2MBytes&quot;M n p 3 . . w q
+			else
+				createFDiskInput \
+					d 2 d n p 1 . +&quot;$disk1MBytes&quot;M n p 2 . . w q
+			fi
+		else
+			if isFSTypeReadOnly;then
+				createFDiskInput \
+					d 2 d 3 n p 2 . +&quot;$disk2MBytes&quot;M \
+					n p 3 . +&quot;$bootXMBytes&quot;M \
+					n p 4 . . \
+					t 4 82 w q
+			else
+				createFDiskInput \
+					d 2 d n p 1 . +&quot;$disk1MBytes&quot;M \
+					n p 2 . +&quot;$bootXMBytes&quot;M \
+					n p 3 . . \
+					t 3 82 w q
+			fi
+		fi
+		luksClose
+		Echo &quot;Repartition the disk according to current geometry&quot;
+		fdisk $imageDiskDevice &lt; $input 1&gt;&amp;2
+		if test $? != 0; then
+			systemException &quot;Failed to create partition table&quot; &quot;reboot&quot;
+		fi
+	fi
+	#======================================
+	# Update new device names
+	#--------------------------------------
+	if [ -z &quot;$DONT_PARTITION&quot; ];then
+		bootid=1
+		if isFSTypeReadOnly;then
+			bootid=2
+		fi
+		activateBootPartition
+		export imageRootDevice=$(luksOpen $imageDiskDevice&quot;1&quot;)
+		export imageBootDevice=$imageDiskDevice&quot;2&quot;
+		export imageSwapDevice=$imageDiskDevice&quot;3&quot;
+		if isFSTypeReadOnly;then
+			export imageBootDevice=$imageDiskDevice&quot;3&quot;
+			export imageSwapDevice=$imageDiskDevice&quot;4&quot;
+			export imageIOWRDevice=$(luksOpen $imageDiskDevice&quot;2&quot; luksReadWrite)
+			export imageRWDevice=$imageIOWRDevice
+			export imageRODevice=$imageRootDevice
+		fi
+	fi
+	#======================================
+	# Create bootfs if DM squash setup
+	#--------------------------------------
+	if ! mke2fs -T ext2 -q $imageBootDevice &gt;/dev/null 2&gt;&amp;1;then
+		systemException &quot;Failed to create Boot filesystem&quot; &quot;reboot&quot;
+	fi
 }
 
 #======================================
@@ -692,9 +732,11 @@ function OEMRepart {
 	#--------------------------------------
 	if [ ! -z &quot;$haveLVM&quot; ];then
 		OEMRepartLVM
+	elif [ &quot;$haveLuks&quot; = &quot;yes&quot; ];then
+		OEMRepartLuks
 	elif [ ! -z &quot;$COMBINED_IMAGE&quot; ];then
 		OEMRepartCombined
-	elif [ ! -z &quot;$UNIONFS_CONFIG&quot; ];then
+	elif isFSTypeReadOnly;then
 		OEMRepartOverlayed
 	else
 		OEMRepartStandard
@@ -713,16 +755,16 @@ function OEMRepart {
 	#======================================
 	# Create home file system
 	#--------------------------------------
-	if [ -z &quot;$OEM_WITHOUTHOME&quot; ];then
+	if [ -z &quot;$DONT_PARTITION&quot; ] &amp;&amp; [ -z &quot;$OEM_WITHOUTHOME&quot; ];then
 		Echo &quot;Creating Home filesystem on $imageHomeDevice&quot;
 		if ! mke2fs -T ext3 -j -q $imageHomeDevice &gt;/dev/null 2&gt;&amp;1;then
-			systemException &quot;Failed to create Home fs&quot; &quot;reboot&quot;
+			systemException &quot;Failed to create Home filesystem&quot; &quot;reboot&quot;
 		fi
 	fi
 	#======================================
 	# Create recovery file system
 	#--------------------------------------
-	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+	if [ -z &quot;$DONT_PARTITION&quot; ] &amp;&amp; [ ! -z &quot;$OEM_RECOVERY&quot; ];then
 		Echo &quot;Creating Recovery filesystem on $imageRecoveryDevice&quot;
 		if ! mke2fs -T ext3 -j -q $imageRecoveryDevice &gt;/dev/null 2&gt;&amp;1;then
 			systemException &quot;Failed to create Recovery fs&quot; &quot;reboot&quot;
@@ -731,7 +773,7 @@ function OEMRepart {
 	#======================================
 	# Setup recovery contents
 	#--------------------------------------
-	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+	if [ -z &quot;$DONT_PARTITION&quot; ] &amp;&amp; [ ! -z &quot;$OEM_RECOVERY&quot; ];then
 		Echo &quot;Setting up recovery archive...&quot;
 		mkdir -p /reco-root
 		if ! mount $imageRootDevice /reco-root &gt;/dev/null;then
@@ -778,3 +820,18 @@ function activateBootPartition {
 		systemException &quot;Failed to set boot flag&quot; &quot;reboot&quot;
 	fi
 }
+
+#======================================
+# createFDiskInput
+#--------------------------------------
+function createFDiskInput {
+	local input=/part.input
+	rm -f $input
+	for cmd in $*;do
+		if [ $cmd = &quot;.&quot; ];then
+			echo &gt;&gt; $input
+			continue
+		fi
+		echo $cmd &gt;&gt; $input
+	done
+}
diff --git a/system/boot/ix86/vmxboot/suse-linuxrc b/system/boot/ix86/vmxboot/suse-linuxrc
index 346f013..4692044 100755
--- a/system/boot/ix86/vmxboot/suse-linuxrc
+++ b/system/boot/ix86/vmxboot/suse-linuxrc
@@ -152,6 +152,7 @@ fi
 probeFileSystem $imageRootDevice
 if [ &quot;$FSTYPE&quot; = &quot;luks&quot; ];then
 	imageRootDevice=$(luksOpen $imageRootDevice)
+	imageRODevice=$imageRootDevice
 	probeFileSystem $imageRootDevice
 	export haveLuks=yes
 fi
@@ -185,7 +186,7 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 13) setup /lvmboot or /syslboot
+# 13) setup boot partition 
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then


hooks/post-receive
-- 
Project kiwi at BerliOS

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001330.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 4a22528c995db91712aface86bbf17a1de00df36
</A></li>
	<LI>Next message: <A HREF="001332.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 54606b9ea536de612f5428f8148c21450d69d48a
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1331">[ date ]</a>
              <a href="thread.html#1331">[ thread ]</a>
              <a href="subject.html#1331">[ subject ]</a>
              <a href="author.html#1331">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
