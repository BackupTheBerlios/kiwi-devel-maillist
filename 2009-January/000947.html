<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] r1831 - in kiwi-head: . doc/examples/suse-10.3/suse-oem-preload doc/examples/suse-11.0/suse-oem-preload doc/examples/suse-11.1/suse-oem-preload modules rpm system/boot/ix86/oemboot system/boot/ix86/oemboot/suse-10.3 system/boot/ix86/oemboot/suse-10.3/root system/boot/ix86/oemboot/suse-11.0 system/boot/ix86/oemboot/suse-11.0/root system/boot/ix86/oemboot/suse-11.1 system/boot/ix86/oemboot/suse-11.1/root system/boot/ix86/oemboot/suse-SLED10 system/boot/ix86/oemboot/suse-SLED10/root system/boot/ix86/oemboot/suse-SLED11 system/boot/ix86/oemboot/suse-SLED11/root system/boot/ix86/oemboot/suse-SLES10 system/boot/ix86/oemboot/suse-SLES10/root system/boot/ix86/oemboot/suse-SLES11 system/boot/ix86/oemboot/suse-SLES11/root system/boot/ix86/vmxboot system/boot/ix86/vmxboot/suse-10.3 system/boot/ix86/vmxboot/suse-11.0 system/boot/ix86/vmxboot/suse-11.1 system/boot/ix86/vmxboot/suse-SLED10 system/boot/ix86/vmxboot/suse-SLED11 system/boot/ix86/vmxboot/suse-SLES10 system/boot/ix86/! vmxboot/suse-SLES11
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2009-January/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20r1831%20-%20in%20kiwi-head%3A%20.%0A%20doc/examples/suse-10.3/suse-oem-preload%0A%20doc/examples/suse-11.0/suse-oem-preload%0A%20doc/examples/suse-11.1/suse-oem-preload%20modules%20rpm%0A%20system/boot/ix86/oemboot%20system/boot/ix86/oemboot/suse-10.3%0A%20system/boot/ix86/oemboot/suse-10.3/root%20system/boot/ix86/oemboot/suse-11.0%0A%20system/boot/ix86/oemboot/suse-11.0/root%20system/boot/ix86/oemboot/suse-11.1%0A%20system/boot/ix86/oemboot/suse-11.1/root%0A%20system/boot/ix86/oemboot/suse-SLED10%0A%20system/boot/ix86/oemboot/suse-SLED10/root%0A%20system/boot/ix86/oemboot/suse-SLED11%0A%20system/boot/ix86/oemboot/suse-SLED11/root%0A%20system/boot/ix86/oemboot/suse-SLES10%0A%20system/boot/ix86/oemboot/suse-SLES10/root%0A%20system/boot/ix86/oemboot/suse-SLES11%0A%20system/boot/ix86/oemboot/suse-SLES11/root%20system/boot/ix86/vmxboot%0A%20system/boot/ix86/vmxboot/suse-10.3%20system/boot/ix86/vmxboot/suse-11.0%0A%20system/boot/ix86/vmxboot/suse-11.1%20system/boot/ix86/vmxboot/suse-SLED10%0A%20system/boot/ix86/vmxboot/suse-SLED11%20system/boot/ix86/vmxboot/suse-SLES10%0A%20system/boot/ix86/%21%20vmxboot/suse-SLES11&In-Reply-To=%3C200901081430.n08EUJER031121%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000946.html">
   <LINK REL="Next"  HREF="000948.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] r1831 - in kiwi-head: . doc/examples/suse-10.3/suse-oem-preload doc/examples/suse-11.0/suse-oem-preload doc/examples/suse-11.1/suse-oem-preload modules rpm system/boot/ix86/oemboot system/boot/ix86/oemboot/suse-10.3 system/boot/ix86/oemboot/suse-10.3/root system/boot/ix86/oemboot/suse-11.0 system/boot/ix86/oemboot/suse-11.0/root system/boot/ix86/oemboot/suse-11.1 system/boot/ix86/oemboot/suse-11.1/root system/boot/ix86/oemboot/suse-SLED10 system/boot/ix86/oemboot/suse-SLED10/root system/boot/ix86/oemboot/suse-SLED11 system/boot/ix86/oemboot/suse-SLED11/root system/boot/ix86/oemboot/suse-SLES10 system/boot/ix86/oemboot/suse-SLES10/root system/boot/ix86/oemboot/suse-SLES11 system/boot/ix86/oemboot/suse-SLES11/root system/boot/ix86/vmxboot system/boot/ix86/vmxboot/suse-10.3 system/boot/ix86/vmxboot/suse-11.0 system/boot/ix86/vmxboot/suse-11.1 system/boot/ix86/vmxboot/suse-SLED10 system/boot/ix86/vmxboot/suse-SLED11 system/boot/ix86/vmxboot/suse-SLES10 system/boot/ix86/! vmxboot/suse-SLES11</H1>
    <B>marcus_schaefer at mail.berlios.de</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20r1831%20-%20in%20kiwi-head%3A%20.%0A%20doc/examples/suse-10.3/suse-oem-preload%0A%20doc/examples/suse-11.0/suse-oem-preload%0A%20doc/examples/suse-11.1/suse-oem-preload%20modules%20rpm%0A%20system/boot/ix86/oemboot%20system/boot/ix86/oemboot/suse-10.3%0A%20system/boot/ix86/oemboot/suse-10.3/root%20system/boot/ix86/oemboot/suse-11.0%0A%20system/boot/ix86/oemboot/suse-11.0/root%20system/boot/ix86/oemboot/suse-11.1%0A%20system/boot/ix86/oemboot/suse-11.1/root%0A%20system/boot/ix86/oemboot/suse-SLED10%0A%20system/boot/ix86/oemboot/suse-SLED10/root%0A%20system/boot/ix86/oemboot/suse-SLED11%0A%20system/boot/ix86/oemboot/suse-SLED11/root%0A%20system/boot/ix86/oemboot/suse-SLES10%0A%20system/boot/ix86/oemboot/suse-SLES10/root%0A%20system/boot/ix86/oemboot/suse-SLES11%0A%20system/boot/ix86/oemboot/suse-SLES11/root%20system/boot/ix86/vmxboot%0A%20system/boot/ix86/vmxboot/suse-10.3%20system/boot/ix86/vmxboot/suse-11.0%0A%20system/boot/ix86/vmxboot/suse-11.1%20system/boot/ix86/vmxboot/suse-SLED10%0A%20system/boot/ix86/vmxboot/suse-SLED11%20system/boot/ix86/vmxboot/suse-SLES10%0A%20system/boot/ix86/%21%20vmxboot/suse-SLES11&In-Reply-To=%3C200901081430.n08EUJER031121%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] r1831 - in kiwi-head: . doc/examples/suse-10.3/suse-oem-preload doc/examples/suse-11.0/suse-oem-preload doc/examples/suse-11.1/suse-oem-preload modules rpm system/boot/ix86/oemboot system/boot/ix86/oemboot/suse-10.3 system/boot/ix86/oemboot/suse-10.3/root system/boot/ix86/oemboot/suse-11.0 system/boot/ix86/oemboot/suse-11.0/root system/boot/ix86/oemboot/suse-11.1 system/boot/ix86/oemboot/suse-11.1/root system/boot/ix86/oemboot/suse-SLED10 system/boot/ix86/oemboot/suse-SLED10/root system/boot/ix86/oemboot/suse-SLED11 system/boot/ix86/oemboot/suse-SLED11/root system/boot/ix86/oemboot/suse-SLES10 system/boot/ix86/oemboot/suse-SLES10/root system/boot/ix86/oemboot/suse-SLES11 system/boot/ix86/oemboot/suse-SLES11/root system/boot/ix86/vmxboot system/boot/ix86/vmxboot/suse-10.3 system/boot/ix86/vmxboot/suse-11.0 system/boot/ix86/vmxboot/suse-11.1 system/boot/ix86/vmxboot/suse-SLED10 system/boot/ix86/vmxboot/suse-SLED11 system/boot/ix86/vmxboot/suse-SLES10 system/boot/ix86/! vmxboot/suse-SLES11">marcus_schaefer at mail.berlios.de
       </A><BR>
    <I>Thu Jan  8 15:30:19 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000946.html">[Kiwi-devel] r1830 - kiwi-branches/KIWI-164-SuSE-10-3-Devel/rpm
</A></li>
        <LI>Next message: <A HREF="000948.html">[Kiwi-devel] r1832 - in kiwi-head: . modules rpm	system/boot/ix86/oemboot system/boot/ix86/usbboot	system/boot/ix86/usbboot/suse-10.3	system/boot/ix86/usbboot/suse-11.0	system/boot/ix86/usbboot/suse-11.1	system/boot/ix86/usbboot/suse-SLED10	system/boot/ix86/usbboot/suse-SLED11	system/boot/ix86/usbboot/suse-SLES10	system/boot/ix86/usbboot/suse-SLES11 system/boot/ix86/vmxboot
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#947">[ date ]</a>
              <a href="thread.html#947">[ thread ]</a>
              <a href="subject.html#947">[ subject ]</a>
              <a href="author.html#947">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: marcus_schaefer
Date: 2009-01-08 15:29:45 +0100 (Thu, 08 Jan 2009)
New Revision: 1831

Added:
   kiwi-head/system/boot/ix86/oemboot/suse-10.3/root/dump
   kiwi-head/system/boot/ix86/oemboot/suse-10.3/root/repart
   kiwi-head/system/boot/ix86/oemboot/suse-11.0/root/dump
   kiwi-head/system/boot/ix86/oemboot/suse-11.0/root/repart
   kiwi-head/system/boot/ix86/oemboot/suse-11.1/root/dump
   kiwi-head/system/boot/ix86/oemboot/suse-11.1/root/repart
   kiwi-head/system/boot/ix86/oemboot/suse-SLED10/root/dump
   kiwi-head/system/boot/ix86/oemboot/suse-SLED10/root/repart
   kiwi-head/system/boot/ix86/oemboot/suse-SLED11/root/dump
   kiwi-head/system/boot/ix86/oemboot/suse-SLED11/root/repart
   kiwi-head/system/boot/ix86/oemboot/suse-SLES10/root/dump
   kiwi-head/system/boot/ix86/oemboot/suse-SLES10/root/repart
   kiwi-head/system/boot/ix86/oemboot/suse-SLES11/root/dump
   kiwi-head/system/boot/ix86/oemboot/suse-SLES11/root/repart
   kiwi-head/system/boot/ix86/oemboot/suse-dump
   kiwi-head/system/boot/ix86/oemboot/suse-repart
Modified:
   kiwi-head/doc/examples/suse-10.3/suse-oem-preload/config.xml
   kiwi-head/doc/examples/suse-11.0/suse-oem-preload/config.xml
   kiwi-head/doc/examples/suse-11.1/suse-oem-preload/config.xml
   kiwi-head/kiwi.pl
   kiwi-head/modules/KIWIBoot.pm
   kiwi-head/modules/KIWIConfig.sh
   kiwi-head/modules/KIWILinuxRC.sh
   kiwi-head/rpm/kiwi.changes
   kiwi-head/rpm/kiwi.spec
   kiwi-head/system/boot/ix86/oemboot/README
   kiwi-head/system/boot/ix86/oemboot/suse-10.3/config.xml
   kiwi-head/system/boot/ix86/oemboot/suse-11.0/config.xml
   kiwi-head/system/boot/ix86/oemboot/suse-11.1/config.xml
   kiwi-head/system/boot/ix86/oemboot/suse-SLED10/config.xml
   kiwi-head/system/boot/ix86/oemboot/suse-SLED11/config.xml
   kiwi-head/system/boot/ix86/oemboot/suse-SLES10/config.xml
   kiwi-head/system/boot/ix86/oemboot/suse-SLES11/config.xml
   kiwi-head/system/boot/ix86/oemboot/suse-linuxrc
   kiwi-head/system/boot/ix86/oemboot/suse-preinit
   kiwi-head/system/boot/ix86/vmxboot/suse-10.3/config.xml
   kiwi-head/system/boot/ix86/vmxboot/suse-11.0/config.xml
   kiwi-head/system/boot/ix86/vmxboot/suse-11.1/config.xml
   kiwi-head/system/boot/ix86/vmxboot/suse-SLED10/config.xml
   kiwi-head/system/boot/ix86/vmxboot/suse-SLED11/config.xml
   kiwi-head/system/boot/ix86/vmxboot/suse-SLES10/config.xml
   kiwi-head/system/boot/ix86/vmxboot/suse-SLES11/config.xml
   kiwi-head/system/boot/ix86/vmxboot/suse-linuxrc
Log:

- v3.03
- added LVM support for vmxboot (bnc #447059)
- restructured/cleaned up oemboot boot code and prepared
  it for use with LVM, related to (bnc #447059)



Modified: kiwi-head/doc/examples/suse-10.3/suse-oem-preload/config.xml
===================================================================
--- kiwi-head/doc/examples/suse-10.3/suse-oem-preload/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/doc/examples/suse-10.3/suse-oem-preload/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -36,8 +36,12 @@
 	&lt;/packages&gt;
 	&lt;split&gt;
 		&lt;persistent&gt;
+			&lt;file name=&quot;/etc&quot;/&gt;
+			&lt;file name=&quot;/etc/*&quot;/&gt;
 			&lt;file name=&quot;/var&quot;/&gt;
 			&lt;file name=&quot;/var/*&quot;/&gt;
+			&lt;file name=&quot;/boot&quot;/&gt;
+			&lt;file name=&quot;/boot/*&quot;/&gt;
 		&lt;/persistent&gt;
 	&lt;/split&gt;
 &lt;/image&gt;

Modified: kiwi-head/doc/examples/suse-11.0/suse-oem-preload/config.xml
===================================================================
--- kiwi-head/doc/examples/suse-11.0/suse-oem-preload/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/doc/examples/suse-11.0/suse-oem-preload/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -35,8 +35,12 @@
 	&lt;/packages&gt;
 	&lt;split&gt;
 		&lt;persistent&gt;
+			&lt;file name=&quot;/etc&quot;/&gt;
+			&lt;file name=&quot;/etc/*&quot;/&gt;
 			&lt;file name=&quot;/var&quot;/&gt;
 			&lt;file name=&quot;/var/*&quot;/&gt;
+			&lt;file name=&quot;/boot&quot;/&gt;
+			&lt;file name=&quot;/boot/*&quot;/&gt;
 		&lt;/persistent&gt;
 	&lt;/split&gt;
 &lt;/image&gt;

Modified: kiwi-head/doc/examples/suse-11.1/suse-oem-preload/config.xml
===================================================================
--- kiwi-head/doc/examples/suse-11.1/suse-oem-preload/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/doc/examples/suse-11.1/suse-oem-preload/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -36,8 +36,12 @@
 	&lt;/packages&gt;
 	&lt;split&gt;
 		&lt;persistent&gt;
+			&lt;file name=&quot;/etc&quot;/&gt;
+			&lt;file name=&quot;/etc/*&quot;/&gt;
 			&lt;file name=&quot;/var&quot;/&gt;
 			&lt;file name=&quot;/var/*&quot;/&gt;
+			&lt;file name=&quot;/boot&quot;/&gt;
+			&lt;file name=&quot;/boot/*&quot;/&gt;
 		&lt;/persistent&gt;
 	&lt;/split&gt;
 &lt;/image&gt;

Modified: kiwi-head/kiwi.pl
===================================================================
--- kiwi-head/kiwi.pl	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/kiwi.pl	2009-01-08 14:29:45 UTC (rev 1831)
@@ -44,7 +44,7 @@
 #============================================
 # Globals (Version)
 #--------------------------------------------
-our $Version       = &quot;3.02&quot;;
+our $Version       = &quot;3.03&quot;;
 our $Publisher     = &quot;SUSE LINUX Products GmbH&quot;;
 our $Preparer      = &quot;KIWI - <A HREF="http://kiwi.berlios.de">http://kiwi.berlios.de</A>&quot;;
 our $openSUSE      = &quot;<A HREF="http://download.opensuse.org">http://download.opensuse.org</A>&quot;;
@@ -198,6 +198,7 @@
 our $TargetArch;            # target architecture -&gt; writes zypp.conf
 our $InstSourceLocal;       # create installation source from local metadata
 our $CheckKernel;           # check for kernel matches in boot and system image
+our $LVM;                   # use LVM partition setup for virtual disk
 our $kiwi;                  # global logging handler object
 
 #============================================
@@ -1058,7 +1059,7 @@
 		}
 		$boot = new KIWIBoot (
 			$kiwi,$BootVMDisk,$BootVMSystem,
-			$BootVMSize,undef,$BootVMFormat
+			$BootVMSize,undef,$BootVMFormat,$LVM
 		);
 		if (! defined $boot) {
 			my $code = kiwiExit (1); return $code;
@@ -1161,6 +1162,7 @@
 		&quot;instsource-local&quot;      =&gt; \$InstSourceLocal,
 		&quot;target-arch=s&quot;         =&gt; \$TargetArch,
 		&quot;check-kernel&quot;          =&gt; \$CheckKernel,
+		&quot;lvm&quot;                   =&gt; \$LVM,
 		&quot;help|h&quot;                =&gt; \&amp;usage,
 		&quot;&lt;&gt;&quot;                    =&gt; \&amp;usage
 	);
@@ -1480,6 +1482,13 @@
 	print &quot;    will temporarly overwrite the value set in the xml\n&quot;;
 	print &quot;    description\n&quot;;
 	print &quot;\n&quot;;
+	print &quot;  [ --lvm ]\n&quot;;
+	print &quot;    use the logical volume manager to control the disk\n&quot;;
+	print &quot;    the partition table will include one lvm partition and\n&quot;;
+	print &quot;    one standard ext2 boot partition. Use of this option\n&quot;;
+	print &quot;    makes sense for the create step only and also only for\n&quot;;
+	print &quot;    the image types: vmx, oem and usb\n&quot;;
+	print &quot;\n&quot;;
 	print &quot;  [ --fs-blocksize &lt;number&gt; ]\n&quot;;
 	print &quot;    When calling kiwi in creation mode this option will set\n&quot;;
 	print &quot;    the block size in bytes. For ISO images with the old style\n&quot;;

Modified: kiwi-head/modules/KIWIBoot.pm
===================================================================
--- kiwi-head/modules/KIWIBoot.pm	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/modules/KIWIBoot.pm	2009-01-08 14:29:45 UTC (rev 1831)
@@ -63,6 +63,7 @@
 	my $vmsize = shift;
 	my $device = shift;
 	my $format = shift;
+	my $lvm    = shift;
 	#==========================================
 	# Constructor setup
 	#------------------------------------------
@@ -343,6 +344,7 @@
 	$this-&gt;{xengz}  = $xengz;
 	$this-&gt;{arch}   = $arch;
 	$this-&gt;{ptool}  = $main::Partitioner;
+	$this-&gt;{lvm}    = $lvm;
 	return $this;
 }
 
@@ -1576,13 +1578,16 @@
 	my $zipped    = $this-&gt;{zipped};
 	my $isxen     = $this-&gt;{isxen};
 	my $xengz     = $this-&gt;{xengz};
+	my $lvm       = $this-&gt;{lvm};
 	my $diskname  = $system.&quot;.raw&quot;;
 	my %deviceMap = ();
 	my @commands  = ();
+	my $VGroup    = &quot;kiwiVG&quot;;
 	my $imgtype   = &quot;vmx&quot;;
 	my $bootfix   = &quot;VMX&quot;;
 	my $haveTree  = 0;
 	my $haveSplit = 0;
+	my $lvmbootMB = 0;
 	my $splitfile;
 	my $version;
 	my $label;
@@ -1595,6 +1600,12 @@
 	my $destdir;
 	my $xml;
 	#==========================================
+	# add boot space if lvm based
+	#------------------------------------------
+	if ($lvm) {
+		$lvmbootMB = 30;
+	}
+	#==========================================
 	# check if image type is oem
 	#------------------------------------------
 	if ($initrd =~ /oemboot/) {
@@ -1677,9 +1688,11 @@
 	if ($imgtype eq &quot;split&quot;) {
 		if (-f $splitfile) {
 			my $splitsize = -s $splitfile; $splitsize /= 1048576;
-			$vmsize = $this-&gt;{vmmbyte} + $splitsize * 1.3;
+			$vmsize = $this-&gt;{vmmbyte} + ($splitsize * 1.3) + $lvmbootMB;
 			$vmsize = sprintf (&quot;%.0f&quot;, $vmsize);
+			$this-&gt;{vmmbyte} = $vmsize;
 			$vmsize = $vmsize.&quot;M&quot;;
+			$this-&gt;{vmsize}  = $vmsize;
 			$haveSplit = 1;
 		}
 	}
@@ -1714,7 +1727,7 @@
 	# Setup boot partition ID
 	#------------------------------------------
 	my $bootpart = &quot;0&quot;;
-	if (($syszip) || ($haveSplit)) {
+	if (($syszip) || ($haveSplit) || ($lvm)) {
 		$bootpart = &quot;1&quot;;
 	}
 	$this-&gt;{bootpart} = $bootpart;
@@ -1765,15 +1778,24 @@
 		#==========================================
 		# create virtual disk partition
 		#------------------------------------------
-		if (($syszip) || ($haveSplit)) {
-			# xda1 ro / xda2 rw
+		if (! $lvm) {
+			if (($syszip) || ($haveSplit)) {
+				# xda1 ro / xda2 rw
+				@commands = (
+					&quot;n&quot;,&quot;p&quot;,&quot;1&quot;,&quot;.&quot;,&quot;+&quot;.$syszip.&quot;M&quot;,
+					&quot;n&quot;,&quot;p&quot;,&quot;2&quot;,&quot;.&quot;,&quot;.&quot;,&quot;w&quot;,&quot;q&quot;
+				);
+			} else {
+				# xda1 rw
+				@commands = ( &quot;n&quot;,&quot;p&quot;,&quot;1&quot;,&quot;.&quot;,&quot;.&quot;,&quot;w&quot;,&quot;q&quot;);
+			}
+		} else {
+			my $lvmsize = $this-&gt;{vmmbyte} - $lvmbootMB;
 			@commands = (
-				&quot;n&quot;,&quot;p&quot;,&quot;1&quot;,&quot;.&quot;,&quot;+&quot;.$syszip.&quot;M&quot;,
-				&quot;n&quot;,&quot;p&quot;,&quot;2&quot;,&quot;.&quot;,&quot;.&quot;,&quot;w&quot;,&quot;q&quot;
+				&quot;n&quot;,&quot;p&quot;,&quot;1&quot;,&quot;.&quot;,&quot;+&quot;.$lvmsize.&quot;M&quot;,
+				&quot;n&quot;,&quot;p&quot;,&quot;2&quot;,&quot;.&quot;,&quot;.&quot;,
+				&quot;t&quot;,&quot;1&quot;,&quot;8e&quot;,&quot;w&quot;,&quot;q&quot;
 			);
-		} else {
-			# xda1 rw
-			@commands = ( &quot;n&quot;,&quot;p&quot;,&quot;1&quot;,&quot;.&quot;,&quot;.&quot;,&quot;w&quot;,&quot;q&quot;);
 		}
 		if (! $this -&gt; setStoragePartition ($this-&gt;{loop},\@commands)) {
 			$kiwi -&gt; failed ();
@@ -1798,6 +1820,62 @@
 			$this -&gt; cleanLoop ();
 			return undef;
 		}
+		#==========================================
+		# setup volume group if requested
+		#------------------------------------------
+		if ($lvm) {
+			$status = qxx (&quot;vgremove --force $VGroup 2&gt;&amp;1&quot;);
+			$status = qxx (&quot;pvcreate $deviceMap{1} 2&gt;&amp;1&quot;);
+			$result = $? &gt;&gt; 8;
+			if ($result != 0) {
+				$kiwi -&gt; failed ();
+				$kiwi -&gt; error  (&quot;Failed creating physical extends: $status&quot;);
+				$kiwi -&gt; failed ();
+				$this -&gt; cleanLoop ();
+				return undef;
+			}
+			$status = qxx (&quot;vgcreate kiwiVG $deviceMap{1} 2&gt;&amp;1&quot;);
+			$result = $? &gt;&gt; 8;
+			if ($result != 0) {
+				$kiwi -&gt; failed ();
+				$kiwi -&gt; error  (&quot;Failed creating volume group: $status&quot;);
+				$kiwi -&gt; failed ();
+				$this -&gt; cleanLoop ();
+				return undef;
+			}
+			if (($syszip) || ($haveSplit)) {
+				$status = qxx (&quot;lvcreate -L $syszip -n LVComp $VGroup 2&gt;&amp;1&quot;);
+				$result = $? &gt;&gt; 8;
+				$status.= qxx (&quot;lvcreate -l 100%FREE -n LVRoot $VGroup 2&gt;&amp;1&quot;);
+				$result+= $? &gt;&gt; 8;
+				if ($result != 0) {
+					$kiwi -&gt; failed ();
+					$kiwi -&gt; error  (&quot;Logical volume(s) setup failed: $status&quot;);
+					$kiwi -&gt; failed ();
+					$this -&gt; cleanLoop ();
+					return undef;
+				}
+				%deviceMap = $this -&gt; setLVMDeviceMap (
+					$VGroup,$this-&gt;{loop},[&quot;LVComp&quot;,&quot;LVRoot&quot;]
+				);
+			} else {
+				$status = qxx (&quot;lvcreate -l 100%FREE -n LVRoot $VGroup 2&gt;&amp;1&quot;);
+				$result = $? &gt;&gt; 8;
+				if ($result != 0) {
+					$kiwi -&gt; failed ();
+					$kiwi -&gt; error  (&quot;Logical volume(s) setup failed: $status&quot;);
+					$kiwi -&gt; failed ();
+					$this -&gt; cleanLoop ();
+					return undef;
+				}
+				%deviceMap = $this -&gt; setLVMDeviceMap (
+					$VGroup,$this-&gt;{loop},[&quot;LVRoot&quot;]
+				);
+			}
+		}
+		#==========================================
+		# set root device name from deviceMap
+		#------------------------------------------
 		$root = $deviceMap{1};
 		#==========================================
 		# check partition sizes
@@ -1816,8 +1894,12 @@
 				#==========================================
 				# bad partition alignment try again
 				#------------------------------------------
-				sleep (1); qxx (&quot;/sbin/kpartx  -d $this-&gt;{loop}&quot;);
-				sleep (1); qxx (&quot;/sbin/losetup -d $this-&gt;{loop}&quot;); 
+				sleep (1);
+				if ($lvm) {
+					qxx (&quot;vgremove --force $VGroup 2&gt;&amp;1&quot;);
+				}
+				qxx (&quot;/sbin/kpartx  -d $this-&gt;{loop}&quot;);
+				qxx (&quot;/sbin/losetup -d $this-&gt;{loop}&quot;);
 			} else {
 				#==========================================
 				# looks good go for it
@@ -1993,9 +2075,12 @@
 	#==========================================
 	# create read/write filesystem if needed
 	#------------------------------------------
-	if (($syszip) || ($haveSplit)) {
+	if (($syszip) || ($haveSplit) || ($lvm)) {
 		$root = $deviceMap{2};
-		if (! $haveSplit) {
+		if ($lvm) {
+			$root = $deviceMap{0};
+		}
+		if ((! $haveSplit) || ($lvm)) {
 			$kiwi -&gt; info (&quot;Creating ext2 read-write filesystem&quot;);
 			my %FSopts = main::checkFSOptions();
 			my $fsopts = $FSopts{ext2};
@@ -2045,6 +2130,9 @@
 	#==========================================
 	# cleanup device maps and part mount
 	#------------------------------------------
+	if ($lvm) {
+		qxx (&quot;vgchange -an 2&gt;&amp;1&quot;);
+	}
 	qxx (&quot;/sbin/kpartx -d $this-&gt;{loop}&quot;);
 	#==========================================
 	# Install boot loader on virtual disk
@@ -2476,6 +2564,7 @@
 	my $loopdir= $this-&gt;{loopdir};
 	qxx (&quot;umount $loopdir 2&gt;&amp;1&quot;);
 	if (defined $loop) {
+		qxx (&quot;vgchange -an 2&gt;&amp;1&quot;);
 		qxx (&quot;/sbin/kpartx  -d $loop 2&gt;&amp;1&quot;);
 		qxx (&quot;/sbin/losetup -d $loop 2&gt;&amp;1&quot;);
 		undef $this-&gt;{loop};
@@ -3431,4 +3520,29 @@
 	return %result;
 }
 
+#==========================================
+# setLVMDeviceMap
+#------------------------------------------
+sub setLVMDeviceMap {
+	# ...
+	# set LVM device map which creates a mapping for
+	# /dev/VG/name volume group device names to a number
+	# ---
+	my $this   = shift;
+	my $group  = shift;
+	my $device = shift;
+	my $names  = shift;
+	my @names  = @{$names};
+	my %result;
+	if (! defined $group) {
+		return undef;
+	}
+	my $dmap = $device; $dmap =~ s/dev\///;
+	$result{0} = &quot;/dev/mapper&quot;.$dmap.&quot;p2&quot;;
+	for (my $i=0;$i&lt;@names;$i++) {
+		$result{$i+1} = &quot;/dev/$group/&quot;.$names[$i];
+	}
+	return %result;
+}
+
 1; 

Modified: kiwi-head/modules/KIWIConfig.sh
===================================================================
--- kiwi-head/modules/KIWIConfig.sh	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/modules/KIWIConfig.sh	2009-01-08 14:29:45 UTC (rev 1831)
@@ -932,6 +932,7 @@
 		usb_id ata_id vol_id edd_id setctsid dumpe2fs debugreiserfs
 		fuser udevadm blogd showconsole killproc curl tar cromfs-driver
 		cvcromfs ldd driveready checkmedia splashy bzip2 hexdump
+		pvchange pvresize pvscan vgscan vgchange vgextend
 	&quot;
 	tools=&quot;$tools $@&quot;
 	for path in /sbin /usr/sbin /usr/bin /bin;do

Modified: kiwi-head/modules/KIWILinuxRC.sh
===================================================================
--- kiwi-head/modules/KIWILinuxRC.sh	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/modules/KIWILinuxRC.sh	2009-01-08 14:29:45 UTC (rev 1831)
@@ -46,7 +46,7 @@
 	# print a message to the controling terminal
 	# ----
 	local option=&quot;&quot;
-	local prefix=&quot;-----&gt;&quot;
+	local prefix=&quot;===&gt;&quot;
 	local optn=&quot;&quot;
 	local opte=&quot;&quot;
 	while getopts &quot;bne&quot; option;do
@@ -485,7 +485,7 @@
 	# fourth primary partition of the disk
 	# ----
 	local input=/grub.input
-	echo &quot;device (hd0) $deviceDisk&quot; &gt; $input
+	echo &quot;device (hd0) $imageDiskDevice&quot; &gt; $input
 	echo &quot;root (hd0,3)&quot;  &gt;&gt; $input
 	echo &quot;setup (hd0,3)&quot; &gt;&gt; $input
 	echo &quot;quit&quot;          &gt;&gt; $input
@@ -685,42 +685,36 @@
 	# create recovery menu.lst
 	#--------------------------------------
 	echo &quot;timeout 0&quot; &gt; $menu
-	local count=1
-	IFS=&quot;,&quot; ; for i in $KERNEL_LIST;do
-		if test ! -z &quot;$i&quot;;then
-			kernel=`echo $i | cut -f1 -d:`
-			initrd=`echo $i | cut -f2 -d:`
-			#======================================
-			# create recovery entry
-			#--------------------------------------
-			if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
-				echo &quot;title Recovery [ $gfix ]&quot;               &gt;&gt; $menu
-				gdev_recovery=&quot;(hd0,3)&quot;
-				rdev_recovery=$OEM_RECOVERY
-				diskByID=`getDiskID $rdev_recovery`
-				if [ $kernel = &quot;vmlinuz-xen&quot; ];then
-					echo &quot; root $gdev_recovery&quot;                   &gt;&gt; $menu
-					echo &quot; kernel /boot/xen.gz&quot;                   &gt;&gt; $menu
-					echo -n &quot; module /boot/$kernel&quot;               &gt;&gt; $menu
-					echo -n &quot; root=$diskByID $console&quot;            &gt;&gt; $menu
-					echo -n &quot; vga=0x314 splash=silent&quot;            &gt;&gt; $menu
-					echo -n &quot; $KIWI_INITRD_PARAMS&quot;                &gt;&gt; $menu
-					echo -n &quot; $KIWI_KERNEL_OPTIONS&quot;               &gt;&gt; $menu
-					echo &quot; KIWI_RECOVERY=1 showopts&quot;              &gt;&gt; $menu
-					echo &quot; module /boot/$initrd&quot;                  &gt;&gt; $menu
-				else
-					echo -n &quot; kernel $gdev_recovery/boot/$kernel&quot; &gt;&gt; $menu
-					echo -n &quot; root=$diskByID $console&quot;            &gt;&gt; $menu
-					echo -n &quot; vga=0x314 splash=silent&quot;            &gt;&gt; $menu
-					echo -n &quot; $KIWI_INITRD_PARAMS&quot;                &gt;&gt; $menu
-					echo -n &quot; $KIWI_KERNEL_OPTIONS&quot;               &gt;&gt; $menu
-					echo &quot; KIWI_RECOVERY=1 showopts&quot;              &gt;&gt; $menu
-					echo &quot; initrd $gdev_recovery/boot/$initrd&quot;    &gt;&gt; $menu
-				fi
-			fi
-			count=`expr $count + 1`
+	kernel=vmlinuz # this is a copy of the kiwi linux.vmx file
+	initrd=initrd  # this is a copy of the kiwi initrd.vmx file
+	#======================================
+	# create recovery entry
+	#--------------------------------------
+	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+		echo &quot;title Recovery [ $gfix ]&quot;               &gt;&gt; $menu
+		gdev_recovery=&quot;(hd0,3)&quot;
+		rdev_recovery=$OEM_RECOVERY
+		diskByID=`getDiskID $rdev_recovery`
+		if [ $kernel = &quot;vmlinuz-xen&quot; ];then
+			echo &quot; root $gdev_recovery&quot;                   &gt;&gt; $menu
+			echo &quot; kernel /boot/xen.gz&quot;                   &gt;&gt; $menu
+			echo -n &quot; module /boot/$kernel&quot;               &gt;&gt; $menu
+			echo -n &quot; root=$diskByID $console&quot;            &gt;&gt; $menu
+			echo -n &quot; vga=0x314 splash=silent&quot;            &gt;&gt; $menu
+			echo -n &quot; $KIWI_INITRD_PARAMS&quot;                &gt;&gt; $menu
+			echo -n &quot; $KIWI_KERNEL_OPTIONS&quot;               &gt;&gt; $menu
+			echo &quot; KIWI_RECOVERY=1 showopts&quot;              &gt;&gt; $menu
+			echo &quot; module /boot/$initrd&quot;                  &gt;&gt; $menu
+		else
+			echo -n &quot; kernel $gdev_recovery/boot/$kernel&quot; &gt;&gt; $menu
+			echo -n &quot; root=$diskByID $console&quot;            &gt;&gt; $menu
+			echo -n &quot; vga=0x314 splash=silent&quot;            &gt;&gt; $menu
+			echo -n &quot; $KIWI_INITRD_PARAMS&quot;                &gt;&gt; $menu
+			echo -n &quot; $KIWI_KERNEL_OPTIONS&quot;               &gt;&gt; $menu
+			echo &quot; KIWI_RECOVERY=1 showopts&quot;              &gt;&gt; $menu
+			echo &quot; initrd $gdev_recovery/boot/$initrd&quot;    &gt;&gt; $menu
 		fi
-	done
+	fi
 }
 #======================================
 # setupBootLoaderGrub
@@ -776,7 +770,9 @@
 	#======================================
 	# check for UNIONFS_CONFIG
 	#--------------------------------------
-	if [ ! -z &quot;$UNIONFS_CONFIG&quot; ] &amp;&amp; [ $gnum -gt 0 ]; then
+	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ]; then
+		gnum=1
+	elif [ ! -z &quot;$UNIONFS_CONFIG&quot; ] &amp;&amp; [ $gnum -gt 0 ]; then
 		rwDevice=`echo $UNIONFS_CONFIG | cut -d , -f 1`
 		gnum=`echo $rwDevice | sed -e &quot;s/\/dev.*\([0-9]\)/\\1/&quot;`
 		gnum=`expr $gnum - 1`
@@ -891,6 +887,9 @@
 	# create grub device map
 	#--------------------------------------
 	rdisk=`echo $rdev | sed -e s&quot;@[0-9]@@g&quot;`
+	if [ ! -z &quot;$imageDiskDevice&quot; ];then
+		rdisk=$imageDiskDevice
+	fi
 	echo &quot;(hd0) $rdisk&quot; &gt; $dmap
 	#======================================
 	# create sysconfig/bootloader
@@ -1046,6 +1045,20 @@
 	echo &quot;$diskByID swap swap pri=42 0 0&quot; &gt;&gt; $nfstab
 }
 #======================================
+# updateLVMBootDeviceFstab
+#--------------------------------------
+function updateLVMBootDeviceFstab {
+	# /.../
+	# add one line to the fstab file for the /lvmboot
+	# device partition
+	# ----
+	local prefix=$1
+	local sdev=$2
+	local diskByID=`getDiskID $sdev`
+	local nfstab=$prefix/etc/fstab
+	echo &quot;$diskByID /lvmboot ext2 defaults 0 0&quot; &gt;&gt; $nfstab
+}
+#======================================
 # updateOtherDeviceFstab
 #--------------------------------------
 function updateOtherDeviceFstab {
@@ -1365,6 +1378,9 @@
 		cddev=$stickDevice
 	fi
 }
+#======================================
+# USBStickDevice
+#--------------------------------------
 function USBStickDevice {
 	stickFound=0
 	#======================================
@@ -1506,7 +1522,7 @@
 	# search for the BIOS boot device which is the device
 	# with the BIOS id 0x80. The test may fail if the boot
 	# device is a CD/DVD drive. If the test fails we search
-	# for the MBR disk label and compare it with the kiw
+	# for the MBR disk label and compare it with the kiwi
 	# written mbrid file in /boot/grub/ of the system image
 	# ----
 	local h=/usr/sbin/hwinfo
@@ -1538,6 +1554,23 @@
 	done
 }
 #======================================
+# searchVolumeGroup
+#--------------------------------------
+function searchVolumeGroup {
+	# /.../
+	# search for a volume group named kiwiVG and if it can be
+	# found activate it while creating appropriate device nodes:
+	# /dev/kiwiVG/LVRoot and/or /dev/kiwiVG/LVComp
+	# return zero on success
+	# ----
+	modprobe dm-mod
+	if vgscan 2&gt;&amp;1 | grep -q &quot;kiwiVG&quot;; then
+		vgchange -a y kiwiVG
+		return $?
+	fi
+	return 1
+}
+#======================================
 # searchSwapSpace
 #--------------------------------------
 function searchSwapSpace {
@@ -1807,7 +1840,7 @@
 	# /.../
 	# zero out a the given disk device
 	# ----
-	diskDevice=$1
+	local diskDevice=$1
 	dd if=/dev/zero of=$diskDevice bs=32M &gt;/dev/null
 }
 #======================================
@@ -2021,7 +2054,7 @@
 	# write the partition table using PART_FILE as
 	# input for sfdisk
 	# ----
-	diskDevice=$1
+	local diskDevice=$1
 	dd if=/dev/zero of=$diskDevice bs=512 count=1 &gt;/dev/null
 	sfdisk -uM --force $diskDevice &lt; $PART_FILE &gt;/dev/null
 	if test $? != 0;then
@@ -2166,7 +2199,7 @@
 	# /.../
 	# write the partition table using parted
 	# ----
-	diskDevice=$1
+	local diskDevice=$1
 	eval $p_cmd
 	if test $? != 0;then
 		systemException \
@@ -2178,8 +2211,8 @@
 # partitionID
 #--------------------------------------
 function partitionID {
-	diskDevice=$1
-	diskNumber=$2
+	local diskDevice=$1
+	local diskNumber=$2
 	if [ $PARTITIONER = &quot;sfdisk&quot; ];then
 		sfdiskGetPartitionID $diskDevice $diskNumber
 	else
@@ -2190,7 +2223,10 @@
 # partitionSize
 #--------------------------------------
 function partitionSize {
-	diskDevice=$1
+	local diskDevice=$1
+	if [ -z $diskDevice ];then
+		return 1
+	fi
 	if [ $PARTITIONER = &quot;sfdisk&quot; ];then
 		sfdiskGetPartitionSize $diskDevice
 	else
@@ -2241,8 +2277,8 @@
 	# check for a linux partition on partition number 2
 	# using the given disk device. On success return 0
 	# ----
-	diskDevice=$1
-	diskPartitionType=`partitionID $diskDevice 2`
+	local diskDevice=$1
+	local diskPartitionType=`partitionID $diskDevice 2`
 	if test &quot;$diskPartitionType&quot; = &quot;83&quot;;then
 		return 0
 	fi
@@ -2594,8 +2630,26 @@
 			if [ &quot;$RELOAD_IMAGE&quot; = &quot;yes&quot; ] || \
 				! mount $rwDevice $rwDir &gt;/dev/null
 			then
-				Echo &quot;Checking filesystem for RW data on $rwDevice...&quot;
-				e2fsck -f $rwDevice -y
+				#======================================
+				# store old FSTYPE value
+				#--------------------------------------
+				if [ ! -z &quot;$FSTYPE&quot; ];then
+					FSTYPE_SAVE=$FSTYPE
+				fi
+				#======================================
+				# probe filesystem
+				#--------------------------------------
+				probeFileSystem $rwDevice
+				if [ ! &quot;$FSTYPE&quot; = &quot;unknown&quot; ];then
+					Echo &quot;Checking filesystem for RW data on $rwDevice...&quot;
+					e2fsck -f $rwDevice -y
+				fi
+				#======================================
+				# restore FSTYPE
+				#--------------------------------------
+				if [ ! -z &quot;$FSTYPE_SAVE&quot; ];then
+					FSTYPE=$FSTYPE_SAVE
+				fi
 				if [ &quot;$RELOAD_IMAGE&quot; = &quot;yes&quot; ] || \
 					! mount $rwDevice $rwDir &gt;/dev/null
 				then
@@ -2645,7 +2699,11 @@
 	local mountDevice=$1
 	local loopf=$2
 	local roDevice=$mountDevice
-	local rwDevice=`getNextPartition $mountDevice`
+	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ]; then
+		local rwDevice=&quot;/dev/kiwiVG/LVRoot&quot;
+	else
+		local rwDevice=`getNextPartition $mountDevice`
+	fi
 	mkdir /read-only &gt;/dev/null
 	# /.../
 	# mount the read-only partition to /read-only and use
@@ -3118,6 +3176,9 @@
 	# ----
 	local device=$1
 	if [ -z &quot;$device&quot; ];then
+		return
+	fi
+	if echo $device | grep -q &quot;kiwiVG&quot;; then
 		echo $device
 		return
 	fi
@@ -3215,8 +3276,8 @@
 		name=$imageRootName
 	elif [ ! -z &quot;$imageRootDevice&quot; ];then
 		name=$imageRootDevice
-	elif [ ! -z &quot;$deviceDisk&quot; ];then
-		name=$deviceDisk
+	elif [ ! -z &quot;$imageDiskDevice&quot; ];then
+		name=$imageDiskDevice
 	else
 		name=&quot;unknown&quot;
 	fi

Modified: kiwi-head/rpm/kiwi.changes
===================================================================
--- kiwi-head/rpm/kiwi.changes	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/rpm/kiwi.changes	2009-01-08 14:29:45 UTC (rev 1831)
@@ -1,4 +1,12 @@
 -------------------------------------------------------------------
+Thu Jan  8 16:26:29 CET 2009 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
+
+- v3.03
+- added LVM support for vmxboot (bnc #447059)
+- restructured/cleaned up oemboot boot code and prepared
+  it for use with LVM, related to (bnc #447059)
+
+-------------------------------------------------------------------
 Tue Dec 30 19:45:45 CET 2008 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
 
 - v3.02

Modified: kiwi-head/rpm/kiwi.spec
===================================================================
--- kiwi-head/rpm/kiwi.spec	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/rpm/kiwi.spec	2009-01-08 14:29:45 UTC (rev 1831)
@@ -1,5 +1,5 @@
 #
-# spec file for package kiwi (Version 3.02
+# spec file for package kiwi (Version 3.03
 #
 # Copyright (c) 2008 SUSE LINUX Products GmbH, Nuernberg, Germany.
 # This file and all modifications and additions to the pristine
@@ -43,7 +43,7 @@
 Summary:        OpenSuSE - KIWI Image System
 Provides:       kiwi2 &lt;= 2.14
 Obsoletes:      kiwi2 &lt;= 2.14
-Version:        3.02
+Version:        3.03
 Release:        80
 Group:          System/Management
 License:        GPL v2 or later

Modified: kiwi-head/system/boot/ix86/oemboot/README
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/README	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/README	2009-01-08 14:29:45 UTC (rev 1831)
@@ -9,4 +9,4 @@
 # All this is done within the oemboot image
 #
 # Note:
-# Do not use this boot image with another image type then vmx or oem !
+# Do not use this boot image with another image type than vmx or oem !

Modified: kiwi-head/system/boot/ix86/oemboot/suse-10.3/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-10.3/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-10.3/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -25,6 +25,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/hid/*&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
@@ -92,6 +93,7 @@
 		&lt;package name=&quot;bootsplash-theme-SuSE&quot;/&gt;
 		&lt;package name=&quot;eject&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 		&lt;package name=&quot;bzip2&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;

Added: kiwi-head/system/boot/ix86/oemboot/suse-10.3/root/dump
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-10.3/root/dump	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-10.3/root/dump	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-dump
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-10.3/root/dump
___________________________________________________________________
Name: svn:special
   + *

Added: kiwi-head/system/boot/ix86/oemboot/suse-10.3/root/repart
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-10.3/root/repart	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-10.3/root/repart	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-repart
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-10.3/root/repart
___________________________________________________________________
Name: svn:special
   + *

Modified: kiwi-head/system/boot/ix86/oemboot/suse-11.0/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-11.0/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-11.0/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -25,6 +25,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/hid/*&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
@@ -95,6 +96,7 @@
 		&lt;package name=&quot;bootsplash-branding-openSUSE&quot;/&gt;
 		&lt;package name=&quot;eject&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 		&lt;package name=&quot;bzip2&quot;/&gt;
 		&lt;package name=&quot;cromfs&quot;/&gt;
 		&lt;package name=&quot;kiwi-tools&quot;/&gt;

Added: kiwi-head/system/boot/ix86/oemboot/suse-11.0/root/dump
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-11.0/root/dump	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-11.0/root/dump	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-dump
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-11.0/root/dump
___________________________________________________________________
Name: svn:special
   + *

Added: kiwi-head/system/boot/ix86/oemboot/suse-11.0/root/repart
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-11.0/root/repart	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-11.0/root/repart	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-repart
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-11.0/root/repart
___________________________________________________________________
Name: svn:special
   + *

Modified: kiwi-head/system/boot/ix86/oemboot/suse-11.1/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-11.1/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-11.1/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -25,6 +25,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/hid/*&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
@@ -100,6 +101,7 @@
 		&lt;package name=&quot;bootsplash-branding-openSUSE&quot;/&gt;
 		&lt;package name=&quot;eject&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 		&lt;package name=&quot;bzip2&quot;/&gt;
 		&lt;package name=&quot;cromfs&quot;/&gt;
 		&lt;package name=&quot;kiwi-tools&quot;/&gt;

Added: kiwi-head/system/boot/ix86/oemboot/suse-11.1/root/dump
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-11.1/root/dump	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-11.1/root/dump	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-dump
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-11.1/root/dump
___________________________________________________________________
Name: svn:special
   + *

Added: kiwi-head/system/boot/ix86/oemboot/suse-11.1/root/repart
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-11.1/root/repart	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-11.1/root/repart	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-repart
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-11.1/root/repart
___________________________________________________________________
Name: svn:special
   + *

Modified: kiwi-head/system/boot/ix86/oemboot/suse-SLED10/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLED10/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLED10/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -28,6 +28,7 @@
 		&lt;file name=&quot;usb/input/usbhid.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext2/*&quot;/&gt;
@@ -86,6 +87,7 @@
 		&lt;package name=&quot;bootsplash-theme-SuSE-NLD&quot;/&gt;
 		&lt;package name=&quot;eject&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 		&lt;package name=&quot;bzip2&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;

Added: kiwi-head/system/boot/ix86/oemboot/suse-SLED10/root/dump
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLED10/root/dump	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLED10/root/dump	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-dump
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-SLED10/root/dump
___________________________________________________________________
Name: svn:special
   + *

Added: kiwi-head/system/boot/ix86/oemboot/suse-SLED10/root/repart
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLED10/root/repart	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLED10/root/repart	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-repart
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-SLED10/root/repart
___________________________________________________________________
Name: svn:special
   + *

Modified: kiwi-head/system/boot/ix86/oemboot/suse-SLED11/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLED11/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLED11/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -25,6 +25,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/hid/*&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
@@ -93,6 +94,7 @@
 		&lt;package name=&quot;bootsplash-branding-SLED&quot;/&gt;
 		&lt;package name=&quot;eject&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 		&lt;package name=&quot;bzip2&quot;/&gt;
 		&lt;package name=&quot;kiwi-tools&quot;/&gt;
 	&lt;/packages&gt;

Added: kiwi-head/system/boot/ix86/oemboot/suse-SLED11/root/dump
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLED11/root/dump	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLED11/root/dump	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-dump
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-SLED11/root/dump
___________________________________________________________________
Name: svn:special
   + *

Added: kiwi-head/system/boot/ix86/oemboot/suse-SLED11/root/repart
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLED11/root/repart	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLED11/root/repart	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-repart
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-SLED11/root/repart
___________________________________________________________________
Name: svn:special
   + *

Modified: kiwi-head/system/boot/ix86/oemboot/suse-SLES10/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLES10/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLES10/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -28,6 +28,7 @@
 		&lt;file name=&quot;usb/input/usbhid.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext2/*&quot;/&gt;
@@ -86,6 +87,7 @@
 		&lt;package name=&quot;bootsplash-theme-SuSE-SLES&quot;/&gt;
 		&lt;package name=&quot;eject&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 		&lt;package name=&quot;bzip2&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;

Added: kiwi-head/system/boot/ix86/oemboot/suse-SLES10/root/dump
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLES10/root/dump	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLES10/root/dump	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-dump
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-SLES10/root/dump
___________________________________________________________________
Name: svn:special
   + *

Added: kiwi-head/system/boot/ix86/oemboot/suse-SLES10/root/repart
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLES10/root/repart	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLES10/root/repart	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-repart
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-SLES10/root/repart
___________________________________________________________________
Name: svn:special
   + *

Modified: kiwi-head/system/boot/ix86/oemboot/suse-SLES11/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLES11/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLES11/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -25,6 +25,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/hid/*&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
@@ -93,6 +94,7 @@
 		&lt;package name=&quot;bootsplash-branding-SLES&quot;/&gt;
 		&lt;package name=&quot;eject&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 		&lt;package name=&quot;bzip2&quot;/&gt;
 		&lt;package name=&quot;kiwi-tools&quot;/&gt;
 	&lt;/packages&gt;

Added: kiwi-head/system/boot/ix86/oemboot/suse-SLES11/root/dump
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLES11/root/dump	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLES11/root/dump	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-dump
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-SLES11/root/dump
___________________________________________________________________
Name: svn:special
   + *

Added: kiwi-head/system/boot/ix86/oemboot/suse-SLES11/root/repart
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-SLES11/root/repart	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-SLES11/root/repart	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1 @@
+link ../../suse-repart
\ No newline at end of file


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-SLES11/root/repart
___________________________________________________________________
Name: svn:special
   + *

Added: kiwi-head/system/boot/ix86/oemboot/suse-dump
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-dump	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-dump	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1,160 @@
+#!/bin/bash
+#================
+# FILE          : linuxrc
+#----------------
+# PROJECT       : OpenSuSE KIWI Image System
+# COPYRIGHT     : (c) 2006 SUSE LINUX Products GmbH. All rights reserved
+#               :
+# AUTHOR        : Marcus Schaefer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>&gt;
+#               :
+# BELONGS TO    : Operating System images
+#               :
+# DESCRIPTION   : This file includes functions for the OEM
+#               : installation mode. Installation means a dump of
+#               : the virtual disk file onto a preselected disk
+#               :
+#               :
+# STATUS        : BETA
+#----------------
+#
+#======================================
+# OEMInstall
+#--------------------------------------
+function OEMInstall {
+	# /.../
+	# Installation mode: find a usable disk to install the image
+	# on. The install image is a virtual disk. The system will be
+	# rebooted at the end of this function
+	# ----
+	#======================================
+	# Check for install mode indicator file
+	#--------------------------------------
+	if [ ! -f $VMX_SYSTEM ];then
+		return
+	fi
+	#======================================
+	# Search and ask for the install device
+	#--------------------------------------
+	Echo &quot;Searching harddrive for installation&quot;
+	hwinfo=/usr/sbin/hwinfo
+	export deviceDisks=`$hwinfo --disk |\
+		grep &quot;Device File:&quot; | cut -f2 -d: |\
+		cut -f1 -d&quot;(&quot; | sed -e s&quot;@$imageDiskDevice@@&quot;`
+	export deviceDisks=`echo $deviceDisks`
+	if [ -z $deviceDisks ];then
+		systemException \
+			&quot;No device(s) for installation found... abort&quot; \
+		&quot;reboot&quot;
+	fi
+	Echo &quot;Found following disk device(s)&quot;
+	count=0
+	for i in $deviceDisks;do
+		Echo -b &quot;Disk $count -&gt; $i&quot;
+		deviceArray[$count]=$i
+		count=`expr $count + 1`
+	done
+	while true;do
+		Echo -n &quot;Enter device name to select disk for installation: &quot;
+		read deviceInput
+		count=0
+		for instDisk in $deviceDisks;do
+			if [ ${deviceArray[$count]} = $deviceInput ];then
+				break 2
+			fi
+			count=`expr $count + 1`
+		done
+		Echo &quot;Given device is not in the list !&quot;
+	done
+	Echo &quot;Entering installation mode for disk: $instDisk&quot;
+	#======================================
+	# Import vmx configuration file
+	#--------------------------------------
+	importFile &lt; $VMX_SYSTEM
+	#======================================
+	# Check MBR ID of installed OS
+	#--------------------------------------
+	mbrM=`dd if=$instDisk bs=1 count=4 skip=$((0x1b8))|hexdump -n4 -e '&quot;0x%x&quot;'`
+	if [ &quot;$mbrM&quot; = &quot;$mbrI&quot; ];then
+		Echo &quot;Base system already installed... reboot&quot;
+		/sbin/reboot -f -i &gt;/dev/null 2&gt;&amp;1
+	fi
+	#======================================
+	# Search CD/DVD/USB stick and mount it
+	#--------------------------------------
+	USBStickDevice
+	if [ $stickFound = 0 ];then
+		Echo &quot;Search for USB stick failed, checking CD/DVD drive&quot;
+		CDMount
+	else
+		Echo &quot;Found Stick: $stickDevice -&gt; $stickSerial&quot;
+		mkdir -p /cdrom &amp;&amp; mount $stickDevice /cdrom
+	fi
+	#======================================
+	# Install disk system
+	#--------------------------------------
+	# install virtual disk image from the CD/DVD onto the
+	# real disk. All data on the disk will be lost
+	# ----
+	imageZipped=&quot;uncompressed&quot;
+	imageDevice=$instDisk
+	field=0
+	IFS=&quot;;&quot; ; for n in $IMAGE;do
+	case $field in
+		0) field=1 ;; 
+		1) imageName=$n   ; field=2 ;;
+		2) imageVersion=$n;
+	esac
+	done
+	imageName=&quot;/cdrom/$imageName&quot;
+	echo $imageName | grep -qE &quot;.gz$&quot;
+	if [ $? = 0 ];then
+		imageZipped=&quot;compressed&quot;
+	fi
+	IFS=&quot; &quot;
+	if test &quot;$imageZipped&quot; = &quot;compressed&quot;; then
+		Echo &quot;Compressed image found&quot;
+		test ! -p /dev/compressed_image &amp;&amp; mkfifo /dev/compressed_image
+		cat /dev/compressed_image | gzip -d &gt; $imageDevice 2&gt;/dev/null &amp;
+		imageDevice_orig=$imageDevice
+		imageName_orig=$imageName
+		imageDevice=&quot;/dev/compressed_image&quot;
+		imageName=&quot;$imageName.gz&quot;
+	fi
+	Echo &quot;Loading $imageName [$imageDevice]...&quot;
+	if ! dd bs=32k if=$imageName of=$imageDevice &gt;/dev/null 2&gt;&amp;1; then
+		systemException \
+			&quot;Failed to install image: $imageName -&gt; $imageDevice&quot; \
+		&quot;reboot&quot;
+	fi
+	if test &quot;$imageZipped&quot; = &quot;compressed&quot;; then
+		imageDevice=$imageDevice_orig
+		imageName=$imageName_orig
+		rm -f /dev/compressed_image
+	fi
+	#======================================
+	# Umount CD/DVD USB
+	#--------------------------------------
+	umount /cdrom
+	#======================================
+	# Reread partition table
+	#--------------------------------------
+	blockdev --rereadpt $imageDevice
+	deviceTest=$imageDevice&quot;1&quot;
+	if ! waitForStorageDevice $deviceTest;then
+		systemException \
+			&quot;Partition $deviceTest doesn't appear... fatal !&quot; \
+		&quot;reboot&quot;
+	fi
+	#======================================
+	# Reboot system
+	#--------------------------------------
+	if [ $stickFound = 0 ];then
+		Echo &quot;NOTE: Please remove the installation CD before reboot !&quot;
+		CDEject
+	else
+		Echo &quot;NOTE: Please unplug the USB stick before reboot !&quot;
+	fi
+	systemException \
+		&quot;System installation has finished&quot; \
+	&quot;reboot&quot;
+}


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-dump
___________________________________________________________________
Name: svn:executable
   + *

Modified: kiwi-head/system/boot/ix86/oemboot/suse-linuxrc
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-linuxrc	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-linuxrc	2009-01-08 14:29:45 UTC (rev 1831)
@@ -22,6 +22,7 @@
 export PATH=&quot;/sbin:/bin:/usr/sbin:/usr/bin&quot;
 export IFS_ORIG=$IFS
 export DEBUG=0
+export bootid=0
 
 #======================================
 # Exports (Booting)
@@ -42,6 +43,8 @@
 # Functions...
 #--------------------------------------
 . /include
+. /repart
+. /dump
 
 #======================================
 # Beautify Startup
@@ -67,31 +70,8 @@
 udevStart
 
 #======================================
-# 4) start boot shell
+# 4) Include proc/cmdline information
 #--------------------------------------
-startBlogD
-startShell
-errorLogStart
-openKernelConsole
-
-#======================================
-# 5) Including required kernel modules
-#--------------------------------------
-# sleep for a while as I don't know a device to listen on
-# I should be sure all possible devices exist. If there is
-# a better way to make sure _now_ is the best time to search
-# a disk please fixme
-# ---
-probeDevices
-for module in ehci-hcd uhci-hcd usb_storage sg sd_mod BusLogic;do
-	modprobe $module &gt;/dev/null 2&gt;&amp;1
-done
-Echo &quot;Waiting for devices to settle...&quot;
-sleep 5
-
-#======================================
-# 6) Include proc/cmdline information
-#--------------------------------------
 includeKernelParameters
 if \
 	[ ! -z $UNIONFS_CONFIG ] || [ &quot;$COMBINED_IMAGE&quot; = &quot;local&quot; ] ||\
@@ -106,803 +86,109 @@
 	# ----
 	export LOCAL_BOOT=&quot;yes&quot;
 fi
-if [ $LOCAL_BOOT = &quot;yes&quot; ];then
-	export deviceRoot=$root
-	export deviceDisk=`getDiskDevice $deviceRoot | sed -e s&quot;@[0-9]@@g&quot;`
-	if [ ! -z &quot;$UNIONFS_CONFIG&quot; ] || [ ! -z &quot;$COMBINED_IMAGE&quot; ];then
-		deviceRoot=&quot;$deviceDisk&quot;1
+
+#======================================
+# 5) start boot shell
+#--------------------------------------
+startBlogD
+startShell
+errorLogStart
+openKernelConsole
+
+#======================================
+# 6) Including required kernel modules
+#--------------------------------------
+probeDevices
+
+#======================================
+# 7) Setup device names...
+#--------------------------------------
+Echo &quot;Searching for boot device...&quot;
+export imageDiskDevice=`searchBIOSBootDevice`
+export imageRootDevice=$imageDiskDevice&quot;1&quot;
+export imageRWDevice=$imageDiskDevice&quot;2&quot;
+export imageRODevice=$imageDiskDevice&quot;1&quot;
+export imageBootDevice=$imageDiskDevice&quot;1&quot;
+if [ ! -z &quot;$RECOVERY&quot; ];then
+	export imageRecoveryDevice=$imageDiskDevice&quot;4&quot;
+	export imageRootDevice=$imageDiskDevice&quot;2&quot;
+fi
+if [ -z &quot;$imageDiskDevice&quot; ];then
+	systemException \
+		&quot;Couldn't find any boot device... abort&quot; \
+	&quot;reboot&quot;
+fi
+Echo &quot;Searching for kiwiVG volume group...&quot;
+if searchVolumeGroup; then
+	export haveLVM=yes
+	if [ -e /dev/kiwiVG/LVComp ];then
+		export imageRootDevice=/dev/kiwiVG/LVComp
+	else
+		export imageRootDevice=/dev/kiwiVG/LVRoot
 	fi
-	if [ ! -z &quot;$UNIONFS_CONFIG&quot; ];then
-		setupUnionFS &quot;$deviceDisk&quot;2 &quot;$deviceDisk&quot;1 aufs
+	export imageRWDevice=/dev/kiwiVG/LVRoot
+	export imageRODevice=/dev/kiwiVG/LVComp
+	export imageBootDevice=$imageDiskDevice&quot;2&quot;
+	if [ ! -z &quot;$RECOVERY&quot; ];then
+		export imageRecoveryDevice=/dev/kiwiVG/LVRecovery
 	fi
-	if [ ! -z &quot;$deviceRecovery&quot; ];then
-		export deviceRecovery=$deviceDisk&quot;4&quot;
-	fi
 fi
 
 #======================================
-# 7) Search disks, prefer removable one
+# 8) Check for installation mode...
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
-	if [ ! -f $VMX_SYSTEM ];then
-		# /.../
-		# installed system: Find the boot device which is flagged
-		# in the BIOS as 0x80:
-		# ----
-		# During first boot of the installed system there is only
-		# one partition and this initrd is going to be replaced by
-		# a later mkinitrd call for unified systems the kiwi initrd
-		# is used and the kernel parameters of this initrd defines
-		# the missing information.
-		# ----
-		# Additionally the partition table is different
-		# for unified systems. Therefore we check if the second
-		# partition is a squashfs/cromfs partition and change the root
-		# partition name accordingly
-		# ----
-		if [ -f $OEM_PARTITION_CONFIG ];then
-			Echo &quot;Including oem partition info file&quot;
-			importFile &lt; $OEM_PARTITION_CONFIG
-		fi
-		Echo &quot;Searching for boot device...&quot;
-		export deviceDisk=`searchBIOSBootDevice`
-		if [ -z &quot;$deviceDisk&quot; ];then
-			systemException \
-				&quot;Couldn't find any boot device... abort&quot; \
-			&quot;reboot&quot;
-		fi
-		export deviceSwap=$deviceDisk&quot;2&quot;
-		if [ -z &quot;$OEM_WITHOUTHOME&quot; ];then
-			export deviceHome=$deviceDisk&quot;3&quot;
-		fi
-		probeFileSystem $deviceDisk&quot;1&quot;
-		if isFSTypeReadOnly;then
-			if [ -z &quot;$COMBINED_IMAGE&quot; ];then
-				Echo &quot;Unified system detected, adapting root partition&quot;
-				setupUnionFS &quot;$deviceDisk&quot;2 &quot;$deviceDisk&quot;1 aufs
-			fi
-			export deviceRoot=$deviceDisk&quot;1&quot;
-			export deviceSwap=$deviceDisk&quot;3&quot;
-		else
-			export deviceRoot=$deviceDisk&quot;1&quot;
-		fi
-		Echo &quot;Using root partition $deviceRoot on disk $deviceDisk&quot;
-	else
-		# /.../
-		# installation mode: find a usable disk to install the image
-		# on. The image is a virtual disk with one partition
-		# ----
-		Echo &quot;Searching harddrive for installation&quot;
-		hwinfo=/usr/sbin/hwinfo
-		export deviceDisks=`$hwinfo --disk |\
-			grep &quot;Device File:&quot; | cut -f2 -d: | cut -f1 -d&quot;(&quot;`
-		export deviceDisks=`echo $deviceDisks`
-		if [ -z $deviceDisks ];then
-			systemException \
-				&quot;No hard disk device(s) found... abort&quot; \
-			&quot;reboot&quot;
-		fi
-		Echo &quot;Found following hard disk device(s)&quot;
-		count=0
-		for i in $deviceDisks;do
-			Echo -b &quot;Disk $count -&gt; $i&quot;
-			deviceArray[$count]=$i
-			count=`expr $count + 1`
-		done
-		while true;do
-			Echo -n &quot;Enter device name to select disk for installation: &quot;
-			read deviceInput
-			count=0
-			for deviceDisk in $deviceDisks;do
-				if [ ${deviceArray[$count]} = $deviceInput ];then
-					break 2
-				fi
-				count=`expr $count + 1`
-			done
-			Echo &quot;Given device is not in the list !&quot;
-		done
-		Echo &quot;Entering installation mode for disk: $deviceDisk&quot;
-	fi
+	OEMInstall
 fi
 
 #======================================
-# 8) Check for vmx system
+# 9) Get filesystem type
 #--------------------------------------
-if [ -f $VMX_SYSTEM ] &amp;&amp; [ $LOCAL_BOOT = &quot;no&quot; ];then
-	#======================================
-	# 8.1) import vmx configuration file
-	#--------------------------------------
-	importFile &lt; $VMX_SYSTEM
-	#======================================
-	# 8.2) check version of installed OS
-	#--------------------------------------
-	deviceRoot=$deviceDisk&quot;2&quot;
-	probeFileSystem $deviceRoot
-	if test &quot;$FSTYPE&quot; = &quot;unknown&quot;;then
-		deviceRoot=&quot;$deviceDisk&quot;1
-		probeFileSystem $deviceRoot
-	fi
-	if [ -z &quot;$COMBINED_IMAGE&quot; ];then
-		if isFSTypeReadOnly;then
-			setupUnionFS &quot;$deviceDisk&quot;2 &quot;$deviceDisk&quot;1 aufs
-		fi
-	fi
-	Echo &quot;Try mounting installed system to check version&quot;
-	mountSystem $deviceRoot; updateNeeded
-	umountSystem
-	if test `getSystemIntegrity 1` = &quot;fine&quot;;then
-		Echo &quot;Base system is up to date... reboot&quot;
-		/sbin/reboot -f -i &gt;/dev/null 2&gt;&amp;1
-	fi
-	#======================================
-	# 8.3) mount CD/DVD/USB stick
-	#--------------------------------------
-	USBStickDevice
-	if [ $stickFound = 0 ];then
-		Echo &quot;Search for USB stick failed, checking CD/DVD drive&quot;
-		CDMount
-	else
-		Echo &quot;Found Stick: $stickDevice -&gt; $stickSerial&quot;
-		mkdir -p /cdrom &amp;&amp; mount $stickDevice /cdrom
-	fi
-	#======================================
-	# 8.4) install disk system
-	#--------------------------------------
-	# /.../
-	# install virtual disk image from the CD/DVD onto the
-	# real disk. All data on the disk will be lost
-	# ----
-	imageZipped=&quot;uncompressed&quot;
-	imageDevice=$deviceDisk
-	field=0
-	IFS=&quot;;&quot; ; for n in $IMAGE;do
-	case $field in
-		0) field=1 ;; 
-		1) imageName=$n   ; field=2 ;;
-		2) imageVersion=$n;
-	esac
-	done
-	imageName=&quot;/cdrom/$imageName&quot;
-	echo $imageName | grep -qE &quot;.gz$&quot;
-	if [ $? = 0 ];then
-		imageZipped=&quot;compressed&quot;
-	fi
-	IFS=&quot; &quot;
-	if test &quot;$imageZipped&quot; = &quot;compressed&quot;; then
-		Echo &quot;Compressed image found&quot;
-		test ! -p /dev/compressed_image &amp;&amp; mkfifo /dev/compressed_image
-		cat /dev/compressed_image | gzip -d &gt; $imageDevice 2&gt;/dev/null &amp;
-		imageDevice_orig=$imageDevice
-		imageName_orig=$imageName
-		imageDevice=&quot;/dev/compressed_image&quot;
-		imageName=&quot;$imageName.gz&quot;
-	fi
-	Echo &quot;Loading $imageName [$imageDevice]...&quot;
-	if ! dd bs=32k if=$imageName of=$imageDevice &gt;/dev/null 2&gt;&amp;1; then
-		systemException \
-			&quot;Failed to install image: $imageName -&gt; $imageDevice&quot; \
-		&quot;reboot&quot;
-	fi
-	if test &quot;$imageZipped&quot; = &quot;compressed&quot;; then
-		imageDevice=$imageDevice_orig
-		imageName=$imageName_orig
-		rm -f /dev/compressed_image
-	fi
-	#======================================
-	# 8.5) Umount the CD/DVD
-	#--------------------------------------
-	umount /cdrom
-	#======================================
-	# 8.6) reread partition table
-	#--------------------------------------
-	blockdev --rereadpt $deviceDisk
-	deviceTest=&quot;$deviceDisk&quot;1
-	if ! waitForStorageDevice $deviceTest;then
-		systemException \
-			&quot;Partition $deviceTest doesn't appear... fatal !&quot; \
-		&quot;reboot&quot;
-	fi
-	#======================================
-	# 8.7) find new root partition
-	#--------------------------------------
-	unset UNIONFS_CONFIG
-	deviceRoot=$deviceDisk&quot;1&quot;
-	probeFileSystem $deviceRoot
-	Echo &quot;Filesystem of root system is: $FSTYPE -&gt; $deviceRoot&quot;
-	if [ -z &quot;$COMBINED_IMAGE&quot; ];then
-		if isFSTypeReadOnly;then
-			setupUnionFS &quot;$deviceDisk&quot;2 &quot;$deviceDisk&quot;1 aufs
-		fi
-	fi
-	#======================================
-	# 8.8) Create md5 version info file
-	#--------------------------------------
-	unset RELOAD_IMAGE
-	if ! mountSystem $deviceRoot;then
-		systemException \
-			&quot;Couldn't mount installed system... abort&quot; \
-		&quot;reboot&quot;
-	fi
-	updateNeeded initialize
-	field=0
-	IFS=&quot;;&quot; ; for n in $IMAGE;do
-	case $field in
-		0) field=1 ;;
-		1) imageName=$n   ; field=2 ;;
-		2) imageVersion=$n
-	esac
-	done
-	atversion=&quot;$imageName-$imageVersion&quot;
-	versionFile=&quot;/mnt/etc/ImageVersion-$atversion&quot;
-	md5sum=`getSystemMD5Status 1`
-	echo &quot;$atversion $md5sum&quot; &gt; $versionFile
-	umountSystem
-	#======================================
-	# 8.9) reboot system
-	#--------------------------------------
-	if [ $stickFound = 0 ];then
-		Echo &quot;NOTE: Please remove the installation CD before reboot !&quot;
-		CDEject
-	else
-		Echo &quot;NOTE: Please unplug the USB stick before reboot !&quot;
-	fi
+probeFileSystem $imageRootDevice
+if [ $FSTYPE = &quot;unknown&quot; ];then
 	systemException \
-		&quot;System installation has finished&quot; \
+		&quot;Couldn't determine filesystem type... abort&quot; \
 	&quot;reboot&quot;
 fi
 
 #======================================
-# 9) Probe filesystem of disk device
+# 10) Check filesystem
 #--------------------------------------
-if [ $LOCAL_BOOT = &quot;no&quot; ];then
-	probeFileSystem $deviceRoot
-	if [ $FSTYPE = &quot;unknown&quot; ];then
-		systemException \
-			&quot;Couldn't determine filesystem type... abort&quot; \
-		&quot;reboot&quot;
-	fi
+Echo &quot;Filesystem of OEM system is: $FSTYPE -&gt; $imageRootDevice&quot;
+if isFSTypeReadOnly;then
+	setupUnionFS $imageRWDevice $imageRODevice aufs
+	bootid=1
 fi
 
 #======================================
-# 10) repartition the disk device
+# 11) Import OEM partition config
 #--------------------------------------
-if [ $LOCAL_BOOT = &quot;no&quot; ];then
-	#======================================
-	# 10.1 calculate amount of swap space
-	#--------------------------------------
-	mem_size=`grep MemTotal: /proc/meminfo | tr -dc '[0-9]'`
-	swapsize=$(( $mem_size *2 / 1024 ))
-	recoMByte=0
-	if [ ! -z &quot;$OEM_SWAPSIZE&quot; ];then
-		swapsize=$OEM_SWAPSIZE
-	fi
-	if [ ! -z &quot;$OEM_WITHOUTSWAP&quot; ];then
-		swapsize=0
-	fi
-	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
-		mkdir -p /reco-root
-		if ! mount $deviceRoot /reco-root &gt;/dev/null;then
-			systemException &quot;Failed to mount root device&quot; &quot;reboot&quot;
-		fi
-		if [ ! -f /reco-root/recovery.tar.gz ];then
-			systemException &quot;Can't find recovery archive&quot; &quot;reboot&quot;
-		fi
-		recoBytes=`du --bytes /reco-root/recovery.tar.gz | cut -f1`
-		recoMByte=`expr $recoBytes / 1048576`
-		recoMByte=`expr $recoMByte \* 15 / 10`
-		umount /reco-root &amp;&amp; rmdir /reco-root
-	fi
-	Echo &quot;Filesystem of root system is: $FSTYPE -&gt; $deviceRoot&quot;
-	if test ! -z $COMBINED_IMAGE;then
-		#====================================== 
-		# 10.2 no recovery support in this mode
-		#--------------------------------------
-		unset OEM_RECOVERY
-		#====================================== 
-		# 10.2 check for read-write partition
-		#--------------------------------------
-		if ! partitionSize $deviceDisk&quot;2&quot; &amp;&gt;/dev/null;then
-			Echo &quot;No read-write partition in this split image&quot;
-			DONT_PARTITION=1
-		fi
-		#======================================
-		# 10.3 calculate new partition 3 size
-		#--------------------------------------
-		if [ -z &quot;$DONT_PARTITION&quot; ];then
-			swapXMBytes=$swapsize
-			diskXMBytes=`partitionSize $deviceDisk`
-			diskXMBytes=`expr $diskXMBytes / 1024`
-			disk1MBytes=`partitionSize &quot;$deviceDisk&quot;1`
-			disk1MBytes=`expr $disk1MBytes / 1024`
-			disk2MBytes=`partitionSize &quot;$deviceDisk&quot;2`
-			disk2MBytes=`expr $disk2MBytes / 1024`
-			diskXLBytes=`expr $diskXMBytes - $disk1MBytes - $disk2MBytes`
-			diskXABytes=`expr $diskXLBytes - $swapXMBytes`
-			if [ $diskXABytes -lt 50 ];then
-				# /.../
-				# Very small disk which we will not re-partition
-				# ----
-				Echo &quot;Disk is too small, will not re-partition it&quot;
-				DONT_PARTITION=1
-			else
-				disk2MBytes=`expr $disk2MBytes + $diskXABytes`
-			fi
-		fi
-		if [ -z &quot;$DONT_PARTITION&quot; ];then
-			#======================================
-			# 10.4 write new partition table
-			#--------------------------------------
-			# /.../
-			# Explanation of the partition commands used within the
-			# here document below:
-			# ----
-			# d               # delete xda partition
-			# 2               # [ 2 ]
-			# n               # create xda partition at same place than xda2
-			# p               # primary
-			# 2               # [ 2 ]
-			#                 # accept old xda3 start block
-			# +&quot;disk2MBytes&quot;M # accept new RW device size of disk blocks - swap
-			# n               # create xda swap partition
-			# p               # primary
-			# 3               # [ 3 ]
-			#                 # accept start block
-			#                 # accept end block
-			# t               # change swap system id
-			# 3               # [ 3 ]
-			# 82              # Linux Swap
-			# w               # write partition table
-			# ----
-			input=/part.input
-			rm -f $input
-			if [ $swapsize = 0 ];then
-				for cmd in d 2 n p 2 . +&quot;$disk2MBytes&quot;M w;do
-					if [ $cmd = &quot;.&quot; ];then
-						echo &gt;&gt; $input
-						continue
-					fi
-					echo $cmd &gt;&gt; $input
-				done
-			else
-				for cmd in d 2 n p 2 . +&quot;$disk2MBytes&quot;M n p 3 . . t 3 82 w;do
-					if [ $cmd = &quot;.&quot; ];then
-						echo &gt;&gt; $input
-						continue
-					fi
-					echo $cmd &gt;&gt; $input
-				done
-			fi
-			Echo &quot;Repartition the disk according to current geometry&quot;
-			fdisk $deviceDisk &lt; $input 1&gt;&amp;2
-			if test $? != 0; then
-				systemException &quot;Failed to create partition table&quot; &quot;reboot&quot;
-			fi
-		fi
-		#======================================
-		# 10.5 Update new device names
-		#--------------------------------------
-		export deviceRoot=$deviceDisk&quot;1&quot;
-		export deviceSwap=$deviceDisk&quot;3&quot;
-		export deviceIOWR=$deviceDisk&quot;2&quot;
+if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ -f $OEM_PARTITION_CONFIG ];then
+	Echo &quot;Including oem partition info file&quot;
+	importFile &lt; $OEM_PARTITION_CONFIG
+fi
 
-		#======================================
-		# 10.6 Activate swap space
-		#--------------------------------------
-		if partitionSize $deviceSwap &amp;&gt;/dev/null;then
-			Echo &quot;Activating swap space on $deviceSwap&quot;
-			if ! mkswap $deviceSwap &gt;/dev/null 2&gt;&amp;1;then
-				systemException &quot;Failed to create swap signature&quot; &quot;reboot&quot;
-			fi
-		fi
-	else
-		if ! isFSTypeReadOnly;then
-			#======================================
-			# 10.2 write new partition table
-			#--------------------------------------
-			# /.../
-			# Explanation of the partition commands used within the
-			# here document below:
-			# ----
-			# d              # delete xda partition [ 1 ]
-			# n              # create xda partition at same place than xda1
-			# p              # primary
-			# 2              # [ 2 ]
-			# 1              # accept old xda1 start block for xda2
-			# +10240M        # accept new root device size of 10GB
-			# n              # create xda swap partition
-			# p              # primary
-			# 1              # [ 1 ]
-			#                # accept start block
-			# +&quot;$swapsize&quot;M  # accept new swapsize
-			# n              # create xda3 home partition
-			# p              # primary
-			# 3              # [ 3 ]
-			#                # accept start block
-			#                # accept end block, complete disk
-			# t              # change swap system id
-			# 1              # [ 1 ]
-			# 82             # Linux Swap
-			# w              # write partition table
-			# ----
-			input=/part.input
-			rm -f $input
-			diskXMBytes=`partitionSize $deviceDisk`
-			diskPMBytes=`partitionSize $deviceDisk&quot;1&quot;`
-			diskPMBytes=`expr $diskPMBytes / 1024`
-			diskXMBytes=`expr $diskXMBytes / 1024`
-			disk1MBytes=10240
-			# /.../
-			# set OEM_SYSTEMSIZE if available, else try to
-			# use 10GB system size
-			# ----
-			if [ ! -z &quot;$OEM_SYSTEMSIZE&quot; ];then
-				disk1MBytes=$OEM_SYSTEMSIZE
-			fi
-			# /.../
-			# prevent /home and recovery partition if requested
-			# system size is bigger than the whole disk
-			# ----
-			if [ $disk1MBytes -gt $diskXMBytes ];then
-				export OEM_WITHOUTHOME=1
-				unset OEM_RECOVERY
-				recoMByte=0
-			fi
-			# /.../
-			# recalculate system size if no /home partition
-			# will be used. size is whole disk minus swap
-			# minus recovery
-			# ----
-			if [ ! -z &quot;$OEM_WITHOUTHOME&quot; ];then
-				disk1MBytes=`expr $diskXMBytes - $swapsize - $recoMByte`
-			fi
-			# /.../
-			# check if requested system size is bigger than
-			# the existing system partition
-			# ----
-			if [ $disk1MBytes -lt $diskPMBytes ];then
-				# /.../
-				# Requested system partition size is smaller than
-				# existing partition, will not re-partition
-				# ----
-				Echo &quot;Current system partition is bigger than requested size&quot;
-				Echo &quot;Disk won't be re-partitioned&quot;
-				OEM_WITHOUTHOME=1
-				DONT_PARTITION=1
-				unset OEM_RECOVERY
-			fi
-			if [ -z &quot;$DONT_PARTITION&quot; ];then
-				if [ ! -z &quot;$OEM_WITHOUTHOME&quot; ];then
-					#======================================
-					# 10.2.1 without /home partition
-					#--------------------------------------
-					if [ -z &quot;$OEM_WITHOUTSWAP&quot; ];then
-						#======================================
-						# 10.2.1.1 with swap partition
-						#--------------------------------------
-						if [ -z &quot;$OEM_RECOVERY&quot; ];then
-							#======================================
-							# 10.2.1.1.1 without recovery partition
-							#--------------------------------------
-							for cmd in \
-								d n p 2 1 +&quot;$disk1MBytes&quot;M \
-								n p 1 . . \
-								t 1 82 w
-							do
-								if [ $cmd = &quot;.&quot; ];then
-									echo &gt;&gt; $input
-									continue
-								fi
-								echo $cmd &gt;&gt; $input
-							done
-						else
-							#======================================
-							# 10.2.1.1.2 with recovery partition
-							#--------------------------------------
-							for cmd in \
-								d n p 2 1 +&quot;$disk1MBytes&quot;M \
-								n p 4 . +&quot;$recoMByte&quot;M \
-								n p 1 . . \
-								t 1 82 w
-						do
-							if [ $cmd = &quot;.&quot; ];then
-								echo &gt;&gt; $input
-									continue
-								fi
-								echo $cmd &gt;&gt; $input
-							done
-						fi
-					else
-						#======================================
-						# 10.2.1.2 without swap partition
-						#--------------------------------------
-						if [ -z &quot;$OEM_RECOVERY&quot; ];then
-							#======================================
-							# 10.2.1.2.1 without recovery partition
-							#--------------------------------------
-							for cmd in \
-								d n p 2 . . w
-							do
-								if [ $cmd = &quot;.&quot; ];then
-									echo &gt;&gt; $input
-									continue
-								fi
-								echo $cmd &gt;&gt; $input
-							done
-						else
-							#======================================
-							# 10.2.1.2.2 with recovery partition
-							#--------------------------------------
-							for cmd in \
-								d n p 2 1 +&quot;$disk1MBytes&quot;M \
-								n p 4 . . w
-							do
-								if [ $cmd = &quot;.&quot; ];then
-									echo &gt;&gt; $input
-									continue
-								fi
-								echo $cmd &gt;&gt; $input
-							done
-						fi
-					fi
-				else
-					#======================================
-					# 10.2.2 with /home partition
-					#--------------------------------------
-					if [ -z &quot;$OEM_WITHOUTSWAP&quot; ];then
-						#======================================
-						# 10.2.2.1 with swap partition
-						#--------------------------------------
-						if [ -z &quot;$OEM_RECOVERY&quot; ];then
-							#======================================
-							# 10.2.2.1.1 without recovery partition
-							#--------------------------------------
-							for cmd in \
-								d n p 2 1 +&quot;$disk1MBytes&quot;M \
-								n p 1 . +&quot;$swapsize&quot;M \
-								n p 3 . . \
-								t 1 82 w
-							do
-								if [ $cmd = &quot;.&quot; ];then
-									echo &gt;&gt; $input
-									continue
-								fi
-								echo $cmd &gt;&gt; $input
-							done
-						else
-							#======================================
-							# 10.2.2.1.2 with recovery partition
-							#--------------------------------------
-							for cmd in \
-								d n p 2 1 +&quot;$disk1MBytes&quot;M \
-								n p 1 . +&quot;$swapsize&quot;M \
-								n p 4 . +&quot;$recoMByte&quot;M \
-								n p 3 . . \
-								t 1 82 w
-							do
-								if [ $cmd = &quot;.&quot; ];then
-									echo &gt;&gt; $input
-									continue
-								fi
-								echo $cmd &gt;&gt; $input
-							done
-						fi
-					else
-						#======================================
-						# 10.2.2.2 without swap partition
-						#--------------------------------------
-						if [ -z &quot;$OEM_RECOVERY&quot; ];then
-							#======================================
-							# 10.2.2.2.1 without recovery partition
-							#--------------------------------------
-							for cmd in \
-								d n p 2 1 +&quot;$disk1MBytes&quot;M \
-								n p 3 . . w
-							do
-								if [ $cmd = &quot;.&quot; ];then
-									echo &gt;&gt; $input
-									continue
-								fi
-								echo $cmd &gt;&gt; $input
-							done
-						else
-							#======================================
-							# 10.2.2.2.2 with recovery partition
-							#--------------------------------------
-							for cmd in \
-								d n p 2 1 +&quot;$disk1MBytes&quot;M \
-								n p 4 . +&quot;$recoMByte&quot;M \
-								n p 3 . . w
-							do
-								if [ $cmd = &quot;.&quot; ];then
-									echo &gt;&gt; $input
-									continue
-								fi
-								echo $cmd &gt;&gt; $input
-							done
-						fi
-					fi
-				fi
-				Echo &quot;Repartition the disk according to current geometry&quot;
-				fdisk $deviceDisk &lt; $input 1&gt;&amp;2
-				if test $? != 0; then
-					systemException &quot;Failed to create partition table&quot; &quot;reboot&quot;
-				fi
-			fi
-			#======================================
-			# 10.3 Update new device names
-			#--------------------------------------
-			if [ -z &quot;$DONT_PARTITION&quot; ];then
-				export deviceRoot=$deviceDisk&quot;2&quot;
-				export deviceSwap=$deviceDisk&quot;1&quot;
-			else
-				export deviceRoot=$deviceDisk&quot;1&quot;
-			fi
-			if [ -z &quot;$OEM_WITHOUTHOME&quot; ];then
-				export deviceHome=$deviceDisk&quot;3&quot;
-			fi
-			if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
-				export deviceRecovery=$deviceDisk&quot;4&quot;
-			fi
-			#======================================
-			# 10.4 Activate swap space
-			#--------------------------------------
-			if partitionSize $deviceSwap &amp;&gt;/dev/null;then
-				Echo &quot;Activating swap space on $deviceSwap&quot;
-				if ! mkswap $deviceSwap &gt;/dev/null 2&gt;&amp;1;then
-					systemException &quot;Failed to create swap signature&quot; &quot;reboot&quot;
-				fi
-			fi
-			#======================================
-			# 10.5 Create home file system
-			#--------------------------------------
-			if [ -z &quot;$OEM_WITHOUTHOME&quot; ];then
-				Echo &quot;Creating Home filesystem on $deviceHome&quot;
-				if ! mke2fs -j -q $deviceHome &gt;/dev/null 2&gt;&amp;1;then
-					systemException &quot;Failed to create Home fs&quot; &quot;reboot&quot;
-				fi
-			fi
-			#======================================
-			# 10.6 Create recovery file system
-			#--------------------------------------
-			if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
-				Echo &quot;Creating Recovery filesystem on $deviceRecovery&quot;
-				if ! mke2fs -j -q $deviceRecovery &gt;/dev/null 2&gt;&amp;1;then
-					systemException &quot;Failed to create Recovery fs&quot; &quot;reboot&quot;
-				fi
-			fi
-			#======================================
-			# 10.7 Setup recovery contents
-			#--------------------------------------
-			if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
-				Echo &quot;Setting up recovery archive...&quot;
-				mkdir -p /reco-root
-				if ! mount $deviceRoot /reco-root &gt;/dev/null;then
-					systemException &quot;Failed to mount root device&quot; &quot;reboot&quot;
-				fi
-				mkdir -p /reco-save
-				if ! mount $deviceRecovery /reco-save &gt;/dev/null;then
-					systemException &quot;Failed to mount recovery device&quot; &quot;reboot&quot;
-				fi
-				if ! mv /reco-root/recovery.tar.gz /reco-save &gt;/dev/null;then
-					systemException &quot;Failed to move recovery archive&quot; &quot;reboot&quot;
-				fi
-				mkdir /reco-save/boot
-				if ! cp /reco-root/boot/initrd.vmx /reco-save/boot/initrd;then
-					systemException &quot;Failed to copy recovery initrd&quot; &quot;reboot&quot;
-				fi
-				if ! cp /reco-root/boot/linux.vmx /reco-save/boot/vmlinuz;then
-					systemException &quot;Failed to copy recovery kernel&quot; &quot;reboot&quot;
-				fi
-				umount /reco-save &amp;&amp; rmdir /reco-save
-				umount /reco-root &amp;&amp; rmdir /reco-root
-			fi
-		else
-			#====================================== 
-			# 10.2 no recovery support in this mode
-			#--------------------------------------
-			unset OEM_RECOVERY
-			#======================================
-			# 10.2 calculate end block - swapspace
-			#--------------------------------------
-			swapXMBytes=$swapsize
-			diskXMBytes=`partitionSize $deviceDisk`
-			diskXMBytes=`expr $diskXMBytes / 1024`
-			disk1MBytes=`partitionSize &quot;$deviceDisk&quot;1`
-			disk1MBytes=`expr $disk1MBytes / 1024`
-			disk2MBytes=`expr $diskXMBytes - $disk1MBytes - $swapsize`
-			if [ $disk2MBytes -lt 100 ];then
-				# /.../
-				# Very small disk which we will not re-partition
-				# ----
-				Echo &quot;Disk is too small, will not re-partition it&quot;
-				DONT_PARTITION=1
-			fi
-			if [ -z &quot;$DONT_PARTITION&quot; ];then
-				#======================================
-				# 10.3 write new partition table
-				#--------------------------------------
-				# /.../
-				# Explanation of the partition commands used within the
-				# here document below:
-				# ----
-				# d               # delete xda partition
-				# 2               # [ 2 ]
-				# n               # create xda partition at same place than xda2
-				# p               # primary
-				# 2               # [ 2 ]
-				#                 # accept old xda2 start block
-				# +&quot;disk2MBytes&quot;M # accept new RW device size
-				# n               # create xda swap partition
-				# p               # primary
-				# 3               # [ 3 ]
-				#                 # accept start block
-				#                 # accept end block
-				# t               # change swap system id
-				# 3               # [ 3 ]
-				# 82              # Linux Swap
-				# w               # write partition table
-				# ----
-				input=/part.input
-				rm -f $input
-				if [ $swapsize = 0 ];then
-					for cmd in d 2 n p 2 . +&quot;$disk2MBytes&quot;M w; do
-						if [ $cmd = &quot;.&quot; ];then
-							echo &gt;&gt; $input
-							continue
-						fi
-						echo $cmd &gt;&gt; $input
-					done
-				else
-					for cmd in d 2 n p 2 . +&quot;$disk2MBytes&quot;M n p 3 . . t 3 82 w
-					do
-						if [ $cmd = &quot;.&quot; ];then
-							echo &gt;&gt; $input
-							continue
-						fi
-						echo $cmd &gt;&gt; $input
-					done
-				fi
-				Echo &quot;Repartition the disk according to current geometry&quot;
-				fdisk $deviceDisk &lt; $input 1&gt;&amp;2
-				if test $? != 0; then
-					systemException &quot;Failed to create partition table&quot; &quot;reboot&quot;
-				fi
-			fi
-			#======================================
-			# 10.4 Update new device names
-			#--------------------------------------
-			export deviceRoot=$deviceDisk&quot;1&quot;
-			export deviceSwap=$deviceDisk&quot;3&quot;
-			export deviceIOWR=$deviceDisk&quot;2&quot;
-
-			#======================================
-			# 10.5 Activate swap space
-			#--------------------------------------
-			if partitionSize $deviceSwap &amp;&gt;/dev/null;then
-				Echo &quot;Activating swap space on $deviceSwap&quot;
-				if ! mkswap $deviceSwap &gt;/dev/null 2&gt;&amp;1;then
-					systemException &quot;Failed to create swap signature&quot; &quot;reboot&quot;
-				fi
-			fi
-		fi
-	fi
+#======================================
+# 12) repartition the disk device
+#--------------------------------------
+if [ $LOCAL_BOOT = &quot;no&quot; ];then
+	OEMRepart
 fi
 
 #======================================
-# 11) Resize filesystem to full space
+# 13) Resize filesystem to full space
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
-	deviceResize=$deviceRoot
+	deviceResize=$imageRootDevice
 	fstypeRootFS=$FSTYPE
 	if [ ! -z $COMBINED_IMAGE ];then
-		deviceResize=$deviceIOWR
+		deviceResize=$imageIOWRDevice
 		KIWI_INITRD_PARAMS=&quot;COMBINED_IMAGE=local&quot;
 		probeFileSystem $deviceResize
 		export KIWI_INITRD_PARAMS
 	fi
 	if isFSTypeReadOnly &amp;&amp; [ -z &quot;$COMBINED_IMAGE&quot; ];then
-		deviceResize=$deviceIOWR
-		setupUnionFS &quot;$deviceDisk&quot;2 &quot;$deviceDisk&quot;1 aufs
+		deviceResize=$imageIOWRDevice
 		KIWI_INITRD_PARAMS=&quot;UNIONFS_CONFIG=yes&quot;
 		probeFileSystem $deviceResize
 		export KIWI_INITRD_PARAMS
@@ -910,42 +196,44 @@
 	if [ ! -z &quot;$deviceResize&quot; ] &amp;&amp; partitionSize $deviceResize &amp;&gt;/dev/null;then
 		if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
 			KIWI_INITRD_PARAMS=&quot;$KIWI_INITRD_PARAMS LOCAL_BOOT=yes&quot;
-			KIWI_INITRD_PARAMS=&quot;$KIWI_INITRD_PARAMS deviceRecovery=yes&quot;
+			KIWI_INITRD_PARAMS=&quot;$KIWI_INITRD_PARAMS RECOVERY=yes&quot;
 			export KIWI_INITRD_PARAMS
 		fi
-		if [ &quot;$FSTYPE&quot; = &quot;reiserfs&quot; ];then
-			Echo &quot;Resize Reiser filesystem to full partition space...&quot;
-			resize_reiserfs -q $deviceResize
-			INITRD_MODULES=&quot;$INITRD_MODULES reiserfs&quot;
+		if [ -z &quot;$DONT_PARTITION&quot; ];then
+			if [ &quot;$FSTYPE&quot; = &quot;reiserfs&quot; ];then
+				Echo &quot;Resize Reiser filesystem to full partition space...&quot;
+				resize_reiserfs -q $deviceResize
+				INITRD_MODULES=&quot;$INITRD_MODULES reiserfs&quot;
+			fi
+			if [ &quot;$FSTYPE&quot; = &quot;ext2&quot; ];then
+				Echo &quot;Resize EXT2 filesystem to full partition space...&quot;
+				resize2fs -f -F -p $deviceResize
+				Echo &quot;Checking EXT2 filesystem...&quot;
+				e2fsck -y -f $deviceResize
+				INITRD_MODULES=&quot;$INITRD_MODULES ext2&quot;
+			fi
+			if [ &quot;$FSTYPE&quot; = &quot;ext3&quot; ];then
+				Echo &quot;Resize EXT3 filesystem to full partition space...&quot;
+				resize2fs -f -F -p $deviceResize
+				Echo &quot;Checking EXT3 filesystem...&quot;
+				e2fsck -y -f $deviceResize
+				INITRD_MODULES=&quot;$INITRD_MODULES ext3&quot;
+			fi
 		fi
-		if [ &quot;$FSTYPE&quot; = &quot;ext2&quot; ];then
-			Echo &quot;Resize EXT2 filesystem to full partition space...&quot;
-			resize2fs -f -F -p $deviceResize
-			Echo &quot;Checking EXT2 filesystem...&quot;
-			e2fsck -y -f $deviceResize
-			INITRD_MODULES=&quot;$INITRD_MODULES ext2&quot;
-		fi
-		if [ &quot;$FSTYPE&quot; = &quot;ext3&quot; ];then
-			Echo &quot;Resize EXT3 filesystem to full partition space...&quot;
-			resize2fs -f -F -p $deviceResize
-			Echo &quot;Checking EXT3 filesystem...&quot;
-			e2fsck -y -f $deviceResize
-			INITRD_MODULES=&quot;$INITRD_MODULES ext3&quot;
-		fi
 	fi
 	FSTYPE=$fstypeRootFS
 fi
 
 #======================================
-# 12) Mount system
+# 14) Mount system
 #--------------------------------------
-if ! mountSystem $deviceRoot;then
+if ! mountSystem $imageRootDevice;then
 	systemException &quot;Failed to mount root filesystem&quot; &quot;reboot&quot;
 fi
 validateRootTree
 
 #======================================
-# 13) Recover system if requested
+# 15) Recover system if requested
 #--------------------------------------
 if [ ! -z &quot;$KIWI_RECOVERY&quot; ];then
 	Echo -n &quot;Do you want to start the System-Recovery ? [y/n]: &quot;; read runReco
@@ -954,14 +242,14 @@
 	fi
 	Echo &quot;Starting System-Recovery...&quot;
 	#======================================
-	# 13.1) mount recovery partition
+	# 15.1) mount recovery partition
 	#--------------------------------------
 	mkdir -p /reco-save
-	if ! mount $deviceRecovery /reco-save &gt;/dev/null;then
+	if ! mount $imageRecoveryDevice /reco-save &gt;/dev/null;then
 		systemException &quot;Failed to mount recovery device&quot; &quot;reboot&quot;
 	fi
 	#======================================
-	# 13.2) restore root archive
+	# 15.2) restore root archive
 	#--------------------------------------
 	Echo &quot;Restoring base operating system...&quot;
 	cd /mnt
@@ -969,7 +257,7 @@
 		systemException &quot;Failed to restore recovery archive&quot; &quot;reboot&quot;
 	fi
 	#======================================
-	# 13.3) restore boot files
+	# 15.3) restore boot files
 	#--------------------------------------
 	Echo &quot;Restoring boot files...&quot;
 	for i in etc/fstab etc/sysconfig/kernel etc/sysconfig/bootloader;do
@@ -990,30 +278,46 @@
 		fi
 	done
 	#======================================
-	# 13.4) umount recovery and boot
+	# 15.4) umount recovery and boot
 	#--------------------------------------
-	umount $deviceRecovery
-	export deviceDisk=`echo $deviceRoot | tr -d &quot;[:digit:]&quot;`
+	umount $imageRecoveryDevice
 fi
 
 #======================================
-# 14) get installed kernels
+# 16) get installed kernels
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
 	kernelList /mnt
 fi
 
 #======================================
-# 15) setup ird/kernel links for union
+# 17) setup /lvmboot
 #--------------------------------------
+if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+	mkdir /mnt/lvmboot
+	mount $imageBootDevice /mnt/lvmboot
+	if [ -z $UNIONFS_CONFIG ];then
+		cp -a /mnt/boot/* /mnt/lvmboot/boot
+	fi
+	rm -rf /mnt/boot
+	( cd /mnt &amp;&amp; ln -s lvmboot/boot boot )
+fi
+
+#======================================
+# 18) setup ird/kernel links for union
+#--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; isFSTypeReadOnly;then
 	# /.../
 	# we are using a special root setup with aufs. In this case
 	# we can't use the SuSE Linux initrd but must stick to the
 	# kiwi boot system.
 	# ----
-	kiwiMount &quot;$deviceDisk&quot;2 &quot;/mnt&quot;
-	pushd /mnt/boot &gt;/dev/null
+	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+		pushd /mnt/lvmboot/boot &gt;/dev/null
+	else
+		kiwiMount $imageRWDevice &quot;/mnt&quot;
+		pushd /mnt/boot &gt;/dev/null
+	fi
 	IFS=&quot;,&quot; ; for i in $KERNEL_LIST;do
 		if test -z &quot;$i&quot;;then
 			continue
@@ -1026,63 +330,69 @@
 	done
 	IFS=$IFS_ORIG
 	popd &gt;/dev/null
-	umount /mnt
+	if [ ! &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+		umount /mnt
+	fi
 fi
 
 #======================================
-# 16) Create system dependant files
+# 19) Create system dependant files
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
-	export HAVE_SWAP=0
+	#======================================
+	# setup: /etc/fstab
+	#--------------------------------------
 	setupDefaultFstab /config
-	if partitionSize $deviceSwap &amp;&gt;/dev/null;then
-		updateSwapDeviceFstab /config $deviceSwap
-		HAVE_SWAP=1
+	updateRootDeviceFstab /config $imageRootDevice
+	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+		updateLVMBootDeviceFstab /config $imageBootDevice
 	fi
-	if [ -z &quot;$UNIONFS_CONFIG&quot; ] &amp;&amp; [ -z &quot;$COMBINED_IMAGE&quot; ]; then
-		echo &quot;$deviceRoot / $FSTYPE defaults 0 0&quot; &gt;&gt; /config/etc/fstab
-		if [ -z &quot;$OEM_WITHOUTHOME&quot; ] &amp;&amp; [ -z &quot;$DONT_PARTITION&quot; ];then
-			if [ `ls /mnt/home/ | wc -l` != 0 ]; then
-				Echo &quot;Found non empty home/ directory !&quot;
-				Echo &quot;Moving home/ data to home partition $deviceHome&quot;
-				mount $deviceHome /mnt/mnt &amp;&amp; mv /mnt/home/* /mnt/mnt
-				umount /mnt/mnt
-			fi
-			Echo &quot;Activate home partition $deviceHome in fstab&quot;
-			echo &quot;$deviceHome /home ext3 defaults 0 0&quot; &gt;&gt; /config/etc/fstab
-		fi
+	if partitionSize $imageSwapDevice &amp;&gt;/dev/null;then
+		updateSwapDeviceFstab /config $imageSwapDevice
+	else
+		unset $imageSwapDevice
 	fi
-	if [ -z &quot;$UNIONFS_CONFIG&quot; ] &amp;&amp; [ -z &quot;$COMBINED_IMAGE&quot; ]; then
-		Echo &quot;Creating boot loader configuration&quot;
-		if [ -z &quot;$OEM_BOOT_TITLE&quot; ];then
-			export OEM_BOOT_TITLE=&quot;OEM&quot;
+	if [ -z &quot;$OEM_WITHOUTHOME&quot; ] &amp;&amp; [ -z &quot;$DONT_PARTITION&quot; ];then
+		if [ `ls /mnt/home/ | wc -l` != 0 ]; then
+			Echo &quot;Found non empty home/ directory !&quot;
+			Echo &quot;Moving home/ data to home partition $imageHomeDevice&quot;
+			mount $imageHomeDevice /mnt/mnt &amp;&amp; mv /mnt/home/* /mnt/mnt
+			umount /mnt/mnt
 		fi
-		if [ ! -z $OEM_RECOVERY ];then
-			OEM_RECOVERY=${deviceDisk}4
-		fi
-		bootid=`echo $deviceRoot | tr -d &quot;[:alpha:]//&quot;`
-		bootid=`expr $bootid - 1`
-		setupBootLoader \
-			/mnt /config $bootid $deviceRoot $OEM_BOOT_TITLE $deviceSwap
+		Echo &quot;Activate home partition $imageHomeDevice in fstab&quot;
+		echo &quot;$imageHomeDevice /home ext3 defaults 0 0&quot; &gt;&gt; /config/etc/fstab
 	fi
+	#======================================
+	# setup: bootloader files
+	#--------------------------------------
+	Echo &quot;Creating boot loader configuration&quot;
+	if [ -z &quot;$OEM_BOOT_TITLE&quot; ];then
+		export OEM_BOOT_TITLE=&quot;OEM&quot;
+	fi
+	if [ ! -z $OEM_RECOVERY ];then
+		OEM_RECOVERY=$imageRecoveryDevice
+	fi
+	setupBootLoader \
+		/mnt /config $bootid $imageRootDevice \
+		$OEM_BOOT_TITLE $imageSwapDevice
 	setupKernelModules /config
 fi
 
 #======================================
-# 17) copy system dependant files
+# 20) copy system dependant files
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
 	setupConfigFiles
 fi
 
 #======================================
-# 18) copy recovery related files
+# 21) copy recovery related files
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ ! -z &quot;$OEM_RECOVERY&quot; ];then
 	IFS=$IFS_ORIG
 	Echo &quot;Setting up recovery configuration files...&quot;
 	mkdir -p /reco-save
-	if ! mount $deviceRecovery /reco-save &gt;/dev/null;then
+	if ! mount $imageRecoveryDevice /reco-save &gt;/dev/null;then
 		systemException &quot;Failed to mount recovery device&quot; &quot;reboot&quot;
 	fi
 	mkdir -p /reco-save/etc/sysconfig
@@ -1108,22 +418,22 @@
 fi
 
 #======================================
-# 19) update system dependant files
+# 22) update system dependant files
 #--------------------------------------
 setupInittab /mnt
 
 #======================================
-# 20) setup real root device
+# 23) setup real root device
 #--------------------------------------
 echo 256 &gt; /proc/sys/kernel/real-root-dev
 
 #======================================
-# 21) umount system filesystems
+# 24) umount system filesystems
 #--------------------------------------
 umountSystemFilesystems
 
 #======================================
-# 22) copy initrd files to image
+# 25) copy initrd files to image
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
 	importBranding
@@ -1132,17 +442,17 @@
 cp /include /mnt
 
 #======================================
-# 23) kill boot shell
+# 26) kill boot shell
 #--------------------------------------
 killShell
 killBlogD
 
 #======================================
-# 24) Activate new root
+# 27) Activate new root
 #--------------------------------------
 activateImage
 
 #======================================
-# 25 Unmount initrd / system init
+# 28 Unmount initrd / system init
 #--------------------------------------
 bootImage $@

Modified: kiwi-head/system/boot/ix86/oemboot/suse-preinit
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-preinit	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-preinit	2009-01-08 14:29:45 UTC (rev 1831)
@@ -60,20 +60,6 @@
 	#======================================
 	# use kiwi initrd from RW partition
 	#--------------------------------------
-	if [ -d /read-write/boot ];then
-		rm -rf /boot &amp;&amp; ln -s /read-write/boot /boot
-	fi
-	kernelList /
-	if [ ! -z &quot;$COMBINED_IMAGE&quot; ];then
-		Echo &quot;Creating bootloader configuration: [ split system ]&quot;
-	else
-		Echo &quot;Creating bootloader configuration: [ unified system ]&quot;
-	fi
-	if [ $HAVE_SWAP -eq 1 ];then
-		setupBootLoader / / 1 &quot;$deviceDisk&quot;2 $OEM_BOOT_TITLE $deviceSwap
-	else
-		setupBootLoader / / 1 &quot;$deviceDisk&quot;2 $OEM_BOOT_TITLE
-	fi
 	bootLoaderOK=1
 fi
 

Added: kiwi-head/system/boot/ix86/oemboot/suse-repart
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-repart	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/oemboot/suse-repart	2009-01-08 14:29:45 UTC (rev 1831)
@@ -0,0 +1,590 @@
+#!/bin/bash
+#================
+# FILE          : linuxrc
+#----------------
+# PROJECT       : OpenSuSE KIWI Image System
+# COPYRIGHT     : (c) 2006 SUSE LINUX Products GmbH. All rights reserved
+#               :
+# AUTHOR        : Marcus Schaefer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>&gt;
+#               :
+# BELONGS TO    : Operating System images
+#               :
+# DESCRIPTION   : OEM repartition code functions. This file is used
+#               : to setup the partition table according to the OEM
+#               : specifications
+#               :
+# STATUS        : BETA
+#----------------
+#======================================
+# OEMRepartInit 
+#--------------------------------------
+function OEMRepartInit {
+	# /.../
+	# calculate memory based swapsize amount and initialize
+	# size of recovery archive
+	# ----
+	mem_size=`grep MemTotal: /proc/meminfo | tr -dc '[0-9]'`
+	swapsize=$(( $mem_size *2 / 1024 ))
+	recoMByte=0
+	if [ ! -z &quot;$OEM_SWAPSIZE&quot; ];then
+		swapsize=$OEM_SWAPSIZE
+	fi
+	if [ ! -z &quot;$OEM_WITHOUTSWAP&quot; ];then
+		swapsize=0
+	fi
+	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+		mkdir -p /reco-root
+		if ! mount $imageRootDevice /reco-root &gt;/dev/null;then
+			systemException &quot;Failed to mount root device&quot; &quot;reboot&quot;
+		fi
+		if [ ! -f /reco-root/recovery.tar.gz ];then
+			systemException &quot;Can't find recovery archive&quot; &quot;reboot&quot;
+		fi
+		recoBytes=`du --bytes /reco-root/recovery.tar.gz | cut -f1`
+		recoMByte=`expr $recoBytes / 1048576`
+		recoMByte=`expr $recoMByte \* 15 / 10`
+		umount /reco-root &amp;&amp; rmdir /reco-root
+	fi
+}
+
+#======================================
+# OEMRepartStandard
+#--------------------------------------
+function OEMRepartStandard {
+	# /.../
+	# repartition disk with read/write root filesystem
+	# ----
+	#======================================
+	# write new partition table
+	#--------------------------------------
+	# /.../
+	# Explanation of the partition commands used within the
+	# here document below:
+	# ----
+	# d              # delete xda partition [ 1 ]
+	# n              # create xda partition at same place than xda1
+	# p              # primary
+	# 2              # [ 2 ]
+	# 1              # accept old xda1 start block for xda2
+	# +10240M        # accept new root device size of 10GB
+	# n              # create xda swap partition
+	# p              # primary
+	# 1              # [ 1 ]
+	#                # accept start block
+	# +&quot;$swapsize&quot;M  # accept new swapsize
+	# n              # create xda3 home partition
+	# p              # primary
+	# 3              # [ 3 ]
+	#                # accept start block
+	#                # accept end block, complete disk
+	# t              # change swap system id
+	# 1              # [ 1 ]
+	# 82             # Linux Swap
+	# w              # write partition table
+	# ----
+	input=/part.input
+	rm -f $input
+	diskXMBytes=`partitionSize $imageDiskDevice`
+	diskPMBytes=`partitionSize $imageDiskDevice&quot;1&quot;`
+	diskPMBytes=`expr $diskPMBytes / 1024`
+	diskXMBytes=`expr $diskXMBytes / 1024`
+	disk1MBytes=10240
+	# /.../
+	# set OEM_SYSTEMSIZE if available, else try to
+	# use 10GB system size
+	# ----
+	if [ ! -z &quot;$OEM_SYSTEMSIZE&quot; ];then
+		disk1MBytes=$OEM_SYSTEMSIZE
+	fi
+	# /.../
+	# prevent /home and recovery partition if requested
+	# system size is bigger than the whole disk
+	# ----
+	if [ $disk1MBytes -gt $diskXMBytes ];then
+		export OEM_WITHOUTHOME=1
+		unset OEM_RECOVERY
+		recoMByte=0
+	fi
+	# /.../
+	# recalculate system size if no /home partition
+	# will be used. size is whole disk minus swap
+	# minus recovery
+	# ----
+	if [ ! -z &quot;$OEM_WITHOUTHOME&quot; ];then
+		disk1MBytes=`expr $diskXMBytes - $swapsize - $recoMByte`
+	fi
+	# /.../
+	# check if requested system size is bigger than
+	# the existing system partition
+	# ----
+	if [ $disk1MBytes -lt $diskPMBytes ];then
+		# /.../
+		# Requested system partition size is smaller than
+		# existing partition, will not re-partition
+		# ----
+		Echo &quot;Current system partition is bigger than requested size&quot;
+		Echo &quot;Disk won't be re-partitioned&quot;
+		OEM_WITHOUTHOME=1
+		DONT_PARTITION=1
+		unset OEM_RECOVERY
+	fi
+	if [ -z &quot;$DONT_PARTITION&quot; ];then
+		if [ ! -z &quot;$OEM_WITHOUTHOME&quot; ];then
+			#======================================
+			# -home
+			#--------------------------------------
+			if [ -z &quot;$OEM_WITHOUTSWAP&quot; ];then
+				#======================================
+				# -home +swap
+				#--------------------------------------
+				if [ -z &quot;$OEM_RECOVERY&quot; ];then
+					#======================================
+					# -home +swap -recovery
+					#--------------------------------------
+					for cmd in \
+						d n p 2 1 +&quot;$disk1MBytes&quot;M \
+						n p 1 . . \
+						t 1 82 w
+					do
+						if [ $cmd = &quot;.&quot; ];then
+							echo &gt;&gt; $input
+							continue
+						fi
+						echo $cmd &gt;&gt; $input
+					done
+				else
+					#======================================
+					# -home +swap +recovery
+					#--------------------------------------
+					for cmd in \
+						d n p 2 1 +&quot;$disk1MBytes&quot;M \
+						n p 4 . +&quot;$recoMByte&quot;M \
+						n p 1 . . \
+						t 1 82 w
+					do
+					if [ $cmd = &quot;.&quot; ];then
+						echo &gt;&gt; $input
+							continue
+						fi
+						echo $cmd &gt;&gt; $input
+					done
+				fi
+			else
+				#======================================
+				# -home -swap
+				#--------------------------------------
+				if [ -z &quot;$OEM_RECOVERY&quot; ];then
+					#======================================
+					# -home -swap -recovery
+					#--------------------------------------
+					for cmd in \
+						d n p 2 . . w
+					do
+						if [ $cmd = &quot;.&quot; ];then
+							echo &gt;&gt; $input
+							continue
+						fi
+						echo $cmd &gt;&gt; $input
+					done
+				else
+					#======================================
+					# -home -swap +recovery
+					#--------------------------------------
+					for cmd in \
+						d n p 2 1 +&quot;$disk1MBytes&quot;M \
+						n p 4 . . w
+					do
+						if [ $cmd = &quot;.&quot; ];then
+							echo &gt;&gt; $input
+							continue
+						fi
+						echo $cmd &gt;&gt; $input
+					done
+				fi
+			fi
+		else
+			#======================================
+			# +home
+			#--------------------------------------
+			if [ -z &quot;$OEM_WITHOUTSWAP&quot; ];then
+				#======================================
+				# +home +swap
+				#--------------------------------------
+				if [ -z &quot;$OEM_RECOVERY&quot; ];then
+					#======================================
+					# +home +swap -recovery
+					#--------------------------------------
+					for cmd in \
+						d n p 2 1 +&quot;$disk1MBytes&quot;M \
+						n p 1 . +&quot;$swapsize&quot;M \
+						n p 3 . . \
+						t 1 82 w
+					do
+						if [ $cmd = &quot;.&quot; ];then
+							echo &gt;&gt; $input
+							continue
+						fi
+						echo $cmd &gt;&gt; $input
+					done
+				else
+					#======================================
+					# +home +swap +recovery
+					#--------------------------------------
+					for cmd in \
+						d n p 2 1 +&quot;$disk1MBytes&quot;M \
+						n p 1 . +&quot;$swapsize&quot;M \
+						n p 4 . +&quot;$recoMByte&quot;M \
+						n p 3 . . \
+						t 1 82 w
+					do
+						if [ $cmd = &quot;.&quot; ];then
+							echo &gt;&gt; $input
+							continue
+						fi
+						echo $cmd &gt;&gt; $input
+					done
+				fi
+			else
+				#======================================
+				# +home -swap
+				#--------------------------------------
+				if [ -z &quot;$OEM_RECOVERY&quot; ];then
+					#======================================
+					# +home -swap -recovery
+					#--------------------------------------
+					for cmd in \
+						d n p 2 1 +&quot;$disk1MBytes&quot;M \
+						n p 3 . . w
+					do
+						if [ $cmd = &quot;.&quot; ];then
+							echo &gt;&gt; $input
+							continue
+						fi
+						echo $cmd &gt;&gt; $input
+					done
+				else
+					#======================================
+					# +home -swap +recovery
+					#--------------------------------------
+					for cmd in \
+						d n p 2 1 +&quot;$disk1MBytes&quot;M \
+						n p 4 . +&quot;$recoMByte&quot;M \
+						n p 3 . . w
+					do
+						if [ $cmd = &quot;.&quot; ];then
+							echo &gt;&gt; $input
+							continue
+						fi
+						echo $cmd &gt;&gt; $input
+					done
+				fi
+			fi
+		fi
+		Echo &quot;Repartition the disk according to current geometry&quot;
+		fdisk $imageDiskDevice &lt; $input 1&gt;&amp;2
+		if test $? != 0; then
+			systemException &quot;Failed to create partition table&quot; &quot;reboot&quot;
+		fi
+	fi
+	#======================================
+	# Update new device names
+	#--------------------------------------
+	if [ -z &quot;$DONT_PARTITION&quot; ];then
+		export imageRootDevice=$imageDiskDevice&quot;2&quot;
+		export imageSwapDevice=$imageDiskDevice&quot;1&quot;
+		bootid=1
+	else
+		export imageRootDevice=$imageDiskDevice&quot;1&quot;
+		bootid=0
+	fi
+	if [ -z &quot;$OEM_WITHOUTHOME&quot; ];then
+		export imageHomeDevice=$imageDiskDevice&quot;3&quot;
+	fi
+	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+		export imageRecoveryDevice=$imageDiskDevice&quot;4&quot;
+	fi
+}
+
+#======================================
+# OEMRepartOverlayed
+#--------------------------------------
+function OEMRepartOverlayed {
+	# /.../
+	# repartition disk if overlay system via aufs is used
+	# ---- 
+	#====================================== 
+	# no recovery support in union mode
+	#--------------------------------------
+	unset OEM_RECOVERY
+	#====================================== 
+	# no homepart support for union mode
+	#--------------------------------------
+	export OEM_WITHOUTHOME=1
+	#======================================
+	# calculate end block - swapspace
+	#--------------------------------------
+	swapXMBytes=$swapsize
+	diskXMBytes=`partitionSize $imageDiskDevice`
+	diskXMBytes=`expr $diskXMBytes / 1024`
+	disk1MBytes=`partitionSize $imageDiskDevice&quot;1&quot;`
+	disk1MBytes=`expr $disk1MBytes / 1024`
+	disk2MBytes=`expr $diskXMBytes - $disk1MBytes - $swapsize`
+	if [ $disk2MBytes -lt 100 ];then
+		# /.../
+		# Very small disk which we will not re-partition
+		# ----
+		Echo &quot;Disk is too small, will not re-partition it&quot;
+		DONT_PARTITION=1
+	fi
+	if [ -z &quot;$DONT_PARTITION&quot; ];then
+		#======================================
+		# write new partition table
+		#--------------------------------------
+		# /.../
+		# Explanation of the partition commands used within the
+		# here document below:
+		# ----
+		# d               # delete xda partition
+		# 2               # [ 2 ]
+		# n               # create xda partition at same place than xda2
+		# p               # primary
+		# 2               # [ 2 ]
+		#                 # accept old xda2 start block
+		# +&quot;disk2MBytes&quot;M # accept new RW device size
+		# n               # create xda swap partition
+		# p               # primary
+		# 3               # [ 3 ]
+		#                 # accept start block
+		#                 # accept end block
+		# t               # change swap system id
+		# 3               # [ 3 ]
+		# 82              # Linux Swap
+		# w               # write partition table
+		# ----
+		input=/part.input
+		rm -f $input
+		if [ $swapsize = 0 ];then
+			for cmd in d 2 n p 2 . +&quot;$disk2MBytes&quot;M w; do
+				if [ $cmd = &quot;.&quot; ];then
+					echo &gt;&gt; $input
+					continue
+				fi
+				echo $cmd &gt;&gt; $input
+			done
+		else
+			for cmd in d 2 n p 2 . +&quot;$disk2MBytes&quot;M n p 3 . . t 3 82 w
+			do
+				if [ $cmd = &quot;.&quot; ];then
+					echo &gt;&gt; $input
+					continue
+				fi
+				echo $cmd &gt;&gt; $input
+			done
+		fi
+		Echo &quot;Repartition the disk according to current geometry&quot;
+		fdisk $imageDiskDevice &lt; $input 1&gt;&amp;2
+		if test $? != 0; then
+			systemException &quot;Failed to create partition table&quot; &quot;reboot&quot;
+		fi
+	fi
+	#======================================
+	# Update new device names
+	#--------------------------------------
+	export imageRootDevice=$imageDiskDevice&quot;1&quot;
+	export imageSwapDevice=$imageDiskDevice&quot;3&quot;
+	export imageIOWRDevice=$imageDiskDevice&quot;2&quot;
+	bootid=1
+}
+
+#======================================
+# OEMRepartCombined
+#--------------------------------------
+function OEMRepartCombined {
+	# /.../
+	# repartition disk if split system is used
+	# ----
+	#====================================== 
+	# no recovery support for combined mode
+	#--------------------------------------
+	unset OEM_RECOVERY
+	#====================================== 
+	# no homepart support for combined mode
+	#--------------------------------------
+	export OEM_WITHOUTHOME=1
+	#====================================== 
+	# check for read-write partition
+	#--------------------------------------
+	if ! partitionSize $imageDiskDevice&quot;2&quot; &amp;&gt;/dev/null;then
+		Echo &quot;No read-write partition in this split image&quot;
+		DONT_PARTITION=1
+	fi
+	#======================================
+	# calculate new partition 3 size
+	#--------------------------------------
+	if [ -z &quot;$DONT_PARTITION&quot; ];then
+		swapXMBytes=$swapsize
+		diskXMBytes=`partitionSize $imageDiskDevice`
+		diskXMBytes=`expr $diskXMBytes / 1024`
+		disk1MBytes=`partitionSize $imageDiskDevice&quot;1&quot;`
+		disk1MBytes=`expr $disk1MBytes / 1024`
+		disk2MBytes=`partitionSize $imageDiskDevice&quot;2&quot;`
+		disk2MBytes=`expr $disk2MBytes / 1024`
+		diskXLBytes=`expr $diskXMBytes - $disk1MBytes - $disk2MBytes`
+		diskXABytes=`expr $diskXLBytes - $swapXMBytes`
+		if [ $diskXABytes -lt 50 ];then
+			# /.../
+			# Very small disk which we will not re-partition
+			# ----
+			Echo &quot;Disk is too small, will not re-partition it&quot;
+			DONT_PARTITION=1
+		else
+			disk2MBytes=`expr $disk2MBytes + $diskXABytes`
+		fi
+	fi
+	if [ -z &quot;$DONT_PARTITION&quot; ];then
+		#======================================
+		# write new partition table
+		#--------------------------------------
+		# /.../
+		# Explanation of the partition commands used within the
+		# here document below:
+		# ----
+		# d               # delete xda partition
+		# 2               # [ 2 ]
+		# n               # create xda partition at same place than xda2
+		# p               # primary
+		# 2               # [ 2 ]
+		#                 # accept old xda3 start block
+		# +&quot;disk2MBytes&quot;M # accept new RW device size of disk blocks - swap
+		# n               # create xda swap partition
+		# p               # primary
+		# 3               # [ 3 ]
+		#                 # accept start block
+		#                 # accept end block
+		# t               # change swap system id
+		# 3               # [ 3 ]
+		# 82              # Linux Swap
+		# w               # write partition table
+		# ----
+		input=/part.input
+		rm -f $input
+		if [ $swapsize = 0 ];then
+			for cmd in d 2 n p 2 . +&quot;$disk2MBytes&quot;M w;do
+				if [ $cmd = &quot;.&quot; ];then
+					echo &gt;&gt; $input
+					continue
+				fi
+				echo $cmd &gt;&gt; $input
+			done
+		else
+			for cmd in d 2 n p 2 . +&quot;$disk2MBytes&quot;M n p 3 . . t 3 82 w;do
+				if [ $cmd = &quot;.&quot; ];then
+					echo &gt;&gt; $input
+					continue
+				fi
+				echo $cmd &gt;&gt; $input
+			done
+		fi
+		Echo &quot;Repartition the disk according to current geometry&quot;
+		fdisk $imageDiskDevice &lt; $input 1&gt;&amp;2
+		if test $? != 0; then
+			systemException &quot;Failed to create partition table&quot; &quot;reboot&quot;
+		fi
+	fi
+	#======================================
+	# Update new device names
+	#--------------------------------------
+	export imageRootDevice=$imageDiskDevice&quot;1&quot;
+	export imageSwapDevice=$imageDiskDevice&quot;3&quot;
+	export imageIOWRDevice=$imageDiskDevice&quot;2&quot;
+	bootid=1
+}
+
+#======================================
+# OEMRepartLVM
+#--------------------------------------
+function OEMRepartLVM {
+	# TODO
+	return
+}
+
+#======================================
+# OEMRepart
+#--------------------------------------
+function OEMRepart {
+	# /.../
+	# call the appropriate repartition functions
+	# ----
+	if [ ! $LOCAL_BOOT = &quot;no&quot; ];then
+		return
+	fi
+	#======================================
+	# Initialize
+	#--------------------------------------
+	OEMRepartInit
+	#======================================
+	# Do the repartitioning
+	#--------------------------------------
+	if [ ! -z &quot;$haveLVM&quot; ];then
+		OEMRepartLVM
+	elif [ ! -z &quot;$COMBINED_IMAGE&quot; ];then
+		OEMRepartCombined
+	elif [ ! -z &quot;$UNIONFS_CONFIG&quot; ];then
+		OEMRepartOverlayed
+	else
+		OEMRepartStandard
+	fi
+	#======================================
+	# Activate swap space
+	#--------------------------------------
+	if partitionSize $imageSwapDevice &amp;&gt;/dev/null;then
+		Echo &quot;Activating swap space on $imageSwapDevice&quot;
+		if ! mkswap $imageSwapDevice &gt;/dev/null 2&gt;&amp;1;then
+			systemException &quot;Failed to create swap signature&quot; &quot;reboot&quot;
+		fi
+	fi
+	#======================================
+	# Create home file system
+	#--------------------------------------
+	if [ -z &quot;$OEM_WITHOUTHOME&quot; ];then
+		Echo &quot;Creating Home filesystem on $imageHomeDevice&quot;
+		if ! mke2fs -j -q $imageHomeDevice &gt;/dev/null 2&gt;&amp;1;then
+			systemException &quot;Failed to create Home fs&quot; &quot;reboot&quot;
+		fi
+	fi
+	#======================================
+	# Create recovery file system
+	#--------------------------------------
+	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+		Echo &quot;Creating Recovery filesystem on $imageRecoveryDevice&quot;
+		if ! mke2fs -j -q $imageRecoveryDevice &gt;/dev/null 2&gt;&amp;1;then
+			systemException &quot;Failed to create Recovery fs&quot; &quot;reboot&quot;
+		fi
+	fi
+	#======================================
+	# Setup recovery contents
+	#--------------------------------------
+	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+		Echo &quot;Setting up recovery archive...&quot;
+		mkdir -p /reco-root
+		if ! mount $imageRootDevice /reco-root &gt;/dev/null;then
+			systemException &quot;Failed to mount root device&quot; &quot;reboot&quot;
+		fi
+		mkdir -p /reco-save
+		if ! mount $imageRecoveryDevice /reco-save &gt;/dev/null;then
+			systemException &quot;Failed to mount recovery device&quot; &quot;reboot&quot;
+		fi
+		if ! mv /reco-root/recovery.tar.gz /reco-save &gt;/dev/null;then
+			systemException &quot;Failed to move recovery archive&quot; &quot;reboot&quot;
+		fi
+		mkdir /reco-save/boot
+		if ! cp /reco-root/boot/initrd.vmx /reco-save/boot/initrd;then
+			systemException &quot;Failed to copy recovery initrd&quot; &quot;reboot&quot;
+		fi
+		if ! cp /reco-root/boot/linux.vmx /reco-save/boot/vmlinuz;then
+			systemException &quot;Failed to copy recovery kernel&quot; &quot;reboot&quot;
+		fi
+		umount /reco-save &amp;&amp; rmdir /reco-save
+		umount /reco-root &amp;&amp; rmdir /reco-root
+	fi
+}


Property changes on: kiwi-head/system/boot/ix86/oemboot/suse-repart
___________________________________________________________________
Name: svn:executable
   + *

Modified: kiwi-head/system/boot/ix86/vmxboot/suse-10.3/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/vmxboot/suse-10.3/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/vmxboot/suse-10.3/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -19,6 +19,7 @@
 		&lt;profile name=&quot;smp&quot; description=&quot;Boot with smp kernel&quot;/&gt;
 	&lt;/profiles&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext2/*&quot;/&gt;
@@ -79,6 +80,7 @@
 		&lt;package name=&quot;bootsplash&quot;/&gt;
 		&lt;package name=&quot;bootsplash-theme-SuSE&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;

Modified: kiwi-head/system/boot/ix86/vmxboot/suse-11.0/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/vmxboot/suse-11.0/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/vmxboot/suse-11.0/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -19,6 +19,7 @@
 		&lt;profile name=&quot;smp&quot; description=&quot;Boot with smp kernel&quot;/&gt;
 	&lt;/profiles&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext2/*&quot;/&gt;
@@ -83,6 +84,7 @@
 		&lt;package name=&quot;bootsplash-branding-openSUSE&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
 		&lt;package name=&quot;cromfs&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;

Modified: kiwi-head/system/boot/ix86/vmxboot/suse-11.1/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/vmxboot/suse-11.1/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/vmxboot/suse-11.1/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -19,6 +19,7 @@
 		&lt;profile name=&quot;smp&quot; description=&quot;Boot with smp kernel&quot;/&gt;
 	&lt;/profiles&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext2/*&quot;/&gt;
@@ -88,6 +89,7 @@
 		&lt;package name=&quot;bootsplash-branding-openSUSE&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
 		&lt;package name=&quot;cromfs&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;

Modified: kiwi-head/system/boot/ix86/vmxboot/suse-SLED10/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/vmxboot/suse-SLED10/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/vmxboot/suse-SLED10/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -19,6 +19,7 @@
 		&lt;profile name=&quot;smp&quot; description=&quot;Boot with smp kernel&quot;/&gt;
 	&lt;/profiles&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;drivers/cdrom/*&quot;/&gt;
 		&lt;file name=&quot;net/packet/*&quot;/&gt;
@@ -75,6 +76,7 @@
 		&lt;package name=&quot;bootsplash&quot;/&gt;
 		&lt;package name=&quot;bootsplash-theme-SuSE-NLD&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;

Modified: kiwi-head/system/boot/ix86/vmxboot/suse-SLED11/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/vmxboot/suse-SLED11/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/vmxboot/suse-SLED11/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -19,6 +19,7 @@
 		&lt;profile name=&quot;smp&quot; description=&quot;Boot with smp kernel&quot;/&gt;
 	&lt;/profiles&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext2/*&quot;/&gt;
@@ -80,6 +81,7 @@
 		&lt;package name=&quot;bootsplash&quot;/&gt;
 		&lt;package name=&quot;bootsplash-branding-SLED&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;

Modified: kiwi-head/system/boot/ix86/vmxboot/suse-SLES10/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/vmxboot/suse-SLES10/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/vmxboot/suse-SLES10/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -19,6 +19,7 @@
 		&lt;profile name=&quot;smp&quot; description=&quot;Boot with smp kernel&quot;/&gt;
 	&lt;/profiles&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;drivers/cdrom/*&quot;/&gt;
 		&lt;file name=&quot;net/packet/*&quot;/&gt;
@@ -75,6 +76,7 @@
 		&lt;package name=&quot;bootsplash&quot;/&gt;
 		&lt;package name=&quot;bootsplash-theme-SuSE-SLES&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;

Modified: kiwi-head/system/boot/ix86/vmxboot/suse-SLES11/config.xml
===================================================================
--- kiwi-head/system/boot/ix86/vmxboot/suse-SLES11/config.xml	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/vmxboot/suse-SLES11/config.xml	2009-01-08 14:29:45 UTC (rev 1831)
@@ -19,6 +19,7 @@
 		&lt;profile name=&quot;smp&quot; description=&quot;Boot with smp kernel&quot;/&gt;
 	&lt;/profiles&gt;
 	&lt;drivers type=&quot;drivers&quot;&gt;
+		&lt;file name=&quot;drivers/md/dm-mod.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/ide/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext3/*&quot;/&gt;
 		&lt;file name=&quot;fs/ext2/*&quot;/&gt;
@@ -80,6 +81,7 @@
 		&lt;package name=&quot;bootsplash&quot;/&gt;
 		&lt;package name=&quot;bootsplash-branding-SLES&quot;/&gt;
 		&lt;package name=&quot;tar&quot;/&gt;
+		&lt;package name=&quot;lvm2&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;bootstrap&quot;&gt;
 		&lt;package name=&quot;filesystem&quot;/&gt;

Modified: kiwi-head/system/boot/ix86/vmxboot/suse-linuxrc
===================================================================
--- kiwi-head/system/boot/ix86/vmxboot/suse-linuxrc	2009-01-07 08:50:41 UTC (rev 1830)
+++ kiwi-head/system/boot/ix86/vmxboot/suse-linuxrc	2009-01-08 14:29:45 UTC (rev 1831)
@@ -112,16 +112,31 @@
 probeDevices
 
 #======================================
-# 7) Mount VM (boot)
+# 7) Setup device names...
 #--------------------------------------
 Echo &quot;Searching for boot device...&quot;
 export imageDiskDevice=`searchBIOSBootDevice`
 export imageRootDevice=$imageDiskDevice&quot;1&quot;
+export imageRWDevice=$imageDiskDevice&quot;2&quot;
+export imageRODevice=$imageDiskDevice&quot;1&quot;
+export imageBootDevice=$imageDiskDevice&quot;1&quot;
 if [ -z &quot;$imageDiskDevice&quot; ];then
 	systemException \
 		&quot;Couldn't find any boot device... abort&quot; \
 	&quot;reboot&quot;
 fi
+Echo &quot;Searching for kiwiVG volume group...&quot;
+if searchVolumeGroup; then
+	export haveLVM=yes
+	if [ -e /dev/kiwiVG/LVComp ];then
+		export imageRootDevice=/dev/kiwiVG/LVComp
+	else
+		export imageRootDevice=/dev/kiwiVG/LVRoot
+	fi
+	export imageRWDevice=/dev/kiwiVG/LVRoot
+	export imageRODevice=/dev/kiwiVG/LVComp
+	export imageBootDevice=$imageDiskDevice&quot;2&quot;
+fi
 
 #======================================
 # 8) Get filesystem type
@@ -138,7 +153,7 @@
 #--------------------------------------
 Echo &quot;Filesystem of VMX system is: $FSTYPE -&gt; $imageRootDevice&quot;
 if isFSTypeReadOnly;then
-	setupUnionFS &quot;$imageDiskDevice&quot;2 &quot;$imageDiskDevice&quot;1 aufs
+	setupUnionFS $imageRWDevice $imageRODevice aufs
 fi
 
 #======================================
@@ -157,16 +172,33 @@
 fi
 
 #======================================
-# 12) setup ird/kernel links for union
+# 12) setup /lvmboot
 #--------------------------------------
+if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+	mkdir /mnt/lvmboot
+	mount $imageBootDevice /mnt/lvmboot
+	if [ -z $UNIONFS_CONFIG ];then
+		cp -a /mnt/boot/* /mnt/lvmboot/boot
+	fi
+	rm -rf /mnt/boot
+	( cd /mnt &amp;&amp; ln -s lvmboot/boot boot )
+fi
+
+#======================================
+# 13) setup ird/kernel links for union
+#--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; isFSTypeReadOnly;then
 	# /.../
 	# we are using a special root setup with aufs. In this case
 	# we can't use the SuSE Linux initrd but must stick to the
 	# kiwi boot system.
 	# ----
-	kiwiMount &quot;$imageDiskDevice&quot;2 &quot;/mnt&quot;
-	pushd /mnt/boot &gt;/dev/null
+	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+		pushd /mnt/lvmboot/boot &gt;/dev/null
+	else
+		kiwiMount $imageRWDevice &quot;/mnt&quot;
+		pushd /mnt/boot &gt;/dev/null
+	fi
 	IFS=&quot;,&quot; ; for i in $KERNEL_LIST;do
 		if test -z &quot;$i&quot;;then
 			continue
@@ -179,48 +211,58 @@
 	done
 	IFS=$IFS_ORIG
 	popd &gt;/dev/null
-	umount /mnt
+	if [ ! &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+		umount /mnt
+	fi
 fi
 
 #======================================
-# 13) Create system dependant files
+# 14) Create system dependant files
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
 	setupDefaultFstab /config
 	updateRootDeviceFstab /config $imageRootDevice
-	if [ -z &quot;$UNIONFS_CONFIG&quot; ]; then
+	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+		updateLVMBootDeviceFstab /config $imageBootDevice
+	fi
+	if [ ! -z &quot;$UNIONFS_CONFIG&quot; ]; then
+		export KIWI_INITRD_PARAMS=&quot;UNIONFS_CONFIG=yes&quot;
+	fi
+	if [ ! -z &quot;$COMBINED_IMAGE&quot; ]; then
+		export KIWI_INITRD_PARAMS=&quot;COMBINED_IMAGE=local&quot;
+	fi
+	if [ -z &quot;$UNIONFS_CONFIG&quot; ] &amp;&amp; [ -z &quot;$COMBINED_IMAGE&quot; ]; then
 		setupBootLoader /mnt /config 0 $imageRootDevice VMX
 	else
-		export KIWI_INITRD_PARAMS=&quot;UNIONFS_CONFIG=yes&quot;
 		setupBootLoader /mnt /config 1 $imageRootDevice VMX
 	fi
 	setupKernelModules /config
 fi
 
 #======================================
-# 14) copy system dependant files
+# 15) copy system dependant files
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
 	setupConfigFiles
 fi
 
 #======================================
-# 15) update system dependant files
+# 16) update system dependant files
 #--------------------------------------
 setupInittab /mnt
 
 #======================================
-# 16) setup real root device
+# 17) setup real root device
 #--------------------------------------
 echo 256 &gt; /proc/sys/kernel/real-root-dev
 
 #======================================
-# 17) umount system filesystems
+# 18) umount system filesystems
 #--------------------------------------
 umountSystemFilesystems
 
 #======================================
-# 18) copy initrd files to image
+# 19) copy initrd files to image
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
 	importBranding
@@ -229,17 +271,17 @@
 cp /include /mnt
 
 #======================================
-# 19) kill boot shell
+# 20) kill boot shell
 #--------------------------------------
 killShell
 killBlogD
 
 #======================================
-# 20) Activate new root
+# 21) Activate new root
 #--------------------------------------
 activateImage
 
 #======================================
-# 21) Unmount initrd / system init
+# 22) Unmount initrd / system init
 #--------------------------------------
 bootImage $@


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000946.html">[Kiwi-devel] r1830 - kiwi-branches/KIWI-164-SuSE-10-3-Devel/rpm
</A></li>
	<LI>Next message: <A HREF="000948.html">[Kiwi-devel] r1832 - in kiwi-head: . modules rpm	system/boot/ix86/oemboot system/boot/ix86/usbboot	system/boot/ix86/usbboot/suse-10.3	system/boot/ix86/usbboot/suse-11.0	system/boot/ix86/usbboot/suse-11.1	system/boot/ix86/usbboot/suse-SLED10	system/boot/ix86/usbboot/suse-SLED11	system/boot/ix86/usbboot/suse-SLES10	system/boot/ix86/usbboot/suse-SLES11 system/boot/ix86/vmxboot
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#947">[ date ]</a>
              <a href="thread.html#947">[ thread ]</a>
              <a href="subject.html#947">[ subject ]</a>
              <a href="author.html#947">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
