<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 4b9258c4ee5bdee50454d3cbf2c88de611db336e
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2010-May/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%20master%2C%0A%09updated.%204b9258c4ee5bdee50454d3cbf2c88de611db336e&In-Reply-To=%3C201005271523.o4RFNCCi020484%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002232.html">
   <LINK REL="Next"  HREF="002234.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 4b9258c4ee5bdee50454d3cbf2c88de611db336e</H1>
    <B>marcus_schaefer at BerliOS</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%20master%2C%0A%09updated.%204b9258c4ee5bdee50454d3cbf2c88de611db336e&In-Reply-To=%3C201005271523.o4RFNCCi020484%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 4b9258c4ee5bdee50454d3cbf2c88de611db336e">marcus_schaefer at mail.berlios.de
       </A><BR>
    <I>Thu May 27 17:23:12 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002232.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. fb3250f8900142a2882d524e2bf3642df1ac2820
</A></li>
        <LI>Next message: <A HREF="002234.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 67001e428fc5854d6b810e0ff038c22d109244aa
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2233">[ date ]</a>
              <a href="thread.html#2233">[ thread ]</a>
              <a href="subject.html#2233">[ subject ]</a>
              <a href="author.html#2233">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Project kiwi at BerliOS&quot;.

The branch, master has been updated
       via  4b9258c4ee5bdee50454d3cbf2c88de611db336e (commit)
      from  fb3250f8900142a2882d524e2bf3642df1ac2820 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 4b9258c4ee5bdee50454d3cbf2c88de611db336e
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Thu May 27 17:22:42 2010 +0200

    - added support for extlinux based recovery (bnc #606651)
    - make recovery work with separate boot partition
    - use bind mount instead of link to boot partition

-----------------------------------------------------------------------

Summary of changes:
diff --git a/modules/KIWIConfig.sh b/modules/KIWIConfig.sh
index 63d56e4..ab5ad48 100644
--- a/modules/KIWIConfig.sh
+++ b/modules/KIWIConfig.sh
@@ -1193,6 +1193,9 @@ function suseGFXBoot {
 		elif [ -f /usr/share/syslinux/gfxboot.c32 ];then
 			mv /usr/share/syslinux/gfxboot.c32 /image/loader
 		fi
+		if [ -f /usr/share/syslinux/chain.c32 ];then
+			mv /usr/share/syslinux/chain.c32 /image/loader
+		fi
 		if [ -f /usr/share/syslinux/mboot.c32 ];then
 			mv /usr/share/syslinux/mboot.c32 /image/loader
 		fi
diff --git a/modules/KIWILinuxRC.sh b/modules/KIWILinuxRC.sh
index 8faba95..b542728 100644
--- a/modules/KIWILinuxRC.sh
+++ b/modules/KIWILinuxRC.sh
@@ -567,8 +567,12 @@ function installBootLoaderRecovery {
 		loader=&quot;grub&quot;
 	fi
 	case $arch-$loader in
-		i*86-grub)   installBootLoaderGrubRecovery ;;
-		x86_64-grub) installBootLoaderGrubRecovery ;;
+		i*86-grub)       installBootLoaderGrubRecovery ;;
+		x86_64-grub)     installBootLoaderGrubRecovery ;;
+		i*86-syslinux)   installBootLoaderSyslinuxRecovery ;;
+		x86_64-syslinux) installBootLoaderSyslinuxRecovery ;;
+		i*86-extlinux)   installBootLoaderSyslinuxRecovery ;;
+		x86_64-extlinux) installBootLoaderSyslinuxRecovery ;;
 		*)
 		systemException \
 			&quot;*** boot loader setup for $arch-$loader not implemented ***&quot; \
@@ -632,6 +636,22 @@ function installBootLoaderLilo {
 	fi
 }
 #======================================
+# installBootLoaderSyslinuxRecovery
+#--------------------------------------
+function installBootLoaderSyslinuxRecovery {
+	local syslmbr=/usr/share/syslinux/mbr.bin
+	if [ -e $syslmbr ];then
+		if [ $loader = &quot;syslinux&quot; ];then
+			syslinux $imageRecoveryDevice
+		else
+			extlinux --install /reco-save/boot/syslinux
+		fi
+	else
+		Echo &quot;Image doesn't have syslinux (mbr.bin) installed&quot;
+		Echo &quot;Can't install boot loader&quot;
+	fi
+}
+#======================================
 # installBootLoaderGrubRecovery
 #--------------------------------------
 function installBootLoaderGrubRecovery {
@@ -646,8 +666,9 @@ function installBootLoaderGrubRecovery {
 	echo &quot;root (hd0,$gdevreco)&quot;  &gt;&gt; $input
 	echo &quot;setup (hd0,$gdevreco)&quot; &gt;&gt; $input
 	echo &quot;quit&quot;          &gt;&gt; $input
-	if [ -x /mnt/usr/sbin/grub ];then
-		/mnt/usr/sbin/grub --batch &lt; $input 1&gt;&amp;2
+	if [ -x /usr/sbin/grub ];then
+		/usr/sbin/grub --batch &lt; $input 1&gt;&amp;2
+		rm -f $input
 	else
 		Echo &quot;Image doesn't have grub installed&quot;
 		Echo &quot;Can't install boot loader&quot;
@@ -754,55 +775,6 @@ function callSUSEInitrdScripts {
 	chroot . bash ./run_all.sh
 }
 #======================================
-# setupBootLoaderFiles
-#--------------------------------------
-function setupBootLoaderFiles {
-	# /.../
-	# generic function which returns the files used for a
-	# specific bootloader. The selection of the bootloader
-	# happens according to the architecture of the system
-	# ----
-	local arch=`uname -m`
-	if [ -z &quot;$loader&quot; ];then
-		loader=&quot;grub&quot;
-	fi
-	case $arch-$loader in
-		i*86-grub)        setupBootLoaderFilesGrub ;;
-		x86_64-grub)      setupBootLoaderFilesGrub ;;
-		ppc*)             setupBootLoaderFilesLilo ;;
-		i*86-syslinux)    setupBootLoaderFilesSyslinux ;;
-		x86_64-syslinux)  setupBootLoaderFilesSyslinux ;;
-		i*86-extlinux)    setupBootLoaderFilesSyslinux ;;
-		x86_64-extlinux)  setupBootLoaderFilesSyslinux ;;
-		*)
-		systemException \
-			&quot;*** boot loader files for $arch-$loader not implemented ***&quot; \
-		&quot;reboot&quot;
-	esac
-}
-#======================================
-# setupBootLoaderFilesSyslinux
-#--------------------------------------
-function setupBootLoaderFilesSyslinux {
-	if [ $loader = &quot;extlinux&quot; ];then
-		echo &quot;/boot/syslinux/extlinux.conf&quot;
-	else
-		echo &quot;/boot/syslinux/syslinux.cfg&quot;
-	fi
-}
-#======================================
-# setupBootLoaderFilesGrub
-#--------------------------------------
-function setupBootLoaderFilesGrub {
-	echo &quot;/boot/grub/menu.lst /etc/grub.conf&quot;
-}
-#======================================
-# setupBootLoaderFilesLilo
-#--------------------------------------
-function setupBootLoaderFilesLilo {
-	echo &quot;/etc/lilo.conf&quot;
-}
-#======================================
 # setupBootLoader
 #--------------------------------------
 function setupBootLoader {
@@ -853,8 +825,12 @@ function setupBootLoaderRecovery {
 		loader=&quot;grub&quot;
 	fi
 	case $arch-$loader in
-		i*86-grub)   eval setupBootLoaderGrubRecovery $para ;;
-		x86_64-grub) eval setupBootLoaderGrubRecovery $para ;;
+		i*86-grub)       eval setupBootLoaderGrubRecovery $para ;;
+		x86_64-grub)     eval setupBootLoaderGrubRecovery $para ;;
+		i*86-syslinux)   eval setupBootLoaderSyslinuxRecovery $para ;;
+		x86_64-syslinux) eval setupBootLoaderSyslinuxRecovery $para ;;
+		i*86-extlinux)   eval setupBootLoaderSyslinuxRecovery $para ;;
+		x86_64-extlinux) eval setupBootLoaderSyslinuxRecovery $para ;;
 		*)
 		systemException \
 			&quot;*** boot loader setup for $arch-$loader not implemented ***&quot; \
@@ -862,6 +838,118 @@ function setupBootLoaderRecovery {
 	esac
 }
 #======================================
+# setupBootLoaderSyslinuxRecovery
+#--------------------------------------
+function setupBootLoaderSyslinuxRecovery {
+	# /.../
+	# create syslinux configuration for the recovery boot system
+	# ----
+	local mountPrefix=$1  # mount path of the image
+	local destsPrefix=$2  # base dir for the config files
+	local gnum=$3         # boot partition ID
+	local rdev=$4         # root partition
+	local gfix=$5         # syslinux title postfix
+	local swap=$6         # optional swap partition
+	local conf=$destsPrefix/boot/syslinux/syslinux.cfg
+	local kernel=&quot;&quot;
+	local initrd=&quot;&quot;
+	local fbmode=$vga
+	if [ -z &quot;$fbmode&quot; ];then
+		fbmode=$DEFAULT_VGA
+	fi
+	#======================================
+	# import syslinux into recovery
+	#--------------------------------------
+	cp -a $mountPrefix/boot/syslinux $destsPrefix/boot
+	#======================================
+	# setup config file name
+	#--------------------------------------
+	if [ $loader = &quot;extlinux&quot; ];then
+		conf=$destsPrefix/boot/syslinux/extlinux.conf
+	fi
+	#======================================
+	# create syslinux.cfg file
+	#--------------------------------------
+	echo &quot;implicit 1&quot;                   &gt; $conf
+	echo &quot;prompt   1&quot;                  &gt;&gt; $conf
+	echo &quot;TIMEOUT $KIWI_BOOT_TIMEOUT&quot;  &gt;&gt; $conf
+	if \
+		[ -f &quot;$destsPrefix/boot/syslinux/gfxboot.com&quot; ] || \
+		[ -f &quot;$destsPrefix/boot/syslinux/gfxboot.c32&quot; ]
+	then
+		echo &quot;ui gfxboot bootlogo isolinux.msg&quot; &gt;&gt; $conf
+	else
+		echo &quot;gfxboot  bootlogo&quot;                &gt;&gt; $conf
+		echo &quot;display  isolinux.msg&quot;            &gt;&gt; $conf
+	fi
+	kernel=linux.vmx   # this is a copy of the kiwi linux.vmx file
+	initrd=initrd.vmx  # this is a copy of the kiwi initrd.vmx file
+	#======================================
+	# create recovery entry
+	#--------------------------------------
+	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+		#======================================
+		# Reboot
+		#--------------------------------------
+		title=$(makeLabel &quot;Cancel/Reboot&quot;)
+		echo &quot;DEFAULT $title&quot;                              &gt;&gt; $conf
+		echo &quot;label $title&quot;                                &gt;&gt; $conf
+		echo &quot; localboot 0x80&quot;                             &gt;&gt; $conf
+		#======================================
+		# Recovery
+		#--------------------------------------
+		title=$(makeLabel &quot;Recover/Repair System&quot;)
+		echo &quot;label $title&quot;                                &gt;&gt; $conf
+		if xenServer;then
+			systemException \
+				&quot;*** $loader: Xen dom0 boot not implemented ***&quot; \
+			&quot;reboot&quot;
+		else
+			echo &quot;kernel /boot/$kernel&quot;                    &gt;&gt; $conf
+			echo -n &quot;append initrd=/boot/$initrd&quot;          &gt;&gt; $conf
+			echo -n &quot; root=$diskByID&quot;                      &gt;&gt; $conf
+			if [ ! -z &quot;$imageDiskDevice&quot; ];then
+				echo -n &quot; disk=$(getDiskID $imageDiskDevice)&quot;  &gt;&gt; $conf
+			fi
+			echo -n &quot; vga=$fbmode loader=$loader&quot;          &gt;&gt; $conf
+			echo -n &quot; splash=silent&quot;                       &gt;&gt; $conf
+			echo -n &quot; $KIWI_INITRD_PARAMS&quot;                 &gt;&gt; $conf
+			echo -n &quot; $KIWI_KERNEL_OPTIONS&quot;                &gt;&gt; $conf
+			if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+				echo -n &quot; VGROUP=$VGROUP&quot;                  &gt;&gt; $conf
+			fi
+			echo &quot; KIWI_RECOVERY=$recoid&quot;                  &gt;&gt; $conf
+			echo &quot; showopts&quot;                               &gt;&gt; $conf
+		fi
+		#======================================
+		# Restore
+		#--------------------------------------
+		title=$(makeLabel &quot;Restore Factory System&quot;)
+		echo &quot;label $title&quot;                                &gt;&gt; $conf
+		if xenServer;then
+			systemException \
+				&quot;*** $loader: Xen dom0 boot not implemented ***&quot; \
+			&quot;reboot&quot;
+		else
+			echo &quot;kernel /boot/$kernel&quot;                    &gt;&gt; $conf
+			echo -n &quot;append initrd=/boot/$initrd&quot;          &gt;&gt; $conf
+			echo -n &quot; root=$diskByID&quot;                      &gt;&gt; $conf
+			if [ ! -z &quot;$imageDiskDevice&quot; ];then
+				echo -n &quot; disk=$(getDiskID $imageDiskDevice)&quot;  &gt;&gt; $conf
+			fi
+			echo -n &quot; vga=$fbmode loader=$loader&quot;          &gt;&gt; $conf
+			echo -n &quot; splash=silent&quot;                       &gt;&gt; $conf
+			echo -n &quot; $KIWI_INITRD_PARAMS&quot;                 &gt;&gt; $conf
+			echo -n &quot; $KIWI_KERNEL_OPTIONS&quot;                &gt;&gt; $conf
+			if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+				echo -n &quot; VGROUP=$VGROUP&quot;                  &gt;&gt; $conf
+			fi
+			echo &quot; KIWI_RECOVERY=$recoid RESTORE=1&quot;        &gt;&gt; $conf
+			echo &quot; showopts&quot;                               &gt;&gt; $conf
+		fi
+	fi
+}
+#======================================
 # setupBootLoaderGrubRecovery
 #--------------------------------------
 function setupBootLoaderGrubRecovery {
@@ -885,13 +973,10 @@ function setupBootLoaderGrubRecovery {
 	#======================================
 	# import grub stages into recovery
 	#--------------------------------------
+	mkdir -p $destsPrefix/boot/grub
 	cp $mountPrefix/boot/grub/stage1 $destsPrefix/boot/grub
 	cp $mountPrefix/boot/grub/stage2 $destsPrefix/boot/grub
 	#======================================
-	# backup current menu.lst
-	#--------------------------------------
-	mv $menu $menu.system
-	#======================================
 	# create recovery menu.lst
 	#--------------------------------------
 	echo &quot;timeout 30&quot; &gt; $menu
@@ -905,7 +990,13 @@ function setupBootLoaderGrubRecovery {
 		#======================================
 		# Make the cancel option default
 		#--------------------------------------
-		echo &quot;default 2&quot;                                  &gt;&gt; $menu
+		echo &quot;default 0&quot;                                  &gt;&gt; $menu
+		#======================================
+		# Reboot
+		#--------------------------------------
+		title=$(makeLabel &quot;Cancel/Reboot&quot;)
+		echo &quot;title $title&quot;                               &gt;&gt; $menu
+		echo &quot; reboot&quot;                                    &gt;&gt; $menu
 		#======================================
 		# Recovery
 		#--------------------------------------
@@ -979,12 +1070,6 @@ function setupBootLoaderGrubRecovery {
 			echo &quot; showopts&quot;                              &gt;&gt; $menu
 			echo &quot; initrd $gdev_recovery/boot/$initrd&quot;    &gt;&gt; $menu
 		fi
-		#======================================
-		# Reboot
-		#--------------------------------------
-		title=$(makeLabel &quot;Cancel/Reboot&quot;)
-		echo &quot;title $title&quot;                               &gt;&gt; $menu
-		echo &quot; reboot&quot;                                    &gt;&gt; $menu
 	fi
 }
 #======================================
@@ -1010,6 +1095,9 @@ function setupBootLoaderSyslinux {
 	local title=&quot;&quot;
 	local fbmode=$vga
 	local xencons=$xencons
+	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+		local gdevreco=$recoid
+	fi
 	if [ -z &quot;$fbmode&quot; ];then
 		fbmode=$DEFAULT_VGA
 	fi
@@ -1073,8 +1161,8 @@ function setupBootLoaderSyslinux {
 	echo &quot;prompt   1&quot;                  &gt;&gt; $conf
 	echo &quot;TIMEOUT $KIWI_BOOT_TIMEOUT&quot;  &gt;&gt; $conf
 	if \
-		[ -f &quot;/boot/syslinux/gfxboot.com&quot; ] || \
-		[ -f &quot;/boot/syslinux/gfxboot.c32&quot; ]
+		[ -f &quot;$destsPrefix/boot/syslinux/gfxboot.com&quot; ] || \
+		[ -f &quot;$destsPrefix/boot/syslinux/gfxboot.c32&quot; ]
 	then
 		echo &quot;ui gfxboot bootlogo isolinux.msg&quot; &gt;&gt; $conf
 	else
@@ -1093,8 +1181,10 @@ function setupBootLoaderSyslinux {
 			#======================================
 			# move to FAT requirements 8+3
 			#--------------------------------------
-			kernel=&quot;linux.$count&quot;
-			initrd=&quot;initrd.$count&quot;
+			if [ &quot;$loader&quot; = &quot;syslinux&quot; ];then
+				kernel=&quot;linux.$count&quot;
+				initrd=&quot;initrd.$count&quot;
+			fi
 			if ! echo $gfix | grep -E -q &quot;OEM|USB|VMX|NET|unknown&quot;;then
 				if [ &quot;$count&quot; = &quot;1&quot; ];then
 					title=$(makeLabel &quot;$gfix&quot;)
@@ -1181,9 +1271,9 @@ function setupBootLoaderSyslinux {
 	# create recovery entry
 	#--------------------------------------
 	if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
-		systemException \
-			&quot;*** $loader: recovery chain loading not implemented ***&quot; \
-		&quot;reboot&quot;
+		echo &quot;label Recovery&quot;                             &gt;&gt; $conf
+		echo &quot;COM32 chain.c32&quot;                            &gt;&gt; $conf
+		echo &quot;append hd0 $gdevreco&quot;                       &gt;&gt; $conf
 	fi
 	#======================================
 	# create sysconfig/bootloader
@@ -1796,6 +1886,7 @@ function updateLVMBootDeviceFstab {
 		FSTYPE=&quot;auto&quot;
 	fi
 	echo &quot;$diskByID $mount $FSTYPE defaults 0 0&quot; &gt;&gt; $nfstab
+	echo &quot;$mount/boot /boot none bind 0 0&quot; &gt;&gt; $nfstab
 	if [ ! -z &quot;$FSTYPE_SAVE&quot; ];then
 		FSTYPE=$FSTYPE_SAVE
 	fi
@@ -1835,6 +1926,7 @@ function updateSyslinuxBootDeviceFstab {
 	else
 		echo &quot;$diskByID /syslboot ext2 defaults 0 0&quot; &gt;&gt; $nfstab
 	fi
+	echo &quot;/syslboot/boot /boot none bind 0 0&quot; &gt;&gt; $nfstab
 }
 #======================================
 # updateOtherDeviceFstab
@@ -3193,6 +3285,10 @@ function umountSystem {
 			retval=1
 		fi
 	fi
+	if [ ! -z &quot;$imageBootDevice&quot; ];then
+		umount /mnt/boot
+		umount $imageBootDevice
+	fi
 	IFS=$OLDIFS
 	return $retval
 }
@@ -3596,10 +3692,6 @@ function mountSystemCombined {
 			ln -s /mnt/read-write /read-write &gt;/dev/null
 		fi
 	fi
-	if [ &quot;$LOCAL_BOOT&quot; = &quot;yes&quot; ] &amp;&amp; [ &quot;$haveLuks&quot; = &quot;yes&quot; ];then
-		mkdir -p /mnt/luksboot
-		( cd /mnt &amp;&amp; rm boot &amp;&amp; ln -sf luksboot/boot boot )
-	fi
 }
 #======================================
 # mountSystemStandard
@@ -3668,6 +3760,9 @@ function mountSystem {
 		mountSystemStandard &quot;$mountDevice&quot;
 		retval=$?
 	fi
+	if [ $retval = 0 ] &amp;&amp; [ -z &quot;$RESTORE&quot; ];then
+		setupBootPartition
+	fi
 	IFS=$OLDIFS
 	return $retval
 }
@@ -5323,6 +5418,69 @@ function startUtimer {
 	fi
 }
 #======================================
+# setupBootPartition
+#--------------------------------------
+function setupBootPartition {
+	local pSearch=83
+	local mpoint
+	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+		#======================================
+		# lvmboot
+		#--------------------------------------
+		test -z &quot;$bootid&quot; &amp;&amp; export bootid=2
+		mpoint=lvmboot
+	elif [ &quot;$haveClicFS&quot; = &quot;yes&quot; ];then
+		#======================================
+		# clicboot
+		#--------------------------------------
+		test -z &quot;$bootid&quot; &amp;&amp; export bootid=3
+		mpoint=clicboot
+	elif \
+		[ &quot;$loader&quot; = &quot;syslinux&quot; ] || \
+		[ &quot;$loader&quot; = &quot;extlinux&quot; ] || \
+		[ &quot;$haveLuks&quot; = &quot;yes&quot; ]
+	then
+		#======================================
+		# syslboot / luksboot
+		#--------------------------------------
+		if [ -z &quot;$bootid&quot; ];then
+			test &quot;$loader&quot; = &quot;syslinux&quot; &amp;&amp; pSearch=6
+			for i in 4 3 2;do
+				pType=$(partitionID $imageDiskDevice $i)
+				if [ &quot;$pType&quot; = $pSearch ];then
+					export bootid=$i
+					break
+				fi
+			done
+		fi
+		if [ &quot;$haveLuks&quot; = &quot;yes&quot; ];then
+			mpoint=luksboot
+		else
+			mpoint=syslboot
+		fi
+	else
+		#======================================
+		# no separate boot partition
+		#--------------------------------------
+		return
+	fi
+	if [ -z &quot;$imageBootDevice&quot; ];then
+		export imageBootDevice=$(ddn $imageDiskDevice $bootid)
+	fi
+	mkdir -p /mnt/$mpoint
+	mount $imageBootDevice /mnt/$mpoint
+	if [ -z &quot;$UNIONFS_CONFIG&quot; ];then
+		cp -a /mnt/boot /mnt/$mpoint
+	fi
+	if [ -e /boot.tgz ];then
+		tar -xf /boot.tgz -C /mnt/$mpoint
+	fi
+	rm -rf /mnt/boot
+	mkdir  /mnt/boot
+	mount --bind \
+		/mnt/$mpoint/boot /mnt/boot
+}
+#======================================
 # initialize
 #--------------------------------------
 function initialize {
diff --git a/rpm/kiwi.changes b/rpm/kiwi.changes
index c381435..7279ef6 100644
--- a/rpm/kiwi.changes
+++ b/rpm/kiwi.changes
@@ -8,6 +8,9 @@ Tue May 25 16:10:30 CEST 2010 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
   on a 512 byte sector size value instead of a 4k filesystem block
   size value which might be wrong depending on the size of the
   filesystem (bnc #604646)
+- added support for extlinux based recovery (bnc #606651)
+- make recovery work with separate boot partition
+- use bind mount instead of link to boot partition
 
 -------------------------------------------------------------------
 Fri May 21 15:47:36 CEST 2010 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
diff --git a/system/boot/ix86/oemboot/suse-linuxrc b/system/boot/ix86/oemboot/suse-linuxrc
index bfee752..b8a529b 100755
--- a/system/boot/ix86/oemboot/suse-linuxrc
+++ b/system/boot/ix86/oemboot/suse-linuxrc
@@ -351,13 +351,8 @@ if [ ! -z &quot;$KIWI_RECOVERY&quot; ];then
 			if ! mountSystem $imageRootDevice;then
 				systemException &quot;Failed to mount root filesystem&quot; &quot;reboot&quot;
 			fi
-			if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
-				mkdir -p /mnt/lvmboot &amp;&amp; rm -rf /mnt/boot
-				mount $imageBootDevice /mnt/lvmboot
-				( cd /mnt &amp;&amp; ln -s lvmboot/boot boot )
-			fi
 			for i in dev sys proc;do
-				mkdir /mnt/$i
+				mkdir -p /mnt/$i
 			done
 		fi
 		cd /mnt
@@ -466,28 +461,7 @@ if [ ! -z &quot;$KIWI_RECOVERY&quot; ];then
 	fi
 	clear
 	#======================================
-	# 16.4) restore boot files
-	#--------------------------------------
-	Echo &quot;Restoring boot files...&quot;
-	for i in etc/fstab etc/sysconfig/kernel etc/sysconfig/bootloader;do
-		if ! cp /reco-save/$i /mnt/$i;then
-			systemException &quot;Failed to restore $i&quot; &quot;reboot&quot;
-		fi
-	done
-	for i in `setupBootLoaderFiles`;do
-		if ! cp /reco-save/$i /mnt/$i;then
-			systemException &quot;Failed to restore $i&quot; &quot;reboot&quot;
-		fi
-	done
-	for i in /reco-save/boot/grub/*;do
-		if echo $i | grep -q .system;then
-			sysbase=`echo ${i%%.system}`
-			sysbase=`echo $sysbase | cut -f3- -d/`
-			cp $i /mnt/$sysbase
-		fi
-	done
-	#======================================
-	# 16.5) restore temporary stored files
+	# 16.4) restore temporary stored files
 	#--------------------------------------
 	if [ -z &quot;$RESTORE&quot; ];then
 		for i in passwd shadow group;do
@@ -503,6 +477,13 @@ if [ ! -z &quot;$KIWI_RECOVERY&quot; ];then
 		rm -rf /mnt/var/lib/rpm.backup
 	fi
 	#======================================
+	# 16.5) restore boot files 1
+	#--------------------------------------
+	Echo &quot;Restoring boot configuration archive part (1)...&quot;
+	if ! tar -xf /reco-save/boot-1.tgz -C /mnt;then
+		systemException &quot;Failed to restore boot configuration&quot; &quot;reboot&quot;
+	fi
+	#======================================
 	# 16.6) restore fstab partitions
 	#--------------------------------------
 	if [ ! -z &quot;$RESTORE&quot; ];then
@@ -519,18 +500,39 @@ if [ ! -z &quot;$KIWI_RECOVERY&quot; ];then
 			probeFileSystem $imageRootDevice
 			createFilesystem $imageHomeDevice
 		fi
+		imageBootDevice=$(
+			cat /mnt/etc/fstab|grep /.*boot|grep -v bind | sed -r 's/\s+/:/g')
+		if [ ! -z &quot;$imageBootDevice&quot; ];then
+			imageBootMountP=$(echo $imageBootDevice | cut -f2 -d:)
+			imageBootDevice=$(echo $imageBootDevice | cut -f1 -d:)
+			rm -rf /mnt/boot
+			mkdir  /mnt/boot
+			probeFileSystem $imageRootDevice
+			createFilesystem $imageBootDevice
+			mkdir -p /mnt/$imageBootMountP
+			mount $imageBootDevice /mnt/$imageBootMountP
+			mkdir -p /mnt/$imageBootMountP/boot
+			mount --bind /mnt/$imageBootMountP/boot /mnt/boot
+		fi
+	fi
+	#======================================
+	# 16.7) restore boot files 2
+	#--------------------------------------
+	Echo &quot;Restoring boot configuration archive part (2)...&quot;
+	if ! tar -xf /reco-save/boot-2.tgz -C /mnt/$imageBootMountP;then
+		systemException &quot;Failed to restore boot configuration&quot; &quot;reboot&quot;
 	fi
 	#======================================
-	# 16.7) umount recovery and boot
+	# 16.8) umount recovery 
 	#--------------------------------------
 	umount $imageRecoveryDevice
 	#======================================
-	# 16.8) import oem config file
+	# 16.9) import oem config file
 	#--------------------------------------
 	importFile &lt; $OEM_PARTITION_CONFIG
 	IFS=$IFS_ORIG
 	#======================================
-	# 16.9) write oem-trigger
+	# 16.10) write oem-trigger
 	#--------------------------------------
 	TDIR=/mnt/var/cache/recovery
 	TOEM=oem-trigger
@@ -551,72 +553,7 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 18) setup boot partition
-#--------------------------------------
-if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ]; then
-	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
-		#======================================
-		# LVM use second partition as boot
-		#--------------------------------------
-		mkdir /mnt/lvmboot
-		mount $imageBootDevice /mnt/lvmboot
-		if [ -z $UNIONFS_CONFIG ];then
-			cp -a /mnt/boot/* /mnt/lvmboot/boot
-		fi
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s lvmboot/boot boot )
-	elif [ &quot;$haveClicFS&quot; = &quot;yes&quot; ];then
-		#======================================
-		# Clic use third partition as boot
-		#--------------------------------------
-		if [ -z &quot;$imageBootDevice&quot; ];then
-			export imageBootDevice=$(ddn $imageDiskDevice $bootid)
-		fi
-		mkdir /mnt/clicboot
-		mount $imageBootDevice /mnt/clicboot
-		cp -a  /mnt/boot /mnt/clicboot
-		if [ -e /boot.tgz ];then
-			tar -xf /boot.tgz -C /mnt/clicboot
-		fi
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s clicboot/boot boot )
-	elif [ &quot;$loader&quot; = &quot;syslinux&quot; ] || [ &quot;$loader&quot; = &quot;extlinux&quot; ];then
-		#======================================
-		# syslinux / extlinux bootloader
-		#--------------------------------------
-		if [ -z &quot;$imageBootDevice&quot; ];then
-			imageBootDevice=$(ddn $imageDiskDevice $bootid)
-		fi
-		mkdir /mnt/syslboot
-		mount $imageBootDevice /mnt/syslboot
-		if [ -e /boot.tgz ];then
-			tar -xf /boot.tgz -C /mnt/syslboot
-		fi
-		if [ -z &quot;$UNIONFS_CONFIG&quot; ];then
-			cp -a /mnt/boot/* /mnt/syslboot/boot
-		fi
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s syslboot/boot boot )
-	elif [ &quot;$haveLuks&quot; = &quot;yes&quot; ];then
-		#======================================
-		# LUKS use second or third part as boot
-		#--------------------------------------
-		if [ -z &quot;$imageBootDevice&quot; ];then
-			imageBootDevice=$(ddn $imageDiskDevice $bootid)
-		fi
-		mkdir -p /mnt/luksboot
-		mount $imageBootDevice /mnt/luksboot
-		cp -a /mnt/boot /mnt/luksboot
-		if [ -e /boot.tgz ];then
-			tar -xf /boot.tgz -C /mnt/luksboot
-		fi
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s luksboot/boot boot )
-	fi
-fi
-
-#======================================
-# 19) setup ird/kernel links for union
+# 18) setup ird/kernel links for union
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then 
 	if [ &quot;$OEM_KIWI_INITRD&quot; = &quot;yes&quot; ] || isFSTypeReadOnly;then
@@ -660,7 +597,7 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 20) Create system dependant files
+# 19) Create system dependant files
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	#======================================
@@ -715,61 +652,29 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 21) copy system dependant files
+# 20) copy system dependant files
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	setupConfigFiles
 fi
 
 #======================================
-# 22) copy recovery related files
-#--------------------------------------
-if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ] &amp;&amp; [ ! -z &quot;$OEM_RECOVERY&quot; ];then
-	IFS=$IFS_ORIG
-	Echo &quot;Setting up recovery configuration files...&quot;
-	mkdir -p /reco-save
-	if ! mount $imageRecoveryDevice /reco-save &gt;/dev/null;then
-		systemException &quot;Failed to mount recovery device&quot; &quot;reboot&quot;
-	fi
-	mkdir -p /reco-save/etc/sysconfig
-	if ! cp /mnt/etc/fstab /reco-save/etc;then
-		systemException &quot;Failed to copy recovery fstab&quot; &quot;reboot&quot;
-	fi
-	if ! cp /mnt/etc/sysconfig/kernel /reco-save/etc/sysconfig;then
-		systemException &quot;Failed to copy recovery sysconfig/kernel&quot; &quot;reboot&quot;
-	fi
-	if ! cp /mnt/etc/sysconfig/bootloader /reco-save/etc/sysconfig;then
-		systemException &quot;Failed to copy recovery sysconfig/bootloader&quot; &quot;reboot&quot;
-	fi
-	for i in `setupBootLoaderFiles`;do
-		bootdir=`dirname $i` &amp;&amp; mkdir -p /reco-save/$bootdir
-		if ! cp /mnt/$i /reco-save/$i;then
-			systemException &quot;Failed to copy recovery $i&quot; &quot;reboot&quot;
-		fi
-	done
-	Echo &quot;Installing boot loader into recovery partition&quot;
-	setupBootLoaderRecovery /mnt /reco-save OEM
-	umount /reco-save &amp;&amp; rmdir /reco-save
-	installBootLoaderRecovery
-fi
-
-#======================================
-# 23) update system dependant files
+# 21) update system dependant files
 #--------------------------------------
 setupInittab /mnt
 
 #======================================
-# 24) setup real root device
+# 22) setup real root device
 #--------------------------------------
 echo 256 &gt; /proc/sys/kernel/real-root-dev
 
 #======================================
-# 25) umount system filesystems
+# 23) umount system filesystems
 #--------------------------------------
 umountSystemFilesystems
 
 #======================================
-# 26) copy initrd files to image
+# 24) copy initrd files to image
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	importBranding
@@ -778,17 +683,17 @@ cp /preinit /mnt
 cp /include /mnt
 
 #======================================
-# 27) kill boot shell
+# 25) kill boot shell
 #--------------------------------------
 killShell
 killBlogD
 
 #======================================
-# 28) Activate new root
+# 26) Activate new root
 #--------------------------------------
 activateImage
 
 #======================================
-# 29 Unmount initrd / system init
+# 27 Unmount initrd / system init
 #--------------------------------------
 bootImage $@
diff --git a/system/boot/ix86/oemboot/suse-preinit b/system/boot/ix86/oemboot/suse-preinit
index 6e88962..31bd8a2 100755
--- a/system/boot/ix86/oemboot/suse-preinit
+++ b/system/boot/ix86/oemboot/suse-preinit
@@ -69,7 +69,7 @@ fi
 #======================================
 # 7) Check FAT requires on syslinux
 #--------------------------------------
-if [ &quot;$loader&quot; = &quot;syslinux&quot; ] || [ &quot;$loader&quot; = &quot;extlinux&quot; ];then
+if [ &quot;$loader&quot; = &quot;syslinux&quot; ];then
 	# /.../
 	# if syslinux is used we need to make sure that the
 	# filename on the boot partition is correct 8+3
@@ -101,7 +101,42 @@ if [ $bootLoaderOK = 1 ];then
 fi
 
 #======================================
-# 9) create /etc/ImagePackages
+# 9) copy recovery related files
+#--------------------------------------
+if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ] &amp;&amp; [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+	IFS=$IFS_ORIG
+	Echo &quot;Setting up recovery configuration archive...&quot;
+	mkdir -p /reco-save
+	if ! mount $imageRecoveryDevice /reco-save &gt;/dev/null;then
+		systemException &quot;Failed to mount recovery device&quot; &quot;reboot&quot;
+	fi
+	backupBootFiles=&quot;&quot;
+	for i in \
+		/etc/fstab \
+		/etc/sysconfig/kernel \
+		/etc/sysconfig/bootloader \
+		/etc/grub.conf \
+		/etc/lilo.conf
+	do
+		test -e $i &amp;&amp; backupBootFiles=&quot;$backupBootFiles $i&quot;
+	done
+	tar -czf /reco-save/boot-1.tgz $backupBootFiles
+	backupBootFiles=&quot;&quot;
+	for i in $(find /boot -type f); do
+		if ! echo $i | grep -q -E &quot;\.sys&quot;;then
+			backupBootFiles=&quot;$backupBootFiles $i&quot;
+		fi
+	done
+	tar -czf /reco-save/boot-2.tgz $backupBootFiles
+	Echo &quot;Installing boot loader into recovery partition&quot;
+	setupBootLoaderRecovery / /reco-save OEM
+	installBootLoaderRecovery
+	umount /reco-save
+	rmdir /reco-save
+fi
+
+#======================================
+# 10) create /etc/ImagePackages
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	if [ -x /bin/rpm ];then
@@ -111,7 +146,7 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 10) kill udev
+# 11) kill udev
 #--------------------------------------
 udevSystemStop
 umountSystemFilesystems
diff --git a/system/boot/ix86/oemboot/suse-repart b/system/boot/ix86/oemboot/suse-repart
index c0ff991..de4c512 100755
--- a/system/boot/ix86/oemboot/suse-repart
+++ b/system/boot/ix86/oemboot/suse-repart
@@ -42,7 +42,7 @@ function OEMRepartInit {
 		fi
 		recoBytes=$(du --bytes /reco-root/recovery.tar.gz | cut -f1)
 		recoMByte=$((recoBytes / 1048576))
-		recoMByte=$((recoMByte * 15 / 10))
+		recoMByte=$((recoMByte + 100))
 		recoID=83
 		if [ ! -z &quot;$OEM_RECOVERY_ID&quot; ];then
 			recoID=$OEM_RECOVERY_ID
@@ -69,6 +69,12 @@ function OEMRepartStandard {
 	#--------------------------------------
 	createBootDeviceData 2
 	#======================================
+	# deactivate features if required
+	#--------------------------------------
+	if [ &quot;$haveBootPartition&quot; = &quot;yes&quot; ];then
+		export OEM_WITHOUTHOME=1
+	fi
+	#======================================
 	# setup initial boot device ID
 	#--------------------------------------
 	export bootid=1
@@ -570,14 +576,21 @@ function OEMRepart {
 			systemException &quot;Failed to move recovery size info&quot; &quot;reboot&quot;
 		fi
 		mkdir /reco-save/boot
-		if ! cp /reco-root/boot/initrd.vmx /reco-save/boot/initrd;then
-			systemException &quot;Failed to copy recovery initrd&quot; &quot;reboot&quot;
-		fi
-		if ! cp /reco-root/boot/linux.vmx /reco-save/boot/vmlinuz;then
-			systemException &quot;Failed to copy recovery kernel&quot; &quot;reboot&quot;
+		if [ &quot;$loader&quot; = &quot;grub&quot; ];then
+			if ! cp /reco-root/boot/initrd.vmx /reco-save/boot/initrd;then
+				systemException &quot;Failed to copy recovery initrd&quot; &quot;reboot&quot;
+			fi
+			if ! cp /reco-root/boot/linux.vmx /reco-save/boot/vmlinuz;then
+				systemException &quot;Failed to copy recovery kernel&quot; &quot;reboot&quot;
+			fi
+			if ! cp /reco-root/boot/message /reco-save/boot/message;then
+				systemException &quot;Failed to copy recovery gfx message&quot; &quot;reboot&quot;
+			fi
 		fi
-		if ! cp /reco-root/boot/message /reco-save/boot/message;then
-			systemException &quot;Failed to copy recovery gfxboot message&quot; &quot;reboot&quot;
+		if [ -f /boot.tgz ];then
+			if ! tar -xf /boot.tgz -C /reco-save;then
+				systemException &quot;Failed to extract recovery boot files&quot; &quot;reboot&quot;
+			fi
 		fi
 		if ! dd if=$imageDiskDevice of=/reco-save/mbr bs=1 count=512;then
 			systemException &quot;Failed to store MBR&quot; &quot;reboot&quot;
@@ -730,10 +743,6 @@ function createBootDeviceData {
 		mount $(ddn $imageDiskDevice $bootPart) /mnt
 		tar -czf /boot.tgz -C /mnt .
 		umount /mnt
-		#====================================== 
-		# deactivate unsupported features
-		#--------------------------------------
-		unset OEM_RECOVERY
 	fi
 	#====================================== 
 	# check for overlay type
diff --git a/system/boot/ix86/usbboot/suse-linuxrc b/system/boot/ix86/usbboot/suse-linuxrc
index 9c4daf9..6ca500d 100755
--- a/system/boot/ix86/usbboot/suse-linuxrc
+++ b/system/boot/ix86/usbboot/suse-linuxrc
@@ -87,6 +87,7 @@ export stickRoot=$biosBootDevice
 export stickDevice=$(ddn $stickRoot 1)
 export stickRWDevice=$(ddn $stickRoot 2)
 export stickRODevice=$(ddn $stickRoot 1)
+export imageDiskDevice=$stickRoot
 Echo &quot;Searching for $VGROUP volume group...&quot;
 if searchVolumeGroup; then
 	export haveLVM=yes
@@ -140,75 +141,7 @@ if [ -e /mnt/etc/ImagePackages ];then
 fi
 
 #======================================
-# 11) setup /lvmboot
-#--------------------------------------
-if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
-	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
-		#======================================
-		# LVM use second partition as boot
-		#--------------------------------------
-		mkdir /mnt/lvmboot
-		mount $stickBootDevice /mnt/lvmboot
-		if [ -z &quot;$UNIONFS_CONFIG&quot; ];then
-			cp -a /mnt/boot/* /mnt/lvmboot/boot
-		fi
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s lvmboot/boot boot )
-	elif [ &quot;$haveClicFS&quot; = &quot;yes&quot; ];then
-		#======================================
-		# Clic use third partition as boot
-		#--------------------------------------
-		mkdir /mnt/clicboot
-		export imageBootDevice=$(ddn $stickRoot 3)
-		mount $imageBootDevice /mnt/clicboot
-		cp -a  /mnt/boot /mnt/clicboot
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s clicboot/boot boot )
-	elif [ &quot;$loader&quot; = &quot;syslinux&quot; ] || [ &quot;$loader&quot; = &quot;extlinux&quot; ];then
-		#======================================
-		# Syslinux search FAT and use as boot
-		#--------------------------------------
-		pSearch=6
-		if [ &quot;$loader&quot; = &quot;extlinux&quot; ];then
-			pSearch=83
-		fi
-		for i in 3 2 1;do
-			pType=`partitionID $stickRoot $i`
-			if [ &quot;$pType&quot; = $pSearch ];then
-				imageBootDevice=$stickRoot$i
-				break
-			fi
-		done
-		if [ -z &quot;$imageBootDevice&quot; ];then
-			systemException &quot;Can't find 0x$pSearch boot partition&quot; &quot;reboot&quot;
-		fi
-		mkdir /mnt/syslboot
-		mount $imageBootDevice /mnt/syslboot
-		if [ -z &quot;$UNIONFS_CONFIG&quot; ];then
-			cp -a /mnt/boot/* /mnt/syslboot/boot
-		fi
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s syslboot/boot boot )
-	elif [ &quot;$haveLuks&quot; = &quot;yes&quot; ];then
-		#======================================
-		# LUKS use second or third part as boot
-		#--------------------------------------
-		mkdir /mnt/luksboot
-		export imageBootDevice=$(ddn $stickRoot 3)
-		if [ ! -e $imageBootDevice ];then
-			imageBootDevice=$(ddn $stickRoot 2)
-		fi
-		mount $imageBootDevice /mnt/luksboot
-		if [ -z &quot;$UNIONFS_CONFIG&quot; ];then
-			cp -a /mnt/boot/* /mnt/luksboot/boot
-		fi
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s luksboot/boot boot )
-	fi
-fi
-
-#======================================
-# 12) Create system dependant files
+# 11) Create system dependant files
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	setupDefaultFstab /config
@@ -225,31 +158,31 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 13) copy system dependant files
+# 12) copy system dependant files
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	setupConfigFiles
 fi
 
 #======================================
-# 14) update system dependant files
+# 13) update system dependant files
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	setupInittab /mnt
 fi
 
 #======================================
-# 15) setup real root device
+# 14) setup real root device
 #--------------------------------------
 echo 256 &gt; /proc/sys/kernel/real-root-dev
 
 #======================================
-# 16) umount system filesystems
+# 15) umount system filesystems
 #--------------------------------------
 umountSystemFilesystems
 
 #======================================
-# 17) copy initrd files to image
+# 16) copy initrd files to image
 #--------------------------------------
 if [ ! -f /mnt/boot/deployed ];then
 	touch /mnt/boot/deployed
@@ -259,17 +192,17 @@ cp /preinit /mnt
 cp /include /mnt
 
 #======================================
-# 18) kill boot shell
+# 17) kill boot shell
 #--------------------------------------
 killShell
 killBlogD
 
 #======================================
-# 19) Activate new root
+# 18) Activate new root
 #--------------------------------------
 activateImage
 
 #======================================
-# 20) Unmount initrd / system init
+# 19) Unmount initrd / system init
 #--------------------------------------
 bootImage $@
diff --git a/system/boot/ix86/vmxboot/suse-linuxrc b/system/boot/ix86/vmxboot/suse-linuxrc
index 121516e..bc9623b 100755
--- a/system/boot/ix86/vmxboot/suse-linuxrc
+++ b/system/boot/ix86/vmxboot/suse-linuxrc
@@ -195,75 +195,7 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 13) setup boot partition 
-#--------------------------------------
-if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
-	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
-		#======================================
-		# LVM use second partition as boot
-		#--------------------------------------
-		mkdir /mnt/lvmboot
-		mount $imageBootDevice /mnt/lvmboot
-		if [ -z &quot;$UNIONFS_CONFIG&quot; ];then
-			cp -a /mnt/boot/* /mnt/lvmboot/boot
-		fi
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s lvmboot/boot boot )
-	elif [ &quot;$haveClicFS&quot; = &quot;yes&quot; ];then
-		#======================================
-		# Clic use third partition as boot
-		#--------------------------------------
-		mkdir /mnt/clicboot
-		export imageBootDevice=$(ddn $imageDiskDevice 3)
-		mount $imageBootDevice /mnt/clicboot
-		cp -a  /mnt/boot /mnt/clicboot
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s clicboot/boot boot )
-	elif [ &quot;$loader&quot; = &quot;syslinux&quot; ] || [ &quot;$loader&quot; = &quot;extlinux&quot; ];then
-		#======================================
-		# Syslinux search FAT and use as boot
-		#--------------------------------------
-		pSearch=6
-		if [ &quot;$loader&quot; = &quot;extlinux&quot; ];then
-			pSearch=83
-		fi
-		for i in 3 2 1;do
-			pType=`partitionID $imageDiskDevice $i`
-			if [ &quot;$pType&quot; = $pSearch ];then
-				imageBootDevice=$(ddn $imageDiskDevice $i)
-				break
-			fi 
-		done
-		if [ -z &quot;$imageBootDevice&quot; ];then
-			systemException &quot;Can't find 0x$pSearch boot partition&quot; &quot;reboot&quot;
-		fi
-		mkdir /mnt/syslboot
-		mount $imageBootDevice /mnt/syslboot
-		if [ -z &quot;$UNIONFS_CONFIG&quot; ];then
-			cp -a /mnt/boot/* /mnt/syslboot/boot
-		fi
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s syslboot/boot boot )
-	elif [ &quot;$haveLuks&quot; = &quot;yes&quot; ];then
-		#======================================
-		# LUKS use second or third part as boot
-		#--------------------------------------
-		mkdir /mnt/luksboot
-		export imageBootDevice=$(ddn $imageDiskDevice 3)
-		if [ ! -e $imageBootDevice ];then
-			imageBootDevice=$(ddn $imageDiskDevice 2)
-		fi
-		mount $imageBootDevice /mnt/luksboot
-		if [ -z &quot;$UNIONFS_CONFIG&quot; ];then
-			cp -a /mnt/boot/* /mnt/luksboot/boot
-		fi
-		rm -rf /mnt/boot
-		( cd /mnt &amp;&amp; ln -s luksboot/boot boot )
-	fi
-fi
-
-#======================================
-# 14) setup ird/kernel links for union
+# 13) setup ird/kernel links for union
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	if isFSTypeReadOnly;then
@@ -277,6 +209,8 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 			pushd /mnt/lvmboot/boot &gt;/dev/null
 		elif [ &quot;$haveClicFS&quot; = &quot;yes&quot; ];then
 			pushd /mnt/clicboot/boot &gt;/dev/null
+		elif [ &quot;$loader&quot; = &quot;syslinux&quot; ] || [ &quot;$loader&quot; = &quot;extlinux&quot; ];then
+			pushd /mnt/syslboot/boot &gt;/dev/null
 		elif [ &quot;$haveLuks&quot; = &quot;yes&quot; ];then
 			pushd /mnt/luksboot/boot &gt;/dev/null
 		else
@@ -303,7 +237,7 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 15) Create system dependant files
+# 14) Create system dependant files
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	setupDefaultFstab /config
@@ -340,29 +274,29 @@ if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 fi
 
 #======================================
-# 16) copy system dependant files
+# 15) copy system dependant files
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	setupConfigFiles
 fi
 
 #======================================
-# 17) update system dependant files
+# 16) update system dependant files
 #--------------------------------------
 setupInittab /mnt
 
 #======================================
-# 18) setup real root device
+# 17) setup real root device
 #--------------------------------------
 echo 256 &gt; /proc/sys/kernel/real-root-dev
 
 #======================================
-# 19) umount system filesystems
+# 18) umount system filesystems
 #--------------------------------------
 umountSystemFilesystems
 
 #======================================
-# 20) copy initrd files to image
+# 19) copy initrd files to image
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ];then
 	importBranding
@@ -371,17 +305,17 @@ cp /preinit /mnt
 cp /include /mnt
 
 #======================================
-# 21) kill boot shell
+# 20) kill boot shell
 #--------------------------------------
 killShell
 killBlogD
 
 #======================================
-# 22) Activate new root
+# 21) Activate new root
 #--------------------------------------
 activateImage
 
 #======================================
-# 23) Unmount initrd / system init
+# 22) Unmount initrd / system init
 #--------------------------------------
 bootImage $@


hooks/post-receive
-- 
Project kiwi at BerliOS

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002232.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. fb3250f8900142a2882d524e2bf3642df1ac2820
</A></li>
	<LI>Next message: <A HREF="002234.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 67001e428fc5854d6b810e0ff038c22d109244aa
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2233">[ date ]</a>
              <a href="thread.html#2233">[ thread ]</a>
              <a href="subject.html#2233">[ subject ]</a>
              <a href="author.html#2233">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
