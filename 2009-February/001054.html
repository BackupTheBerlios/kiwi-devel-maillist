<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] r1932 - in kiwi-head: . modules rpm	system/boot/ix86/oemboot system/boot/ix86/vmxboot
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2009-February/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20r1932%20-%20in%20kiwi-head%3A%20.%20modules%20rpm%0A%09system/boot/ix86/oemboot%20system/boot/ix86/vmxboot&In-Reply-To=%3C200902271541.n1RFfW68010614%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001053.html">
   <LINK REL="Next"  HREF="001055.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] r1932 - in kiwi-head: . modules rpm	system/boot/ix86/oemboot system/boot/ix86/vmxboot</H1>
    <B>marcus_schaefer at mail.berlios.de</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20r1932%20-%20in%20kiwi-head%3A%20.%20modules%20rpm%0A%09system/boot/ix86/oemboot%20system/boot/ix86/vmxboot&In-Reply-To=%3C200902271541.n1RFfW68010614%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] r1932 - in kiwi-head: . modules rpm	system/boot/ix86/oemboot system/boot/ix86/vmxboot">marcus_schaefer at mail.berlios.de
       </A><BR>
    <I>Fri Feb 27 16:41:32 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001053.html">[Kiwi-devel] r1931 - in kiwi-head: doc/examples/suse-10.3/suse-live-stick doc/examples/suse-10.3/suse-live-stick/root/etc doc/examples/suse-10.3/suse-oem-preload doc/examples/suse-10.3/suse-oem-preload/root/etc doc/examples/suse-10.3/suse-pxe-client doc/examples/suse-10.3/suse-pxe-client/root/etc doc/examples/suse-10.3/suse-vm-guest doc/examples/suse-10.3/suse-vm-guest/root/etc doc/examples/suse-10.3/suse-xen-guest doc/examples/suse-10.3/suse-xen-guest/root/etc doc/examples/suse-11.0/suse-ec2-guest doc/examples/suse-11.0/suse-ec2-guest/root/etc doc/examples/suse-11.0/suse-live-iso doc/examples/suse-11.0/suse-live-iso/root/etc doc/examples/suse-11.0/suse-live-stick doc/examples/suse-11.0/suse-live-stick/root/etc doc/examples/suse-11.0/suse-oem-preload doc/examples/suse-11.0/suse-oem-preload/root/etc doc/examples/suse-11.0/suse-pxe-client doc/examples/suse-11.0/suse-pxe-client/root/etc doc/examples/suse-11.0/suse-vm-guest doc/examples/suse-11.0/suse-vm-guest/root/etc doc/examples/! suse-11.0/suse-xen-guest doc/examples/suse-11.0/suse-xen-guest/root/etc doc/examples/suse-11.1/suse-ec2-guest doc/examples/suse-11.1/suse-ec2-guest/root/etc doc/examples/suse-11.1/suse-live-iso doc/examples/suse-11.1/suse-live-iso/root/etc doc/examples/suse-11.1/suse-live-stick/root/etc doc/examples/suse-11.1/suse-oem-preload doc/examples/suse-11.1/suse-oem-preload/root/etc doc/examples/suse-11.1/suse-pxe-client doc/examples/suse-11.1/suse-pxe-client/root/etc doc/examples/suse-11.1/suse-vm-guest doc/examples/suse-11.1/suse-vm-guest/root/etc doc/examples/suse-11.1/suse-xen-guest doc/examples/suse-11.1/suse-xen-guest/root/etc doc/examples/suse-11.2/suse-ec2-guest doc/examples/suse-11.2/suse-ec2-guest/root/etc doc/examples/suse-11.2/suse-live-iso doc/examples/suse-11.2/suse-live-iso/root/etc doc/examples/suse-11.2/suse-live-stick/root/etc doc/examples/suse-11.2/suse-oem-preload doc/examples/suse-11.2/suse-oem-preload/root/etc doc/examples/suse-11.2/suse-pxe-client doc/examples! /suse-11.2/suse-pxe-client/root/etc doc/examples/suse-11.2/sus! e-vm-gue
</A></li>
        <LI>Next message: <A HREF="001055.html">[Kiwi-devel] r1933 - in kiwi-head: doc doc/LaTex modules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1054">[ date ]</a>
              <a href="thread.html#1054">[ thread ]</a>
              <a href="subject.html#1054">[ subject ]</a>
              <a href="author.html#1054">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: marcus_schaefer
Date: 2009-02-27 16:41:22 +0100 (Fri, 27 Feb 2009)
New Revision: 1932

Modified:
   kiwi-head/kiwi.pl
   kiwi-head/modules/KIWIBoot.pm
   kiwi-head/modules/KIWILinuxRC.sh
   kiwi-head/modules/KIWIXML.pm
   kiwi-head/rpm/kiwi.changes
   kiwi-head/rpm/kiwi.spec
   kiwi-head/system/boot/ix86/oemboot/suse-linuxrc
   kiwi-head/system/boot/ix86/vmxboot/suse-linuxrc
   kiwi-head/system/boot/ix86/vmxboot/suse-preinit
Log:

- v3.23
- fixed syslinux setup for vmx image types
- add system exception for syslinux on oem image types.
  This is because we don't support OEMs with syslinux



Modified: kiwi-head/kiwi.pl
===================================================================
--- kiwi-head/kiwi.pl	2009-02-26 18:04:23 UTC (rev 1931)
+++ kiwi-head/kiwi.pl	2009-02-27 15:41:22 UTC (rev 1932)
@@ -44,7 +44,7 @@
 #============================================
 # Globals (Version)
 #--------------------------------------------
-our $Version       = &quot;3.22&quot;;
+our $Version       = &quot;3.23&quot;;
 our $Publisher     = &quot;SUSE LINUX Products GmbH&quot;;
 our $Preparer      = &quot;KIWI - <A HREF="http://kiwi.berlios.de">http://kiwi.berlios.de</A>&quot;;
 our $openSUSE      = &quot;<A HREF="http://download.opensuse.org">http://download.opensuse.org</A>&quot;;

Modified: kiwi-head/modules/KIWIBoot.pm
===================================================================
--- kiwi-head/modules/KIWIBoot.pm	2009-02-26 18:04:23 UTC (rev 1931)
+++ kiwi-head/modules/KIWIBoot.pm	2009-02-27 15:41:22 UTC (rev 1932)
@@ -2416,7 +2416,7 @@
 	#==========================================
 	# Copy boot data on system image
 	#------------------------------------------
-	$status = qxx (&quot;cp -a $tmpdir/boot $loopdir 2&gt;&amp;1&quot;);
+	$status = qxx (&quot;cp -dR $tmpdir/boot $loopdir 2&gt;&amp;1&quot;);
 	$result = $? &gt;&gt; 8;
 	if ($result != 0) {
 		$kiwi -&gt; failed ();
@@ -3321,10 +3321,12 @@
 				print FD &quot; ramdisk_size=512000 ramdisk_blocksize=4096&quot;;
 			} elsif (($type=~ /^KIWI USB/)||($imgtype=~ /vmx|oem|split|usb/)) {
 				print FD &quot; root (hd0,$bootpart)\n&quot;;
-				print FD &quot; kernel /boot/linux.vmx vga=0x314 splash=silent&quot;;
+				print FD &quot; kernel /boot/linux.vmx vga=0x314&quot;;
+				print FD &quot; loader=$loader splash=silent&quot;;
 			} else {
 				print FD &quot; root (hd0,$bootpart)\n&quot;;
-				print FD &quot; kernel /boot/linux vga=0x314 splash=silent&quot;;
+				print FD &quot; kernel /boot/linux vga=0x314&quot;;
+				print FD &quot; loader=$loader splash=silent&quot;;
 			}
 			if ($imgtype eq &quot;split&quot;) {
 				print FD &quot; COMBINED_IMAGE=yes showopts&quot;;
@@ -3347,11 +3349,13 @@
 			} elsif (($type=~ /^KIWI USB/)||($imgtype=~ /vmx|oem|split|usb/)) {
 				print FD &quot; root (hd0,$bootpart)\n&quot;;
 				print FD &quot; kernel /boot/xen.gz.vmx\n&quot;;
-				print FD &quot; module /boot/linux.vmx vga=0x314 splash=silent&quot;;
+				print FD &quot; module /boot/linux.vmx vga=0x314&quot;;
+				print FD &quot; loader=$loader splash=silent&quot;;
 			} else {
 				print FD &quot; root (hd0,$bootpart)\n&quot;;
 				print FD &quot; kernel /boot/xen.gz\n&quot;;
-				print FD &quot; module /boot/linux vga=0x314 splash=silent&quot;;
+				print FD &quot; module /boot/linux vga=0x314&quot;;
+				print FD &quot; loader=$loader splash=silent&quot;;
 			}
 			if ($imgtype eq &quot;split&quot;) {
 				print FD &quot; COMBINED_IMAGE=yes showopts&quot;;
@@ -3383,10 +3387,12 @@
 				print FD &quot; ramdisk_size=512000 ramdisk_blocksize=4096&quot;;
 			} elsif (($type=~ /^KIWI USB/)||($imgtype=~ /vmx|oem|split|usb/)) {
 				print FD &quot; root (hd0,$bootpart)\n&quot;;
-				print FD &quot; kernel /boot/linux.vmx vga=0x314 splash=silent&quot;;
+				print FD &quot; kernel /boot/linux.vmx vga=0x314&quot;;
+				print FD &quot; loader=$loader splash=silent&quot;;
 			} else {
 				print FD &quot; root (hd0,$bootpart)\n&quot;;
-				print FD &quot; kernel /boot/linux vga=0x314 splash=silent&quot;;
+				print FD &quot; kernel /boot/linux vga=0x314&quot;;
+				print FD &quot; loader=$loader splash=silent&quot;;
 			}
 			print FD &quot; ide=nodma apm=off acpi=off noresume selinux=0 nosmp&quot;;
 			print FD &quot; noapic maxcpus=0 edd=off\n&quot;;
@@ -3411,11 +3417,13 @@
 			} elsif (($type=~ /^KIWI USB/)||($imgtype=~ /vmx|oem|split|usb/)) {
 				print FD &quot; root (hd0,$bootpart)\n&quot;;
 				print FD &quot; kernel /boot/xen.gz.vmx\n&quot;;
-				print FD &quot; module /boot/linux.vmx vga=0x314 splash=silent&quot;;
+				print FD &quot; module /boot/linux.vmx vga=0x314&quot;;
+				print FD &quot; loader=$loader splash=silent&quot;;
 			} else {
 				print FD &quot; root (hd0,$bootpart)\n&quot;;
 				print FD &quot; kernel /boot/xen.gz\n&quot;;
-				print FD &quot; module /boot/linux vga=0x314 splash=silent&quot;;
+				print FD &quot; module /boot/linux vga=0x314&quot;;
+				print FD &quot; loader=$loader splash=silent&quot;;
 			}
 			print FD &quot; ide=nodma apm=off acpi=off noresume selinux=0 nosmp&quot;;
 			print FD &quot; noapic maxcpus=0 edd=off&quot;;
@@ -3486,12 +3494,12 @@
 				# not supported yet..
 			} elsif (($type=~ /^KIWI USB/)||($imgtype=~ /vmx|oem|split|usb/)) {
 				print FD &quot;KERNEL /boot/linux.vmx\n&quot;;
-				print FD &quot;APPEND ro initrd=/boot/initrd.vmx &quot;;
-				print FD &quot;vga=0x314 splash=silent&quot;;
+				print FD &quot;APPEND initrd=/boot/initrd.vmx &quot;;
+				print FD &quot;vga=0x314 loader=$loader splash=silent&quot;;
 			} else {
 				print FD &quot;KERNEL /boot/linux\n&quot;;
-				print FD &quot;APPEND ro initrd=/boot/initrd &quot;;
-				print FD &quot;vga=0x314 splash=silent&quot;;
+				print FD &quot;APPEND initrd=/boot/initrd &quot;;
+				print FD &quot;vga=0x314 loader=$loader splash=silent&quot;;
 			}
 			if ($imgtype eq &quot;split&quot;) {
 				print FD &quot; COMBINED_IMAGE=yes showopts\n&quot;;
@@ -3529,12 +3537,12 @@
 				# not supported yet..
 			} elsif (($type=~ /^KIWI USB/)||($imgtype=~ /vmx|oem|split|usb/)) {
 				print FD &quot;KERNEL /boot/linux.vmx\n&quot;;
-				print FD &quot;APPEND ro initrd=/boot/initrd.vmx &quot;;
-				print FD &quot;vga=0x314 splash=silent&quot;;
+				print FD &quot;APPEND initrd=/boot/initrd.vmx &quot;;
+				print FD &quot;vga=0x314 loader=$loader splash=silent&quot;;
 			} else {
 				print FD &quot;KERNEL /boot/linux\n&quot;;
-				print FD &quot;APPEND ro initrd=/boot/initrd &quot;;
-				print FD &quot;vga=0x314 splash=silent&quot;;
+				print FD &quot;APPEND initrd=/boot/initrd &quot;;
+				print FD &quot;vga=0x314 loader=$loader splash=silent&quot;;
 			}
 			print FD &quot; ide=nodma apm=off acpi=off noresume selinux=0 nosmp&quot;;
 			print FD &quot; noapic maxcpus=0 edd=off&quot;;

Modified: kiwi-head/modules/KIWILinuxRC.sh
===================================================================
--- kiwi-head/modules/KIWILinuxRC.sh	2009-02-26 18:04:23 UTC (rev 1931)
+++ kiwi-head/modules/KIWILinuxRC.sh	2009-02-27 15:41:22 UTC (rev 1932)
@@ -411,13 +411,16 @@
 	# the architecture of the system
 	# ----
 	local arch=`uname -m`
-	case $arch in
-		i*86)   installBootLoaderGrub ;;
-		x86_64) installBootLoaderGrub ;;
-		ppc*)   installBootLoaderLilo ;;
+	if [ -z &quot;$loader&quot; ];then
+		loader=&quot;grub&quot;
+	fi
+	case $arch-$loader in
+		i*86-grub)   installBootLoaderGrub ;;
+		x86_64-grub) installBootLoaderGrub ;;
+		ppc*)        installBootLoaderLilo ;;
 		*)
 		systemException \
-			&quot;*** boot loader setup for $arch not implemented ***&quot; \
+			&quot;*** boot loader install for $arch-$loader not implemented ***&quot; \
 		&quot;reboot&quot;
 	esac
 }
@@ -431,12 +434,15 @@
 	# happens according to the architecture of the system
 	# ----
 	local arch=`uname -m`
-	case $arch in
-		i*86)   installBootLoaderGrubRecovery ;;
-		x86_64) installBootLoaderGrubRecovery ;;
+	if [ -z &quot;$loader&quot; ];then
+		loader=&quot;grub&quot;
+	fi
+	case $arch-$loader in
+		i*86-grub)   installBootLoaderGrubRecovery ;;
+		x86_64-grub) installBootLoaderGrubRecovery ;;
 		*)
 		systemException \
-			&quot;*** boot loader setup for $arch not implemented ***&quot; \
+			&quot;*** boot loader setup for $arch-$loader not implemented ***&quot; \
 		&quot;reboot&quot;
 	esac
 }
@@ -591,13 +597,16 @@
 	# happens according to the architecture of the system
 	# ----
 	local arch=`uname -m`
-	case $arch in
-		i*86)    setupBootLoaderFilesGrub ;;
-		x86_64)  setupBootLoaderFilesGrub ;;
-		ppc*)    setupBootLoaderFilesLilo ;;
+	if [ -z &quot;$loader&quot; ];then
+		loader=&quot;grub&quot;
+	fi
+	case $arch-$loader in
+		i*86-grub)    setupBootLoaderFilesGrub ;;
+		x86_64-grub)  setupBootLoaderFilesGrub ;;
+		ppc*)         setupBootLoaderFilesLilo ;;
 		*)
 		systemException \
-			&quot;*** boot loader files for $arch not implemented ***&quot; \
+			&quot;*** boot loader files for $arch-$loader not implemented ***&quot; \
 		&quot;reboot&quot;
 	esac
 }
@@ -628,13 +637,18 @@
 		para=&quot;$para \&quot;$1\&quot;&quot;
 		shift
 	done
-	case $arch in
-		i*86)   eval setupBootLoaderGrub $para ;;
-		x86_64) eval setupBootLoaderGrub $para ;;
-		ppc*)   eval setupBootLoaderLilo $para ;;
+	if [ -z &quot;$loader&quot; ];then
+		loader=&quot;grub&quot;
+	fi
+	case $arch-$loader in
+		i*86-grub)       eval setupBootLoaderGrub $para ;;
+		x86_64-grub)     eval setupBootLoaderGrub $para ;;
+		i*86-syslinux)   eval setupBootLoaderSyslinux $para ;;
+		x86_64-syslinux) eval setupBootLoaderSyslinux $para ;;
+		ppc*)            eval setupBootLoaderLilo $para ;;
 		*)
 		systemException \
-			&quot;*** boot loader setup for $arch not implemented ***&quot; \
+			&quot;*** boot loader setup for $arch-$loader not implemented ***&quot; \
 		&quot;reboot&quot;
 	esac
 }
@@ -653,12 +667,15 @@
 		para=&quot;$para \&quot;$1\&quot;&quot;
 		shift
 	done
-	case $arch in
-		i*86)   eval setupBootLoaderGrubRecovery $para ;;
-		x86_64) eval setupBootLoaderGrubRecovery $para ;;
+	if [ -z &quot;$loader&quot; ];then
+		loader=&quot;grub&quot;
+	fi
+	case $arch-$loader in
+		i*86-grub)   eval setupBootLoaderGrubRecovery $para ;;
+		x86_64-grub) eval setupBootLoaderGrubRecovery $para ;;
 		*)
 		systemException \
-			&quot;*** boot loader setup for $arch not implemented ***&quot; \
+			&quot;*** boot loader setup for $arch-$loader not implemented ***&quot; \
 		&quot;reboot&quot;
 	esac
 }
@@ -720,6 +737,164 @@
 	fi
 }
 #======================================
+# setupBootLoaderSyslinux
+#--------------------------------------
+function setupBootLoaderSyslinux {
+	# /.../
+	# create syslinux.cfg used for the
+	# syslinux bootloader
+	# ----
+	local mountPrefix=$1  # mount path of the image
+	local destsPrefix=$2  # base dir for the config files
+	local gnum=$3         # boot partition ID
+	local rdev=$4         # root partition
+	local gfix=$5         # syslinux title
+	local swap=$6         # optional swap partition
+	local conf=$destsPrefix/boot/syslinux/syslinux.cfg
+	local sysb=$destsPrefix/etc/sysconfig/bootloader
+	local console=&quot;&quot;
+	local kname=&quot;&quot;
+	local kernel=&quot;&quot;
+	local initrd=&quot;&quot;
+	#======================================
+	# check for device by ID
+	#--------------------------------------
+	local diskByID=`getDiskID $rdev`
+	local swapByID=`getDiskID $swap`
+	#======================================
+	# check for boot image .profile
+	#--------------------------------------
+	if [ -f /.profile ];then
+		importFile &lt; /.profile
+	fi
+	#======================================
+	# check for system image .profile
+	#--------------------------------------
+	if [ -f $mountPrefix/image/.profile ];then
+		importFile &lt; $mountPrefix/image/.profile
+	fi
+	#======================================
+	# check for syslinux title postfix
+	#--------------------------------------
+	if [ -z &quot;$gfix&quot; ];then
+		gfix=&quot;unknown&quot;
+	fi
+	#======================================
+	# check for boot TIMEOUT
+	#--------------------------------------
+	if [ -z &quot;$KIWI_BOOT_TIMEOUT&quot; ];then
+		KIWI_BOOT_TIMEOUT=100;
+	fi
+	#======================================
+	# create directory structure
+	#--------------------------------------
+	for dir in $conf $sysb;do
+		dir=`dirname $dir`; mkdir -p $dir
+	done
+	#======================================
+	# create syslinux.cfg file
+	#--------------------------------------
+	echo &quot;DEFAULT vesamenu.c32&quot;         &gt; $conf
+	echo &quot;TIMEOUT $KIWI_BOOT_TIMEOUT&quot;  &gt;&gt; $conf
+	local count=1
+	IFS=&quot;,&quot; ; for i in $KERNEL_LIST;do
+		if test ! -z &quot;$i&quot;;then
+			#======================================
+			# create standard entry
+			#--------------------------------------
+			kernel=`echo $i | cut -f1 -d:`
+			initrd=`echo $i | cut -f2 -d:`
+			kname=${KERNEL_NAME[$count]}
+			#======================================
+			# move to FAT requirements 8+3
+			#--------------------------------------
+			kernel=&quot;linux.$count&quot;
+			initrd=&quot;initrd.$count&quot;
+			echo &quot;LABEL Linux&quot; &gt;&gt; $conf
+			if ! echo $gfix | grep -E -q &quot;OEM|USB|VMX|unknown&quot;;then
+				echo &quot;MENU LABEL &quot;&quot;$gfix&quot;                    &gt;&gt; $conf
+			elif [ -z &quot;$kiwi_oemtitle&quot; ];then
+				echo &quot;MENU LABEL &quot;&quot;$kname&quot;&quot; [ &quot;$gfix&quot; ]&quot;     &gt;&gt; $conf
+			else
+				if [ &quot;$count&quot; = &quot;1&quot; ];then
+					echo -n &quot;MENU LABEL &quot;&quot;$kiwi_oemtitle&quot;    &gt;&gt; $conf
+					echo &quot; [ &quot;&quot;$gfix&quot;&quot; ]&quot;                    &gt;&gt; $conf
+				else
+					echo -n &quot;MENU LABEL &quot;&quot;$kiwi_oemtitle&quot;    &gt;&gt; $conf
+					echo &quot;-&quot;&quot;$kname&quot;&quot; [ &quot;&quot;$gfix&quot;&quot; ]&quot;         &gt;&gt; $conf
+				fi
+			fi
+			if [ $kernel = &quot;vmlinuz-xen&quot; ];then
+				systemException \
+					&quot;*** syslinux xen boot not implemented ***&quot; \
+				&quot;reboot&quot;
+			else
+				echo &quot;KERNEL /boot/$kernel&quot;                  &gt;&gt; $conf
+				echo -n &quot;APPEND initrd=/boot/$initrd&quot;     &gt;&gt; $conf
+				echo -n &quot; root=$diskByID $console vga=0x314&quot; &gt;&gt; $conf
+				echo -n &quot; loader=$loader splash=silent&quot;      &gt;&gt; $conf
+				if [ ! -z &quot;$swap&quot; ];then
+					echo -n &quot; resume=$swapByID&quot;              &gt;&gt; $conf
+				fi
+				echo -n &quot; $KIWI_INITRD_PARAMS&quot;               &gt;&gt; $conf
+				echo &quot; $KIWI_KERNEL_OPTIONS showopts&quot;        &gt;&gt; $conf
+			fi
+			#======================================
+			# create Failsafe entry
+			#--------------------------------------
+			echo &quot;LABEL Failsafe&quot; &gt;&gt; $conf
+			if ! echo $gfix | grep -E -q &quot;OEM|USB|VMX|unknown&quot;;then
+				echo &quot;MENU LABEL Failsafe -- &quot;&quot;$gfix&quot;        &gt;&gt; $conf
+			elif [ -z &quot;$kiwi_oemtitle&quot; ];then
+				echo -n &quot;MENU LABEL Failsafe -- &quot;&quot;$kname&quot;    &gt;&gt; $conf
+				echo &quot; [ &quot;$gfix&quot; ]&quot;                          &gt;&gt; $conf
+			else
+				if [ &quot;$count&quot; = &quot;1&quot; ];then
+					echo -n &quot;MENU LABEL Failsafe -- &quot;        &gt;&gt; $conf
+					echo -n &quot;$kiwi_oemtitle&quot;&quot; [ &quot;            &gt;&gt; $conf
+					echo &quot;$gfix&quot;&quot; ]&quot;                         &gt;&gt; $conf
+				else
+					echo -n &quot;MENU LABEL Failsafe -- &quot;        &gt;&gt; $conf
+					echo -n &quot;$kiwi_oemtitle&quot;&quot;-&quot;&quot;$kname&quot;&quot; [ &quot; &gt;&gt; $conf
+					echo &quot;$gfix&quot;&quot; ]&quot;                         &gt;&gt; $conf
+				fi
+			fi
+			if [ $kernel = &quot;vmlinuz-xen&quot; ];then
+				systemException \
+					&quot;*** syslinux xen boot not implemented ***&quot; \
+				&quot;reboot&quot;
+			else
+				echo &quot;KERNEL /boot/$kernel&quot;                  &gt;&gt; $conf
+				echo -n &quot;APPEND initrd=/boot/$initrd&quot;     &gt;&gt; $conf
+				echo -n &quot; root=$diskByID $console vga=0x314&quot; &gt;&gt; $conf
+				echo -n &quot; loader=$loader splash=silent&quot;      &gt;&gt; $conf
+				if [ ! -z &quot;$swap&quot; ];then
+					echo -n &quot; resume=$swapByID&quot;              &gt;&gt; $conf
+				fi
+				echo -n &quot; $KIWI_INITRD_PARAMS&quot;               &gt;&gt; $conf
+				echo &quot; $KIWI_KERNEL_OPTIONS showopts&quot;        &gt;&gt; $conf
+				echo -n &quot; ide=nodma apm=off acpi=off&quot;        &gt;&gt; $conf
+				echo -n &quot; noresume selinux=0 nosmp&quot;          &gt;&gt; $conf
+				echo &quot; noapic maxcpus=0 edd=off&quot;             &gt;&gt; $conf
+			fi
+			#======================================
+			# create recovery entry
+			#--------------------------------------
+			if [ ! -z &quot;$OEM_RECOVERY&quot; ];then
+				systemException \
+					&quot;*** syslinux recovery chain loading not implemented ***&quot; \
+				&quot;reboot&quot;
+			fi
+			count=`expr $count + 1`
+		fi
+	done
+	#======================================
+	# create sysconfig/bootloader
+	#--------------------------------------
+	echo &quot;LOADER_TYPE=\&quot;syslinux\&quot;&quot;   &gt; $sysb
+	echo &quot;LOADER_LOCATION=\&quot;mbr\&quot;&quot;   &gt;&gt; $sysb
+}
+#======================================
 # setupBootLoaderGrub
 #--------------------------------------
 function setupBootLoaderGrub {
@@ -747,6 +922,12 @@
 	local diskByID=`getDiskID $rdev`
 	local swapByID=`getDiskID $swap`
 	#======================================
+	# check for boot image .profile
+	#--------------------------------------
+	if [ -f /.profile ];then
+		importFile &lt; /.profile
+	fi
+	#======================================
 	# check for system image .profile
 	#--------------------------------------
 	if [ -f $mountPrefix/image/.profile ];then
@@ -808,11 +989,16 @@
 			kname=${KERNEL_NAME[$count]}
 			if ! echo $gfix | grep -E -q &quot;OEM|USB|VMX|unknown&quot;;then
 				echo &quot;title _&quot;&quot;$gfix&quot;&quot;_&quot;                          &gt;&gt; $menu
-			elif [ -z &quot;$kiwi_iname&quot; ];then
+			elif [ -z &quot;$kiwi_oemtitle&quot; ];then
 				echo &quot;title _&quot;&quot;$kname&quot;&quot; [ &quot;$gfix&quot; ]_&quot;             &gt;&gt; $menu
 			else
-				echo -n &quot;title _&quot;&quot;$kiwi_iname&quot;                    &gt;&gt; $menu
-				echo &quot;-&quot;&quot;$kname&quot;&quot; [ &quot;&quot;$gfix&quot;&quot; ]_&quot;                 &gt;&gt; $menu
+				if [ &quot;$count&quot; = &quot;1&quot; ];then
+					echo -n &quot;title _&quot;&quot;$kiwi_oemtitle&quot;             &gt;&gt; $menu
+					echo &quot; [ &quot;&quot;$gfix&quot;&quot; ]_&quot;                        &gt;&gt; $menu
+				else
+					echo -n &quot;title _&quot;&quot;$kiwi_oemtitle&quot;&quot;-&quot;&quot;$kname&quot;  &gt;&gt; $menu
+					echo &quot; [ &quot;&quot;$gfix&quot;&quot; ]_&quot;
+				fi
 			fi
 			if [ $kernel = &quot;vmlinuz-xen&quot; ];then
 				echo &quot; root $gdev&quot;                                &gt;&gt; $menu
@@ -841,13 +1027,18 @@
 			# create failsafe entry
 			#--------------------------------------
 			if ! echo $gfix | grep -E -q &quot;OEM|USB|VMX|unknown&quot;;then
-				echo &quot;title _Failsafe -- &quot;&quot;$gfix&quot;&quot;_&quot;             &gt;&gt; $menu
-			elif [ -z &quot;$kiwi_iname&quot; ];then
-				echo -n &quot;title _Failsafe -- &quot;                    &gt;&gt; $menu
-				echo &quot;$kname&quot;&quot; [ &quot;&quot;$gfix&quot;&quot; ]_&quot;                   &gt;&gt; $menu
+				echo &quot;title _Failsafe -- &quot;&quot;$gfix&quot;&quot;_&quot;              &gt;&gt; $menu
+			elif [ -z &quot;$kiwi_oemtitle&quot; ];then
+				echo -n &quot;title _Failsafe -- &quot;                     &gt;&gt; $menu
+				echo &quot;$kname&quot;&quot; [ &quot;&quot;$gfix&quot;&quot; ]_&quot;                    &gt;&gt; $menu
 			else
-				echo -n &quot;title _Failsafe -- &quot;&quot;$kiwi_iname&quot;       &gt;&gt; $menu
-				echo &quot;-&quot;&quot;$kname&quot;&quot; [ &quot;&quot;$gfix&quot;&quot; ]_&quot;                &gt;&gt; $menu
+				if [ &quot;$count&quot; = &quot;1&quot; ];then
+					echo -n &quot;title _Failsafe -- &quot;&quot;$kiwi_oemtitle&quot; &gt;&gt; $menu
+					echo &quot; [ &quot;&quot;$gfix&quot;&quot; ]_&quot;
+				else
+					echo -n &quot;title _Failsafe -- &quot;&quot;$kiwi_oemtitle&quot; &gt;&gt; $menu
+					echo &quot;-&quot;&quot;$kname&quot;&quot; [ &quot;&quot;$gfix&quot;&quot; ]_&quot;             &gt;&gt; $menu
+				fi
 			fi
 			if [ $kernel = &quot;vmlinuz-xen&quot; ];then
 				echo &quot; root $gdev&quot;                                &gt;&gt; $menu
@@ -930,6 +1121,12 @@
 		&quot;setupBootLoaderLilo $# called with '$1' '$2' '$3' '$4' '$5' '$6' '$7'&quot;\
 	&gt;&amp;2
 	#======================================
+	# check for boot image .profile
+	#--------------------------------------
+	if [ -f /.profile ];then
+		importFile &lt; /.profile
+	fi
+	#======================================
 	# check for system image .profile
 	#--------------------------------------
 	if [ -f $mountPrefix/image/.profile ];then
@@ -976,13 +1173,17 @@
 			echo &quot;image=/boot/$kernel&quot;
 			echo -n &quot;###Don't change this comment - YaST2 identifier:&quot;
 			echo &quot; Original name: linux###&quot;
-			echo &quot;# kiwi_iname $kiwi_iname&quot;
+			echo &quot;# kiwi_oemtitle $kiwi_oemtitle&quot;
 			if ! echo $gfix | grep -E -q &quot;OEM|USB|VMX|unknown&quot;;then
 				echo &quot;label=\&quot;$gfix\&quot;&quot;
-			elif [ -z &quot;$kiwi_iname&quot; ];then
+			elif [ -z &quot;$kiwi_oemtitle&quot; ];then
 				echo &quot;label=\&quot;$kname [ $gfix ]\&quot;&quot;
 			else
-				echo &quot;label=\&quot;$kiwi_iname-$kname [ $gfix ]\&quot;&quot;
+				if [ &quot;$count&quot; = &quot;1&quot; ];then
+					echo &quot;label=\&quot;$kiwi_oemtitle [ $gfix ]\&quot;&quot;
+				else
+					echo &quot;label=\&quot;$kiwi_oemtitle-$kname [ $gfix ]\&quot;&quot;
+				fi
 			fi
 			echo &quot;    initrd=/boot/$initrd&quot;
 			echo &quot;    append=\&quot;quiet sysrq=1 panic=9 $KIWI_INITRD_PARAMS\&quot;&quot;
@@ -1077,8 +1278,6 @@
 	local sdev=$2
 	local diskByID=`getDiskID $sdev`
 	local nfstab=$prefix/etc/fstab
-
-
 	if [ ! -z &quot;$FSTYPE&quot; ];then
 		FSTYPE_SAVE=$FSTYPE
 	fi
@@ -1095,6 +1294,20 @@
 	fi
 }
 #======================================
+# updateSyslinuxBootDeviceFstab
+#--------------------------------------
+function updateSyslinuxBootDeviceFstab {
+	# /.../
+	# add one line to the fstab file for the /syslboot
+	# device partition
+	# ----
+	local prefix=$1
+	local sdev=$2
+	local diskByID=`getDiskID $sdev`
+	local nfstab=$prefix/etc/fstab
+	echo &quot;$diskByID /syslboot vfat defaults 0 0&quot; &gt;&gt; $nfstab
+}
+#======================================
 # updateOtherDeviceFstab
 #--------------------------------------
 function updateOtherDeviceFstab {
@@ -1133,10 +1346,14 @@
 	# kernel modules to become integrated into the initrd
 	# if created by the distro mkinitrd tool
 	# ----
-	local prefix=$1
-	local ktempl=/mnt/var/adm/fillup-templates/sysconfig.kernel
-	local syskernel=$prefix/etc/sysconfig/kernel
-	mkdir -p $prefix/etc/sysconfig
+	local destprefix=$1
+	local srcprefix=$2
+	if [ -z &quot;$srcprefix&quot; ];then
+		srcprefix=/mnt
+	fi
+	local ktempl=$srcprefix/var/adm/fillup-templates/sysconfig.kernel
+	local syskernel=$destprefix/etc/sysconfig/kernel
+	mkdir -p $destprefix/etc/sysconfig
 	if [ ! -f $ktempl ];then
 		systemException \
 			&quot;Can't find kernel sysconfig template in system image !&quot; \

Modified: kiwi-head/modules/KIWIXML.pm
===================================================================
--- kiwi-head/modules/KIWIXML.pm	2009-02-26 18:04:23 UTC (rev 1931)
+++ kiwi-head/modules/KIWIXML.pm	2009-02-27 15:41:22 UTC (rev 1932)
@@ -1176,7 +1176,10 @@
 	my $node = $this -&gt; getPreferencesNodeByTagName (&quot;oem-boot-title&quot;);
 	my $title= $node -&gt; getElementsByTagName (&quot;oem-boot-title&quot;);
 	if ((! defined $title) || (&quot;$title&quot; eq &quot;&quot;)) {
-		return undef;
+		$title = $this -&gt; getImageDisplayName();
+		if ((! defined $title) || (&quot;$title&quot; eq &quot;&quot;)) {
+			return undef;
+		}
 	}
 	return $title;
 }

Modified: kiwi-head/rpm/kiwi.changes
===================================================================
--- kiwi-head/rpm/kiwi.changes	2009-02-26 18:04:23 UTC (rev 1931)
+++ kiwi-head/rpm/kiwi.changes	2009-02-27 15:41:22 UTC (rev 1932)
@@ -1,4 +1,12 @@
 -------------------------------------------------------------------
+Fri Feb 27 13:38:54 CET 2009 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
+
+- v3.23
+- fixed syslinux setup for vmx image types
+- add system exception for syslinux on oem image types.
+  This is because we don't support OEMs with syslinux
+
+-------------------------------------------------------------------
 Wed Feb 25 14:08:16 CET 2009 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
 
 - v3.22

Modified: kiwi-head/rpm/kiwi.spec
===================================================================
--- kiwi-head/rpm/kiwi.spec	2009-02-26 18:04:23 UTC (rev 1931)
+++ kiwi-head/rpm/kiwi.spec	2009-02-27 15:41:22 UTC (rev 1932)
@@ -1,5 +1,5 @@
 #
-# spec file for package kiwi (Version 3.22
+# spec file for package kiwi (Version 3.23
 #
 # Copyright (c) 2008 SUSE LINUX Products GmbH, Nuernberg, Germany.
 # This file and all modifications and additions to the pristine
@@ -43,7 +43,7 @@
 Summary:        OpenSuSE - KIWI Image System
 Provides:       kiwi2 &lt;= 2.14
 Obsoletes:      kiwi2 &lt;= 2.14
-Version:        3.22
+Version:        3.23
 Release:        80
 Group:          System/Management
 License:        GPL v2 or later

Modified: kiwi-head/system/boot/ix86/oemboot/suse-linuxrc
===================================================================
--- kiwi-head/system/boot/ix86/oemboot/suse-linuxrc	2009-02-26 18:04:23 UTC (rev 1931)
+++ kiwi-head/system/boot/ix86/oemboot/suse-linuxrc	2009-02-27 15:41:22 UTC (rev 1932)
@@ -86,7 +86,11 @@
 	# ----
 	export LOCAL_BOOT=&quot;yes&quot;
 fi
-
+if [ &quot;$loader&quot; = &quot;syslinux&quot; ];then
+	systemException \
+		&quot;syslinux boot not supported for OEM systems... abort&quot; \
+	&quot;reboot&quot;
+fi
 #======================================
 # 5) start boot shell
 #--------------------------------------

Modified: kiwi-head/system/boot/ix86/vmxboot/suse-linuxrc
===================================================================
--- kiwi-head/system/boot/ix86/vmxboot/suse-linuxrc	2009-02-26 18:04:23 UTC (rev 1931)
+++ kiwi-head/system/boot/ix86/vmxboot/suse-linuxrc	2009-02-27 15:41:22 UTC (rev 1932)
@@ -171,16 +171,42 @@
 fi
 
 #======================================
-# 12) setup /lvmboot
+# 12) setup /lvmboot or /syslboot
 #--------------------------------------
-if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
-	mkdir /mnt/lvmboot
-	mount $imageBootDevice /mnt/lvmboot
-	if [ -z $UNIONFS_CONFIG ];then
-		cp -a /mnt/boot/* /mnt/lvmboot/boot
+if [ $LOCAL_BOOT = &quot;no&quot; ];then
+	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
+		#======================================
+		# LVM use first partition as boot
+		#--------------------------------------
+		mkdir /mnt/lvmboot
+		mount $imageBootDevice /mnt/lvmboot
+		if [ -z $UNIONFS_CONFIG ];then
+			cp -a /mnt/boot/* /mnt/lvmboot/boot
+		fi
+		rm -rf /mnt/boot
+		( cd /mnt &amp;&amp; ln -s lvmboot/boot boot )
+	elif [ &quot;$loader&quot; = &quot;syslinux&quot; ];then
+		#======================================
+		# Syslinux search FAT and use as boot
+		#--------------------------------------
+		for i in 1 2 3;do
+			pType=`partitionID $imageDiskDevice $i`
+			if [ &quot;$pType&quot; = &quot;6&quot; ];then
+				imageFatDevice=$imageDiskDevice$i
+				break
+			fi 
+		done
+		if [ -z &quot;$imageFatDevice&quot; ];then
+			systemException &quot;Can't find FAT partition&quot; &quot;reboot&quot;
+		fi
+		mkdir /mnt/syslboot
+		mount $imageFatDevice /mnt/syslboot
+		if [ -z $UNIONFS_CONFIG ];then
+			cp -a /mnt/boot/* /mnt/syslboot/boot
+		fi
+		rm -rf /mnt/boot
+		( cd /mnt &amp;&amp; ln -s syslboot/boot boot )
 	fi
-	rm -rf /mnt/boot
-	( cd /mnt &amp;&amp; ln -s lvmboot/boot boot )
 fi
 
 #======================================
@@ -223,6 +249,8 @@
 	updateRootDeviceFstab /config $imageRootDevice
 	if [ &quot;$haveLVM&quot; = &quot;yes&quot; ];then
 		updateLVMBootDeviceFstab /config $imageBootDevice
+	elif [ &quot;$loader&quot; = &quot;syslinux&quot; ];then
+		updateSyslinuxBootDeviceFstab /config $imageFatDevice
 	fi
 	if [ ! -z &quot;$UNIONFS_CONFIG&quot; ]; then
 		export KIWI_INITRD_PARAMS=&quot;UNIONFS_CONFIG=yes&quot;

Modified: kiwi-head/system/boot/ix86/vmxboot/suse-preinit
===================================================================
--- kiwi-head/system/boot/ix86/vmxboot/suse-preinit	2009-02-26 18:04:23 UTC (rev 1931)
+++ kiwi-head/system/boot/ix86/vmxboot/suse-preinit	2009-02-27 15:41:22 UTC (rev 1932)
@@ -57,26 +57,36 @@
 fi
 
 #======================================
-# 7) check for union filesystem
+# 8) create initrd on diskful
 #--------------------------------------
-if [ ! -z &quot;$UNIONFS_CONFIG&quot; ]; then
-	exit 0
+if [ -z &quot;$UNIONFS_CONFIG&quot; ]; then
+	setupSUSEInitrd
 fi
 
 #======================================
-# 8) create initrd on diskful
+# 7) Check FAT requires on syslinux
 #--------------------------------------
-setupSUSEInitrd
-
-#======================================
-# 9) Install boot loader on diskful
-#--------------------------------------
-if [ $bootLoaderOK = 1 ];then
-	installBootLoader
+if [ -z &quot;$UNIONFS_CONFIG&quot; ] &amp;&amp; [ &quot;$loader&quot; = &quot;syslinux&quot; ];then
+	# /.../
+	# if syslinux is used we need to make sure that the
+	# filename on the boot partition is correct 8+3
+	# ----
+	count=1
+	IFS=&quot;,&quot; ; for i in $KERNEL_LIST;do
+		if test -z &quot;$i&quot;;then
+			continue
+		fi
+		kernel=`echo $i | cut -f1 -d:`
+		initrd=`echo $i | cut -f2 -d:`
+		mv /boot/$kernel /boot/linux.$count
+		mv /boot/$initrd /boot/initrd.$count
+		count=`expr $count + 1`
+	done
+	IFS=$IFS_ORIG
 fi
 
 #======================================
-# 10) kill udev
+# 9) kill udev
 #--------------------------------------
 udevKill
 umountSystemFilesystems


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001053.html">[Kiwi-devel] r1931 - in kiwi-head: doc/examples/suse-10.3/suse-live-stick doc/examples/suse-10.3/suse-live-stick/root/etc doc/examples/suse-10.3/suse-oem-preload doc/examples/suse-10.3/suse-oem-preload/root/etc doc/examples/suse-10.3/suse-pxe-client doc/examples/suse-10.3/suse-pxe-client/root/etc doc/examples/suse-10.3/suse-vm-guest doc/examples/suse-10.3/suse-vm-guest/root/etc doc/examples/suse-10.3/suse-xen-guest doc/examples/suse-10.3/suse-xen-guest/root/etc doc/examples/suse-11.0/suse-ec2-guest doc/examples/suse-11.0/suse-ec2-guest/root/etc doc/examples/suse-11.0/suse-live-iso doc/examples/suse-11.0/suse-live-iso/root/etc doc/examples/suse-11.0/suse-live-stick doc/examples/suse-11.0/suse-live-stick/root/etc doc/examples/suse-11.0/suse-oem-preload doc/examples/suse-11.0/suse-oem-preload/root/etc doc/examples/suse-11.0/suse-pxe-client doc/examples/suse-11.0/suse-pxe-client/root/etc doc/examples/suse-11.0/suse-vm-guest doc/examples/suse-11.0/suse-vm-guest/root/etc doc/examples/! suse-11.0/suse-xen-guest doc/examples/suse-11.0/suse-xen-guest/root/etc doc/examples/suse-11.1/suse-ec2-guest doc/examples/suse-11.1/suse-ec2-guest/root/etc doc/examples/suse-11.1/suse-live-iso doc/examples/suse-11.1/suse-live-iso/root/etc doc/examples/suse-11.1/suse-live-stick/root/etc doc/examples/suse-11.1/suse-oem-preload doc/examples/suse-11.1/suse-oem-preload/root/etc doc/examples/suse-11.1/suse-pxe-client doc/examples/suse-11.1/suse-pxe-client/root/etc doc/examples/suse-11.1/suse-vm-guest doc/examples/suse-11.1/suse-vm-guest/root/etc doc/examples/suse-11.1/suse-xen-guest doc/examples/suse-11.1/suse-xen-guest/root/etc doc/examples/suse-11.2/suse-ec2-guest doc/examples/suse-11.2/suse-ec2-guest/root/etc doc/examples/suse-11.2/suse-live-iso doc/examples/suse-11.2/suse-live-iso/root/etc doc/examples/suse-11.2/suse-live-stick/root/etc doc/examples/suse-11.2/suse-oem-preload doc/examples/suse-11.2/suse-oem-preload/root/etc doc/examples/suse-11.2/suse-pxe-client doc/examples! /suse-11.2/suse-pxe-client/root/etc doc/examples/suse-11.2/sus! e-vm-gue
</A></li>
	<LI>Next message: <A HREF="001055.html">[Kiwi-devel] r1933 - in kiwi-head: doc doc/LaTex modules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1054">[ date ]</a>
              <a href="thread.html#1054">[ thread ]</a>
              <a href="subject.html#1054">[ subject ]</a>
              <a href="author.html#1054">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
