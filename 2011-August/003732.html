<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-485-SuSE-11-1-SLE-SP-Devel,	updated. d7261e43ed1405714ef9947b5efecd0093f6ebf3
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2011-August/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%0A%09KIWI-485-SuSE-11-1-SLE-SP-Devel%2C%0A%09updated.%20d7261e43ed1405714ef9947b5efecd0093f6ebf3&In-Reply-To=%3C20110824145604.0F1BE481462%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003734.html">
   <LINK REL="Next"  HREF="003735.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-485-SuSE-11-1-SLE-SP-Devel,	updated. d7261e43ed1405714ef9947b5efecd0093f6ebf3</H1>
    <B>marcus_schaefer at BerliOS</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%0A%09KIWI-485-SuSE-11-1-SLE-SP-Devel%2C%0A%09updated.%20d7261e43ed1405714ef9947b5efecd0093f6ebf3&In-Reply-To=%3C20110824145604.0F1BE481462%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-485-SuSE-11-1-SLE-SP-Devel,	updated. d7261e43ed1405714ef9947b5efecd0093f6ebf3">marcus_schaefer at mail.berlios.de
       </A><BR>
    <I>Wed Aug 24 16:56:03 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="003734.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 418c6df5c22b455b7ee17ac53d0ff867ec0506c0
</A></li>
        <LI>Next message: <A HREF="003735.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 6ac77e30cd2c9da6a959cb47c3cb0b21b1176a9d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3732">[ date ]</a>
              <a href="thread.html#3732">[ thread ]</a>
              <a href="subject.html#3732">[ subject ]</a>
              <a href="author.html#3732">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Project kiwi at BerliOS&quot;.

The branch, KIWI-485-SuSE-11-1-SLE-SP-Devel has been updated
       via  d7261e43ed1405714ef9947b5efecd0093f6ebf3 (commit)
       via  86ad2f5a7710d122c2663fda5b815c460980cad9 (commit)
       via  d287c0643eaeed38a14fba78f7ba7433c01a0c22 (commit)
       via  566960650cf26f594901940e31e942d77a5d6c24 (commit)
       via  bbc012930fc2f0e1d5b45e02a10ed6c41e8127bb (commit)
      from  a3dd455d8eef06807aa2b6a1d6f6d25baf7c5b0e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit d7261e43ed1405714ef9947b5efecd0093f6ebf3
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Wed Aug 24 16:55:42 2011 +0200

    - added changelog entry for last four commits

commit 86ad2f5a7710d122c2663fda5b815c460980cad9
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Wed Aug 24 16:24:30 2011 +0200

    - don't remove data from initial boot partition

commit d287c0643eaeed38a14fba78f7ba7433c01a0c22
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Wed Aug 24 15:20:40 2011 +0200

    - call setupBootPartition() only if systemIntegrity is != fine
    - clean up setupBootPartition, create mount points inside the initrd
    - clean up netboot code, setup bootid before mountSystem and let
      setupBootPartition do the setup of the boot contents

commit 566960650cf26f594901940e31e942d77a5d6c24
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Wed Aug 24 16:52:48 2011 +0200

    - added support for pxe luks encrypted images

commit bbc012930fc2f0e1d5b45e02a10ed6c41e8127bb
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Wed Aug 24 12:20:03 2011 +0200

    - break up long code line into two

-----------------------------------------------------------------------

Summary of changes:
diff --git a/modules/KIWILinuxRC.sh b/modules/KIWILinuxRC.sh
index 7936051..b88bcdb 100644
--- a/modules/KIWILinuxRC.sh
+++ b/modules/KIWILinuxRC.sh
@@ -4567,7 +4567,12 @@ function mountSystem {
 	# setup boot partition
 	#--------------------------------------
 	if [ ! &quot;$arch&quot; = &quot;ppc64&quot; ];then
-		if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ] &amp;&amp; [ $retval = 0 ] &amp;&amp; [ -z &quot;$RESTORE&quot; ];then
+		if \
+			[ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ]          &amp;&amp; \
+			[ ! &quot;$systemIntegrity&quot; = &quot;fine&quot; ] &amp;&amp; \
+			[ $retval = 0 ]                   &amp;&amp; \
+			[ -z &quot;$RESTORE&quot; ]
+		then
 			setupBootPartition
 		fi
 	fi
@@ -5010,7 +5015,8 @@ function fetchFile {
 						--option \&quot;blksize $imageBlkSize\&quot; \
 						-g -r $path -l $dest $host 2&gt;&amp;1 | \
 						atftpProgress \
-							$needMByte \&quot;$TEXT_LOAD\&quot; $TRANSFER_ERRORS_FILE $imageBlkSize \
+							$needMByte \&quot;$TEXT_LOAD\&quot; \
+							$TRANSFER_ERRORS_FILE $imageBlkSize \
 						&gt; /progress&quot;
 				else
 					call=&quot;atftp \
@@ -7102,21 +7108,30 @@ function setupBootPartition {
 		# no such boot device like for live ISO hybrid disk
 		return
 	fi
-	mkdir -p /mnt/$mpoint
-	mount $imageBootDevice /mnt/$mpoint
-	if \
-		[ -z &quot;$UNIONFS_CONFIG&quot; ] &amp;&amp;
-		[ -z &quot;$COMBINED_IMAGE&quot; ] &amp;&amp;
-		[ &quot;$bootid&quot; = &quot;1&quot; ]
-	then
-		rm -fr /mnt/$mpoint/*
-	fi
-	cp -a /mnt/boot /mnt/$mpoint
+	#======================================
+	# copy boot data from image to bootpart
+	#--------------------------------------
+	mkdir -p /$mpoint
+	mount $imageBootDevice /$mpoint
+	cp -a /mnt/boot /$mpoint
 	if [ -e /boot.tgz ];then
-		tar -xf /boot.tgz -C /mnt/$mpoint
+		tar -xf /boot.tgz -C /$mpoint
+	fi
+	umount /$mpoint
+	rmdir  /$mpoint
+	#======================================
+	# bind mount boot partition
+	#--------------------------------------
+	# the resetBootBind() function will resolve this to a
+	# standard /boot mount when the bootloader will be
+	# installed in preinit.
+	# ---
+	if ! isFSTypeReadOnly;then
+		rm -rf /mnt/boot
+		mkdir  /mnt/boot
 	fi
-	rm -rf /mnt/boot
-	mkdir  /mnt/boot
+	mkdir /mnt/$mpoint
+	mount $imageBootDevice /mnt/$mpoint
 	mount --bind \
 		/mnt/$mpoint/boot /mnt/boot
 }
diff --git a/rpm/kiwi.changes b/rpm/kiwi.changes
index c23dcb6..09366df 100644
--- a/rpm/kiwi.changes
+++ b/rpm/kiwi.changes
@@ -1,4 +1,14 @@
 -------------------------------------------------------------------
+Wed Aug 24 16:54:38 CEST 2011 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
+
+- don't remove data from initial boot partition
+- call setupBootPartition() only if systemIntegrity is != fine
+- clean up setupBootPartition, create mount points inside the initrd
+- clean up netboot code, setup bootid before mountSystem and let
+  setupBootPartition do the setup of the boot contents
+- added support for pxe luks encrypted images
+
+-------------------------------------------------------------------
 Tue Aug 23 18:58:57 CEST 2011 - <A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at suse.de</A>
 
 - fixed boot code: explicitly wait until the background
diff --git a/system/boot/ix86/netboot/suse-11.3/config.xml b/system/boot/ix86/netboot/suse-11.3/config.xml
index 57e89b2..821c819 100644
--- a/system/boot/ix86/netboot/suse-11.3/config.xml
+++ b/system/boot/ix86/netboot/suse-11.3/config.xml
@@ -26,6 +26,7 @@
 		&lt;file name=&quot;drivers/xen/*&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot; profiles=&quot;default,xen&quot;&gt;
+		&lt;file name=&quot;crypto/*&quot;/&gt;
 		&lt;file name=&quot;drivers/md/*&quot;/&gt;
 		&lt;file name=&quot;drivers/hid/*&quot;/&gt;
 		&lt;file name=&quot;drivers/input/keyboard/*&quot;/&gt;
@@ -159,6 +160,7 @@
 		&lt;package name=&quot;xen&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;image&quot; profiles=&quot;default,xen&quot;&gt;
+		&lt;package name=&quot;cryptsetup&quot;/&gt;
 		&lt;package name=&quot;bc&quot;/&gt;
 		&lt;package name=&quot;adaptec-firmware&quot;/&gt;
 		&lt;package name=&quot;clicfs&quot;/&gt;
diff --git a/system/boot/ix86/netboot/suse-11.4/config.xml b/system/boot/ix86/netboot/suse-11.4/config.xml
index 0ee54d1..b026ff4 100644
--- a/system/boot/ix86/netboot/suse-11.4/config.xml
+++ b/system/boot/ix86/netboot/suse-11.4/config.xml
@@ -26,6 +26,7 @@
 		&lt;file name=&quot;drivers/xen/*&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot; profiles=&quot;default,xen&quot;&gt;
+		&lt;file name=&quot;crypto/*&quot;/&gt;
 		&lt;file name=&quot;drivers/md/*&quot;/&gt;
 		&lt;file name=&quot;drivers/hid/*&quot;/&gt;
 		&lt;file name=&quot;drivers/input/keyboard/*&quot;/&gt;
@@ -162,6 +163,7 @@
 		&lt;package name=&quot;xen&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;image&quot; profiles=&quot;default,xen&quot;&gt;
+		&lt;package name=&quot;cryptsetup&quot;/&gt;
 		&lt;package name=&quot;bc&quot;/&gt;
 		&lt;package name=&quot;adaptec-firmware&quot;/&gt;
 		&lt;package name=&quot;clicfs&quot;/&gt;
diff --git a/system/boot/ix86/netboot/suse-SLED11/config.xml b/system/boot/ix86/netboot/suse-SLED11/config.xml
index 3a1bb00..1f23b3b 100644
--- a/system/boot/ix86/netboot/suse-SLED11/config.xml
+++ b/system/boot/ix86/netboot/suse-SLED11/config.xml
@@ -30,6 +30,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot; profiles=&quot;default,xen&quot;&gt;
+		&lt;file name=&quot;crypto/*&quot;/&gt;
 		&lt;file name=&quot;drivers/gpu/drm/i915/i915.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/char/agp/intel-agp.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/md/*&quot;/&gt;
@@ -154,6 +155,7 @@
 		&lt;package name=&quot;xen&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;image&quot; profiles=&quot;default,xen&quot;&gt;
+		&lt;package name=&quot;cryptsetup&quot;/&gt;
 		&lt;package name=&quot;bc&quot;/&gt;
 		&lt;package name=&quot;curl&quot;/&gt;
 		&lt;package name=&quot;psmisc&quot;/&gt;
diff --git a/system/boot/ix86/netboot/suse-SLES11/config.xml b/system/boot/ix86/netboot/suse-SLES11/config.xml
index ee34b07..9e54b17 100644
--- a/system/boot/ix86/netboot/suse-SLES11/config.xml
+++ b/system/boot/ix86/netboot/suse-SLES11/config.xml
@@ -30,6 +30,7 @@
 		&lt;file name=&quot;usb/storage/usb-storage.ko&quot;/&gt;
 	&lt;/drivers&gt;
 	&lt;drivers type=&quot;drivers&quot; profiles=&quot;default,xen&quot;&gt;
+		&lt;file name=&quot;crypto/*&quot;/&gt;
 		&lt;file name=&quot;drivers/gpu/drm/i915/i915.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/char/agp/intel-agp.ko&quot;/&gt;
 		&lt;file name=&quot;drivers/md/*&quot;/&gt;
@@ -154,6 +155,7 @@
 		&lt;package name=&quot;xen&quot;/&gt;
 	&lt;/packages&gt;
 	&lt;packages type=&quot;image&quot; profiles=&quot;default,xen&quot;&gt;
+		&lt;package name=&quot;cryptsetup&quot;/&gt;
 		&lt;package name=&quot;bc&quot;/&gt;
 		&lt;package name=&quot;adaptec-firmware&quot;/&gt;
 		&lt;package name=&quot;curl&quot;/&gt;
diff --git a/system/boot/ix86/netboot/suse-linuxrc b/system/boot/ix86/netboot/suse-linuxrc
index 6039d6f..cf38565 100755
--- a/system/boot/ix86/netboot/suse-linuxrc
+++ b/system/boot/ix86/netboot/suse-linuxrc
@@ -259,7 +259,12 @@ probeDevices &quot;skipUSB&quot;
 runHook postprobe
 
 #======================================
-# 11) Check for diskful station
+# 11) Select language if not in cmdline
+#--------------------------------------
+selectLanguage
+
+#======================================
+# 12) Check for diskful station
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
 	checkDevice=$DISK
@@ -282,7 +287,7 @@ if [ $LOCAL_BOOT = &quot;no&quot; ];then
 fi
 
 #======================================
-# 12) Check for installed system
+# 13) Check for installed system
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $haveDisk = &quot;1&quot; ];then
 	if [ ! -z &quot;$RAID&quot; ];then
@@ -302,6 +307,13 @@ if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $haveDisk = &quot;1&quot; ];then
 		done
 		updateNeeded initialize
 		if linuxPartition $imageDiskDevice;then
+			probeFileSystem $imageDevice
+			if [ &quot;$FSTYPE&quot; = &quot;luks&quot; ];then
+				imageDevice=$(luksOpen $imageDevice)
+				imageRODevice=$imageDevice
+				probeFileSystem $imageRootDevice
+				export haveLuks=yes
+			fi
 			if mountSystem $imageDevice;then
 				updateNeeded
 				umountSystem
@@ -323,7 +335,7 @@ if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $haveDisk = &quot;1&quot; ];then
 fi
 
 #======================================
-# 13) Create ptable on diskful system
+# 14) Create ptable on diskful system
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $systemIntegrity = &quot;clean&quot; ];then
 	runHook prepartition
@@ -410,7 +422,7 @@ if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $systemIntegrity = &quot;clean&quot; ];then
 fi
 
 #======================================
-# 14) Setup root device environment
+# 15) Setup root device environment
 #--------------------------------------
 runHook predownload
 if \
@@ -418,7 +430,7 @@ if \
 	([ $haveDisk = &quot;1&quot; ] || [ $haveRamDisk = &quot;1&quot; ])
 then
 	#======================================
-	# 14.1) Download network client image
+	# 15.1) Download network client image
 	#--------------------------------------
 	count=0
 	IFS=&quot;,&quot; ; for i in $IMAGE;do
@@ -439,9 +451,6 @@ then
 			imageRootDevice=$imageDevice
 			imageRootName=$imageName
 		fi
-		if [ $count = 2 ];then
-			imageNextRootDevice=$imageDevice
-		fi
 		# /.../
 		# start download only if installed system is different
 		# from the image on the pxe boot server
@@ -544,28 +553,29 @@ then
 			Echo -b &quot;   within the appropriate .md5 file for this image&quot;
 			echo
 			if [ -z &quot;$DISK&quot; ];then
-			Echo -b &quot;4) ramdisk size is too small for the image:&quot;
-			Echo -b &quot;   check the ramdisk_size parameter of the PXE&quot;
-			Echo -b &quot;   configuration file on the TFTP server&quot;
+				Echo -b &quot;4) ramdisk size is too small for the image:&quot;
+				Echo -b &quot;   check the ramdisk_size parameter of the PXE&quot;
+				Echo -b &quot;   configuration file on the TFTP server&quot;
 			else
-			Echo -b &quot;4) partition size is too small for the image:&quot;
-			Echo -b &quot;   check the PART line in the image config file on the&quot;
-			Echo -b &quot;   TFTP server&quot;
+				Echo -b &quot;4) partition size is too small for the image:&quot;
+				Echo -b &quot;   check the PART line in the image config file on the&quot;
+				Echo -b &quot;   TFTP server&quot;
 			fi
 			echo
 			Echo &quot;Retry to load image...&quot;
 			sleep 15
 		done
-		if [ ! -z &quot;$DISK&quot; ];then
-			probeFileSystem $imageDevice
-			resizeFilesystem $imageDevice
+		imageRootDevice=$imageDevice
+		if [ ! -z &quot;$UNIONFS_CONFIG&quot; ];then
+			imageRWDevice=`echo $UNIONFS_CONFIG | cut -d , -f 1`
+			imageRODevice=`echo $UNIONFS_CONFIG | cut -d , -f 2`
 		fi
 		rm -f /etc/ireal.md5
 		rm -f /etc/image.md5
 	done
 else
 	#======================================
-	# 14.2) Check for local boot
+	# 15.2) Check for local boot
 	#--------------------------------------
 	if [ $LOCAL_BOOT = &quot;yes&quot; ];then
 		imageDisk=$(dn $root)
@@ -574,14 +584,12 @@ else
 		imageRootName=&quot;Local-System&quot;
 		if [ ! -z &quot;$UNIONFS_CONFIG&quot; ];then
 			unionFST=$UNIONFS_CONFIG
-			setupUnionFS $(ddn $imageDisk 3) $(ddn $imageDisk 2) $unionFST
-		fi
-		if [ ! -z &quot;$COMBINED_IMAGE&quot; ];then
-			imageNextRootDevice=$(ddn $imageDisk 3)
+			imageRWDevice=$(ddn $imageDisk 3)
+			imageRODevice=$(ddn $imageDisk 2)
 		fi
 	fi
 	#======================================
-	# 14.3) Check for NFS root
+	# 15.3) Check for NFS root
 	#--------------------------------------
 	if [ ! -z &quot;$NFSROOT&quot; ];then
 		IFS=&quot;,&quot; ; for i in $NFSROOT;do
@@ -604,18 +612,20 @@ else
 		if [ ! -z &quot;$COMBINED_IMAGE&quot; ] || [ ! -z &quot;$UNIONFS_CONFIG&quot; ];then
 			imageRootDevice=&quot;-o nolock,ro $nfsRootServer:$nfsRootDevice&quot;
 		fi
+		imageRootName=&quot;NFSRoot-System&quot;
+		systemIntegrity=&quot;clean&quot;
+		export FSTYPE=nfs
 		if [ ! -z &quot;$UNIONFS_CONFIG&quot; ];then
+			imageRWDevice=`echo $UNIONFS_CONFIG | cut -d , -f 1`
+			imageRODevice=`echo $UNIONFS_CONFIG | cut -d , -f 2`
 			unionFST=`echo $UNIONFS_CONFIG | cut -d , -f 3`
 			if [ &quot;$unionFST&quot; = &quot;clicfs&quot; ];then
 				systemException &quot;clicfs over NFSROOT is not supported&quot; &quot;reboot&quot;
 			fi
 		fi
-		imageRootName=&quot;NFSRoot-System&quot;
-		systemIntegrity=&quot;clean&quot;
-		export FSTYPE=nfs
 	fi
 	#======================================
-	# 14.4) Check for NBD root
+	# 15.4) Check for NBD root
 	#--------------------------------------
 	if [ ! -z &quot;$NBDROOT&quot; ];then
 		if ! modprobe nbd;then
@@ -710,18 +720,15 @@ else
 		# setup union if basic root filesystem is read-only
 		# ----
 		imageRootDevice=$nbdDevice
-		probeFileSystem $imageRootDevice
-		Echo &quot;Filesystem of remote root system is: $FSTYPE&quot;
-		if [ -z &quot;$COMBINED_IMAGE&quot; ];then
-			if isFSTypeReadOnly;then
-				setupUnionFS &quot;$nbdwriteDevice&quot; &quot;$imageRootDevice&quot; $unionFST
-			fi
-		fi
 		imageRootName=&quot;NBDRoot-System&quot;
 		systemIntegrity=&quot;clean&quot;
+		if [ -z &quot;$COMBINED_IMAGE&quot; ];then
+			imageRWDevice=$nbdwriteDevice
+			imageRODevice=$imageRootDevice
+		fi
 	fi
 	#======================================
-	# 14.5) Check for AOE root
+	# 15.5) Check for AOE root
 	#--------------------------------------
 	if [ ! -z &quot;$AOEROOT&quot; ];then
 		aoeRODevice=`echo $AOEROOT | cut -d , -f 1`
@@ -748,50 +755,80 @@ else
 		fi
 		Echo &quot;Mounting AoE root system: $aoeRODevice...&quot;
 		imageRootDevice=$aoeRODevice
-		probeFileSystem $imageRootDevice
-		Echo &quot;Filesystem of remote root system is: $FSTYPE&quot;
-		if [ -z &quot;$COMBINED_IMAGE&quot; ];then
-			if isFSTypeReadOnly;then
-				setupUnionFS &quot;$aoeRWDevice&quot; &quot;$imageRootDevice&quot; $unionFST
-			fi
-		fi
 		imageRootName=&quot;AOERoot-System&quot;
 		systemIntegrity=&quot;clean&quot;
+		if [ -z &quot;$COMBINED_IMAGE&quot; ];then
+			imageRWDevice=$aoeRWDevice
+			imageRODevice=$imageRootDevice
+		fi
 	fi
 fi
 runHook postdownload
 
 #======================================
-# 15) Mount OS image to /mnt
+# 16) Get filesystem type
 #--------------------------------------
-runHook premount
-if ! mountSystem;then
-	systemException &quot;Failed to mount root filesystem&quot; &quot;reboot&quot;
+if [ -b $imageRootDevice ];then
+	probeFileSystem $imageRootDevice
+	if [ &quot;$FSTYPE&quot; = &quot;luks&quot; ];then
+		imageRootDevice=$(luksOpen $imageRootDevice)
+		imageRODevice=$imageRootDevice
+		probeFileSystem $imageRootDevice
+		export haveLuks=yes
+	fi
+	if [ &quot;$FSTYPE&quot; = &quot;unknown&quot; ];then
+		systemException \
+			&quot;Couldn't determine filesystem type... abort&quot; \
+		&quot;reboot&quot;
+	fi
+fi
+
+#======================================
+# 17) resize fs on diskful client
+#--------------------------------------
+if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $systemIntegrity = &quot;clean&quot; ];then
+	if [ $haveDisk = &quot;1&quot; ] || [ $haveRamDisk = &quot;1&quot; ];then
+		resizeFilesystem $imageRootDevice
+	fi
+fi
+
+#======================================
+# 18) Check filesystem
+#--------------------------------------
+Echo &quot;Filesystem of PXE system is: $FSTYPE -&gt; $imageRootDevice&quot;
+if isFSTypeReadOnly;then
+	if [ ! -z &quot;$imageRWDevice&quot; ] &amp;&amp; [ ! -z &quot;$imageRODevice&quot; ];then
+		setupUnionFS $imageRWDevice $imageRODevice $unionFST
+	fi
 fi
-validateRootTree
-runHook postmount
 
 #======================================
-# 16) Setup boot device contents
+# 19) Setup bootid for this table
 #--------------------------------------
 if [ ! -z &quot;$imageBootDevice&quot; ];then
+	# bootid is boot partition
 	export bootid=$(nd $imageBootDevice)
-	cd /mnt/boot &amp;&amp; tar -czf /tmp/boot.tgz .
-	rm -rf /mnt/boot/* &amp;&amp; mount $imageBootDevice /mnt/boot
-	cd /mnt/boot &amp;&amp; tar -xf /tmp/boot.tgz
-	rm -f /tmp/boot.tgz
 else
+	# bootid is root partition
 	export bootid=$(nd $imageRootDevice)
 fi
 if [ ! -z &quot;$RAID&quot; ];then
 	# raid md devices start with 0 but partition id's start with 1
 	bootid=$((bootid + 1))
-	# make mdadm.conf available in system image
-	cp /mdadm.conf /mnt/etc
 fi
 
 #======================================
-# 17) Import fixed configuration files
+# 20) Mount OS image to /mnt
+#--------------------------------------
+runHook premount
+if ! mountSystem;then
+	systemException &quot;Failed to mount root filesystem&quot; &quot;reboot&quot;
+fi
+validateRootTree
+runHook postmount
+
+#======================================
+# 21) Import fixed configuration files
 #--------------------------------------
 runHook preconfig
 if [ $LOCAL_BOOT = &quot;no&quot; ] || [ ! -z &quot;$RELOAD_CONFIG&quot; ];then
@@ -799,7 +836,19 @@ if [ $LOCAL_BOOT = &quot;no&quot; ] || [ ! -z &quot;$RELOAD_CONFIG&quot; ];then
 		Echo &quot;Configuration files reload forced via RELOAD_CONFIG...&quot;
 	fi
 	#=======================================
-	# 17.1) Import files from backup
+	# 21.0) Import NFS root files
+	#---------------------------------------
+	if [ ! -z &quot;$NFSROOT&quot; ];then
+		test -f /etc/resolv.conf &amp;&amp; cp /etc/resolv.conf /mnt/etc
+	fi
+	#=======================================
+	# 21.1) Import RAID config file
+	#---------------------------------------
+	if [ ! -z &quot;$RAID&quot; ];then
+		cp /mdadm.conf /mnt/etc
+	fi
+	#=======================================
+	# 21.2) Import files from backup
 	#---------------------------------------
 	BCFG_BASE='etc/KIWI'
 	BCFG_NAME='InstalledConfigFiles'
@@ -809,7 +858,7 @@ if [ $LOCAL_BOOT = &quot;no&quot; ] || [ ! -z &quot;$RELOAD_CONFIG&quot; ];then
 	ALL_CCONF=`condenseConfigData &quot;$CONF,$VENDOR_CONF&quot;`
 	ALL_CBK_CONF=`condenseConfigData &quot;$BK_CONF,$BK_VENDOR_CONF&quot;`
 	#=======================================
-	# 17.2) Store new configuration
+	# 21.3) Store new configuration
 	#---------------------------------------
 	mkdir  /config
 	mkdir -p  /config/$BCFG_BASE
@@ -817,7 +866,7 @@ if [ $LOCAL_BOOT = &quot;no&quot; ] || [ ! -z &quot;$RELOAD_CONFIG&quot; ];then
 	echo &quot;CONF=$CONF&quot;               &gt;  &quot;/config/$BCFG_BASE/$BCFG_NAME&quot;
 	echo &quot;VENDOR_CONF=$VENDOR_CONF&quot; &gt;&gt; &quot;/config/$BCFG_BASE/$BCFG_NAME&quot;
 	#=======================================
-	# 17.3) Get files from CONF, VENDOR_CONF
+	# 21.4) Get files from CONF, VENDOR_CONF
 	#---------------------------------------
 	IFS=&quot;,&quot; ; for i in $ALL_CCONF;do
 		unset configHash
@@ -858,7 +907,7 @@ if [ $LOCAL_BOOT = &quot;no&quot; ] || [ ! -z &quot;$RELOAD_CONFIG&quot; ];then
 		fi
 	done
 	#=======================================
-	# 17.4) check config files to be deleted
+	# 21.5) check config files to be deleted
 	#---------------------------------------
 	IFS=&quot;,&quot; ; for i in $ALL_CBK_CONF;do
 		BKconfigDest=`echo &quot;$i&quot; | cut -d ';' -f 2`
@@ -877,7 +926,7 @@ if [ $LOCAL_BOOT = &quot;no&quot; ] || [ ! -z &quot;$RELOAD_CONFIG&quot; ];then
 	done
 	IFS=$IFS_ORIG
 	#=======================================
-	# 17.5) Check for KIWI_INITRD
+	# 21.6) Check for KIWI_INITRD
 	#---------------------------------------
 	if [ $haveDisk = &quot;1&quot; ] &amp;&amp; [ $systemIntegrity = &quot;clean&quot; ];then
 		if [ ! -z &quot;$KIWI_INITRD&quot; ] &amp;&amp; [ ! -z &quot;$KIWI_KERNEL&quot; ];then
@@ -904,7 +953,7 @@ fi
 runHook postconfig
 
 #======================================
-# 18) check filesystem and kernels
+# 22) check filesystem and kernels
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $systemIntegrity = &quot;clean&quot; ];then
 	if [ &quot;$FSTYPE&quot; != &quot;nfs&quot; ];then
@@ -914,14 +963,14 @@ if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $systemIntegrity = &quot;clean&quot; ];then
 fi
 
 #======================================
-# 19) setup ird/kernel links for union
+# 23) setup ird/kernel links for union
 #--------------------------------------
 if [ &quot;$LOCAL_BOOT&quot; = &quot;no&quot; ] &amp;&amp; [ $systemIntegrity = &quot;clean&quot; ];then
 	setupKernelLinks
 fi
 
 #======================================
-# 20) Create system dependant files
+# 24) Create system dependant files
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $systemIntegrity = &quot;clean&quot; ];then
 	mkdir -p /config
@@ -938,7 +987,7 @@ if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $systemIntegrity = &quot;clean&quot; ];then
 fi
 
 #======================================
-# 21) send DHCP_RELEASE, reset cache
+# 25) send DHCP_RELEASE, reset cache
 #--------------------------------------
 runHook preNetworkRelease
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
@@ -946,25 +995,25 @@ if [ $LOCAL_BOOT = &quot;no&quot; ];then
 fi
 
 #======================================
-# 22) copy system dependant files
+# 26) copy system dependant files
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ];then
 	setupConfigFiles
 fi
 
 #======================================
-# 23) update system dependant files
+# 27) update system dependant files
 #--------------------------------------
 setupInittab /mnt
 
 echo 256 &gt; /proc/sys/kernel/real-root-dev
 #======================================
-# 24) umount system filesystems
+# 28) umount system filesystems
 #--------------------------------------
 umountSystemFilesystems
 
 #======================================
-# 25) copy initrd files to image
+# 29) copy initrd files to image
 #--------------------------------------
 if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $systemIntegrity = &quot;clean&quot; ];then
 	if canWrite /mnt;then
@@ -975,18 +1024,18 @@ if [ $LOCAL_BOOT = &quot;no&quot; ] &amp;&amp; [ $systemIntegrity = &quot;clean&quot; ];then
 fi
 
 #======================================
-# 26) kill boot shell
+# 30) kill boot shell
 #--------------------------------------
 killShell
 killBlogD
 
 #======================================
-# 27) Activate new root
+# 31) Activate new root
 #--------------------------------------
 runHook preactivate
 activateImage
 
 #======================================
-# 28) Unmount initrd / system init
+# 32) Unmount initrd / system init
 #--------------------------------------
 bootImage $@


hooks/post-receive
-- 
Project kiwi at BerliOS

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003734.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 418c6df5c22b455b7ee17ac53d0ff867ec0506c0
</A></li>
	<LI>Next message: <A HREF="003735.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 6ac77e30cd2c9da6a959cb47c3cb0b21b1176a9d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3732">[ date ]</a>
              <a href="thread.html#3732">[ thread ]</a>
              <a href="subject.html#3732">[ subject ]</a>
              <a href="author.html#3732">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
