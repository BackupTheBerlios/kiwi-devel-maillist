<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-480-SuSE-11.4-Devel,	updated. 9a9f9fc8e6f79c437d1c5a2cb5658cf186261fe1
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2011-March/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%0A%09KIWI-480-SuSE-11.4-Devel%2C%0A%09updated.%209a9f9fc8e6f79c437d1c5a2cb5658cf186261fe1&In-Reply-To=%3C20110321102224.C9F184805EE%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003229.html">
   <LINK REL="Next"  HREF="003231.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-480-SuSE-11.4-Devel,	updated. 9a9f9fc8e6f79c437d1c5a2cb5658cf186261fe1</H1>
    <B>marcus_schaefer at BerliOS</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%0A%09KIWI-480-SuSE-11.4-Devel%2C%0A%09updated.%209a9f9fc8e6f79c437d1c5a2cb5658cf186261fe1&In-Reply-To=%3C20110321102224.C9F184805EE%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-480-SuSE-11.4-Devel,	updated. 9a9f9fc8e6f79c437d1c5a2cb5658cf186261fe1">marcus_schaefer at mail.berlios.de
       </A><BR>
    <I>Mon Mar 21 11:22:24 CET 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="003229.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. e41c82d203b854b6006b80a1ca18e18dd90bfda9
</A></li>
        <LI>Next message: <A HREF="003231.html">[Kiwi-devel] Avoid use of uninitialized var
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3230">[ date ]</a>
              <a href="thread.html#3230">[ thread ]</a>
              <a href="subject.html#3230">[ subject ]</a>
              <a href="author.html#3230">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Project kiwi at BerliOS&quot;.

The branch, KIWI-480-SuSE-11.4-Devel has been updated
       via  9a9f9fc8e6f79c437d1c5a2cb5658cf186261fe1 (commit)
       via  ad39f553deec7f4c273ae3c0c27bdb35ef9794a8 (commit)
       via  3bc52a065371208a08211bdc5941fbd3b2fa921e (commit)
       via  e17c411840b9afd18c684a366e3a0c18a50e5fdd (commit)
      from  939820c443d1e901d712a6165eede3140735f439 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9a9f9fc8e6f79c437d1c5a2cb5658cf186261fe1
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Tue Mar 15 11:50:21 2011 +0100

    - fixed race condition in CD device search, missing udevPending

commit ad39f553deec7f4c273ae3c0c27bdb35ef9794a8
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Tue Mar 15 18:06:03 2011 +0100

    - fixed device map cleanup. The cleanup happened to early
      because the installBootLoader() code accesses the device
      map under certain circumstances but the original device
      was already freed. In that case the installBootLoader()
      code re-adds the mapping but that could lead to a different
      device name compared to the one stored in the device
      mapping table

commit 3bc52a065371208a08211bdc5941fbd3b2fa921e
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Fri Mar 18 10:58:06 2011 +0100

    - fixed exit code handling:
      * kiwi --version     =&gt; exit 0
      * kiwi --help | -h   =&gt; exit 0
      * unknown option     =&gt; exit 1
      * no root privileges =&gt; exit 1
      * processsing error  =&gt; exit 1

commit e17c411840b9afd18c684a366e3a0c18a50e5fdd
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Fri Mar 18 14:46:49 2011 +0100

    - fixed kiwirevision check. In case of a git revision it's
      invalid to check for less than a number. The check must
      match the revision

-----------------------------------------------------------------------

Summary of changes:
diff --git a/kiwi.pl b/kiwi.pl
index b1b82eb..a152583 100755
--- a/kiwi.pl
+++ b/kiwi.pl
@@ -1158,12 +1158,14 @@ sub init {
 	$SIG{&quot;HUP&quot;}      = \&quit;
 	$SIG{&quot;TERM&quot;}     = \&quit;
 	$SIG{&quot;INT&quot;}      = \&quit;
+	my $Help;
+	my $Version;
 	my $kiwi = new KIWILog(&quot;tiny&quot;);
 	#==========================================
 	# get options and call non-root tasks
 	#------------------------------------------
 	my $result = GetOptions(
-		&quot;version&quot;               =&gt; \&amp;version,
+		&quot;version&quot;               =&gt; \$Version,
 		&quot;recycle-root&quot;          =&gt; \$RecycleRoot,
 		&quot;targetdevice=s&quot;        =&gt; \$targetDevice,
 		&quot;v|verbose+&quot;            =&gt; \$Verbosity,
@@ -1240,8 +1242,7 @@ sub init {
 		&quot;check-config=s&quot;        =&gt; \$CheckConfig,
 		&quot;yes|y&quot;                 =&gt; \$defaultAnswer,
 		&quot;debug&quot;                 =&gt; \$Debug,
-		&quot;help|h&quot;                =&gt; \&amp;usage,
-		&quot;&lt;&gt;&quot;                    =&gt; \&amp;usage
+		&quot;help|h&quot;                =&gt; \$Help
 	);
 	#========================================
 	# check if recycle-root is used
@@ -1340,15 +1341,30 @@ sub init {
 		cloneImage();
 	}
 	#==========================================
+	# non root task: Help
+	#------------------------------------------
+	if (defined $Help) {
+		usage(0);
+	}
+	#==========================================
+	# non root task: Version
+	#------------------------------------------
+	if (defined $Version) {
+		version(0);
+	}
+	#==========================================
+	# Check result of options parsing
+	#------------------------------------------
+	if ( $result != 1 ) {
+		usage(1);
+	}
+	#==========================================
 	# Check for root privileges
 	#------------------------------------------
 	if ($&lt; != 0) {
 		$kiwi -&gt; error (&quot;Only root can do this&quot;);
 		$kiwi -&gt; failed ();
-		usage();
-	}
-	if ( $result != 1 ) {
-		usage();
+		usage(1);
 	}
 	#==========================================
 	# Check option combination/values
@@ -1456,6 +1472,7 @@ sub usage {
 	# Explain the available options for this
 	# image creation system
 	# ---
+	my $exit = shift;
 	my $kiwi = new KIWILog(&quot;tiny&quot;);
 	my $date = qxx ( &quot;bash -c 'LANG=POSIX date -I'&quot; ); chomp $date;
 	print &quot;Linux KIWI setup  (image builder) ($date)\n&quot;;
@@ -1639,7 +1656,7 @@ sub usage {
 	print &quot;      system image. The kernel check also tries to fix the boot\n&quot;;
 	print &quot;      image if no matching kernel was found.\n&quot;;
 	print &quot;--\n&quot;;
-	version();
+	version ($exit);
 }
 
 #==========================================
@@ -2230,6 +2247,10 @@ sub version {
 	# ...
 	# Version information
 	# ---
+	my $exit = shift;
+	if (! defined $exit) {
+		$exit = 0;
+	}
 	if (! defined $kiwi) {
 		$kiwi = new KIWILog(&quot;tiny&quot;);
 	}
@@ -2239,7 +2260,7 @@ sub version {
 	}
 	$kiwi -&gt; info (&quot;kiwi version v$Version\nGIT Commit: $rev\n&quot;);
 	$kiwi -&gt; cleanSweep();
-	exit 0;
+	exit ($exit);
 }
 
 #==========================================
diff --git a/modules/KIWIBoot.pm b/modules/KIWIBoot.pm
index b1f9fda..16ccc32 100644
--- a/modules/KIWIBoot.pm
+++ b/modules/KIWIBoot.pm
@@ -2242,13 +2242,6 @@ sub setupBootDisk {
 	main::umount();
 	$kiwi -&gt; done();
 	#==========================================
-	# cleanup device maps and part mount
-	#------------------------------------------
-	if ($lvm) {
-		qxx (&quot;vgchange -an $this-&gt;{lvmgroup} 2&gt;&amp;1&quot;);
-	}
-	$this -&gt; cleanLoopMaps();
-	#==========================================
 	# Install boot loader on disk
 	#------------------------------------------
 	my $bootdevice = $diskname;
@@ -2260,6 +2253,13 @@ sub setupBootDisk {
 		return undef;
 	}
 	#==========================================
+	# cleanup device maps and part mount
+	#------------------------------------------
+	if ($lvm) {
+		qxx (&quot;vgchange -an $this-&gt;{lvmgroup} 2&gt;&amp;1&quot;);
+	}
+	$this -&gt; cleanLoopMaps();
+	#==========================================
 	# cleanup temp directory
 	#------------------------------------------
 	qxx (&quot;rm -rf $tmpdir&quot;);
diff --git a/modules/KIWILinuxRC.sh b/modules/KIWILinuxRC.sh
index 3cd3caa..f5e4f9e 100644
--- a/modules/KIWILinuxRC.sh
+++ b/modules/KIWILinuxRC.sh
@@ -2799,6 +2799,7 @@ function CDDevice {
 			sleep 1
 		fi
 		count=`expr $count + 1`
+		udevPending
 	done
 	echo
 	if [ -z &quot;$cddev&quot; ];then
diff --git a/modules/KIWIXMLValidator.pm b/modules/KIWIXMLValidator.pm
index 2f4c803..b9f4e20 100644
--- a/modules/KIWIXMLValidator.pm
+++ b/modules/KIWIXMLValidator.pm
@@ -590,10 +590,10 @@ sub __checkRevision {
 		my $cur_rev = &lt;$FD&gt;; close $FD;
 		my $req_rev = $imgnameNodeList
 			-&gt; get_node(1) -&gt; getAttribute (&quot;kiwirevision&quot;);
-		if ((defined $req_rev) &amp;&amp; ($cur_rev &lt; $req_rev)) {
+		if ((defined $req_rev) &amp;&amp; ($cur_rev ne $req_rev)) {
 			$kiwi -&gt; failed ();
 			$kiwi -&gt; error  (
-				&quot;KIWI revision too old, require r$req_rev got r$cur_rev&quot;
+				&quot;KIWI revision mismatch, require r$req_rev got r$cur_rev&quot;
 			);
 			$kiwi -&gt; failed ();
 			return undef;
diff --git a/tests/unit/lib/Test/xmlValidator.pm b/tests/unit/lib/Test/xmlValidator.pm
index 26d10a3..591cb5b 100644
--- a/tests/unit/lib/Test/xmlValidator.pm
+++ b/tests/unit/lib/Test/xmlValidator.pm
@@ -544,7 +544,7 @@ sub test_revisionMismatch {
 	my $kiwi = $this -&gt; {kiwi};
 	my $msg = $kiwi -&gt; getMessage();
 	$this -&gt; assert_str_equals(
-		&quot;KIWI revision too old, require r3 got r1\n&quot;,$msg
+		&quot;KIWI revision mismatch, require r3 got r1\n&quot;,$msg
 	);
 	my $msgT = $kiwi -&gt; getMessageType();
 	$this -&gt; assert_str_equals('error', $msgT);


hooks/post-receive
-- 
Project kiwi at BerliOS

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003229.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. e41c82d203b854b6006b80a1ca18e18dd90bfda9
</A></li>
	<LI>Next message: <A HREF="003231.html">[Kiwi-devel] Avoid use of uninitialized var
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3230">[ date ]</a>
              <a href="thread.html#3230">[ thread ]</a>
              <a href="subject.html#3230">[ subject ]</a>
              <a href="author.html#3230">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
