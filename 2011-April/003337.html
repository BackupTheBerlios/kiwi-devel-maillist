<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 80f256a4bae33ac10045b042122c8ba1f7e9cade
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/kiwi-devel/2011-April/index.html" >
   <LINK REL="made" HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%20master%2C%0A%09updated.%2080f256a4bae33ac10045b042122c8ba1f7e9cade&In-Reply-To=%3C20110414142235.291FC481381%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003336.html">
   <LINK REL="Next"  HREF="003338.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 80f256a4bae33ac10045b042122c8ba1f7e9cade</H1>
    <B>marcus_schaefer at BerliOS</B> 
    <A HREF="mailto:kiwi-devel%40lists.berlios.de?Subject=Re%3A%20%5BKiwi-devel%5D%20%5BGit%5DProject%20kiwi%20at%20BerliOS%20branch%2C%20master%2C%0A%09updated.%2080f256a4bae33ac10045b042122c8ba1f7e9cade&In-Reply-To=%3C20110414142235.291FC481381%40sheep.berlios.de%3E"
       TITLE="[Kiwi-devel] [Git]Project kiwi at BerliOS branch, master,	updated. 80f256a4bae33ac10045b042122c8ba1f7e9cade">marcus_schaefer at mail.berlios.de
       </A><BR>
    <I>Thu Apr 14 16:22:35 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="003336.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-485-SuSE-11-1-SLE-SP-Devel,	updated. af431d97c3cc8392e8423f71eaa8ebd9ba530358
</A></li>
        <LI>Next message: <A HREF="003338.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-485-SuSE-11-1-SLE-SP-Devel,	updated. 1bd8d9f881d91690f060a868bd62608bd8ca755e
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3337">[ date ]</a>
              <a href="thread.html#3337">[ thread ]</a>
              <a href="subject.html#3337">[ subject ]</a>
              <a href="author.html#3337">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Project kiwi at BerliOS&quot;.

The branch, master has been updated
       via  80f256a4bae33ac10045b042122c8ba1f7e9cade (commit)
       via  7d14317caffb52ee3fb65286710914fa89b19d54 (commit)
       via  8df04b0e6852202dd472db02b9153fab038dc266 (commit)
       via  7c54738f1a7dbc61b421cad0dc79d81df5b15a7a (commit)
      from  c35b71b29486d225c167328e4756c915fd960478 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 80f256a4bae33ac10045b042122c8ba1f7e9cade
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Thu Apr 14 16:00:52 2011 +0200

    - fixed boot partition id in suse-repart if syslinux is
      used as bootloader. We are using fat32 now (c)

commit 7d14317caffb52ee3fb65286710914fa89b19d54
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Thu Apr 14 15:55:52 2011 +0200

    - using sfdisk --id now, thus require sfdisk in spec file

commit 8df04b0e6852202dd472db02b9153fab038dc266
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Thu Apr 14 15:52:16 2011 +0200

    - fixed getStorageID function and the evaluation of the return
      value of this function. The assumption that the partition id
      is a decimal value is wrong, thus calling int() on the result
      is not a good idea. man I really shouldn't code at midnight

commit 7c54738f1a7dbc61b421cad0dc79d81df5b15a7a
Author: Marcus Sch&#195;&#164;fer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/kiwi-devel">ms at novell.com</A>&gt;
Date:   Thu Apr 14 12:32:44 2011 +0200

    - fixed setupSUSEInitrd function. We create imho poinless
      links named linux.vmx and initrd.vmx which are not used
      at all if the initrd could be generated by mkinitrd.
      Additionally the links are broken if the running kernel
      is not the same as the installed kernel. Therefore I
      removed the creation of that link files
    
    - fixed kernelList function. the code searching for installed
      kernels if the running kernel can't be found was never
      reached. Additionally the function did not search for other
      than the running kernel which seems to be wrong if multiple
      kernels are installed

-----------------------------------------------------------------------

Summary of changes:
diff --git a/modules/KIWIBoot.pm b/modules/KIWIBoot.pm
index bc431bb..b9e0f06 100644
--- a/modules/KIWIBoot.pm
+++ b/modules/KIWIBoot.pm
@@ -1818,7 +1818,7 @@ sub setupBootDisk {
 				if ($bootloader =~ /(sys|ext)linux/) {
 					my $partid = &quot;c&quot;;
 					if ($bootloader eq &quot;extlinux&quot; ) {
-						$partid = 83;
+						$partid = &quot;83&quot;;
 					}
 					my $syslsize = $this-&gt;{vmmbyte} - $syslbootMB - $syszip;
 					@commands = (
@@ -1856,7 +1856,7 @@ sub setupBootDisk {
 				if ($bootloader =~ /(sys|ext)linux/) {
 					my $partid = &quot;c&quot;;
 					if ($bootloader eq &quot;extlinux&quot; ) {
-						$partid = 83;
+						$partid = &quot;83&quot;;
 					}
 					my $syslsize = $this-&gt;{vmmbyte} - $syslbootMB;
 					@commands = (
@@ -1883,7 +1883,7 @@ sub setupBootDisk {
 			if ($bootloader =~ /(sys|ext)linux/) {
 				my $partid = &quot;c&quot;;
 				if ($bootloader eq &quot;extlinux&quot; ) {
-					$partid = 83;
+					$partid = &quot;83&quot;;
 				}
 				my $lvmsize = $this-&gt;{vmmbyte} - $syslbootMB;
 				my $bootpartsize = &quot;+&quot;.$syslbootMB.&quot;M&quot;;
@@ -4417,46 +4417,14 @@ sub getStorageID {
 	# partition. If the call fails the function
 	# returns 0
 	# ---
-	my $this = shift;
-	my $pdev = shift;
-	my $tool = $this-&gt;{ptool};
-	my $result;
-	my $status;
-	if (! defined $tool) {
-		$tool = &quot;parted&quot;;
-	}
-	SWITCH: for ($tool) {
-		#==========================================
-		# parted
-		#------------------------------------------
-		/^parted/  &amp;&amp; do {
-			my $parted = &quot;/usr/sbin/parted -m &quot;;
-			my $disk   = $pdev;
-			if ($pdev =~ /mapper/) {
-				if ($pdev =~ /mapper\/(.*)p(\d+)/) {
-					$disk = &quot;/dev/&quot;.$1;
-					$pdev = &quot;/dev/&quot;.$1.$2;
-				}
-			} else {
-				if ($pdev =~ /(.*)(\d+)/) {
-					$disk = $1;
-				}
-			}
-			$parted .= '-s '.$disk.' print |';
-			$parted .= 'sed -e &quot;s@^\([0-4]\):@'.$disk.'\1:@&quot; |';
-			$parted .= 'grep ^'.$pdev.':|cut -f2 -d= | cut -f1 -d,';
-			$status = qxx ($parted);
-			$result = $? &gt;&gt; 8;
-			if ((! $status) &amp;&amp; ($pdev =~ /loop/)) {
-				$status = qxx (&quot;/usr/sbin/parted -s $pdev mklabel msdos 2&gt;&amp;1&quot;);
-				$status = qxx ($parted);
-				$result = $? &gt;&gt; 8;
-			}
-			last SWITCH;
-		};
-	}
+	my $this   = shift;
+	my $device = shift;
+	my $partid = shift;
+	my $status = qxx (&quot;sfdisk --id $device $partid 2&gt;&amp;1&quot;);
+	my $result = $? &gt;&gt; 8;
 	if ($result == 0) {
-		return int $status;
+		chomp  $status;
+		return $status;
 	}
 	return 0;
 }
@@ -4501,7 +4469,7 @@ sub setPPCDeviceMap {
 	}
 	if ($loader eq &quot;lilo&quot;) {
 		for (my $i=1;$i&lt;=2;$i++) {
-			my $type = $this -&gt; getStorageID ($device.$i);
+			my $type = $this -&gt; getStorageID ($device,$i);
 			if ($type = $search) {
 				$result{prep} = $device.$i;
 			}
@@ -4535,11 +4503,11 @@ sub setDefaultDeviceMap {
 	if ($loader =~ /(sys|ext)linux/) {
 		my $search = &quot;c&quot;;
 		if ($loader eq &quot;extlinux&quot; ) {
-			$search = 83;
+			$search = &quot;83&quot;;
 		}
 		for (my $i=3;$i&gt;=1;$i--) {
-			my $type = $this -&gt; getStorageID ($device.$i);
-			if ($type == $search) {
+			my $type = $this -&gt; getStorageID ($device,$i);
+			if ($type eq $search) {
 				if ($loader eq &quot;syslinux&quot; ) {
 					$result{fat} = $device.$i;
 				} else {
@@ -4577,11 +4545,11 @@ sub setLoopDeviceMap {
 	if ($loader =~ /(sys|ext)linux/) {
 		my $search = &quot;c&quot;;
 		if ($loader eq &quot;extlinux&quot; ) {
-			$search = 83;
+			$search = &quot;83&quot;;
 		}
 		for (my $i=3;$i&gt;=1;$i--) {
-			my $type = $this -&gt; getStorageID (&quot;/dev/mapper&quot;.$dmap.&quot;p$i&quot;);
-			if ($type == $search) {
+			my $type = $this -&gt; getStorageID ($device,$i);
+			if (&quot;$type&quot; eq &quot;$search&quot;) {
 				if ($loader eq &quot;syslinux&quot;) {
 					$result{fat} = &quot;/dev/mapper&quot;.$dmap.&quot;p$i&quot;;
 				} else {
diff --git a/modules/KIWILinuxRC.sh b/modules/KIWILinuxRC.sh
index 9c4d745..ae3857e 100644
--- a/modules/KIWILinuxRC.sh
+++ b/modules/KIWILinuxRC.sh
@@ -897,13 +897,6 @@ function setupSUSEInitrd {
 		if [ -f /etc/init.d/boot.device-mapper ];then
 			/etc/init.d/boot.device-mapper stop
 		fi
-		if [ $bootLoaderOK = &quot;1&quot; ] &amp;&amp; [ $haveVMX = &quot;1&quot; ];then
-			running=$(uname -r)
-			rlinux=vmlinuz-$running
-			rinitrd=initrd-$running
-			ln -s $rlinux  /boot/linux.vmx
-			ln -s $rinitrd /boot/initrd.vmx
-		fi
 		if [ $umountSys -eq 1 ];then
 			umount /sys
 		fi
@@ -1583,7 +1576,7 @@ function setupBootLoaderSyslinux {
 			#--------------------------------------
 			echo &quot;DEFAULT $title&quot;                              &gt;&gt; $conf
 			echo &quot;label $title&quot;                                &gt;&gt; $conf
-			if xenServer $kernel $mountPrefix;then
+			if xenServer $kname $mountPrefix;then
 				systemException \
 					&quot;*** $loader: Xen dom0 boot not implemented ***&quot; \
 				&quot;reboot&quot;
@@ -1616,7 +1609,7 @@ function setupBootLoaderSyslinux {
 			#--------------------------------------
 			title=$(makeLabel &quot;Failsafe -- $title&quot;)
 			echo &quot;label $title&quot;                                &gt;&gt; $conf
-			if xenServer $kernel $mountPrefix;then
+			if xenServer $kname $mountPrefix;then
 				systemException \
 					&quot;*** $loader: Xen dom0 boot not implemented ***&quot; \
 				&quot;reboot&quot;
@@ -3781,23 +3774,23 @@ function kernelList {
 			KERNEL_PAIR=$kernel:$initrd
 			KERNEL_NAME[$kcount]=$krunning
 			KERNEL_LIST=$KERNEL_PAIR
+			kcount=$((kcount+1))
 		fi
 	fi
 	#======================================
 	# search for other kernels
 	#--------------------------------------
-	if [ ! -z &quot;$KERNEL_LIST&quot; ];then
-		for i in $prefix/lib/modules/*;do
-			if [ ! -d $i ];then
-				continue
-			fi
-			unset kernel
-			unset initrd
-			kname=`basename $i`
-			if [ &quot;$kname&quot; = $krunning ];then
-				continue
-			fi
-			for name in vmlinux vmlinuz image;do
+	for i in $prefix/lib/modules/*;do
+		if [ ! -d $i ];then
+			continue
+		fi
+		unset kernel
+		unset initrd
+		kname=`basename $i`
+		if [ &quot;$kname&quot; = $krunning ];then
+			continue
+		fi
+		for name in vmlinux vmlinuz image;do
 			for k in $prefix/boot/$name-${i##*/}; do
 				if [ -f $k ];then
 					kernel=${k##*/}
@@ -3805,16 +3798,17 @@ function kernelList {
 					break 2
 				fi
 			done
-			done
-			if [ -z &quot;$kernel&quot; ];then
-				continue
-			fi
-			kcount=$((kcount+1))
+		done
+		if [ ! -z &quot;$kernel&quot; ];then
 			kpair=$kernel:$initrd
 			KERNEL_NAME[$kcount]=$kname
 			KERNEL_LIST=$KERNEL_LIST,$kpair
-		done
-	fi
+			kcount=$((kcount+1))
+		fi
+	done
+	#======================================
+	# what if no kernel was found...
+	#--------------------------------------
 	if [ -z &quot;$KERNEL_LIST&quot; ];then
 		# /.../
 		# the system image doesn't provide the kernel and initrd but
@@ -3832,6 +3826,7 @@ function kernelList {
 			KERNEL_NAME[1]=vmlinux
 		fi
 	fi
+	KERNEL_LIST=$(echo $KERNEL_LIST | sed -e s@^,@@)
 	export KERNEL_LIST
 	export KERNEL_NAME
 	export KERNEL_PAIR
diff --git a/rpm/kiwi.spec b/rpm/kiwi.spec
index d10130a..4562462 100644
--- a/rpm/kiwi.spec
+++ b/rpm/kiwi.spec
@@ -50,7 +50,7 @@ Requires:       squashfs
 Requires:       perl = %{perl_version}
 Requires:       perl-XML-LibXML perl-libwww-perl screen coreutils
 Requires:       perl-XML-LibXML-Common perl-XML-SAX perl-Config-IniFiles
-Requires:       kiwi-tools libxslt checkmedia
+Requires:       kiwi-tools libxslt checkmedia sfdisk
 %if %{suse_version} &gt; 1030
 Requires:       satsolver-tools
 %endif
diff --git a/system/boot/ix86/oemboot/suse-repart b/system/boot/ix86/oemboot/suse-repart
index 1239ae6..fec623b 100755
--- a/system/boot/ix86/oemboot/suse-repart
+++ b/system/boot/ix86/oemboot/suse-repart
@@ -732,7 +732,7 @@ function createBootDeviceData {
 		export bootXMBytes=100
 		export bootpartID=83
 		if [ &quot;$loader&quot; = &quot;syslinux&quot; ];then
-			bootpartID=6
+			bootpartID=c
 		fi
 		#======================================
 		# Store contents in RAM


hooks/post-receive
-- 
Project kiwi at BerliOS

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003336.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-485-SuSE-11-1-SLE-SP-Devel,	updated. af431d97c3cc8392e8423f71eaa8ebd9ba530358
</A></li>
	<LI>Next message: <A HREF="003338.html">[Kiwi-devel] [Git]Project kiwi at BerliOS branch,	KIWI-485-SuSE-11-1-SLE-SP-Devel,	updated. 1bd8d9f881d91690f060a868bd62608bd8ca755e
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3337">[ date ]</a>
              <a href="thread.html#3337">[ thread ]</a>
              <a href="subject.html#3337">[ subject ]</a>
              <a href="author.html#3337">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/kiwi-devel">More information about the Kiwi-devel
mailing list</a><br>
</body></html>
